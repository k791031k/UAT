【a17】
avascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const TOKEN_STORAGE_KEY='euisToken';const A17_TEXT_SETTINGS_STORAGE_KEY='kgilifeQueryTool_A17TextSettings_v3';const TOOL_MAIN_CONTAINER_ID='kgilifeQueryToolMainContainer_vFinal';const Z_INDEX_OVERLAY=2147483640;const Z_INDEX_MAIN_UI=2147483630;const Z_INDEX_NOTIFICATION=2147483647;const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}];const%20FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',mainStatus:'%E4%B8%BB%E7%8B%80%E6%85%8B',subStatus:'%E6%AC%A1%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8',_queriedValue_:'%E6%9F%A5%E8%A9%A2%E5%80%BC',NO:'%E5%BA%8F%E8%99%9F',_apiQueryStatus:'%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C'};const%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];const%20UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'};const%20A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1%E5%96%AE%E4%BD%8D',color:'#546e7a'}];const%20UNIT_MAP_FIELD_API_KEY='uwApproverUnit';const%20A17_DEFAULT_TEXT_CONTENT=%22DEAR,\n\n%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9AA17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E4%BB%A5%E5%8F%8A%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82\n\n%E6%9C%AC%E9%80%B1%E6%88%91%E5%80%91%E5%B7%B2%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E8%A9%B2%E7%AD%89%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%EF%BC%8C%E7%B5%90%E6%9E%9C%E9%A1%AF%E7%A4%BA%EF%BC%8C%E9%80%99%E4%BA%9B%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%E3%80%82%E7%82%BA%E5%88%A9%E5%BE%8C%E7%BA%8C%E5%B8%B3%E5%8B%99%E8%99%95%E7%90%86%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%AF%A6%E9%9A%9B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E4%B8%A6%E5%A6%82%E6%9C%89%E9%9C%80%E8%AA%BF%E6%95%B4%E6%88%96%E8%99%95%E7%90%86%E4%BA%8B%E9%A0%85%EF%BC%8C%E8%AB%8B%E4%B8%80%E4%BD%B5%E5%8D%94%E5%8A%A9%E8%BE%A6%E7%90%86%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;let%20CURRENT_API_URL='';let%20apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);let%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS[0];let%20originalQueryResults=[];let%20baseA17MasterData=[];let%20currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:!1,mainUIElement:null,tableBodyElement:null,tableHeadElement:null,a17UnitButtonsContainer:null,};let%20a17ModeState={isActive:!1,selectedUnits:new%20Set(),textSettings:{mainContent:A17_DEFAULT_TEXT_CONTENT,mainFontSize:12,mainLineHeight:1.5,mainFontColor:'#333333',dateFontSize:8,dateLineHeight:1.2,dateFontColor:'#555555',genDateOffset:-3,compDateOffset:0,},};let%20csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1,};let%20isEditMode=!1;let%20dragState={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};let%20a17ButtonLongPressTimer=null;function%20escapeHtml(unsafe){if(typeof%20unsafe!=='string')return%20unsafe===null||unsafe===undefined?'':String(unsafe);return%20unsafe.replace(/[&%3C%3E%22']/g,m=%3E({'&':'&','%3C':'%3C','%3E':'%3E','%22':'%22',%22'%22:'&#039;'})[m])}function%20displaySystemNotification(message,isError=!1,duration=3000){const%20id=TOOL_MAIN_CONTAINER_ID+'_Notification';document.getElementById(id)?.remove();const%20n=document.createElement('div');n.id=id;n.style.cssText=%60position:fixed;top:20px;right:20px;background-color:${isError%20?%20'#dc3545'%20:%20'#28a745'};color:white;padding:10px%2015px;border-radius:5px;z-index:${Z_INDEX_NOTIFICATION};font-size:14px;font-family:'Microsoft%20JhengHei',Arial,sans-serif;box-shadow:0%202px%2010px%20rgba(0,0,0,0.2);transform:translateX(calc(100%%20+%2025px));transition:transform%200.3s%20ease-in-out;display:flex;align-items:center;%60;const%20i=document.createElement('span');i.style.marginRight='8px';i.style.fontSize='16px';i.innerHTML=isError?'&#x26A0;':'&#x2714;';n.appendChild(i);n.appendChild(document.createTextNode(message));document.body.appendChild(n);setTimeout(()=%3En.style.transform='translateX(0)',50);setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2025px))';setTimeout(()=%3En.remove(),300)},duration)}function%20createDialogBase(idSuffix,contentHtml,minWidth='350px',maxWidth='600px',customStyles=''){const%20id=TOOL_MAIN_CONTAINER_ID+idSuffix;document.getElementById(id+'_overlay')?.remove();const%20overlay=document.createElement('div');overlay.id=id+'_overlay';overlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:${Z_INDEX_OVERLAY};display:flex;align-items:center;justify-content:center;font-family:'Microsoft%20JhengHei',Arial,sans-serif;backdrop-filter:blur(2px);%60;const%20dialog=document.createElement('div');dialog.id=id+'_dialog';dialog.style.cssText=%60background:#fff;padding:20px%2025px;border-radius:8px;box-shadow:0%205px%2020px%20rgba(0,0,0,0.25);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtDialogAppear%200.2s%20ease-out;${customStyles}%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);document.body.appendChild(overlay);const%20styleEl=document.createElement('style');styleEl.textContent=%60@keyframes%20qtDialogAppear{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn{border:none;padding:8px%2015px;border-radius:4px;font-size:13px;cursor:pointer;transition:opacity%200.2s%20ease,transform%200.1s%20ease;font-weight:500;margin-left:8px;}.qt-dialog-btn:hover{opacity:0.85;}.qt-dialog-btn:active{transform:scale(0.98);}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-red{background:#dc3545;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;}.qt-dialog-btn-green{background:#28a745;color:white;}.qt-dialog-title{margin:0%200%2015px%200;color:#333;font-size:18px;text-align:center;font-weight:600;}.qt-input,.qt-textarea,.qt-select{width:calc(100%%20-%2018px);padding:9px;border:1px%20solid%20#ccc;border-radius:4px;font-size:13px;margin-bottom:15px;color:#333;box-sizing:border-box;}.qt-textarea{min-height:70px;resize:vertical;}.qt-dialog-flex-end{display:flex;justify-content:flex-end;margin-top:15px;}.qt-dialog-flex-between{display:flex;justify-content:space-between;align-items:center;margin-top:15px;}%60;dialog.appendChild(styleEl);return{overlay,dialog}}function%20extractName(strVal){if(!strVal||typeof%20strVal!=='string')return'';const%20matchResult=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+/);return%20matchResult?matchResult[0]:strVal.split('%20')[0]}function%20getFirstLetter(unitString){if(!unitString||typeof%20unitString!=='string')return'Z';for(let%20i=0;i%3CunitString.length;i++){const%20char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char))return%20char}return'Z'}function%20formatDate(date){const%20y=date.getFullYear();const%20m=String(date.getMonth()+1).padStart(2,'0');const%20d=String(date.getDate()).padStart(2,'0');return%20%60${y}${m}${d}%60}function%20createEnvSelectionDialog(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20justify-content:center;%22%3E%3Cbutton%20id=%22qt-env-uat%22%20class=%22qt-dialog-btn%20qt-dialog-btn-green%22%20style=%22flex-grow:1;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%3Cbutton%20id=%22qt-env-prod%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%20style=%22flex-grow:1;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%3C/div%3E%3Cdiv%20style=%22text-align:center;%20margin-top:15px;%22%3E%3Cbutton%20id=%22qt-env-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay}=createDialogBase('_EnvSelect',contentHtml,'300px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-env-uat').onclick=()=%3EcloseDialog('test');overlay.querySelector('#qt-env-prod').onclick=()=%3EcloseDialog('prod');overlay.querySelector('#qt-env-cancel').onclick=()=%3EcloseDialog(null)})}function%20createTokenDialog(attempt=1){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input%22%20class=%22qt-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E${attempt%20%3E%201%20?%20%60%3Cp%20style=%22color:red;%20font-size:12px;%20text-align:center;%20margin-bottom:10px;%22%3EToken%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%3C/p%3E%60%20:%20''}%3Cdiv%20class=%22qt-dialog-flex-between%22%3E%3Cbutton%20id=%22qt-token-skip%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-token-close-tool%22%20class=%22qt-dialog-btn%20qt-dialog-btn-red%22%3E%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%3C/button%3E%3Cbutton%20id=%22qt-token-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E${attempt%20%3E%201%20?%20'%E9%87%8D%E8%A9%A6'%20:%20'%E7%A2%BA%E5%AE%9A'}%3C/button%3E%3C/div%3E%3C/div%3E%60;const{overlay}=createDialogBase('_Token',contentHtml,'320px','auto');const%20inputEl=overlay.querySelector('#qt-token-input');inputEl.focus();if(attempt%3E2){const%20okBtn=overlay.querySelector('#qt-token-ok');okBtn.disabled=!0;okBtn.style.opacity='0.5';okBtn.style.cursor='not-allowed';displaySystemNotification('Token%E5%A4%9A%E6%AC%A1%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97',!0,4000)}const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog('_token_dialog_cancel_');};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-token-ok').onclick=()=%3EcloseDialog(inputEl.value.trim());overlay.querySelector('#qt-token-close-tool').onclick=()=%3EcloseDialog('_close_tool_');overlay.querySelector('#qt-token-skip').onclick=()=%3EcloseDialog('_skip_token_')})}function%20createQuerySetupDialog(){return%20new%20Promise(resolve=%3E{const%20queryButtonsHtml=QUERYABLE_FIELD_DEFINITIONS.map(def=%3E%60%3Cbutton%20class=%22qt-querytype-btn%22%20data-apikey=%22${def.queryApiKey}%22%20style=%22background-color:${def.color};%20color:white;%20border:%202px%20solid%20transparent;%20padding:%208px%2010px;%20flex-grow:%201;%20border-radius:%204px;%20font-size:%2013px;%20font-weight:%20500;%20cursor:%20pointer;%22%3E${escapeHtml(def.queryDisplayName)}%3C/button%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin-bottom:10px;%20font-size:13px;%20color:#555;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B%EF%BC%9A%3C/div%3E%3Cdiv%20id=%22qt-querytype-buttons%22%20style=%22display:flex;%20flex-wrap:wrap;%20gap:8px;%20margin-bottom:15px;%22%3E${queryButtonsHtml}%3C/div%3E%3Cdiv%20style=%22margin-bottom:5px;%20font-size:13px;%20color:#555;%22%3E%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%80%BC%20(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E4%BB%A5%E6%8F%9B%E8%A1%8C/%E7%A9%BA%E6%A0%BC/%E9%80%97%E8%99%9F/%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94)%EF%BC%9A%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input%22%20class=%22qt-textarea%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B%22%3E%3C/textarea%3E%3Cdiv%20style=%22margin-bottom:15px;%22%3E%3Cbutton%20id=%22qt-csv-import-btn%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%20style=%22margin-left:0;%22%3E%E5%BE%9ECSV/TXT%E5%8C%AF%E5%85%A5...%3C/button%3E%3Cspan%20id=%22qt-csv-filename-display%22%20style=%22font-size:12px;%20color:#666;%20margin-left:10px;%22%3E%3C/span%3E%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-between%22%3E%3Cbutton%20id=%22qt-clear-all-input-btn%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E8%BC%B8%E5%85%A5%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-querysetup-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%3C/div%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-file-input-hidden%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;const{overlay,dialog}=createDialogBase('_QuerySetup',contentHtml,'480px','auto');const%20queryValuesInput=overlay.querySelector('#qt-queryvalues-input');const%20typeButtons=overlay.querySelectorAll('.qt-querytype-btn');const%20csvImportBtn=overlay.querySelector('#qt-csv-import-btn');const%20fileInputHidden=overlay.querySelector('#qt-file-input-hidden');const%20csvFilenameDisplay=overlay.querySelector('#qt-csv-filename-display');function%20setActiveButton(apiKey){typeButtons.forEach(btn=%3E{const%20isSelected=btn.dataset.apikey===apiKey;btn.style.border=isSelected?%602px%20solid%20${btn.style.backgroundColor}%60:'2px%20solid%20transparent';btn.style.boxShadow=isSelected?%600%200%208px%20${btn.style.backgroundColor}70%60:'none';if(isSelected){selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);queryValuesInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selectedQueryDefinitionGlobal.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86...)%60}})}typeButtons.forEach(btn=%3Ebtn.onclick=()=%3E{setActiveButton(btn.dataset.apikey);queryValuesInput.focus()});setActiveButton(selectedQueryDefinitionGlobal.queryApiKey);csvImportBtn.onclick=()=%3EfileInputHidden.click();fileInputHidden.onchange=async(e)=%3E{const%20file=e.target.files[0];if(!file)return;csvFilenameDisplay.textContent=%60%E5%B7%B2%E9%81%B8:%20${file.name}%60;try{const%20text=await%20file.text();const%20lines=text.split(/\r?\n/).filter(line=%3Eline.trim()!=='');if(lines.length===0){displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E7%82%BA%E7%A9%BA',!0);return}const%20headers=lines[0].split(/,|;|\t/).map(h=%3Eh.trim().replace(/^%22|%22$/g,''));const%20purpose=await%20createCSVPurposeDialog();if(!purpose){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}if(purpose==='fillQueryValues'){const%20columnIndex=await%20createCSVColumnSelectionDialog(headers,%22%E9%81%B8%E6%93%87%E5%8C%85%E5%90%AB%E6%9F%A5%E8%A9%A2%E5%80%BC%E7%9A%84%E6%AC%84%E4%BD%8D%EF%BC%9A%22);if(columnIndex===null||columnIndex===undefined){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}const%20values=[];for(let%20i=1;i%3Clines.length;i++){const%20cols=lines[i].split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''));if(cols[columnIndex]&&cols[columnIndex].trim()!==%22%22)values.push(cols[columnIndex].trim());}queryValuesInput.value=Array.from(new%20Set(values)).join('\n');displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%80%BC%E5%B7%B2%E5%BE%9ECSV%E5%A1%AB%E5%85%A5',!1);csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=%3Eline.split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''))),selectedColForQueryName:headers[columnIndex],isA17CsvPrepared:!1,selectedColsForA17Merge:[]}}else%20if(purpose==='prepareA17Merge'){const%20selectedHeadersForA17=await%20createCSVColumnCheckboxDialog(headers,%22%E5%8B%BE%E9%81%B8%E8%A6%81%E5%9C%A8A17%E8%A1%A8%E6%A0%BC%E4%B8%AD%E9%A1%AF%E7%A4%BA%E7%9A%84CSV%E6%AC%84%E4%BD%8D%EF%BC%9A%22);if(!selectedHeadersForA17||selectedHeadersForA17.length===0){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=%3Eline.split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''))),selectedColsForA17Merge:selectedHeadersForA17,isA17CsvPrepared:!0,selectedColForQueryName:null};displaySystemNotification(%60%E5%B7%B2%E9%81%B8%20${selectedHeadersForA17.length}%20%E5%80%8BCSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%60,!1)}}catch(err){console.error(%22%E8%99%95%E7%90%86CSV%E9%8C%AF%E8%AA%A4:%22,err);displaySystemNotification('%E8%AE%80%E5%8F%96CSV%E5%A4%B1%E6%95%97',!0);csvFilenameDisplay.textContent=''}fileInputHidden.value=''};overlay.querySelector('#qt-clear-all-input-btn').onclick=()=%3E{queryValuesInput.value='';csvFilenameDisplay.textContent='';csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};fileInputHidden.value='';displaySystemNotification('%E6%89%80%E6%9C%89%E8%BC%B8%E5%85%A5%E5%B7%B2%E6%B8%85%E9%99%A4',!1)};const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-querysetup-ok').onclick=()=%3E{const%20values=queryValuesInput.value.trim();if(!selectedQueryDefinitionGlobal){displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B',!0);return}if(!values){displaySystemNotification(%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selectedQueryDefinitionGlobal.queryDisplayName}%60,!0);queryValuesInput.focus();return}closeDialog({selectedApiKey:selectedQueryDefinitionGlobal.queryApiKey,queryValues:values})};overlay.querySelector('#qt-querysetup-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVPurposeDialog(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E9%81%B8%E6%93%87CSV%E6%AA%94%E6%A1%88%E7%94%A8%E9%80%94%3C/h3%3E%3Cdiv%20style=%22display:flex;%20flex-direction:column;%20gap:10px;%22%3E%3Cbutton%20id=%22qt-csv-purpose-query%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20style=%22margin-left:0;%22%3E%E5%B0%87CSV%E6%9F%90%E6%AC%84%E4%BD%9C%E7%82%BA%E6%9F%A5%E8%A9%A2%E5%80%BC%3C/button%3E%3Cbutton%20id=%22qt-csv-purpose-a17%22%20class=%22qt-dialog-btn%20qt-dialog-btn-green%22%20style=%22margin-left:0;%22%3E%E5%8B%BE%E9%81%B8CSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%E9%A1%AF%E7%A4%BA%3C/button%3E%3C/div%3E%3Cdiv%20style=%22text-align:center;%20margin-top:15px;%22%3E%3Cbutton%20id=%22qt-csv-purpose-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay}=createDialogBase('_CSVPurpose',contentHtml,'300px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csv-purpose-query').onclick=()=%3EcloseDialog('fillQueryValues');overlay.querySelector('#qt-csv-purpose-a17').onclick=()=%3EcloseDialog('prepareA17Merge');overlay.querySelector('#qt-csv-purpose-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVColumnSelectionDialog(headers,title){return%20new%20Promise(resolve=%3E{let%20optionsHtml=headers.map((header,index)=%3E%60%3Cbutton%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20data-index=%22${index}%22%20style=%22margin:5px;%20width:%20calc(50%%20-%2010px);%20text-overflow:%20ellipsis;%20overflow:%20hidden;%20white-space:%20nowrap;%22%3E${escapeHtml(header)}%3C/button%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E${escapeHtml(title)}%3C/h3%3E%3Cdiv%20style=%22display:flex;%20flex-wrap:wrap;%20justify-content:center;%20max-height:300px;%20overflow-y:auto;%20margin-bottom:15px;%22%3E${optionsHtml}%3C/div%3E%3Cdiv%20style=%22text-align:center;%22%3E%3Cbutton%20id=%22qt-csvcol-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_CSVColSelect',contentHtml,'400px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelectorAll('.qt-dialog-btn[data-index]').forEach(btn=%3E{btn.onclick=()=%3EcloseDialog(parseInt(btn.dataset.index))});overlay.querySelector('#qt-csvcol-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVColumnCheckboxDialog(headers,title){return%20new%20Promise(resolve=%3E{let%20checkboxesHtml=headers.map((header,index)=%3E%60%3Cdiv%20style=%22margin-bottom:%208px;%20display:flex;%20align-items:center;%22%3E%3Cinput%20type=%22checkbox%22%20id=%22qt-csv-header-cb-${index}%22%20value=%22${escapeHtml(header)}%22%20style=%22margin-right:8px;%20transform:scale(1.2);%22%3E%3Clabel%20for=%22qt-csv-header-cb-${index}%22%20style=%22font-size:14px;%22%3E${escapeHtml(header)}%3C/label%3E%3C/div%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E${escapeHtml(title)}%3C/h3%3E%3Cdiv%20style=%22max-height:%20300px;%20overflow-y:%20auto;%20margin-bottom:%2015px;%20border:%201px%20solid%20#eee;%20padding:%2010px;%20border-radius:%204px;%22%3E${checkboxesHtml}%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-end%22%3E%3Cbutton%20id=%22qt-csvcb-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-csvcb-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%E5%8B%BE%E9%81%B8%3C/button%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_CSVCheckbox',contentHtml,'400px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csvcb-ok').onclick=()=%3E{const%20selected=[];dialog.querySelectorAll('input[type=%22checkbox%22]:checked').forEach(cb=%3Eselected.push(cb.value));if(selected.length===0){displaySystemNotification('%E8%AB%8B%E8%87%B3%E5%B0%91%E5%8B%BE%E9%81%B8%E4%B8%80%E5%80%8B%E6%AC%84%E4%BD%8D',!0);return}closeDialog(selected)};overlay.querySelector('#qt-csvcb-cancel').onclick=()=%3EcloseDialog(null)})}function%20createA17TextSettingDialog(){return%20new%20Promise(resolve=%3E{const%20s=a17ModeState.textSettings;const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3EA17%20%E9%80%9A%E7%9F%A5%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22display:grid;%20grid-template-columns:%201fr;%20gap:%2015px;%22%3E%3Cdiv%3E%3Clabel%20for=%22qt-a17-mainContent%22%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E4%B8%BB%E6%96%87%E6%A1%88%E5%85%A7%E5%AE%B9%EF%BC%9A%3C/label%3E%3Ctextarea%20id=%22qt-a17-mainContent%22%20class=%22qt-textarea%22%20style=%22height:150px;%22%3E${escapeHtml(s.mainContent)}%3C/textarea%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20margin-top:5px;%20flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-mainFontSize%22%20value=%22${s.mainFontSize}%22%20min=%228%22%20max=%2224%22%20step=%220.5%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20pt%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E8%A1%8C%E9%AB%98:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-mainLineHeight%22%20value=%22${s.mainLineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%80%8D%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E9%A1%8F%E8%89%B2:%20%3Cinput%20type=%22color%22%20id=%22qt-a17-mainFontColor%22%20value=%22${s.mainFontColor}%22%20style=%22padding:1px;%20height:25px;%20vertical-align:middle;%22%3E%3C/label%3E%3C/div%3E%3C/div%3E%3Cdiv%3E%3Clabel%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E5%8B%95%E6%85%8B%E6%97%A5%E6%9C%9F%E8%A8%AD%E5%AE%9A%20(%E7%9B%B8%E5%B0%8D%E6%96%BC%E4%BB%8A%E5%A4%A9)%EF%BC%9A%3C/label%3E%3Cdiv%20style=%22display:flex;%20gap:15px;%20align-items:center;%20margin-bottom:5px;flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%E5%81%8F%E7%A7%BB:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-genDateOffset%22%20value=%22${s.genDateOffset}%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%A4%A9%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%E5%81%8F%E7%A7%BB:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-compDateOffset%22%20value=%22${s.compDateOffset}%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%A4%A9%3C/label%3E%3C/div%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-dateFontSize%22%20value=%22${s.dateFontSize}%22%20min=%226%22%20max=%2216%22%20step=%220.5%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20pt%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E8%A1%8C%E9%AB%98:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-dateLineHeight%22%20value=%22${s.dateLineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%80%8D%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E9%A1%8F%E8%89%B2:%20%3Cinput%20type=%22color%22%20id=%22qt-a17-dateFontColor%22%20value=%22${s.dateFontColor}%22%20style=%22padding:1px;%20height:25px;%20vertical-align:middle;%22%3E%3C/label%3E%3C/div%3E%3C/div%3E%3Cdiv%3E%3Clabel%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E9%A0%90%E8%A6%BD%E6%95%88%E6%9E%9C%20(%E6%AD%A4%E5%8D%80%E5%8F%AF%E8%87%A8%E6%99%82%E7%B7%A8%E8%BC%AF%EF%BC%8C%E5%83%85%E5%BD%B1%E9%9F%BF%E7%95%B6%E6%AC%A1%E8%A4%87%E8%A3%BD)%EF%BC%9A%3C/label%3E%3Cdiv%20id=%22qt-a17-preview%22%20contenteditable=%22true%22%20style=%22border:1px%20solid%20#ccc;%20padding:10px;%20min-height:100px;%20max-height:200px;%20overflow-y:auto;%20font-size:${s.mainFontSize}pt;%20line-height:${s.mainLineHeight};%20color:${s.mainFontColor};%20background:#f9f9f9;%20border-radius:4px;%22%3E%3C/div%3E%3C/div%3E%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-between%22%20style=%22margin-top:20px;%22%3E%3Cbutton%20id=%22qt-a17-text-reset%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E9%87%8D%E8%A8%AD%E9%A0%90%E8%A8%AD%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-a17-text-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-a17-text-save%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E5%84%B2%E5%AD%98%E8%A8%AD%E5%AE%9A%3C/button%3E%3C/div%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_A17TextSettings',contentHtml,'550px','auto');const%20previewEl=overlay.querySelector('#qt-a17-preview');const%20getSettingsFromUI=()=%3E({mainContent:overlay.querySelector('#qt-a17-mainContent').value,mainFontSize:parseFloat(overlay.querySelector('#qt-a17-mainFontSize').value),mainLineHeight:parseFloat(overlay.querySelector('#qt-a17-mainLineHeight').value),mainFontColor:overlay.querySelector('#qt-a17-mainFontColor').value,dateFontSize:parseFloat(overlay.querySelector('#qt-a17-dateFontSize').value),dateLineHeight:parseFloat(overlay.querySelector('#qt-a17-dateLineHeight').value),dateFontColor:overlay.querySelector('#qt-a17-dateFontColor').value,genDateOffset:parseInt(overlay.querySelector('#qt-a17-genDateOffset').value),compDateOffset:parseInt(overlay.querySelector('#qt-a17-compDateOffset').value)});const%20updatePreview=()=%3E{const%20currentUISettings=getSettingsFromUI();const%20today=new%20Date();const%20genDate=new%20Date(today);genDate.setDate(today.getDate()+currentUISettings.genDateOffset);const%20compDate=new%20Date(today);compDate.setDate(today.getDate()+currentUISettings.compDateOffset);const%20genDateStr=formatDate(genDate);const%20compDateStr=formatDate(compDate);let%20previewContent=escapeHtml(currentUISettings.mainContent).replace(/\n/g,'%3Cbr%3E')+%60%3Cbr%3E%3Cbr%3E%3Cspan%20class=%22qt-a17-dynamic-date%22%20style=%22font-size:${currentUISettings.dateFontSize}pt;%20line-height:${currentUISettings.dateLineHeight};%20color:${currentUISettings.dateFontColor};%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}%3Cbr%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}%3C/span%3E%60;previewEl.innerHTML=previewContent;previewEl.style.fontSize=currentUISettings.mainFontSize+'pt';previewEl.style.lineHeight=currentUISettings.mainLineHeight;previewEl.style.color=currentUISettings.mainFontColor};['#qt-a17-mainContent','#qt-a17-mainFontSize','#qt-a17-mainLineHeight','#qt-a17-mainFontColor','#qt-a17-dateFontSize','#qt-a17-dateLineHeight','#qt-a17-dateFontColor','#qt-a17-genDateOffset','#qt-a17-compDateOffset'].forEach(selector=%3E{const%20el=overlay.querySelector(selector);if(el.type==='color')el.onchange=updatePreview;else%20el.oninput=updatePreview});updatePreview();const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-a17-text-save').onclick=()=%3E{const%20newSettings=getSettingsFromUI();if(!newSettings.mainContent.trim()){displaySystemNotification('%E4%B8%BB%E6%96%87%E6%A1%88%E5%85%A7%E5%AE%B9%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA',!0);return}a17ModeState.textSettings=newSettings;localStorage.setItem(A17_TEXT_SETTINGS_STORAGE_KEY,JSON.stringify(newSettings));displaySystemNotification('A17%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%B7%B2%E5%84%B2%E5%AD%98',!1);closeDialog(!0)};overlay.querySelector('#qt-a17-text-cancel').onclick=()=%3EcloseDialog(null);overlay.querySelector('#qt-a17-text-reset').onclick=()=%3E{overlay.querySelector('#qt-a17-mainContent').value=A17_DEFAULT_TEXT_CONTENT;overlay.querySelector('#qt-a17-mainFontSize').value=12;overlay.querySelector('#qt-a17-mainLineHeight').value=1.5;overlay.querySelector('#qt-a17-mainFontColor').value='#333333';overlay.querySelector('#qt-a17-dateFontSize').value=8;overlay.querySelector('#qt-a17-dateLineHeight').value=1.2;overlay.querySelector('#qt-a17-dateFontColor').value='#555555';overlay.querySelector('#qt-a17-genDateOffset').value=-3;overlay.querySelector('#qt-a17-compDateOffset').value=0;updatePreview()}})}async%20function%20performApiQuery(queryValue,apiKey){const%20reqBody={currentPage:1,pageSize:10};reqBody[apiKey]=queryValue;const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody),};if(apiAuthToken)fetchOpts.headers['SSO-TOKEN']=apiAuthToken;let%20retries=1;while(retries%3E=0){try{const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);const%20data=await%20res.json();if(res.status===401){apiAuthToken=null;localStorage.removeItem(TOKEN_STORAGE_KEY);return{error:'token_invalid',data:null}}if(!res.ok){throw%20new%20Error(%60API%E8%AB%8B%E6%B1%82%E9%8C%AF%E8%AA%A4:%20${res.status}%20${res.statusText}%60)}return{error:null,data:data,success:data&&data.records&&data.records.length%3E0}}catch(e){console.error(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E9%8C%AF%E8%AA%A4%20(%E5%98%97%E8%A9%A6%20${2-retries}):%60,e);if(retries%3E0){displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E5%A4%B1%E6%95%97%EF%BC%8C2%E7%A7%92%E5%BE%8C%E9%87%8D%E8%A9%A6...%60,!0,1800);await%20new%20Promise(r=%3EsetTimeout(r,2000));retries--}else{return{error:'network_error',data:null}}}}}function%20renderResultsTableUI(dataToRender){currentTableInstance.mainUIElement?.remove();document.removeEventListener('keydown',mainUIEscListener);const%20mainUI=document.createElement('div');currentTableInstance.mainUIElement=mainUI;mainUI.id=TOOL_MAIN_CONTAINER_ID;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:50%;transform:translate(-50%,-50%);background:#f8f9fa;border-radius:10px;box-shadow:0%208px%2030px%20rgba(0,0,0,0.15);padding:0;width:auto;max-width:850px;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:13px;border:1px%20solid%20#dee2e6;user-select:none;%60;const%20titleBar=document.createElement('div');titleBar.textContent='%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%E6%A1%88%E4%BB%B6%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C';titleBar.style.cssText=%60padding:10px%2015px;margin:-0px%20-0px%2010px%20-0px;background-color:#343a40;color:white;font-weight:bold;font-size:14px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;user-select:none;%60;mainUI.appendChild(titleBar);const%20contentWrapper=document.createElement('div');contentWrapper.style.cssText='padding:15px;%20overflow-y:auto;%20display:flex;%20flex-direction:column;%20flex-grow:1;';mainUI.appendChild(contentWrapper);const%20controlsHeader=document.createElement('div');controlsHeader.style.cssText=%60display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:10px;border-bottom:1px%20solid%20#e0e0e0;flex-wrap:wrap;gap:8px;%60;const%20summarySec=document.createElement('div');summarySec.id=TOOL_MAIN_CONTAINER_ID+'_SummarySection';summarySec.style.cssText='font-size:13px;font-weight:bold;color:#2c3e50;white-space:nowrap;';controlsHeader.appendChild(summarySec);const%20filterInput=document.createElement('input');filterInput.type='text';filterInput.id=TOOL_MAIN_CONTAINER_ID+'_TableFilterInput';filterInput.placeholder='%E7%AF%A9%E9%81%B8%E8%A1%A8%E6%A0%BC%E5%85%A7%E5%AE%B9...';filterInput.className='qt-input';filterInput.style.width='180px';filterInput.style.marginBottom='0';const%20buttonsGroupLeft=document.createElement('div');buttonsGroupLeft.style.cssText='display:flex;gap:6px;align-items:center;';const%20buttonsGroupRight=document.createElement('div');buttonsGroupRight.style.cssText='display:flex;gap:6px;align-items:center;margin-left:auto;';[{id:'ClearConditions',text:'%E6%B8%85%E9%99%A4%E6%A2%9D%E4%BB%B6',cls:'qt-dialog-btn-grey',group:buttonsGroupLeft},{id:'Requery',text:'%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2',cls:'qt-dialog-btn-orange',group:buttonsGroupLeft},{id:'A17',text:'A17%E4%BD%9C%E6%A5%AD',cls:'qt-dialog-btn-purple',group:buttonsGroupLeft},{id:'CopyTable',text:'%E8%A4%87%E8%A3%BD%E8%A1%A8%E6%A0%BC',cls:'qt-dialog-btn-green',group:buttonsGroupLeft},{id:'EditMode',text:'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft},{id:'AddRow',text:'+%20%E6%96%B0%E5%A2%9E%E5%88%97',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft,style:'display:none;'}].forEach(cfg=%3E{const%20btn=document.createElement('button');btn.id=TOOL_MAIN_CONTAINER_ID+'_btn'+cfg.id;btn.textContent=cfg.text;btn.className=%60qt-dialog-btn%20${cfg.cls}%60;if(cfg.style)btn.style.cssText+=cfg.style;cfg.group.appendChild(btn)});const%20closeBtn=document.createElement('button');closeBtn.id=TOOL_MAIN_CONTAINER_ID+'_btnCloseTool';closeBtn.textContent='%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7';closeBtn.className='qt-dialog-btn%20qt-dialog-btn-red';buttonsGroupRight.appendChild(closeBtn);controlsHeader.appendChild(filterInput);controlsHeader.appendChild(buttonsGroupLeft);controlsHeader.appendChild(buttonsGroupRight);contentWrapper.appendChild(controlsHeader);const%20a17UnitBtnsCtr=document.createElement('div');a17UnitBtnsCtr.id=TOOL_MAIN_CONTAINER_ID+'_A17UnitBtns';a17UnitBtnsCtr.style.cssText='margin-bottom:10px;display:none;flex-wrap:wrap;gap:6px;justify-content:flex-start;';contentWrapper.appendChild(a17UnitBtnsCtr);currentTableInstance.a17UnitButtonsContainer=a17UnitBtnsCtr;const%20a17TextControls=document.createElement('div');a17TextControls.id=TOOL_MAIN_CONTAINER_ID+'_A17TextControls';a17TextControls.style.cssText='margin-bottom:10px;display:none;align-items:center;gap:10px;';a17TextControls.innerHTML=%60%3Clabel%20style=%22font-size:12px;color:#333;display:flex;align-items:center;cursor:pointer;%22%3E%3Cinput%20type=%22checkbox%22%20id=%22${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText%22%20checked%20style=%22margin-right:4px;%22%3EA17%E5%90%AB%E9%80%9A%E7%9F%A5%E6%96%87%3C/label%3E%3Cbutton%20id=%22${TOOL_MAIN_CONTAINER_ID}_btnA17EditText%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20style=%22margin-left:0;padding:5px%2010px;font-size:12px;%22%3E%E7%B7%A8%E8%BC%AF%E9%80%9A%E7%9F%A5%E6%96%87%3C/button%3E%60;contentWrapper.appendChild(a17TextControls);const%20tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px%20solid%20#ccc;border-radius:5px;background:white;';const%20tableEl=document.createElement('table');tableEl.id=TOOL_MAIN_CONTAINER_ID+'_ResultsTable';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:12px;';tableScrollWrap.appendChild(tableEl);contentWrapper.appendChild(tableScrollWrap);const%20tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:1;background-color:#343a40;color:white;';tableEl.appendChild(tHREl);currentTableInstance.tableHeadElement=tHREl;const%20tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);currentTableInstance.tableBodyElement=tBREl;document.body.appendChild(mainUI);titleBar.onmousedown=(e)=%3E{if(e.target!==titleBar)return;e.preventDefault();dragState.dragging=!0;dragState.startX=e.clientX;dragState.startY=e.clientY;dragState.initialX=mainUI.offsetLeft;dragState.initialY=mainUI.offsetTop;titleBar.style.cursor='grabbing';mainUI.style.transform='none'};document.onmousemove=(e)=%3E{if(dragState.dragging){const%20dx=e.clientX-dragState.startX;const%20dy=e.clientY-dragState.startY;mainUI.style.left=(dragState.initialX+dx)+'px';mainUI.style.top=(dragState.initialY+dy)+'px'}};document.onmouseup=()=%3E{if(dragState.dragging){dragState.dragging=!1;titleBar.style.cursor='grab'}};filterInput.oninput=()=%3EapplyTableFilter();mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnClearConditions%60).onclick=handleClearConditions;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnRequery%60).onclick=()=%3E{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener);executeCaseQueryTool()};const%20a17Btn=mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17%60);a17Btn.onmousedown=(e)=%3E{if(e.button!==0)return;a17ButtonLongPressTimer=setTimeout(()=%3E{a17ButtonLongPressTimer=null;toggleA17Mode(!0)},700)};a17Btn.onmouseup=()=%3E{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null;toggleA17Mode(!1)}};a17Btn.onmouseleave=()=%3E{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null}};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnCopyTable%60).onclick=handleCopyTable;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60).onclick=toggleEditMode;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60).onclick=handleAddRowToTable;closeBtn.onclick=()=%3E{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener)};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17EditText%60).onclick=async()=%3E{await%20createA17TextSettingDialog()};document.addEventListener('keydown',mainUIEscListener);updateSummaryCount(dataToRender.length);if(currentTableInstance.isA17Mode){renderA17ModeUI();populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{renderNormalModeUI();populateTableRows(dataToRender)}}const%20mainUIEscListener=(e)=%3E{if(e.key==='Escape'&&currentTableInstance.mainUIElement&&!document.querySelector(%60[id^=%22${TOOL_MAIN_CONTAINER_ID}_%22][id$=%22_overlay%22]%60)){currentTableInstance.mainUIElement.remove();document.removeEventListener('keydown',mainUIEscListener)}};function%20updateSummaryCount(visibleRowCount){const%20summaryEl=currentTableInstance.mainUIElement?.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_SummarySection%60);if(!summaryEl)return;let%20baseDataCount=currentTableInstance.isA17Mode?baseA17MasterData.length:originalQueryResults.length;let%20text=%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%EF%BC%9A%3Cstrong%3E${baseDataCount}%3C/strong%3E%E7%AD%86%60;const%20filterInput=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60);const%20isFiltered=(filterInput&&filterInput.value.trim()!=='')||(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size%3E0);if(isFiltered&&visibleRowCount!==baseDataCount){text+=%60%20(%E7%AF%A9%E9%81%B8%E5%BE%8C%E9%A1%AF%E7%A4%BA%20%3Cstrong%3E${visibleRowCount}%3C/strong%3E%20%E7%AD%86)%60}summaryEl.innerHTML=text}function%20renderTableHeaders(headers){currentTableInstance.tableHeadElement.innerHTML='';const%20hr=document.createElement('tr');headers.forEach((hTxt,idx)=%3E{const%20th=document.createElement('th');th.textContent=escapeHtml(hTxt);th.style.cssText=%60padding:%208px%206px;%20text-align:center;%20white-space:nowrap;%20cursor:pointer;%20user-select:none;%20font-weight:600;%20font-size:12px;%20border-right:%201px%20solid%20#4a6075;%60;if(idx===headers.length-1)th.style.borderRight='none';if(idx===0&&!currentTableInstance.isA17Mode)th.style.backgroundColor='#007bff';th.onclick=()=%3EsortTableByColumn(hTxt);hr.appendChild(th)});if(isEditMode){const%20thAction=document.createElement('th');thAction.textContent=%22%E6%93%8D%E4%BD%9C%22;thAction.style.cssText=%60padding:%208px%206px;%20text-align:center;%20white-space:nowrap;%20font-weight:600;%20font-size:12px;%60;hr.appendChild(thAction)}currentTableInstance.tableHeadElement.appendChild(hr);currentTableInstance.currentHeaders=headers}function%20populateTableRows(data){currentTableInstance.tableBodyElement.innerHTML='';data.forEach((row,rowIndex)=%3E{const%20tr=document.createElement('tr');tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff';tr.onmouseover=()=%3E{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor='#e9ecef'};tr.onmouseout=()=%3E{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff'};currentTableInstance.currentHeaders.forEach((headerKey,colIndex)=%3E{const%20td=document.createElement('td');td.style.cssText='padding:6px;%20border-bottom:1px%20solid%20#dee2e6;%20font-size:12px;%20text-align:center;%20border-right:1px%20solid%20#dee2e6;';if(colIndex===currentTableInstance.currentHeaders.length-1)td.style.borderRight='none';let%20cellValue=row[headerKey]===null||row[headerKey]===undefined?'':String(row[headerKey]);if(headerKey===FIELD_DISPLAY_NAMES_MAP.statusCombined&&typeof%20cellValue==='string'&&cellValue.includes('%3Cspan')){td.innerHTML=cellValue}else{td.textContent=cellValue}if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){td.style.backgroundColor='#e6f7ff';td.style.fontWeight='500'}if(isEditMode&&((colIndex%3E1&&!row._isNewRow)||(row._isNewRow&&headerKey!==%22%E6%93%8D%E4%BD%9C%22))&&headerKey!==FIELD_DISPLAY_NAMES_MAP._apiQueryStatus){td.onclick=(e)=%3E{if(e.target.tagName!=='INPUT'&&e.target.tagName!=='SELECT')startCellEdit(td,row,headerKey,rowIndex);}}else%20if(!isEditMode){td.onclick=()=%3E{navigator.clipboard.writeText(td.textContent||td.innerText).then(()=%3EdisplaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD:%20${td.textContent%20||%20td.innerText}%60,!1,1000)).catch(err=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))}}tr.appendChild(td)});if(isEditMode){const%20tdAction=document.createElement('td');tdAction.style.cssText='padding:6px;%20border-bottom:1px%20solid%20#dee2e6;%20text-align:center;';const%20deleteBtn=document.createElement('button');deleteBtn.innerHTML='&#x1F5D1;';deleteBtn.className='qt-dialog-btn%20qt-dialog-btn-red';deleteBtn.style.padding='3px%206px';deleteBtn.style.fontSize='10px';deleteBtn.onclick=()=%3EhandleDeleteRow(rowIndex);tdAction.appendChild(deleteBtn);tr.appendChild(tdAction)}currentTableInstance.tableBodyElement.appendChild(tr)});updateSummaryCount(data.length)}function%20sortTableByColumn(headerKeyToSortBy){const%20currentData=currentTableInstance.isA17Mode?[...baseA17MasterData]:[...originalQueryResults];if(currentData.length===0)return;const%20direction=(currentTableInstance.sortDirections[headerKeyToSortBy]||'desc')==='asc'?'desc':'asc';currentTableInstance.sortDirections={};currentTableInstance.sortDirections[headerKeyToSortBy]=direction;currentData.sort((a,b)=%3E{let%20valA=a[headerKeyToSortBy]===null||a[headerKeyToSortBy]===undefined?'':String(a[headerKeyToSortBy]);let%20valB=b[headerKeyToSortBy]===null||b[headerKeyToSortBy]===undefined?'':String(b[headerKeyToSortBy]);const%20isNumeric=headerKeyToSortBy===FIELD_DISPLAY_NAMES_MAP.NO||(!isNaN(parseFloat(valA))&&isFinite(valA)&&!isNaN(parseFloat(valB))&&isFinite(valB)&&valA.trim()!==''&&valB.trim()!=='');let%20comparison=0;if(isNumeric){comparison=parseFloat(valA)-parseFloat(valB)}else{comparison=valA.localeCompare(valB,'zh-Hant-TW')}return%20direction==='asc'?comparison:-comparison});if(currentTableInstance.isA17Mode)baseA17MasterData=currentData;else%20originalQueryResults=currentData;populateTableRows(currentData);displaySystemNotification(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerKeyToSortBy}%E3%80%8D${direction%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1);currentTableInstance.tableHeadElement.querySelectorAll('th').forEach(th=%3E{const%20currentHeaderText=th.textContent.replace(/[\u25B2\u25BC\s]*$/,'').trim();th.innerHTML=escapeHtml(currentHeaderText);if(currentHeaderText===headerKeyToSortBy){th.innerHTML+=(direction==='asc'?'%20%3Cspan%20style=%22font-size:10px;%22%3E\u25B2%3C/span%3E':'%20%3Cspan%20style=%22font-size:10px;%22%3E\u25BC%3C/span%3E')}})}function%20applyTableFilter(){const%20filterText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value.trim().toLowerCase();const%20baseData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;let%20filteredData=baseData;if(filterText){filteredData=baseData.filter(row=%3EcurrentTableInstance.currentHeaders.some(headerKey=%3E(String(row[headerKey]||'').toLowerCase().includes(filterText))))}if(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size%3E0){let%20unitFilteredData=[];a17ModeState.selectedUnits.forEach(unitId=%3E{unitFilteredData=unitFilteredData.concat(filteredData.filter(row=%3E{const%20unitVal=String(row[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');if(unitId==='UNDEF'){const%20knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=%3Eb.id!=='UNDEF').map(b=%3Eb.id.toUpperCase());return%20unitVal.trim()===''||!knownPrefixes.some(prefix=%3EunitVal.toUpperCase().startsWith(prefix))}return%20unitVal.toUpperCase().startsWith(unitId.toUpperCase())}))});filteredData=Array.from(new%20Set(unitFilteredData.map(JSON.stringify))).map(JSON.parse)}populateTableRows(filteredData)}function%20handleClearConditions(){currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value='';currentTableInstance.sortDirections={};if(currentTableInstance.isA17Mode){a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button.highlighted').forEach(btn=%3E{btn.classList.remove('highlighted');btn.style.boxShadow='none'});csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};baseA17MasterData=[...originalQueryResults];baseA17MasterData.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{originalQueryResults.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(originalQueryResults)}renderTableHeaders(currentTableInstance.currentHeaders);displaySystemNotification('%E6%89%80%E6%9C%89%E6%A2%9D%E4%BB%B6%E5%B7%B2%E6%B8%85%E9%99%A4%EF%BC%8C%E8%A1%A8%E6%A0%BC%E5%B7%B2%E9%87%8D%E7%BD%AE%E7%82%BA%E6%8C%89%E5%BA%8F%E8%99%9F%E6%8E%92%E5%BA%8F',!1)}function%20toggleEditMode(){isEditMode=!isEditMode;const%20editBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60);const%20addRowBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60);editBtn.textContent=isEditMode?'%E5%AE%8C%E6%88%90%E7%B7%A8%E8%BC%AF':'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editBtn.className=%60qt-dialog-btn%20${isEditMode%20?%20'qt-dialog-btn-red'%20:%20'qt-dialog-btn-blue'}%60;addRowBtn.style.display=isEditMode?'inline-block':'none';const%20currentData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;renderTableHeaders(currentTableInstance.currentHeaders);populateTableRows(currentData);displaySystemNotification(isEditMode?'%E5%B7%B2%E9%80%B2%E5%85%A5%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F':'%E5%B7%B2%E9%80%80%E5%87%BA%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',!1)}function%20startCellEdit(td,rowData,headerKey,rowIndex){if(td.querySelector('input,%20select'))return;td.classList.add('qt-editing-cell');const%20originalText=td.textContent;td.innerHTML='';let%20inputElement;if(isEditMode&&currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){inputElement=document.createElement('select');inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px%20solid%20#007bff;margin:0;background:transparent;';const%20defaultOption=document.createElement('option');defaultOption.value=%22%22;defaultOption.textContent=%22--%E9%81%B8%E6%93%87%E5%88%86%E5%85%AC%E5%8F%B8--%22;inputElement.appendChild(defaultOption);A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{if(unitDef.id==='UNDEF')return;const%20option=document.createElement('option');option.value=unitDef.id;option.textContent=unitDef.label;const%20currentUnitPrefix=String(rowData[headerKey]||'').split('-')[0].toUpperCase();if(unitDef.id===currentUnitPrefix)option.selected=!0;inputElement.appendChild(option)});inputElement.onchange=()=%3EfinishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'select')}else{inputElement=document.createElement('input');inputElement.type='text';inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px%20solid%20#007bff;margin:0;';inputElement.value=originalText;inputElement.onkeydown=(e)=%3E{if(e.key==='Enter'){e.preventDefault();finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'input')}else%20if(e.key==='Escape'){td.textContent=originalText;td.classList.remove('qt-editing-cell')}}}inputElement.onblur=()=%3E{setTimeout(()=%3E{if(td.contains(inputElement))finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputElement.tagName.toLowerCase());},100)};td.appendChild(inputElement);inputElement.focus();if(inputElement.select)inputElement.select();}function%20finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputType='input'){const%20newValue=inputElement.value.trim();td.classList.remove('qt-editing-cell');const%20displayValue=(inputType==='select'&&newValue)?A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===newValue)?.label||newValue:newValue;td.textContent=displayValue;if(newValue!==originalText||(inputType==='select'&&(rowData[headerKey]||'').split('-')[0]!==newValue)){rowData[headerKey]=displayValue;displaySystemNotification(%60%E3%80%8C${headerKey}%E3%80%8D%E5%B7%B2%E6%9B%B4%E6%96%B0%60,!1,1500);td.style.backgroundColor='#d4edda';if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0)applyTableFilter();}}else{td.textContent=originalText}}function%20handleAddRowToTable(){if(!isEditMode){displaySystemNotification('%E8%AB%8B%E5%85%88%E9%80%B2%E5%85%A5%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',!0);return}const%20newRow={_isNewRow:!0};let%20maxNo=0;const%20targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;targetDataset.forEach(row=%3E{const%20currentNo=parseInt(row[FIELD_DISPLAY_NAMES_MAP.NO]);if(!isNaN(currentNo)&&currentNo%3EmaxNo)maxNo=currentNo});newRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(maxNo+1);currentTableInstance.currentHeaders.forEach(header=%3E{if(header!==FIELD_DISPLAY_NAMES_MAP.NO&&header!==%22%E6%93%8D%E4%BD%9C%22)newRow[header]=''});if(currentTableInstance.isA17Mode){baseA17MasterData.push(newRow);populateTableRows(baseA17MasterData)}else{originalQueryResults.push(newRow);populateTableRows(originalQueryResults)}displaySystemNotification('%E5%B7%B2%E6%96%B0%E5%A2%9E%E4%B8%80%E5%88%97%EF%BC%8C%E8%AB%8B%E7%B7%A8%E8%BC%AF%E5%85%A7%E5%AE%B9',!1);const%20tableWrapper=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableScrollWrapper%60);if(tableWrapper)tableWrapper.scrollTop=tableWrapper.scrollHeight}function%20handleDeleteRow(rowIndex){if(!isEditMode)return;const%20targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;if(rowIndex%3E=0&&rowIndex%3CtargetDataset.length){targetDataset.splice(rowIndex,1);populateTableRows(targetDataset);displaySystemNotification('%E5%B7%B2%E5%88%AA%E9%99%A4%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99',!1);if(currentTableInstance.isA17Mode)updateA17UnitButtonCounts();}}function%20loadA17TextSettings(){const%20saved=localStorage.getItem(A17_TEXT_SETTINGS_STORAGE_KEY);if(saved){try{const%20parsed=JSON.parse(saved);for(const%20key%20in%20a17ModeState.textSettings){if(parsed.hasOwnProperty(key))a17ModeState.textSettings[key]=parsed[key]}}catch(e){console.error(%22%E8%BC%89%E5%85%A5A17%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%A4%B1%E6%95%97:%22,e)}}}function%20toggleA17Mode(forceEnter=!1){const%20a17TextControls=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_A17TextControls%60);if(currentTableInstance.isA17Mode){currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.style.display='none';a17TextControls.style.display='none';renderNormalModeUI();populateTableRows(originalQueryResults);displaySystemNotification('%E5%B7%B2%E9%80%80%E5%87%BAA17%E4%BD%9C%E6%A5%AD%E6%A8%A1%E5%BC%8F',!1)}else{if(!forceEnter&&!csvImportState.isA17CsvPrepared){displaySystemNotification('%E8%AB%8B%E5%85%88%E9%80%8F%E9%81%8E%E3%80%8C%E5%8C%AF%E5%85%A5CSV/TXT%E3%80%8D%E6%8C%89%E9%88%95%E9%81%B8%E6%93%87%E3%80%8C%E5%8B%BE%E9%81%B8CSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%E3%80%8D%E4%B8%A6%E5%AE%8C%E6%88%90%E8%A8%AD%E5%AE%9A%E3%80%82%E6%88%96%E9%95%B7%E6%8C%89%E3%80%8CA17%E4%BD%9C%E6%A5%AD%E3%80%8D%E6%8C%89%E9%88%95%E5%BC%B7%E5%88%B6%E9%80%B2%E5%85%A5%E3%80%82',!0,6000);return}currentTableInstance.isA17Mode=!0;a17ModeState.isActive=!0;currentTableInstance.a17UnitButtonsContainer.style.display='flex';a17TextControls.style.display='flex';if(forceEnter&&!csvImportState.isA17CsvPrepared){baseA17MasterData=originalQueryResults.map(row=%3E{const%20newRow={};newRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]=row[FIELD_DISPLAY_NAMES_MAP._queriedValue_];newRow[FIELD_DISPLAY_NAMES_MAP.NO]=row[FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(row.hasOwnProperty(displayName))newRow[displayName]=row[displayName]});newRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=row[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus];return%20newRow})}else{baseA17MasterData=[];const%20keyCsvHeader=csvImportState.rawHeaders.find(h=%3Eh.includes('%E9%80%81%E9%87%91%E5%96%AE'));const%20keyCsvIndex=keyCsvHeader?csvImportState.rawHeaders.indexOf(keyCsvHeader):(csvImportState.rawHeaders.length%3E0?0:-1);csvImportState.rawData.forEach((csvRowData,index)=%3E{let%20mergedRow={};mergedRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(index+1);csvImportState.selectedColsForA17Merge.forEach(selectedCsvHeader=%3E{const%20originalCsvIndex=csvImportState.rawHeaders.indexOf(selectedCsvHeader);if(originalCsvIndex!==-1)mergedRow[selectedCsvHeader]=csvRowData[originalCsvIndex]});const%20csvKeyValue=(keyCsvIndex!==-1)?csvRowData[keyCsvIndex]:null;let%20apiFound=!1;if(csvKeyValue){const%20matchingApiRow=originalQueryResults.find(apiRow=%3E(apiRow[FIELD_DISPLAY_NAMES_MAP.receiptNumber]===csvKeyValue||apiRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]===csvKeyValue));if(matchingApiRow){apiFound=!0;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName)&&matchingApiRow.hasOwnProperty(displayName)){mergedRow[displayName]=matchingApiRow[displayName]}});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=matchingApiRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]||'%E2%9C%94%EF%B8%8F%20%E6%88%90%E5%8A%9F'}}if(!apiFound){ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName))mergedRow[displayName]='-'});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]='%E2%9E%96%20%E7%84%A1%E5%B0%8D%E6%87%89API%E8%B3%87%E6%96%99'}baseA17MasterData.push(mergedRow)})}renderA17ModeUI();populateTableRows(baseA17MasterData);createA17UnitButtons();updateA17UnitButtonCounts();displaySystemNotification('%E5%B7%B2%E9%80%B2%E5%85%A5A17%E4%BD%9C%E6%A5%AD%E6%A8%A1%E5%BC%8F',!1)}}function%20renderNormalModeUI(){let%20headers=[FIELD_DISPLAY_NAMES_MAP._queriedValue_,FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function%20renderA17ModeUI(){let%20headers=[];if(csvImportState.isA17CsvPrepared&&csvImportState.selectedColsForA17Merge.length%3E0){csvImportState.selectedColsForA17Merge.forEach(csvHeader=%3E{if(!headers.includes(csvHeader))headers.push(csvHeader);});ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!headers.includes(displayName))headers.push(displayName);})}else{headers.push(FIELD_DISPLAY_NAMES_MAP._queriedValue_);headers.push(FIELD_DISPLAY_NAMES_MAP.NO);ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)})}if(!headers.includes(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus))headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function%20createA17UnitButtons(){currentTableInstance.a17UnitButtonsContainer.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{const%20btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.textContent=%60${unitDef.label}%20(0)%60;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:6px%208px;border-radius:4px;cursor:pointer;font-size:11px;transition:all%200.2s%20ease;flex-grow:1;min-width:80px;text-align:center;%60;btn.onclick=()=%3E{if(btn.classList.contains('disabled'))return;const%20unitId=btn.dataset.unitId;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow=%600%200%200%202px%20white,%200%200%200%204px%20${btn.style.backgroundColor}%60}applyTableFilter();displaySystemNotification(%60%E5%B7%B2%E9%81%B8%E6%93%87%20${a17ModeState.selectedUnits.size}%20%E5%80%8B%E5%96%AE%E4%BD%8D%60,!1,1500)};currentTableInstance.a17UnitButtonsContainer.appendChild(btn)})}function%20updateA17UnitButtonCounts(){if(!currentTableInstance.isA17Mode)return;const%20unitCounts={};const%20dataToCount=baseA17MasterData;dataToCount.forEach(row=%3E{const%20unitFull=String(row[FIELD_DISPLAY_NAMES_MAP.uwApproverUnit]||'');let%20unitPrefix='UNDEF';for(const%20code%20in%20UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()==='')unitPrefix='UNDEF';unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button').forEach(btn=%3E{const%20unitId=btn.dataset.unitId;const%20count=unitCounts[unitId]||0;const%20unitDef=A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label}%20(${count})%60;if(count===0){btn.classList.add('disabled');btn.disabled=!0;btn.style.opacity='0.6';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.classList.remove('disabled');btn.disabled=!1;btn.style.opacity='1'}}})}function%20handleCopyTable(){const%20dataToCopy=[];const%20rows=currentTableInstance.tableBodyElement.querySelectorAll('tr');rows.forEach(tr=%3E{const%20rowData={};tr.querySelectorAll('td').forEach((td,colIndex)=%3E{if(isEditMode&&colIndex===currentTableInstance.currentHeaders.length)return;const%20headerKey=currentTableInstance.currentHeaders[colIndex];rowData[headerKey]=td.textContent||td.innerText});if(Object.keys(rowData).length%3E0)dataToCopy.push(rowData);});if(dataToCopy.length===0){displaySystemNotification('%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD',!0);return}if(currentTableInstance.isA17Mode){const%20includeText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText%60).checked;const%20previewDialog=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_A17TextSettings_overlay');let%20customContentFromPreview=null;if(previewDialog&&previewDialog.style.display==='flex'){const%20previewEl=previewDialog.querySelector('#qt-a17-preview');if(previewEl)customContentFromPreview=previewEl.innerHTML}generateAndCopyA17NotificationHTML(dataToCopy,currentTableInstance.currentHeaders,includeText,customContentFromPreview)}else{let%20tsvContent=currentTableInstance.currentHeaders.join('\t')+'\n';dataToCopy.forEach(row=%3E{const%20rowValues=currentTableInstance.currentHeaders.map(header=%3EString(row[header]||'').replace(/\t/g,'%20').replace(/\n/g,'%20'));tsvContent+=rowValues.join('\t')+'\n'});navigator.clipboard.writeText(tsvContent).then(()=%3EdisplaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD%20${dataToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99%20(TSV%E6%A0%BC%E5%BC%8F)%60,!1)).catch(err=%3E{console.error('TSV%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97:',err);displaySystemNotification('%E8%A4%87%E8%A3%BDTSV%E5%A4%B1%E6%95%97',!0)})}}function%20generateAndCopyA17NotificationHTML(data,headers,includeText,customPreviewContent=null){const%20s=a17ModeState.textSettings;const%20today=new%20Date();const%20genDate=new%20Date(today);genDate.setDate(today.getDate()+s.genDateOffset);const%20compDate=new%20Date(today);compDate.setDate(today.getDate()+s.compDateOffset);const%20genDateStr=formatDate(genDate);const%20compDateStr=formatDate(compDate);let%20textContentHtml='';if(includeText){if(customPreviewContent){textContentHtml=customPreviewContent}else{textContentHtml=%60%3Cdiv%20style=%22font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${s.mainFontSize}pt;line-height:${s.mainLineHeight};color:${s.mainFontColor};%22%3E%60+escapeHtml(s.mainContent).replace(/\n/g,'%3Cbr%3E')+%60%3Cbr%3E%3Cbr%3E%3Cp%20style=%22font-size:${s.dateFontSize}pt;line-height:${s.dateLineHeight};color:${s.dateFontColor};margin-top:${s.dateLineHeight%20%3E%201.2%20?%20'10px':'5px'};margin-bottom:${s.dateLineHeight%20%3E%201.2%20?%20'10px':'5px'};%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}%3Cbr%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}%3C/p%3E%3C/div%3E%60}}const%20tableRowsHtml=data.map((row,idx)=%3E%60%3Ctr%20style=%22background-color:${idx%20%%202%20?%20'#f8f9fa':'#ffffff'};%22%3E${headers.map(header%20=%3E%20%60%3Ctd%20style=%22border:1px%20solid%20#dddddd;padding:5px%207px;text-align:center;font-size:10pt;color:#333333;white-space:normal;word-break:break-all;%22%3E${escapeHtml(row[header]||'')}%3C/td%3E%60).join('')}%3C/tr%3E%60).join('');const%20tableHtml=%60%3Ctable%20style=%22border-collapse:collapse;width:100%;margin-top:10px;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:10pt;%22%3E%3Cthead%3E%3Ctr%20style=%22background-color:#343a40;color:white;font-weight:bold;%22%3E${headers.map(header%20=%3E%20%60%3Cth%20style=%22border:1px%20solid%20#23272b;padding:6px%208px;text-align:center;%22%3E${escapeHtml(header)}%3C/th%3E%60).join('')}%3C/tr%3E%3C/thead%3E%3Ctbody%3E${tableRowsHtml}%3C/tbody%3E%3C/table%3E%60;const%20finalHtml=textContentHtml+tableHtml;try{const%20blobHtml=new%20Blob([finalHtml],{type:'text/html'});const%20plainTextForClipboard=(includeText?(customPreviewContent?new%20DOMParser().parseFromString(customPreviewContent,%22text/html%22).body.textContent:s.mainContent)+%60\n\n%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}\n%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');const%20blobText=new%20Blob([plainTextForClipboard],{type:'text/plain'});navigator.clipboard.write([new%20ClipboardItem({'text/html':blobHtml,'text/plain':blobText})]).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(HTML%E6%A0%BC%E5%BC%8F)',!1)).catch(err=%3E{console.error('HTML%20Clipboard%20API%20%E5%A4%B1%E6%95%97:',err);navigator.clipboard.writeText(plainTextForClipboard).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(%E7%B4%94%E6%96%87%E5%AD%97)',!1)).catch(txtErr=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))})}catch(e){console.error('ClipboardItem%20API%20%E4%B8%8D%E5%8F%AF%E7%94%A8:',e);const%20plainFallback=(includeText?(customPreviewContent?new%20DOMParser().parseFromString(customPreviewContent,%22text/html%22).body.textContent:s.mainContent)+%60\n\n%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}\n%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');navigator.clipboard.writeText(plainFallback).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(%E7%B4%94%E6%96%87%E5%AD%97)',!1)).catch(txtErr=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))}}async%20function%20executeCaseQueryTool(){if(document.getElementById(TOOL_MAIN_CONTAINER_ID)){displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',!0);return}const%20selectedEnv=await%20createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv%20===%20'prod'%20?%20'%E6%AD%A3%E5%BC%8F'%20:%20'%E6%B8%AC%E8%A9%A6'}%60,!1);let%20tokenIsValid=!1;if(apiAuthToken)tokenIsValid=!0;if(!tokenIsValid){let%20tokenAttempt=1;while(!0){const%20tokenResult=await%20createTokenDialog(tokenAttempt);if(tokenResult==='_close_tool_'){displaySystemNotification('%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%97%9C%E9%96%89',!1);return}if(tokenResult==='_skip_token_'){apiAuthToken=null;displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8EToken%E8%BC%B8%E5%85%A5',!1);break}if(tokenResult==='_token_dialog_cancel_'){displaySystemNotification('Token%E8%BC%B8%E5%85%A5%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}if(tokenResult&&tokenResult.trim()!==''){apiAuthToken=tokenResult.trim();localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);displaySystemNotification('Token%E5%B7%B2%E8%A8%AD%E5%AE%9A',!1);break}else{if(tokenAttempt%3E=2){}else{displaySystemNotification('Token%E6%9C%AA%E8%BC%B8%E5%85%A5',!0)}}tokenAttempt++;if(tokenAttempt%3E2&&(!tokenResult||tokenResult.trim()===''))break}}const%20querySetupResult=await%20createQuerySetupDialog();if(!querySetupResult){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupResult.selectedApiKey);const%20queryValues=querySetupResult.queryValues.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC',!0);return}const%20loadingDialog=createDialogBase('_Loading',%60%3Ch3%20class=%22qt-dialog-title%22%20id=%22${TOOL_MAIN_CONTAINER_ID}_LoadingTitle%22%3E%E6%9F%A5%E8%A9%A2%E4%B8%AD...%3C/h3%3E%3Cp%20id=%22${TOOL_MAIN_CONTAINER_ID}_LoadingMsg%22%20style=%22text-align:center;font-size:13px;color:#555;%22%3E%E8%99%95%E7%90%86%E4%B8%AD...%3C/p%3E%3Cdiv%20style=%22width:40px;height:40px;border:4px%20solid%20#f3f3f3;border-top:4px%20solid%20#3498db;border-radius:50%;margin:15px%20auto;animation:qtSpin%201s%20linear%20infinite;%22%3E%3C/div%3E%60,'300px','auto','text-align:center;');const%20loadingTitleEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingTitle%60);const%20loadingMsgEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingMsg%60);originalQueryResults=[];let%20currentQueryCount=0;for(const%20singleQueryValue%20of%20queryValues){currentQueryCount++;if(loadingTitleEl)loadingTitleEl.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD%20(${currentQueryCount}/${queryValues.length})%60;if(loadingMsgEl)loadingMsgEl.textContent=%60%E6%AD%A3%E5%9C%A8%E8%99%95%E7%90%86:%20${singleQueryValue}%60;const%20resultRowBase={[FIELD_DISPLAY_NAMES_MAP.NO]:String(currentQueryCount),[FIELD_DISPLAY_NAMES_MAP._queriedValue_]:singleQueryValue};const%20apiResult=await%20performApiQuery(singleQueryValue,selectedQueryDefinitionGlobal.queryApiKey);let%20apiQueryStatusText='%E2%9D%8C%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';if(apiResult.error==='token_invalid'){apiQueryStatusText='%E2%9D%8C%20TOKEN%E5%A4%B1%E6%95%88';loadingDialog.overlay.remove();displaySystemNotification('Token%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%A8%AD%E5%AE%9AToken%E5%BE%8C%E5%86%8D%E6%AC%A1%E6%9F%A5%E8%A9%A2%E3%80%82',!0,5000);apiAuthToken=null;return}else%20if(apiResult.success){apiQueryStatusText='%E2%9C%94%EF%B8%8F%20%E6%88%90%E5%8A%9F'}else%20if(!apiResult.error){apiQueryStatusText='%E2%9E%96%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99'}resultRowBase[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=apiQueryStatusText;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=%3E{const%20populatedRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let%20cellValue=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){const%20mainS=rec.mainStatus||'';const%20subS=rec.subStatus||'';populatedRow[displayName]=%60%3Cspan%20style=%22font-weight:bold;%22%3E${escapeHtml(mainS)}%3C/span%3E%60+(subS?%60%20%3Cspan%20style=%22color:#777;%22%3E(${escapeHtml(subS)})%3C/span%3E%60:'')}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){const%20unitCodePrefix=getFirstLetter(cellValue);const%20mappedUnitName=UNIT_CODE_MAPPINGS[unitCodePrefix]||cellValue;populatedRow[displayName]=unitCodePrefix&&UNIT_CODE_MAPPINGS[unitCodePrefix]?%60${unitCodePrefix}-${mappedUnitName.replace(/^[A-Z]-/,'')}%60:mappedUnitName}else%20if(dKey==='uwApprover'||dKey==='approvalUser'){populatedRow[displayName]=extractName(cellValue)}else{populatedRow[displayName]=cellValue}});originalQueryResults.push(populatedRow)})}else{ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{resultRowBase[FIELD_DISPLAY_NAMES_MAP[dKey]||dKey]='-'});originalQueryResults.push(resultRowBase)}}loadingDialog.overlay.remove();if(originalQueryResults.length%3E0)originalQueryResults.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;isEditMode=!1;renderResultsTableUI(originalQueryResults);displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%E8%99%95%E7%90%86%20${queryValues.length}%20%E5%80%8B%E6%9F%A5%E8%A9%A2%E5%80%BC%EF%BC%8C%E7%8D%B2%E5%8F%96%20${originalQueryResults.length}%20%E7%AD%86%E8%B3%87%E6%96%99%60,!1,3500)}(function(){document.getElementById(TOOL_MAIN_CONTAINER_ID)?.remove();['EnvSelect','Token','QuerySetup','A17TextSettings','Loading','CSVPurpose','CSVColSelect','CSVCheckbox'].forEach(suffix=%3E{const%20el=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_'+suffix+'_overlay');if(el)el.remove();});document.getElementById(TOOL_MAIN_CONTAINER_ID+'_Notification')?.remove();loadA17TextSettings();executeCaseQueryTool()})()})()

javascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const TOKEN_STORAGE_KEY='euisToken';const A17_TEXT_SETTINGS_STORAGE_KEY='kgilifeQueryTool_A17TextSettings_v3';const TOOL_MAIN_CONTAINER_ID='kgilifeQueryToolMainContainer_vFinal';const Z_INDEX_OVERLAY=2147483640;const Z_INDEX_MAIN_UI=2147483630;const Z_INDEX_NOTIFICATION=2147483647;const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}];const%20FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',mainStatus:'%E4%B8%BB%E7%8B%80%E6%85%8B',subStatus:'%E6%AC%A1%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8',_queriedValue_:'%E6%9F%A5%E8%A9%A2%E5%80%BC',NO:'%E5%BA%8F%E8%99%9F',_apiQueryStatus:'%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C'};const%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];const%20UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'};const%20A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1%E5%96%AE%E4%BD%8D',color:'#546e7a'}];const%20UNIT_MAP_FIELD_API_KEY='uwApproverUnit';const%20A17_DEFAULT_TEXT_CONTENT=%22DEAR,\n\n%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9AA17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E4%BB%A5%E5%8F%8A%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82\n\n%E6%9C%AC%E9%80%B1%E6%88%91%E5%80%91%E5%B7%B2%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E8%A9%B2%E7%AD%89%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%EF%BC%8C%E7%B5%90%E6%9E%9C%E9%A1%AF%E7%A4%BA%EF%BC%8C%E9%80%99%E4%BA%9B%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%E3%80%82%E7%82%BA%E5%88%A9%E5%BE%8C%E7%BA%8C%E5%B8%B3%E5%8B%99%E8%99%95%E7%90%86%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%AF%A6%E9%9A%9B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E4%B8%A6%E5%A6%82%E6%9C%89%E9%9C%80%E8%AA%BF%E6%95%B4%E6%88%96%E8%99%95%E7%90%86%E4%BA%8B%E9%A0%85%EF%BC%8C%E8%AB%8B%E4%B8%80%E4%BD%B5%E5%8D%94%E5%8A%A9%E8%BE%A6%E7%90%86%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;let%20CURRENT_API_URL='';let%20apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);let%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS[0];let%20originalQueryResults=[];let%20baseA17MasterData=[];let%20currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:!1,mainUIElement:null,tableBodyElement:null,tableHeadElement:null,a17UnitButtonsContainer:null,};let%20a17ModeState={isActive:!1,selectedUnits:new%20Set(),textSettings:{mainContent:A17_DEFAULT_TEXT_CONTENT,mainFontSize:12,mainLineHeight:1.5,mainFontColor:'#333333',dateFontSize:8,dateLineHeight:1.2,dateFontColor:'#555555',genDateOffset:-3,compDateOffset:0,},};let%20csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1,};let%20isEditMode=!1;let%20dragState={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};let%20a17ButtonLongPressTimer=null;function%20escapeHtml(unsafe){if(typeof%20unsafe!=='string')return%20unsafe===null||unsafe===undefined?'':String(unsafe);return%20unsafe.replace(/[&%3C%3E%22']/g,m=%3E({'&':'&amp;','%3C':'&lt;','%3E':'&gt;','%22':'&quot;',%22'%22:'&#039;'})[m])}function%20displaySystemNotification(message,isError=!1,duration=3000){const%20id=TOOL_MAIN_CONTAINER_ID+'_Notification';document.getElementById(id)?.remove();const%20n=document.createElement('div');n.id=id;n.style.cssText=%60position:fixed;top:20px;right:20px;background-color:${isError%20?%20'#dc3545'%20:%20'#28a745'};color:white;padding:10px%2015px;border-radius:5px;z-index:${Z_INDEX_NOTIFICATION};font-size:14px;font-family:'Microsoft%20JhengHei',Arial,sans-serif;box-shadow:0%202px%2010px%20rgba(0,0,0,0.2);transform:translateX(calc(100%%20+%2025px));transition:transform%200.3s%20ease-in-out;display:flex;align-items:center;%60;const%20i=document.createElement('span');i.style.marginRight='8px';i.style.fontSize='16px';i.innerHTML=isError?'&#x26A0;':'&#x2714;';n.appendChild(i);n.appendChild(document.createTextNode(message));document.body.appendChild(n);setTimeout(()=%3En.style.transform='translateX(0)',50);setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2025px))';setTimeout(()=%3En.remove(),300)},duration)}function%20createDialogBase(idSuffix,contentHtml,minWidth='350px',maxWidth='600px',customStyles=''){const%20id=TOOL_MAIN_CONTAINER_ID+idSuffix;document.getElementById(id+'_overlay')?.remove();const%20overlay=document.createElement('div');overlay.id=id+'_overlay';overlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:${Z_INDEX_OVERLAY};display:flex;align-items:center;justify-content:center;font-family:'Microsoft%20JhengHei',Arial,sans-serif;backdrop-filter:blur(2px);%60;const%20dialog=document.createElement('div');dialog.id=id+'_dialog';dialog.style.cssText=%60background:#fff;padding:20px%2025px;border-radius:8px;box-shadow:0%205px%2020px%20rgba(0,0,0,0.25);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtDialogAppear%200.2s%20ease-out;${customStyles}%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);document.body.appendChild(overlay);const%20styleEl=document.createElement('style');styleEl.textContent=%60@keyframes%20qtDialogAppear{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn{border:none;padding:8px%2015px;border-radius:4px;font-size:13px;cursor:pointer;transition:opacity%200.2s%20ease,transform%200.1s%20ease;font-weight:500;margin-left:8px;}.qt-dialog-btn:hover{opacity:0.85;}.qt-dialog-btn:active{transform:scale(0.98);}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-red{background:#dc3545;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;}.qt-dialog-btn-green{background:#28a745;color:white;}.qt-dialog-title{margin:0%200%2015px%200;color:#333;font-size:18px;text-align:center;font-weight:600;}.qt-input,.qt-textarea,.qt-select{width:calc(100%%20-%2018px);padding:9px;border:1px%20solid%20#ccc;border-radius:4px;font-size:13px;margin-bottom:15px;color:#333;box-sizing:border-box;}.qt-textarea{min-height:70px;resize:vertical;}.qt-dialog-flex-end{display:flex;justify-content:flex-end;margin-top:15px;}.qt-dialog-flex-between{display:flex;justify-content:space-between;align-items:center;margin-top:15px;}%60;dialog.appendChild(styleEl);return{overlay,dialog}}function%20extractName(strVal){if(!strVal||typeof%20strVal!=='string')return'';const%20matchResult=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+/);return%20matchResult?matchResult[0]:strVal.split('%20')[0]}function%20getFirstLetter(unitString){if(!unitString||typeof%20unitString!=='string')return'Z';for(let%20i=0;i%3CunitString.length;i++){const%20char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char))return%20char}return'Z'}function%20formatDate(date){const%20y=date.getFullYear();const%20m=String(date.getMonth()+1).padStart(2,'0');const%20d=String(date.getDate()).padStart(2,'0');return%20%60${y}${m}${d}%60}function%20createEnvSelectionDialog(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20justify-content:center;%22%3E%3Cbutton%20id=%22qt-env-uat%22%20class=%22qt-dialog-btn%20qt-dialog-btn-green%22%20style=%22flex-grow:1;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%3Cbutton%20id=%22qt-env-prod%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%20style=%22flex-grow:1;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%3C/div%3E%3Cdiv%20style=%22text-align:center;%20margin-top:15px;%22%3E%3Cbutton%20id=%22qt-env-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay}=createDialogBase('_EnvSelect',contentHtml,'300px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-env-uat').onclick=()=%3EcloseDialog('test');overlay.querySelector('#qt-env-prod').onclick=()=%3EcloseDialog('prod');overlay.querySelector('#qt-env-cancel').onclick=()=%3EcloseDialog(null)})}function%20createTokenDialog(attempt=1){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input%22%20class=%22qt-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E${attempt%20%3E%201%20?%20%60%3Cp%20style=%22color:red;%20font-size:12px;%20text-align:center;%20margin-bottom:10px;%22%3EToken%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%3C/p%3E%60%20:%20''}%3Cdiv%20class=%22qt-dialog-flex-between%22%3E%3Cbutton%20id=%22qt-token-skip%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-token-close-tool%22%20class=%22qt-dialog-btn%20qt-dialog-btn-red%22%3E%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%3C/button%3E%3Cbutton%20id=%22qt-token-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E${attempt%20%3E%201%20?%20'%E9%87%8D%E8%A9%A6'%20:%20'%E7%A2%BA%E5%AE%9A'}%3C/button%3E%3C/div%3E%3C/div%3E%60;const{overlay}=createDialogBase('_Token',contentHtml,'320px','auto');const%20inputEl=overlay.querySelector('#qt-token-input');inputEl.focus();if(attempt%3E2){const%20okBtn=overlay.querySelector('#qt-token-ok');okBtn.disabled=!0;okBtn.style.opacity='0.5';okBtn.style.cursor='not-allowed';displaySystemNotification('Token%E5%A4%9A%E6%AC%A1%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97',!0,4000)}const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog('_token_dialog_cancel_');};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-token-ok').onclick=()=%3EcloseDialog(inputEl.value.trim());overlay.querySelector('#qt-token-close-tool').onclick=()=%3EcloseDialog('_close_tool_');overlay.querySelector('#qt-token-skip').onclick=()=%3EcloseDialog('_skip_token_')})}function%20createQuerySetupDialog(){return%20new%20Promise(resolve=%3E{const%20queryButtonsHtml=QUERYABLE_FIELD_DEFINITIONS.map(def=%3E%60%3Cbutton%20class=%22qt-querytype-btn%22%20data-apikey=%22${def.queryApiKey}%22%20style=%22background-color:${def.color};%20color:white;%20border:%202px%20solid%20transparent;%20padding:%208px%2010px;%20flex-grow:%201;%20border-radius:%204px;%20font-size:%2013px;%20font-weight:%20500;%20cursor:%20pointer;%22%3E${escapeHtml(def.queryDisplayName)}%3C/button%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin-bottom:10px;%20font-size:13px;%20color:#555;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B%EF%BC%9A%3C/div%3E%3Cdiv%20id=%22qt-querytype-buttons%22%20style=%22display:flex;%20flex-wrap:wrap;%20gap:8px;%20margin-bottom:15px;%22%3E${queryButtonsHtml}%3C/div%3E%3Cdiv%20style=%22margin-bottom:5px;%20font-size:13px;%20color:#555;%22%3E%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%80%BC%20(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E4%BB%A5%E6%8F%9B%E8%A1%8C/%E7%A9%BA%E6%A0%BC/%E9%80%97%E8%99%9F/%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94)%EF%BC%9A%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input%22%20class=%22qt-textarea%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B%22%3E%3C/textarea%3E%3Cdiv%20style=%22margin-bottom:15px;%22%3E%3Cbutton%20id=%22qt-csv-import-btn%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%20style=%22margin-left:0;%22%3E%E5%BE%9ECSV/TXT%E5%8C%AF%E5%85%A5...%3C/button%3E%3Cspan%20id=%22qt-csv-filename-display%22%20style=%22font-size:12px;%20color:#666;%20margin-left:10px;%22%3E%3C/span%3E%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-between%22%3E%3Cbutton%20id=%22qt-clear-all-input-btn%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E8%BC%B8%E5%85%A5%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-querysetup-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%3C/div%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-file-input-hidden%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;const{overlay,dialog}=createDialogBase('_QuerySetup',contentHtml,'480px','auto');const%20queryValuesInput=overlay.querySelector('#qt-queryvalues-input');const%20typeButtons=overlay.querySelectorAll('.qt-querytype-btn');const%20csvImportBtn=overlay.querySelector('#qt-csv-import-btn');const%20fileInputHidden=overlay.querySelector('#qt-file-input-hidden');const%20csvFilenameDisplay=overlay.querySelector('#qt-csv-filename-display');function%20setActiveButton(apiKey){typeButtons.forEach(btn=%3E{const%20isSelected=btn.dataset.apikey===apiKey;btn.style.border=isSelected?%602px%20solid%20${btn.style.backgroundColor}%60:'2px%20solid%20transparent';btn.style.boxShadow=isSelected?%600%200%208px%20${btn.style.backgroundColor}70%60:'none';if(isSelected){selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);queryValuesInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selectedQueryDefinitionGlobal.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86...)%60}})}typeButtons.forEach(btn=%3Ebtn.onclick=()=%3E{setActiveButton(btn.dataset.apikey);queryValuesInput.focus()});setActiveButton(selectedQueryDefinitionGlobal.queryApiKey);csvImportBtn.onclick=()=%3EfileInputHidden.click();fileInputHidden.onchange=async(e)=%3E{const%20file=e.target.files[0];if(!file)return;csvFilenameDisplay.textContent=%60%E5%B7%B2%E9%81%B8:%20${file.name}%60;try{const%20text=await%20file.text();const%20lines=text.split(/\r?\n/).filter(line=%3Eline.trim()!=='');if(lines.length===0){displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E7%82%BA%E7%A9%BA',!0);return}const%20headers=lines[0].split(/,|;|\t/).map(h=%3Eh.trim().replace(/^%22|%22$/g,''));const%20purpose=await%20createCSVPurposeDialog();if(!purpose){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}if(purpose==='fillQueryValues'){const%20columnIndex=await%20createCSVColumnSelectionDialog(headers,%22%E9%81%B8%E6%93%87%E5%8C%85%E5%90%AB%E6%9F%A5%E8%A9%A2%E5%80%BC%E7%9A%84%E6%AC%84%E4%BD%8D%EF%BC%9A%22);if(columnIndex===null||columnIndex===undefined){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}const%20values=[];for(let%20i=1;i%3Clines.length;i++){const%20cols=lines[i].split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''));if(cols[columnIndex]&&cols[columnIndex].trim()!==%22%22)values.push(cols[columnIndex].trim());}queryValuesInput.value=Array.from(new%20Set(values)).join('\n');displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%80%BC%E5%B7%B2%E5%BE%9ECSV%E5%A1%AB%E5%85%A5',!1);csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=%3Eline.split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''))),selectedColForQueryName:headers[columnIndex],isA17CsvPrepared:!1,selectedColsForA17Merge:[]}}else%20if(purpose==='prepareA17Merge'){const%20selectedHeadersForA17=await%20createCSVColumnCheckboxDialog(headers,%22%E5%8B%BE%E9%81%B8%E8%A6%81%E5%9C%A8A17%E8%A1%A8%E6%A0%BC%E4%B8%AD%E9%A1%AF%E7%A4%BA%E7%9A%84CSV%E6%AC%84%E4%BD%8D%EF%BC%9A%22);if(!selectedHeadersForA17||selectedHeadersForA17.length===0){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=%3Eline.split(/,|;|\t/).map(c=%3Ec.trim().replace(/^%22|%22$/g,''))),selectedColsForA17Merge:selectedHeadersForA17,isA17CsvPrepared:!0,selectedColForQueryName:null};displaySystemNotification(%60%E5%B7%B2%E9%81%B8%20${selectedHeadersForA17.length}%20%E5%80%8BCSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%60,!1)}}catch(err){console.error(%22%E8%99%95%E7%90%86CSV%E9%8C%AF%E8%AA%A4:%22,err);displaySystemNotification('%E8%AE%80%E5%8F%96CSV%E5%A4%B1%E6%95%97',!0);csvFilenameDisplay.textContent=''}fileInputHidden.value=''};overlay.querySelector('#qt-clear-all-input-btn').onclick=()=%3E{queryValuesInput.value='';csvFilenameDisplay.textContent='';csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};fileInputHidden.value='';displaySystemNotification('%E6%89%80%E6%9C%89%E8%BC%B8%E5%85%A5%E5%B7%B2%E6%B8%85%E9%99%A4',!1)};const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-querysetup-ok').onclick=()=%3E{const%20values=queryValuesInput.value.trim();if(!selectedQueryDefinitionGlobal){displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B',!0);return}if(!values){displaySystemNotification(%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selectedQueryDefinitionGlobal.queryDisplayName}%60,!0);queryValuesInput.focus();return}closeDialog({selectedApiKey:selectedQueryDefinitionGlobal.queryApiKey,queryValues:values})};overlay.querySelector('#qt-querysetup-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVPurposeDialog(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E%E9%81%B8%E6%93%87CSV%E6%AA%94%E6%A1%88%E7%94%A8%E9%80%94%3C/h3%3E%3Cdiv%20style=%22display:flex;%20flex-direction:column;%20gap:10px;%22%3E%3Cbutton%20id=%22qt-csv-purpose-query%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20style=%22margin-left:0;%22%3E%E5%B0%87CSV%E6%9F%90%E6%AC%84%E4%BD%9C%E7%82%BA%E6%9F%A5%E8%A9%A2%E5%80%BC%3C/button%3E%3Cbutton%20id=%22qt-csv-purpose-a17%22%20class=%22qt-dialog-btn%20qt-dialog-btn-green%22%20style=%22margin-left:0;%22%3E%E5%8B%BE%E9%81%B8CSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%E9%A1%AF%E7%A4%BA%3C/button%3E%3C/div%3E%3Cdiv%20style=%22text-align:center;%20margin-top:15px;%22%3E%3Cbutton%20id=%22qt-csv-purpose-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay}=createDialogBase('_CSVPurpose',contentHtml,'300px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csv-purpose-query').onclick=()=%3EcloseDialog('fillQueryValues');overlay.querySelector('#qt-csv-purpose-a17').onclick=()=%3EcloseDialog('prepareA17Merge');overlay.querySelector('#qt-csv-purpose-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVColumnSelectionDialog(headers,title){return%20new%20Promise(resolve=%3E{let%20optionsHtml=headers.map((header,index)=%3E%60%3Cbutton%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20data-index=%22${index}%22%20style=%22margin:5px;%20width:%20calc(50%%20-%2010px);%20text-overflow:%20ellipsis;%20overflow:%20hidden;%20white-space:%20nowrap;%22%3E${escapeHtml(header)}%3C/button%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E${escapeHtml(title)}%3C/h3%3E%3Cdiv%20style=%22display:flex;%20flex-wrap:wrap;%20justify-content:center;%20max-height:300px;%20overflow-y:auto;%20margin-bottom:15px;%22%3E${optionsHtml}%3C/div%3E%3Cdiv%20style=%22text-align:center;%22%3E%3Cbutton%20id=%22qt-csvcol-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_CSVColSelect',contentHtml,'400px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelectorAll('.qt-dialog-btn[data-index]').forEach(btn=%3E{btn.onclick=()=%3EcloseDialog(parseInt(btn.dataset.index))});overlay.querySelector('#qt-csvcol-cancel').onclick=()=%3EcloseDialog(null)})}function%20createCSVColumnCheckboxDialog(headers,title){return%20new%20Promise(resolve=%3E{let%20checkboxesHtml=headers.map((header,index)=%3E%60%3Cdiv%20style=%22margin-bottom:%208px;%20display:flex;%20align-items:center;%22%3E%3Cinput%20type=%22checkbox%22%20id=%22qt-csv-header-cb-${index}%22%20value=%22${escapeHtml(header)}%22%20style=%22margin-right:8px;%20transform:scale(1.2);%22%3E%3Clabel%20for=%22qt-csv-header-cb-${index}%22%20style=%22font-size:14px;%22%3E${escapeHtml(header)}%3C/label%3E%3C/div%3E%60).join('');const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3E${escapeHtml(title)}%3C/h3%3E%3Cdiv%20style=%22max-height:%20300px;%20overflow-y:%20auto;%20margin-bottom:%2015px;%20border:%201px%20solid%20#eee;%20padding:%2010px;%20border-radius:%204px;%22%3E${checkboxesHtml}%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-end%22%3E%3Cbutton%20id=%22qt-csvcb-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-csvcb-ok%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%E5%8B%BE%E9%81%B8%3C/button%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_CSVCheckbox',contentHtml,'400px','auto');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csvcb-ok').onclick=()=%3E{const%20selected=[];dialog.querySelectorAll('input[type=%22checkbox%22]:checked').forEach(cb=%3Eselected.push(cb.value));if(selected.length===0){displaySystemNotification('%E8%AB%8B%E8%87%B3%E5%B0%91%E5%8B%BE%E9%81%B8%E4%B8%80%E5%80%8B%E6%AC%84%E4%BD%8D',!0);return}closeDialog(selected)};overlay.querySelector('#qt-csvcb-cancel').onclick=()=%3EcloseDialog(null)})}function%20createA17TextSettingDialog(){return%20new%20Promise(resolve=%3E{const%20s=a17ModeState.textSettings;const%20contentHtml=%60%3Ch3%20class=%22qt-dialog-title%22%3EA17%20%E9%80%9A%E7%9F%A5%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22display:grid;%20grid-template-columns:%201fr;%20gap:%2015px;%22%3E%3Cdiv%3E%3Clabel%20for=%22qt-a17-mainContent%22%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E4%B8%BB%E6%96%87%E6%A1%88%E5%85%A7%E5%AE%B9%EF%BC%9A%3C/label%3E%3Ctextarea%20id=%22qt-a17-mainContent%22%20class=%22qt-textarea%22%20style=%22height:150px;%22%3E${escapeHtml(s.mainContent)}%3C/textarea%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20margin-top:5px;%20flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-mainFontSize%22%20value=%22${s.mainFontSize}%22%20min=%228%22%20max=%2224%22%20step=%220.5%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20pt%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E8%A1%8C%E9%AB%98:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-mainLineHeight%22%20value=%22${s.mainLineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%80%8D%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E9%A1%8F%E8%89%B2:%20%3Cinput%20type=%22color%22%20id=%22qt-a17-mainFontColor%22%20value=%22${s.mainFontColor}%22%20style=%22padding:1px;%20height:25px;%20vertical-align:middle;%22%3E%3C/label%3E%3C/div%3E%3C/div%3E%3Cdiv%3E%3Clabel%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E5%8B%95%E6%85%8B%E6%97%A5%E6%9C%9F%E8%A8%AD%E5%AE%9A%20(%E7%9B%B8%E5%B0%8D%E6%96%BC%E4%BB%8A%E5%A4%A9)%EF%BC%9A%3C/label%3E%3Cdiv%20style=%22display:flex;%20gap:15px;%20align-items:center;%20margin-bottom:5px;flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%E5%81%8F%E7%A7%BB:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-genDateOffset%22%20value=%22${s.genDateOffset}%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%A4%A9%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%E5%81%8F%E7%A7%BB:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-compDateOffset%22%20value=%22${s.compDateOffset}%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%A4%A9%3C/label%3E%3C/div%3E%3Cdiv%20style=%22display:flex;%20gap:10px;%20flex-wrap:wrap;%22%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-dateFontSize%22%20value=%22${s.dateFontSize}%22%20min=%226%22%20max=%2216%22%20step=%220.5%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20pt%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E8%A1%8C%E9%AB%98:%20%3Cinput%20type=%22number%22%20id=%22qt-a17-dateLineHeight%22%20value=%22${s.dateLineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%20class=%22qt-input%22%20style=%22width:60px;%20padding:3px;%20margin-bottom:0;%22%3E%20%E5%80%8D%3C/label%3E%3Clabel%20style=%22font-size:12px;%22%3E%E6%97%A5%E6%9C%9F%E9%A1%8F%E8%89%B2:%20%3Cinput%20type=%22color%22%20id=%22qt-a17-dateFontColor%22%20value=%22${s.dateFontColor}%22%20style=%22padding:1px;%20height:25px;%20vertical-align:middle;%22%3E%3C/label%3E%3C/div%3E%3C/div%3E%3Cdiv%3E%3Clabel%20style=%22font-weight:bold;%20font-size:13px;%20display:block;%20margin-bottom:5px;%22%3E%E9%A0%90%E8%A6%BD%E6%95%88%E6%9E%9C%20(%E6%AD%A4%E5%8D%80%E5%8F%AF%E8%87%A8%E6%99%82%E7%B7%A8%E8%BC%AF%EF%BC%8C%E5%83%85%E5%BD%B1%E9%9F%BF%E7%95%B6%E6%AC%A1%E8%A4%87%E8%A3%BD)%EF%BC%9A%3C/label%3E%3Cdiv%20id=%22qt-a17-preview%22%20contenteditable=%22true%22%20style=%22border:1px%20solid%20#ccc;%20padding:10px;%20min-height:100px;%20max-height:200px;%20overflow-y:auto;%20font-size:${s.mainFontSize}pt;%20line-height:${s.mainLineHeight};%20color:${s.mainFontColor};%20background:#f9f9f9;%20border-radius:4px;%22%3E%3C/div%3E%3C/div%3E%3C/div%3E%3Cdiv%20class=%22qt-dialog-flex-between%22%20style=%22margin-top:20px;%22%3E%3Cbutton%20id=%22qt-a17-text-reset%22%20class=%22qt-dialog-btn%20qt-dialog-btn-orange%22%3E%E9%87%8D%E8%A8%AD%E9%A0%90%E8%A8%AD%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-a17-text-cancel%22%20class=%22qt-dialog-btn%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-a17-text-save%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%3E%E5%84%B2%E5%AD%98%E8%A8%AD%E5%AE%9A%3C/button%3E%3C/div%3E%3C/div%3E%60;const{overlay,dialog}=createDialogBase('_A17TextSettings',contentHtml,'550px','auto');const%20previewEl=overlay.querySelector('#qt-a17-preview');const%20getSettingsFromUI=()=%3E({mainContent:overlay.querySelector('#qt-a17-mainContent').value,mainFontSize:parseFloat(overlay.querySelector('#qt-a17-mainFontSize').value),mainLineHeight:parseFloat(overlay.querySelector('#qt-a17-mainLineHeight').value),mainFontColor:overlay.querySelector('#qt-a17-mainFontColor').value,dateFontSize:parseFloat(overlay.querySelector('#qt-a17-dateFontSize').value),dateLineHeight:parseFloat(overlay.querySelector('#qt-a17-dateLineHeight').value),dateFontColor:overlay.querySelector('#qt-a17-dateFontColor').value,genDateOffset:parseInt(overlay.querySelector('#qt-a17-genDateOffset').value),compDateOffset:parseInt(overlay.querySelector('#qt-a17-compDateOffset').value)});const%20updatePreview=()=%3E{const%20currentUISettings=getSettingsFromUI();const%20today=new%20Date();const%20genDate=new%20Date(today);genDate.setDate(today.getDate()+currentUISettings.genDateOffset);const%20compDate=new%20Date(today);compDate.setDate(today.getDate()+currentUISettings.compDateOffset);const%20genDateStr=formatDate(genDate);const%20compDateStr=formatDate(compDate);let%20previewContent=escapeHtml(currentUISettings.mainContent).replace(/\n/g,'%3Cbr%3E')+%60%3Cbr%3E%3Cbr%3E%3Cspan%20class=%22qt-a17-dynamic-date%22%20style=%22font-size:${currentUISettings.dateFontSize}pt;%20line-height:${currentUISettings.dateLineHeight};%20color:${currentUISettings.dateFontColor};%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}%3Cbr%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}%3C/span%3E%60;previewEl.innerHTML=previewContent;previewEl.style.fontSize=currentUISettings.mainFontSize+'pt';previewEl.style.lineHeight=currentUISettings.mainLineHeight;previewEl.style.color=currentUISettings.mainFontColor};['#qt-a17-mainContent','#qt-a17-mainFontSize','#qt-a17-mainLineHeight','#qt-a17-mainFontColor','#qt-a17-dateFontSize','#qt-a17-dateLineHeight','#qt-a17-dateFontColor','#qt-a17-genDateOffset','#qt-a17-compDateOffset'].forEach(selector=%3E{const%20el=overlay.querySelector(selector);if(el.type==='color')el.onchange=updatePreview;else%20el.oninput=updatePreview});updatePreview();const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-a17-text-save').onclick=()=%3E{const%20newSettings=getSettingsFromUI();if(!newSettings.mainContent.trim()){displaySystemNotification('%E4%B8%BB%E6%96%87%E6%A1%88%E5%85%A7%E5%AE%B9%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA',!0);return}a17ModeState.textSettings=newSettings;localStorage.setItem(A17_TEXT_SETTINGS_STORAGE_KEY,JSON.stringify(newSettings));displaySystemNotification('A17%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%B7%B2%E5%84%B2%E5%AD%98',!1);closeDialog(!0)};overlay.querySelector('#qt-a17-text-cancel').onclick=()=%3EcloseDialog(null);overlay.querySelector('#qt-a17-text-reset').onclick=()=%3E{overlay.querySelector('#qt-a17-mainContent').value=A17_DEFAULT_TEXT_CONTENT;overlay.querySelector('#qt-a17-mainFontSize').value=12;overlay.querySelector('#qt-a17-mainLineHeight').value=1.5;overlay.querySelector('#qt-a17-mainFontColor').value='#333333';overlay.querySelector('#qt-a17-dateFontSize').value=8;overlay.querySelector('#qt-a17-dateLineHeight').value=1.2;overlay.querySelector('#qt-a17-dateFontColor').value='#555555';overlay.querySelector('#qt-a17-genDateOffset').value=-3;overlay.querySelector('#qt-a17-compDateOffset').value=0;updatePreview()}})}async%20function%20performApiQuery(queryValue,apiKey){const%20reqBody={currentPage:1,pageSize:10};reqBody[apiKey]=queryValue;const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody),};if(apiAuthToken)fetchOpts.headers['SSO-TOKEN']=apiAuthToken;let%20retries=1;while(retries%3E=0){try{const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);const%20data=await%20res.json();if(res.status===401){apiAuthToken=null;localStorage.removeItem(TOKEN_STORAGE_KEY);return{error:'token_invalid',data:null}}if(!res.ok){throw%20new%20Error(%60API%E8%AB%8B%E6%B1%82%E9%8C%AF%E8%AA%A4:%20${res.status}%20${res.statusText}%60)}return{error:null,data:data,success:data&&data.records&&data.records.length%3E0}}catch(e){console.error(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E9%8C%AF%E8%AA%A4%20(%E5%98%97%E8%A9%A6%20${2-retries}):%60,e);if(retries%3E0){displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E5%A4%B1%E6%95%97%EF%BC%8C2%E7%A7%92%E5%BE%8C%E9%87%8D%E8%A9%A6...%60,!0,1800);await%20new%20Promise(r=%3EsetTimeout(r,2000));retries--}else{return{error:'network_error',data:null}}}}}function%20renderResultsTableUI(dataToRender){currentTableInstance.mainUIElement?.remove();document.removeEventListener('keydown',mainUIEscListener);const%20mainUI=document.createElement('div');currentTableInstance.mainUIElement=mainUI;mainUI.id=TOOL_MAIN_CONTAINER_ID;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:50%;transform:translate(-50%,-50%);background:#f8f9fa;border-radius:10px;box-shadow:0%208px%2030px%20rgba(0,0,0,0.15);padding:0;width:auto;max-width:850px;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:13px;border:1px%20solid%20#dee2e6;user-select:none;%60;const%20titleBar=document.createElement('div');titleBar.textContent='%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%E6%A1%88%E4%BB%B6%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C';titleBar.style.cssText=%60padding:10px%2015px;margin:-0px%20-0px%2010px%20-0px;background-color:#343a40;color:white;font-weight:bold;font-size:14px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;user-select:none;%60;mainUI.appendChild(titleBar);const%20contentWrapper=document.createElement('div');contentWrapper.style.cssText='padding:15px;%20overflow-y:auto;%20display:flex;%20flex-direction:column;%20flex-grow:1;';mainUI.appendChild(contentWrapper);const%20controlsHeader=document.createElement('div');controlsHeader.style.cssText=%60display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:10px;border-bottom:1px%20solid%20#e0e0e0;flex-wrap:wrap;gap:8px;%60;const%20summarySec=document.createElement('div');summarySec.id=TOOL_MAIN_CONTAINER_ID+'_SummarySection';summarySec.style.cssText='font-size:13px;font-weight:bold;color:#2c3e50;white-space:nowrap;';controlsHeader.appendChild(summarySec);const%20filterInput=document.createElement('input');filterInput.type='text';filterInput.id=TOOL_MAIN_CONTAINER_ID+'_TableFilterInput';filterInput.placeholder='%E7%AF%A9%E9%81%B8%E8%A1%A8%E6%A0%BC%E5%85%A7%E5%AE%B9...';filterInput.className='qt-input';filterInput.style.width='180px';filterInput.style.marginBottom='0';const%20buttonsGroupLeft=document.createElement('div');buttonsGroupLeft.style.cssText='display:flex;gap:6px;align-items:center;';const%20buttonsGroupRight=document.createElement('div');buttonsGroupRight.style.cssText='display:flex;gap:6px;align-items:center;margin-left:auto;';[{id:'ClearConditions',text:'%E6%B8%85%E9%99%A4%E6%A2%9D%E4%BB%B6',cls:'qt-dialog-btn-grey',group:buttonsGroupLeft},{id:'Requery',text:'%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2',cls:'qt-dialog-btn-orange',group:buttonsGroupLeft},{id:'A17',text:'A17%E4%BD%9C%E6%A5%AD',cls:'qt-dialog-btn-purple',group:buttonsGroupLeft},{id:'CopyTable',text:'%E8%A4%87%E8%A3%BD%E8%A1%A8%E6%A0%BC',cls:'qt-dialog-btn-green',group:buttonsGroupLeft},{id:'EditMode',text:'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft},{id:'AddRow',text:'+%20%E6%96%B0%E5%A2%9E%E5%88%97',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft,style:'display:none;'}].forEach(cfg=%3E{const%20btn=document.createElement('button');btn.id=TOOL_MAIN_CONTAINER_ID+'_btn'+cfg.id;btn.textContent=cfg.text;btn.className=%60qt-dialog-btn%20${cfg.cls}%60;if(cfg.style)btn.style.cssText+=cfg.style;cfg.group.appendChild(btn)});const%20closeBtn=document.createElement('button');closeBtn.id=TOOL_MAIN_CONTAINER_ID+'_btnCloseTool';closeBtn.textContent='%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7';closeBtn.className='qt-dialog-btn%20qt-dialog-btn-red';buttonsGroupRight.appendChild(closeBtn);controlsHeader.appendChild(filterInput);controlsHeader.appendChild(buttonsGroupLeft);controlsHeader.appendChild(buttonsGroupRight);contentWrapper.appendChild(controlsHeader);const%20a17UnitBtnsCtr=document.createElement('div');a17UnitBtnsCtr.id=TOOL_MAIN_CONTAINER_ID+'_A17UnitBtns';a17UnitBtnsCtr.style.cssText='margin-bottom:10px;display:none;flex-wrap:wrap;gap:6px;justify-content:flex-start;';contentWrapper.appendChild(a17UnitBtnsCtr);currentTableInstance.a17UnitButtonsContainer=a17UnitBtnsCtr;const%20a17TextControls=document.createElement('div');a17TextControls.id=TOOL_MAIN_CONTAINER_ID+'_A17TextControls';a17TextControls.style.cssText='margin-bottom:10px;display:none;align-items:center;gap:10px;';a17TextControls.innerHTML=%60%3Clabel%20style=%22font-size:12px;color:#333;display:flex;align-items:center;cursor:pointer;%22%3E%3Cinput%20type=%22checkbox%22%20id=%22${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText%22%20checked%20style=%22margin-right:4px;%22%3EA17%E5%90%AB%E9%80%9A%E7%9F%A5%E6%96%87%3C/label%3E%3Cbutton%20id=%22${TOOL_MAIN_CONTAINER_ID}_btnA17EditText%22%20class=%22qt-dialog-btn%20qt-dialog-btn-blue%22%20style=%22margin-left:0;padding:5px%2010px;font-size:12px;%22%3E%E7%B7%A8%E8%BC%AF%E9%80%9A%E7%9F%A5%E6%96%87%3C/button%3E%60;contentWrapper.appendChild(a17TextControls);const%20tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px%20solid%20#ccc;border-radius:5px;background:white;';const%20tableEl=document.createElement('table');tableEl.id=TOOL_MAIN_CONTAINER_ID+'_ResultsTable';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:12px;';tableScrollWrap.appendChild(tableEl);contentWrapper.appendChild(tableScrollWrap);const%20tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:1;background-color:#343a40;color:white;';tableEl.appendChild(tHREl);currentTableInstance.tableHeadElement=tHREl;const%20tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);currentTableInstance.tableBodyElement=tBREl;document.body.appendChild(mainUI);titleBar.onmousedown=(e)=%3E{if(e.target!==titleBar)return;e.preventDefault();dragState.dragging=!0;dragState.startX=e.clientX;dragState.startY=e.clientY;dragState.initialX=mainUI.offsetLeft;dragState.initialY=mainUI.offsetTop;titleBar.style.cursor='grabbing';mainUI.style.transform='none'};document.onmousemove=(e)=%3E{if(dragState.dragging){const%20dx=e.clientX-dragState.startX;const%20dy=e.clientY-dragState.startY;mainUI.style.left=(dragState.initialX+dx)+'px';mainUI.style.top=(dragState.initialY+dy)+'px'}};document.onmouseup=()=%3E{if(dragState.dragging){dragState.dragging=!1;titleBar.style.cursor='grab'}};filterInput.oninput=()=%3EapplyTableFilter();mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnClearConditions%60).onclick=handleClearConditions;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnRequery%60).onclick=()=%3E{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener);executeCaseQueryTool()};const%20a17Btn=mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17%60);a17Btn.onmousedown=(e)=%3E{if(e.button!==0)return;a17ButtonLongPressTimer=setTimeout(()=%3E{a17ButtonLongPressTimer=null;toggleA17Mode(!0)},700)};a17Btn.onmouseup=()=%3E{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null;toggleA17Mode(!1)}};a17Btn.onmouseleave=()=%3E{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null}};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnCopyTable%60).onclick=handleCopyTable;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60).onclick=toggleEditMode;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60).onclick=handleAddRowToTable;closeBtn.onclick=()=%3E{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener)};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17EditText%60).onclick=async()=%3E{await%20createA17TextSettingDialog()};document.addEventListener('keydown',mainUIEscListener);updateSummaryCount(dataToRender.length);if(currentTableInstance.isA17Mode){renderA17ModeUI();populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{renderNormalModeUI();populateTableRows(dataToRender)}}const%20mainUIEscListener=(e)=%3E{if(e.key==='Escape'&&currentTableInstance.mainUIElement&&!document.querySelector(%60[id^=%22${TOOL_MAIN_CONTAINER_ID}_%22][id$=%22_overlay%22]%60)){currentTableInstance.mainUIElement.remove();document.removeEventListener('keydown',mainUIEscListener)}};function%20updateSummaryCount(visibleRowCount){const%20summaryEl=currentTableInstance.mainUIElement?.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_SummarySection%60);if(!summaryEl)return;let%20baseDataCount=currentTableInstance.isA17Mode?baseA17MasterData.length:originalQueryResults.length;let%20text=%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%EF%BC%9A%3Cstrong%3E${baseDataCount}%3C/strong%3E%E7%AD%86%60;const%20filterInput=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60);const%20isFiltered=(filterInput&&filterInput.value.trim()!=='')||(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size%3E0);if(isFiltered&&visibleRowCount!==baseDataCount){text+=%60%20(%E7%AF%A9%E9%81%B8%E5%BE%8C%E9%A1%AF%E7%A4%BA%20%3Cstrong%3E${visibleRowCount}%3C/strong%3E%20%E7%AD%86)%60}summaryEl.innerHTML=text}function%20renderTableHeaders(headers){currentTableInstance.tableHeadElement.innerHTML='';const%20hr=document.createElement('tr');headers.forEach((hTxt,idx)=%3E{const%20th=document.createElement('th');th.textContent=escapeHtml(hTxt);th.style.cssText=%60padding:%208px%206px;%20text-align:center;%20white-space:nowrap;%20cursor:pointer;%20user-select:none;%20font-weight:600;%20font-size:12px;%20border-right:%201px%20solid%20#4a6075;%60;if(idx===headers.length-1)th.style.borderRight='none';if(idx===0&&!currentTableInstance.isA17Mode)th.style.backgroundColor='#007bff';th.onclick=()=%3EsortTableByColumn(hTxt);hr.appendChild(th)});if(isEditMode){const%20thAction=document.createElement('th');thAction.textContent=%22%E6%93%8D%E4%BD%9C%22;thAction.style.cssText=%60padding:%208px%206px;%20text-align:center;%20white-space:nowrap;%20font-weight:600;%20font-size:12px;%60;hr.appendChild(thAction)}currentTableInstance.tableHeadElement.appendChild(hr);currentTableInstance.currentHeaders=headers}function%20populateTableRows(data){currentTableInstance.tableBodyElement.innerHTML='';data.forEach((row,rowIndex)=%3E{const%20tr=document.createElement('tr');tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff';tr.onmouseover=()=%3E{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor='#e9ecef'};tr.onmouseout=()=%3E{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff'};currentTableInstance.currentHeaders.forEach((headerKey,colIndex)=%3E{const%20td=document.createElement('td');td.style.cssText='padding:6px;%20border-bottom:1px%20solid%20#dee2e6;%20font-size:12px;%20text-align:center;%20border-right:1px%20solid%20#dee2e6;';if(colIndex===currentTableInstance.currentHeaders.length-1)td.style.borderRight='none';let%20cellValue=row[headerKey]===null||row[headerKey]===undefined?'':String(row[headerKey]);if(headerKey===FIELD_DISPLAY_NAMES_MAP.statusCombined&&typeof%20cellValue==='string'&&cellValue.includes('%3Cspan')){td.innerHTML=cellValue}else{td.textContent=cellValue}if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){td.style.backgroundColor='#e6f7ff';td.style.fontWeight='500'}if(isEditMode&&((colIndex%3E1&&!row._isNewRow)||(row._isNewRow&&headerKey!==%22%E6%93%8D%E4%BD%9C%22))&&headerKey!==FIELD_DISPLAY_NAMES_MAP._apiQueryStatus){td.onclick=(e)=%3E{if(e.target.tagName!=='INPUT'&&e.target.tagName!=='SELECT')startCellEdit(td,row,headerKey,rowIndex);}}else%20if(!isEditMode){td.onclick=()=%3E{navigator.clipboard.writeText(td.textContent||td.innerText).then(()=%3EdisplaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD:%20${td.textContent%20||%20td.innerText}%60,!1,1000)).catch(err=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))}}tr.appendChild(td)});if(isEditMode){const%20tdAction=document.createElement('td');tdAction.style.cssText='padding:6px;%20border-bottom:1px%20solid%20#dee2e6;%20text-align:center;';const%20deleteBtn=document.createElement('button');deleteBtn.innerHTML='&#x1F5D1;';deleteBtn.className='qt-dialog-btn%20qt-dialog-btn-red';deleteBtn.style.padding='3px%206px';deleteBtn.style.fontSize='10px';deleteBtn.onclick=()=%3EhandleDeleteRow(rowIndex);tdAction.appendChild(deleteBtn);tr.appendChild(tdAction)}currentTableInstance.tableBodyElement.appendChild(tr)});updateSummaryCount(data.length)}function%20sortTableByColumn(headerKeyToSortBy){const%20currentData=currentTableInstance.isA17Mode?[...baseA17MasterData]:[...originalQueryResults];if(currentData.length===0)return;const%20direction=(currentTableInstance.sortDirections[headerKeyToSortBy]||'desc')==='asc'?'desc':'asc';currentTableInstance.sortDirections={};currentTableInstance.sortDirections[headerKeyToSortBy]=direction;currentData.sort((a,b)=%3E{let%20valA=a[headerKeyToSortBy]===null||a[headerKeyToSortBy]===undefined?'':String(a[headerKeyToSortBy]);let%20valB=b[headerKeyToSortBy]===null||b[headerKeyToSortBy]===undefined?'':String(b[headerKeyToSortBy]);const%20isNumeric=headerKeyToSortBy===FIELD_DISPLAY_NAMES_MAP.NO||(!isNaN(parseFloat(valA))&&isFinite(valA)&&!isNaN(parseFloat(valB))&&isFinite(valB)&&valA.trim()!==''&&valB.trim()!=='');let%20comparison=0;if(isNumeric){comparison=parseFloat(valA)-parseFloat(valB)}else{comparison=valA.localeCompare(valB,'zh-Hant-TW')}return%20direction==='asc'?comparison:-comparison});if(currentTableInstance.isA17Mode)baseA17MasterData=currentData;else%20originalQueryResults=currentData;populateTableRows(currentData);displaySystemNotification(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerKeyToSortBy}%E3%80%8D${direction%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1);currentTableInstance.tableHeadElement.querySelectorAll('th').forEach(th=%3E{const%20currentHeaderText=th.textContent.replace(/[\u25B2\u25BC\s]*$/,'').trim();th.innerHTML=escapeHtml(currentHeaderText);if(currentHeaderText===headerKeyToSortBy){th.innerHTML+=(direction==='asc'?'%20%3Cspan%20style=%22font-size:10px;%22%3E\u25B2%3C/span%3E':'%20%3Cspan%20style=%22font-size:10px;%22%3E\u25BC%3C/span%3E')}})}function%20applyTableFilter(){const%20filterText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value.trim().toLowerCase();const%20baseData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;let%20filteredData=baseData;if(filterText){filteredData=baseData.filter(row=%3EcurrentTableInstance.currentHeaders.some(headerKey=%3E(String(row[headerKey]||'').toLowerCase().includes(filterText))))}if(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size%3E0){let%20unitFilteredData=[];a17ModeState.selectedUnits.forEach(unitId=%3E{unitFilteredData=unitFilteredData.concat(filteredData.filter(row=%3E{const%20unitVal=String(row[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');if(unitId==='UNDEF'){const%20knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=%3Eb.id!=='UNDEF').map(b=%3Eb.id.toUpperCase());return%20unitVal.trim()===''||!knownPrefixes.some(prefix=%3EunitVal.toUpperCase().startsWith(prefix))}return%20unitVal.toUpperCase().startsWith(unitId.toUpperCase())}))});filteredData=Array.from(new%20Set(unitFilteredData.map(JSON.stringify))).map(JSON.parse)}populateTableRows(filteredData)}function%20handleClearConditions(){currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value='';currentTableInstance.sortDirections={};if(currentTableInstance.isA17Mode){a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button.highlighted').forEach(btn=%3E{btn.classList.remove('highlighted');btn.style.boxShadow='none'});csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};baseA17MasterData=[...originalQueryResults];baseA17MasterData.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{originalQueryResults.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(originalQueryResults)}renderTableHeaders(currentTableInstance.currentHeaders);displaySystemNotification('%E6%89%80%E6%9C%89%E6%A2%9D%E4%BB%B6%E5%B7%B2%E6%B8%85%E9%99%A4%EF%BC%8C%E8%A1%A8%E6%A0%BC%E5%B7%B2%E9%87%8D%E7%BD%AE%E7%82%BA%E6%8C%89%E5%BA%8F%E8%99%9F%E6%8E%92%E5%BA%8F',!1)}function%20toggleEditMode(){isEditMode=!isEditMode;const%20editBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60);const%20addRowBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60);editBtn.textContent=isEditMode?'%E5%AE%8C%E6%88%90%E7%B7%A8%E8%BC%AF':'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editBtn.className=%60qt-dialog-btn%20${isEditMode%20?%20'qt-dialog-btn-red'%20:%20'qt-dialog-btn-blue'}%60;addRowBtn.style.display=isEditMode?'inline-block':'none';const%20currentData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;renderTableHeaders(currentTableInstance.currentHeaders);populateTableRows(currentData);displaySystemNotification(isEditMode?'%E5%B7%B2%E9%80%B2%E5%85%A5%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F':'%E5%B7%B2%E9%80%80%E5%87%BA%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',!1)}function%20startCellEdit(td,rowData,headerKey,rowIndex){if(td.querySelector('input,%20select'))return;td.classList.add('qt-editing-cell');const%20originalText=td.textContent;td.innerHTML='';let%20inputElement;if(isEditMode&&currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){inputElement=document.createElement('select');inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px%20solid%20#007bff;margin:0;background:transparent;';const%20defaultOption=document.createElement('option');defaultOption.value=%22%22;defaultOption.textContent=%22--%E9%81%B8%E6%93%87%E5%88%86%E5%85%AC%E5%8F%B8--%22;inputElement.appendChild(defaultOption);A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{if(unitDef.id==='UNDEF')return;const%20option=document.createElement('option');option.value=unitDef.id;option.textContent=unitDef.label;const%20currentUnitPrefix=String(rowData[headerKey]||'').split('-')[0].toUpperCase();if(unitDef.id===currentUnitPrefix)option.selected=!0;inputElement.appendChild(option)});inputElement.onchange=()=%3EfinishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'select')}else{inputElement=document.createElement('input');inputElement.type='text';inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px%20solid%20#007bff;margin:0;';inputElement.value=originalText;inputElement.onkeydown=(e)=%3E{if(e.key==='Enter'){e.preventDefault();finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'input')}else%20if(e.key==='Escape'){td.textContent=originalText;td.classList.remove('qt-editing-cell')}}}inputElement.onblur=()=%3E{setTimeout(()=%3E{if(td.contains(inputElement))finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputElement.tagName.toLowerCase());},100)};td.appendChild(inputElement);inputElement.focus();if(inputElement.select)inputElement.select();}function%20finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputType='input'){const%20newValue=inputElement.value.trim();td.classList.remove('qt-editing-cell');const%20displayValue=(inputType==='select'&&newValue)?A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===newValue)?.label||newValue:newValue;td.textContent=displayValue;if(newValue!==originalText||(inputType==='select'&&(rowData[headerKey]||'').split('-')[0]!==newValue)){rowData[headerKey]=displayValue;displaySystemNotification(%60%E3%80%8C${headerKey}%E3%80%8D%E5%B7%B2%E6%9B%B4%E6%96%B0%60,!1,1500);td.style.backgroundColor='#d4edda';if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0)applyTableFilter();}}else{td.textContent=originalText}}function%20handleAddRowToTable(){if(!isEditMode){displaySystemNotification('%E8%AB%8B%E5%85%88%E9%80%B2%E5%85%A5%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F',!0);return}const%20newRow={_isNewRow:!0};let%20maxNo=0;const%20targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;targetDataset.forEach(row=%3E{const%20currentNo=parseInt(row[FIELD_DISPLAY_NAMES_MAP.NO]);if(!isNaN(currentNo)&&currentNo%3EmaxNo)maxNo=currentNo});newRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(maxNo+1);currentTableInstance.currentHeaders.forEach(header=%3E{if(header!==FIELD_DISPLAY_NAMES_MAP.NO&&header!==%22%E6%93%8D%E4%BD%9C%22)newRow[header]=''});if(currentTableInstance.isA17Mode){baseA17MasterData.push(newRow);populateTableRows(baseA17MasterData)}else{originalQueryResults.push(newRow);populateTableRows(originalQueryResults)}displaySystemNotification('%E5%B7%B2%E6%96%B0%E5%A2%9E%E4%B8%80%E5%88%97%EF%BC%8C%E8%AB%8B%E7%B7%A8%E8%BC%AF%E5%85%A7%E5%AE%B9',!1);const%20tableWrapper=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableScrollWrapper%60);if(tableWrapper)tableWrapper.scrollTop=tableWrapper.scrollHeight}function%20handleDeleteRow(rowIndex){if(!isEditMode)return;const%20targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;if(rowIndex%3E=0&&rowIndex%3CtargetDataset.length){targetDataset.splice(rowIndex,1);populateTableRows(targetDataset);displaySystemNotification('%E5%B7%B2%E5%88%AA%E9%99%A4%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99',!1);if(currentTableInstance.isA17Mode)updateA17UnitButtonCounts();}}function%20loadA17TextSettings(){const%20saved=localStorage.getItem(A17_TEXT_SETTINGS_STORAGE_KEY);if(saved){try{const%20parsed=JSON.parse(saved);for(const%20key%20in%20a17ModeState.textSettings){if(parsed.hasOwnProperty(key))a17ModeState.textSettings[key]=parsed[key]}}catch(e){console.error(%22%E8%BC%89%E5%85%A5A17%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%A4%B1%E6%95%97:%22,e)}}}function%20toggleA17Mode(forceEnter=!1){const%20a17TextControls=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_A17TextControls%60);if(currentTableInstance.isA17Mode){currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.style.display='none';a17TextControls.style.display='none';renderNormalModeUI();populateTableRows(originalQueryResults);displaySystemNotification('%E5%B7%B2%E9%80%80%E5%87%BAA17%E4%BD%9C%E6%A5%AD%E6%A8%A1%E5%BC%8F',!1)}else{if(!forceEnter&&!csvImportState.isA17CsvPrepared){displaySystemNotification('%E8%AB%8B%E5%85%88%E9%80%8F%E9%81%8E%E3%80%8C%E5%8C%AF%E5%85%A5CSV/TXT%E3%80%8D%E6%8C%89%E9%88%95%E9%81%B8%E6%93%87%E3%80%8C%E5%8B%BE%E9%81%B8CSV%E6%AC%84%E4%BD%8D%E4%BE%9BA17%E5%90%88%E4%BD%B5%E3%80%8D%E4%B8%A6%E5%AE%8C%E6%88%90%E8%A8%AD%E5%AE%9A%E3%80%82%E6%88%96%E9%95%B7%E6%8C%89%E3%80%8CA17%E4%BD%9C%E6%A5%AD%E3%80%8D%E6%8C%89%E9%88%95%E5%BC%B7%E5%88%B6%E9%80%B2%E5%85%A5%E3%80%82',!0,6000);return}currentTableInstance.isA17Mode=!0;a17ModeState.isActive=!0;currentTableInstance.a17UnitButtonsContainer.style.display='flex';a17TextControls.style.display='flex';if(forceEnter&&!csvImportState.isA17CsvPrepared){baseA17MasterData=originalQueryResults.map(row=%3E{const%20newRow={};newRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]=row[FIELD_DISPLAY_NAMES_MAP._queriedValue_];newRow[FIELD_DISPLAY_NAMES_MAP.NO]=row[FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(row.hasOwnProperty(displayName))newRow[displayName]=row[displayName]});newRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=row[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus];return%20newRow})}else{baseA17MasterData=[];const%20keyCsvHeader=csvImportState.rawHeaders.find(h=%3Eh.includes('%E9%80%81%E9%87%91%E5%96%AE'));const%20keyCsvIndex=keyCsvHeader?csvImportState.rawHeaders.indexOf(keyCsvHeader):(csvImportState.rawHeaders.length%3E0?0:-1);csvImportState.rawData.forEach((csvRowData,index)=%3E{let%20mergedRow={};mergedRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(index+1);csvImportState.selectedColsForA17Merge.forEach(selectedCsvHeader=%3E{const%20originalCsvIndex=csvImportState.rawHeaders.indexOf(selectedCsvHeader);if(originalCsvIndex!==-1)mergedRow[selectedCsvHeader]=csvRowData[originalCsvIndex]});const%20csvKeyValue=(keyCsvIndex!==-1)?csvRowData[keyCsvIndex]:null;let%20apiFound=!1;if(csvKeyValue){const%20matchingApiRow=originalQueryResults.find(apiRow=%3E(apiRow[FIELD_DISPLAY_NAMES_MAP.receiptNumber]===csvKeyValue||apiRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]===csvKeyValue));if(matchingApiRow){apiFound=!0;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName)&&matchingApiRow.hasOwnProperty(displayName)){mergedRow[displayName]=matchingApiRow[displayName]}});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=matchingApiRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]||'%E2%9C%94%EF%B8%8F%20%E6%88%90%E5%8A%9F'}}if(!apiFound){ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName))mergedRow[displayName]='-'});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]='%E2%9E%96%20%E7%84%A1%E5%B0%8D%E6%87%89API%E8%B3%87%E6%96%99'}baseA17MasterData.push(mergedRow)})}renderA17ModeUI();populateTableRows(baseA17MasterData);createA17UnitButtons();updateA17UnitButtonCounts();displaySystemNotification('%E5%B7%B2%E9%80%B2%E5%85%A5A17%E4%BD%9C%E6%A5%AD%E6%A8%A1%E5%BC%8F',!1)}}function%20renderNormalModeUI(){let%20headers=[FIELD_DISPLAY_NAMES_MAP._queriedValue_,FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function%20renderA17ModeUI(){let%20headers=[];if(csvImportState.isA17CsvPrepared&&csvImportState.selectedColsForA17Merge.length%3E0){csvImportState.selectedColsForA17Merge.forEach(csvHeader=%3E{if(!headers.includes(csvHeader))headers.push(csvHeader);});ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!headers.includes(displayName))headers.push(displayName);})}else{headers.push(FIELD_DISPLAY_NAMES_MAP._queriedValue_);headers.push(FIELD_DISPLAY_NAMES_MAP.NO);ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)})}if(!headers.includes(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus))headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function%20createA17UnitButtons(){currentTableInstance.a17UnitButtonsContainer.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{const%20btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.textContent=%60${unitDef.label}%20(0)%60;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:6px%208px;border-radius:4px;cursor:pointer;font-size:11px;transition:all%200.2s%20ease;flex-grow:1;min-width:80px;text-align:center;%60;btn.onclick=()=%3E{if(btn.classList.contains('disabled'))return;const%20unitId=btn.dataset.unitId;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow=%600%200%200%202px%20white,%200%200%200%204px%20${btn.style.backgroundColor}%60}applyTableFilter();displaySystemNotification(%60%E5%B7%B2%E9%81%B8%E6%93%87%20${a17ModeState.selectedUnits.size}%20%E5%80%8B%E5%96%AE%E4%BD%8D%60,!1,1500)};currentTableInstance.a17UnitButtonsContainer.appendChild(btn)})}function%20updateA17UnitButtonCounts(){if(!currentTableInstance.isA17Mode)return;const%20unitCounts={};const%20dataToCount=baseA17MasterData;dataToCount.forEach(row=%3E{const%20unitFull=String(row[FIELD_DISPLAY_NAMES_MAP.uwApproverUnit]||'');let%20unitPrefix='UNDEF';for(const%20code%20in%20UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()==='')unitPrefix='UNDEF';unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button').forEach(btn=%3E{const%20unitId=btn.dataset.unitId;const%20count=unitCounts[unitId]||0;const%20unitDef=A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label}%20(${count})%60;if(count===0){btn.classList.add('disabled');btn.disabled=!0;btn.style.opacity='0.6';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.classList.remove('disabled');btn.disabled=!1;btn.style.opacity='1'}}})}function%20handleCopyTable(){const%20dataToCopy=[];const%20rows=currentTableInstance.tableBodyElement.querySelectorAll('tr');rows.forEach(tr=%3E{const%20rowData={};tr.querySelectorAll('td').forEach((td,colIndex)=%3E{if(isEditMode&&colIndex===currentTableInstance.currentHeaders.length)return;const%20headerKey=currentTableInstance.currentHeaders[colIndex];rowData[headerKey]=td.textContent||td.innerText});if(Object.keys(rowData).length%3E0)dataToCopy.push(rowData);});if(dataToCopy.length===0){displaySystemNotification('%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD',!0);return}if(currentTableInstance.isA17Mode){const%20includeText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText%60).checked;const%20previewDialog=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_A17TextSettings_overlay');let%20customContentFromPreview=null;if(previewDialog&&previewDialog.style.display==='flex'){const%20previewEl=previewDialog.querySelector('#qt-a17-preview');if(previewEl)customContentFromPreview=previewEl.innerHTML}generateAndCopyA17NotificationHTML(dataToCopy,currentTableInstance.currentHeaders,includeText,customContentFromPreview)}else{let%20tsvContent=currentTableInstance.currentHeaders.join('\t')+'\n';dataToCopy.forEach(row=%3E{const%20rowValues=currentTableInstance.currentHeaders.map(header=%3EString(row[header]||'').replace(/\t/g,'%20').replace(/\n/g,'%20'));tsvContent+=rowValues.join('\t')+'\n'});navigator.clipboard.writeText(tsvContent).then(()=%3EdisplaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD%20${dataToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99%20(TSV%E6%A0%BC%E5%BC%8F)%60,!1)).catch(err=%3E{console.error('TSV%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97:',err);displaySystemNotification('%E8%A4%87%E8%A3%BDTSV%E5%A4%B1%E6%95%97',!0)})}}function%20generateAndCopyA17NotificationHTML(data,headers,includeText,customPreviewContent=null){const%20s=a17ModeState.textSettings;const%20today=new%20Date();const%20genDate=new%20Date(today);genDate.setDate(today.getDate()+s.genDateOffset);const%20compDate=new%20Date(today);compDate.setDate(today.getDate()+s.compDateOffset);const%20genDateStr=formatDate(genDate);const%20compDateStr=formatDate(compDate);let%20textContentHtml='';if(includeText){if(customPreviewContent){textContentHtml=customPreviewContent}else{textContentHtml=%60%3Cdiv%20style=%22font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${s.mainFontSize}pt;line-height:${s.mainLineHeight};color:${s.mainFontColor};%22%3E%60+escapeHtml(s.mainContent).replace(/\n/g,'%3Cbr%3E')+%60%3Cbr%3E%3Cbr%3E%3Cp%20style=%22font-size:${s.dateFontSize}pt;line-height:${s.dateLineHeight};color:${s.dateFontColor};margin-top:${s.dateLineHeight%20%3E%201.2%20?%20'10px':'5px'};margin-bottom:${s.dateLineHeight%20%3E%201.2%20?%20'10px':'5px'};%22%3E%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}%3Cbr%3E%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}%3C/p%3E%3C/div%3E%60}}const%20tableRowsHtml=data.map((row,idx)=%3E%60%3Ctr%20style=%22background-color:${idx%20%%202%20?%20'#f8f9fa':'#ffffff'};%22%3E${headers.map(header%20=%3E%20%60%3Ctd%20style=%22border:1px%20solid%20#dddddd;padding:5px%207px;text-align:center;font-size:10pt;color:#333333;white-space:normal;word-break:break-all;%22%3E${escapeHtml(row[header]||'')}%3C/td%3E%60).join('')}%3C/tr%3E%60).join('');const%20tableHtml=%60%3Ctable%20style=%22border-collapse:collapse;width:100%;margin-top:10px;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:10pt;%22%3E%3Cthead%3E%3Ctr%20style=%22background-color:#343a40;color:white;font-weight:bold;%22%3E${headers.map(header%20=%3E%20%60%3Cth%20style=%22border:1px%20solid%20#23272b;padding:6px%208px;text-align:center;%22%3E${escapeHtml(header)}%3C/th%3E%60).join('')}%3C/tr%3E%3C/thead%3E%3Ctbody%3E${tableRowsHtml}%3C/tbody%3E%3C/table%3E%60;const%20finalHtml=textContentHtml+tableHtml;try{const%20blobHtml=new%20Blob([finalHtml],{type:'text/html'});const%20plainTextForClipboard=(includeText?(customPreviewContent?new%20DOMParser().parseFromString(customPreviewContent,%22text/html%22).body.textContent:s.mainContent)+%60\n\n%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}\n%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');const%20blobText=new%20Blob([plainTextForClipboard],{type:'text/plain'});navigator.clipboard.write([new%20ClipboardItem({'text/html':blobHtml,'text/plain':blobText})]).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(HTML%E6%A0%BC%E5%BC%8F)',!1)).catch(err=%3E{console.error('HTML%20Clipboard%20API%20%E5%A4%B1%E6%95%97:',err);navigator.clipboard.writeText(plainTextForClipboard).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(%E7%B4%94%E6%96%87%E5%AD%97)',!1)).catch(txtErr=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))})}catch(e){console.error('ClipboardItem%20API%20%E4%B8%8D%E5%8F%AF%E7%94%A8:',e);const%20plainFallback=(includeText?(customPreviewContent?new%20DOMParser().parseFromString(customPreviewContent,%22text/html%22).body.textContent:s.mainContent)+%60\n\n%E7%94%A2%E6%AA%94%E6%99%82%E9%96%93%EF%BC%9A${genDateStr}\n%E6%AF%94%E5%B0%8D%E6%99%82%E9%96%93%EF%BC%9A${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');navigator.clipboard.writeText(plainFallback).then(()=%3EdisplaySystemNotification('A17%E9%80%9A%E7%9F%A5%E5%B7%B2%E8%A4%87%E8%A3%BD%20(%E7%B4%94%E6%96%87%E5%AD%97)',!1)).catch(txtErr=%3EdisplaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',!0))}}async%20function%20executeCaseQueryTool(){if(document.getElementById(TOOL_MAIN_CONTAINER_ID)){displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',!0);return}const%20selectedEnv=await%20createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv%20===%20'prod'%20?%20'%E6%AD%A3%E5%BC%8F'%20:%20'%E6%B8%AC%E8%A9%A6'}%60,!1);let%20tokenIsValid=!1;if(apiAuthToken)tokenIsValid=!0;if(!tokenIsValid){let%20tokenAttempt=1;while(!0){const%20tokenResult=await%20createTokenDialog(tokenAttempt);if(tokenResult==='_close_tool_'){displaySystemNotification('%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%97%9C%E9%96%89',!1);return}if(tokenResult==='_skip_token_'){apiAuthToken=null;displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8EToken%E8%BC%B8%E5%85%A5',!1);break}if(tokenResult==='_token_dialog_cancel_'){displaySystemNotification('Token%E8%BC%B8%E5%85%A5%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}if(tokenResult&&tokenResult.trim()!==''){apiAuthToken=tokenResult.trim();localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);displaySystemNotification('Token%E5%B7%B2%E8%A8%AD%E5%AE%9A',!1);break}else{if(tokenAttempt%3E=2){}else{displaySystemNotification('Token%E6%9C%AA%E8%BC%B8%E5%85%A5',!0)}}tokenAttempt++;if(tokenAttempt%3E2&&(!tokenResult||tokenResult.trim()===''))break}}const%20querySetupResult=await%20createQuerySetupDialog();if(!querySetupResult){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupResult.selectedApiKey);const%20queryValues=querySetupResult.queryValues.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC',!0);return}const%20loadingDialog=createDialogBase('_Loading',%60%3Ch3%20class=%22qt-dialog-title%22%20id=%22${TOOL_MAIN_CONTAINER_ID}_LoadingTitle%22%3E%E6%9F%A5%E8%A9%A2%E4%B8%AD...%3C/h3%3E%3Cp%20id=%22${TOOL_MAIN_CONTAINER_ID}_LoadingMsg%22%20style=%22text-align:center;font-size:13px;color:#555;%22%3E%E8%99%95%E7%90%86%E4%B8%AD...%3C/p%3E%3Cdiv%20style=%22width:40px;height:40px;border:4px%20solid%20#f3f3f3;border-top:4px%20solid%20#3498db;border-radius:50%;margin:15px%20auto;animation:qtSpin%201s%20linear%20infinite;%22%3E%3C/div%3E%60,'300px','auto','text-align:center;');const%20loadingTitleEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingTitle%60);const%20loadingMsgEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingMsg%60);originalQueryResults=[];let%20currentQueryCount=0;for(const%20singleQueryValue%20of%20queryValues){currentQueryCount++;if(loadingTitleEl)loadingTitleEl.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD%20(${currentQueryCount}/${queryValues.length})%60;if(loadingMsgEl)loadingMsgEl.textContent=%60%E6%AD%A3%E5%9C%A8%E8%99%95%E7%90%86:%20${singleQueryValue}%60;const%20resultRowBase={[FIELD_DISPLAY_NAMES_MAP.NO]:String(currentQueryCount),[FIELD_DISPLAY_NAMES_MAP._queriedValue_]:singleQueryValue};const%20apiResult=await%20performApiQuery(singleQueryValue,selectedQueryDefinitionGlobal.queryApiKey);let%20apiQueryStatusText='%E2%9D%8C%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';if(apiResult.error==='token_invalid'){apiQueryStatusText='%E2%9D%8C%20TOKEN%E5%A4%B1%E6%95%88';loadingDialog.overlay.remove();displaySystemNotification('Token%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%A8%AD%E5%AE%9AToken%E5%BE%8C%E5%86%8D%E6%AC%A1%E6%9F%A5%E8%A9%A2%E3%80%82',!0,5000);apiAuthToken=null;return}else%20if(apiResult.success){apiQueryStatusText='%E2%9C%94%EF%B8%8F%20%E6%88%90%E5%8A%9F'}else%20if(!apiResult.error){apiQueryStatusText='%E2%9E%96%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99'}resultRowBase[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=apiQueryStatusText;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=%3E{const%20populatedRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20displayName=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let%20cellValue=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){const%20mainS=rec.mainStatus||'';const%20subS=rec.subStatus||'';populatedRow[displayName]=%60%3Cspan%20style=%22font-weight:bold;%22%3E${escapeHtml(mainS)}%3C/span%3E%60+(subS?%60%20%3Cspan%20style=%22color:#777;%22%3E(${escapeHtml(subS)})%3C/span%3E%60:'')}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){const%20unitCodePrefix=getFirstLetter(cellValue);const%20mappedUnitName=UNIT_CODE_MAPPINGS[unitCodePrefix]||cellValue;populatedRow[displayName]=unitCodePrefix&&UNIT_CODE_MAPPINGS[unitCodePrefix]?%60${unitCodePrefix}-${mappedUnitName.replace(/^[A-Z]-/,'')}%60:mappedUnitName}else%20if(dKey==='uwApprover'||dKey==='approvalUser'){populatedRow[displayName]=extractName(cellValue)}else{populatedRow[displayName]=cellValue}});originalQueryResults.push(populatedRow)})}else{ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{resultRowBase[FIELD_DISPLAY_NAMES_MAP[dKey]||dKey]='-'});originalQueryResults.push(resultRowBase)}}loadingDialog.overlay.remove();if(originalQueryResults.length%3E0)originalQueryResults.sort((a,b)=%3E(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;isEditMode=!1;renderResultsTableUI(originalQueryResults);displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%E8%99%95%E7%90%86%20${queryValues.length}%20%E5%80%8B%E6%9F%A5%E8%A9%A2%E5%80%BC%EF%BC%8C%E7%8D%B2%E5%8F%96%20${originalQueryResults.length}%20%E7%AD%86%E8%B3%87%E6%96%99%60,!1,3500)}(function(){document.getElementById(TOOL_MAIN_CONTAINER_ID)?.remove();['EnvSelect','Token','QuerySetup','A17TextSettings','Loading','CSVPurpose','CSVColSelect','CSVCheckbox'].forEach(suffix=%3E{const%20el=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_'+suffix+'_overlay');if(el)el.remove();});document.getElementById(TOOL_MAIN_CONTAINER_ID+'_Notification')?.remove();loadA17TextSettings();executeCaseQueryTool()})()})()

javascript:(async()=>{ const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; let CURRENT_API_URL=''; const TOKEN_STORAGE_KEY='euisToken'; const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}];%20let%20selectedQueryDefinitionGlobal=null;%20const%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];%20const%20FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8',mainStatus:'%E4%B8%BB%E7%8B%80%E6%85%8B',subStatus:'%E6%AC%A1%E7%8B%80%E6%85%8B'};%20const%20UNIT_MAP_FIELD_API_KEY='uwApproverUnit';%20const%20UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',F:'%E5%8F%B0%E4%B8%AD(%E5%98%89%E7%BE%A9)',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'};%20const%20APPROVER_FIELD_API_KEY='uwApprover';%20const%20APPROVAL_USER_FIELD_API_KEY='approvalUser';%20const%20SPECIAL_QUERIED_VALUE_KEY='_queriedValue_';%20const%20A17_BUTTON_TEXT=%22A17%E4%BD%9C%E6%A5%AD%E9%80%9A%E7%9F%A5%22;%20const%20A17_REPORT_NAME=%22A17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%22;%20const%20A17_PARA1=%22%E6%82%A8%E5%A5%BD%EF%BC%8C%22;%20const%20A17_PARA2_TEMPLATE=%22%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9A{{REPORT_NAME}}%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E6%9C%AC%E9%80%B1%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82%22;%20const%20A17_PARA3=%22%E7%B6%93%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E6%AF%94%E5%B0%8D%E5%BE%8C%EF%BC%8C%E8%A9%B2%E7%AD%89%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;%20const%20A17_GEN_DATE_OFFSET_DAYS=-3;%20const%20A17_COMP_DATE_OFFSET_DAYS=0;%20const%20A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1',color:'#546e7a'}];%20const%20A17_CSV_DATA_DISPLAY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B'];%20const%20A17_API_DATA_DISPLAY_HEADERS=['%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1'];%20const%20A17_COPY_ONLY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','',''];%20let%20baseA17MasterData=[];%20let%20activeA17UnitButtonElement=null;%20let%20apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);%20let%20originalQueryResults=[];%20let%20currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,mainTableSortState:{columnIndex:1,direction:'asc'},isCSVImportModeGlobal:false};%20let%20importedCSVRawData=null;%20const%20V_SUFFIX='_vFinal';%20const%20sleep=t=%3Enew%20Promise(r=%3EsetTimeout(r,t));%20const%20escapeHtml=unsafe=%3Eunsafe===undefined||unsafe===null?'':String(unsafe).replace(/[&%3C%22']/g,m=%3E({'&':'&','%3C':'%3C','%22':'%22',%22'%22:'&#039;'})[m]);%20const%20Z_INDEX_DIALOG=2147483640;%20const%20Z_INDEX_MAIN_UI=2147483630;%20const%20Z_INDEX_NOTIFICATION=2147483647;%20%20function%20displaySystemNotification(message,isError=false,duration=3000){%20const%20nId='qtNotif'+V_SUFFIX;%20document.getElementById(nId)?.remove();%20const%20n=document.createElement('div');%20n.id=nId;%20n.style.cssText=%60position:fixed;top:10px;right:10px;background:${isError?'#c0392b':'#27ae60'};color:white;padding:6px%209px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:11.5px;transform:translateX(calc(100%%20+%2015px));transition:transform%200.25s%20ease-out;box-shadow:0%201px%205px%20rgba(0,0,0,0.12);font-family:'Microsoft%20JhengHei',Arial,sans-serif;display:flex;align-items:center;gap:4px;%60;%20n.innerHTML=%60${isError?'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x26A0;%3C/span%3E':'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x2714;%3C/span%3E'}%3Cspan%3E${escapeHtml(message)}%3C/span%3E%60;%20document.body.appendChild(n);%20setTimeout(()=%3En.style.transform='translateX(0)',20);%20setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2015px))';setTimeout(()=%3En.remove(),250)},duration);%20}%20%20function%20createDialogBase(id,contentHtml,minWidth='300px',maxWidth='450px',customDialogStyle=''){%20document.getElementById(id)?.remove();%20const%20o=document.createElement('div');%20o.id=id;%20o.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:${Z_INDEX_DIALOG};display:flex;align-items:center;justify-content:center;backdrop-filter:blur(1.5px);font-family:'Microsoft%20JhengHei',Arial,sans-serif;padding:8px;box-sizing:border-box;%60;%20const%20d=document.createElement('div');%20d.style.cssText=%60background:#fff;padding:12px%2015px;border-radius:6px;box-shadow:0%203px%2015px%20rgba(0,0,0,0.12);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtModalOpenSlight%200.15s%20ease-out;${customDialogStyle}%60;%20d.innerHTML=contentHtml+%60%3Cstyle%3E@keyframes%20qtModalOpenSlight{from{opacity:0;transform:scale(0.98)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn${V_SUFFIX}{border:none;padding:5px%2010px;border-radius:3px;font-size:12px;cursor:pointer;transition:opacity%200.15s%20ease;font-weight:500;margin-left:5px;}.qt-dialog-btn${V_SUFFIX}:hover{opacity:0.8;}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;margin-right:auto!important;}%3C/style%3E%60;%20o.appendChild(d);%20document.body.appendChild(o);%20return{overlay:o,dialog:d};%20}%20%20function%20createTokenDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:14px;text-align:center;font-weight:600;%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);padding:7px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:10px;color:#333;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;%22%3E%3Cbutton%20id=%22qt-token-skip${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20id=%22qt-token-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-token-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3C/div%3E%60;%20const{overlay}=createDialogBase('qtTokenDialog'+V_SUFFIX,html);%20const%20iEl=document.getElementById('qt-token-input'+V_SUFFIX);%20if(iEl)iEl.focus();%20const%20c=v=%3E{document.removeEventListener('keydown',k);overlay.remove();resolve(v);};%20const%20k=e=%3E{if(e.key==='Escape')c(null);else%20if(e.key==='Enter'&&iEl&&iEl===document.activeElement){e.preventDefault();c(iEl.value.trim());}};%20document.addEventListener('keydown',k);%20document.getElementById('qt-token-ok'+V_SUFFIX).onclick=()=%3Ec(iEl?iEl.value.trim():'');%20document.getElementById('qt-token-cancel'+V_SUFFIX).onclick=()=%3Ec(null);%20document.getElementById('qt-token-skip'+V_SUFFIX).onclick=()=%3Ec('_QT_SKIP_');%20});%20}%20%20function%20createQuerySetupDialog(currentApiKey){%20return%20new%20Promise(resolve=%3E{%20let%20selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;%20const%20btns=QUERYABLE_FIELD_DEFINITIONS.map(d=%3E%60%3Cbutton%20class=%22qt-querytype-btn${V_SUFFIX}%22%20data-apikey=%22${d.queryApiKey}%22%20style=%22background-color:${d.color};color:white;border:2px%20solid%20transparent;padding:5px%200;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all%200.15s%20ease;height:26px;line-height:1.2;%22%3E${escapeHtml(d.queryDisplayName)}%3C/button%3E%60).join('');%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:15px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%3C/h3%3E%3Cdiv%20id=%22qt-querytype-buttons${V_SUFFIX}%22%20style=%22display:flex;gap:4px;margin-bottom:8px;%22%3E${btns}%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);min-height:45px;padding:6px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%22%3E%3C/textarea%3E%3Cdiv%20style=%22display:flex;justify-content:space-between;align-items:center;%22%3E%3Cbutton%20id=%22qt-import-csv-btn${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%20style=%22margin-left:0;%22%3E%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-querysetup-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E6%9F%A5%E8%A9%A2%3C/button%3E%3C/div%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-csv-file-input${V_SUFFIX}%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;%20const{overlay,dialog}=createDialogBase('qtQuerySetupDialog'+V_SUFFIX,html,'380px','580px');%20const%20qvInput=document.getElementById('qt-queryvalues-input'+V_SUFFIX);%20const%20typeBtns=dialog.querySelectorAll('.qt-querytype-btn'+V_SUFFIX);%20const%20csvFileInput=document.getElementById('qt-csv-file-input'+V_SUFFIX);%20const%20importCsvBtn=document.getElementById('qt-import-csv-btn'+V_SUFFIX);%20%20function%20setAB(apiKey){%20typeBtns.forEach(b=%3E{%20const%20isSel=b.dataset.apikey===apiKey;%20b.style.borderColor=isSel?b.style.backgroundColor:'transparent';%20b.style.boxShadow=isSel?%600%200%200%201.5px%20#fff,%200%200%200%203px%20${b.style.backgroundColor}%60:'none';%20b.style.filter=isSel?'brightness(1.12)':'brightness(1)';%20if(isSel){%20const%20selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);%20if(qvInput&&selDef)qvInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selDef.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E3%80%81%E5%88%86%E8%99%9F%E6%88%96%E6%8F%9B%E8%A1%8C%E5%88%86%E9%9A%94)%60;%20}%20b.onmouseover=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(0.95)';};%20b.onmouseout=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(1)';};%20});%20}%20%20typeBtns.forEach(b=%3E{%20if(b)b.onclick=()=%3E{%20selApiKey=b.dataset.apikey;%20setAB(selApiKey);%20if(qvInput)qvInput.focus();%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20typeBtns.forEach(tb=%3Etb.disabled=false);%20};%20});%20%20if(selApiKey)setAB(selApiKey);%20else%20if(QUERYABLE_FIELD_DEFINITIONS.length%3E0){%20selApiKey=QUERYABLE_FIELD_DEFINITIONS[0].queryApiKey;%20setAB(selApiKey);%20}%20%20if(importCsvBtn)importCsvBtn.onclick=()=%3EcsvFileInput?.click();%20%20if(csvFileInput)csvFileInput.onchange=e=%3E{%20const%20file=e.target.files[0];%20if(file){%20const%20reader=new%20FileReader();%20reader.onload=re=%3E{%20try{%20const%20text=re.target.result;%20const%20lines=text.split(/\r?\n/);%20if(lines.length%3E1){%20let%20keysFromCsv=[];%20importedCSVRawData=[];%20for(let%20i=1;i%3Clines.length;i++){%20const%20currentLineContent=lines[i];%20if(currentLineContent.trim()==='')continue;%20try{%20const%20cols=currentLineContent.split(',');%20const%20keyVal=cols[1];%20const%20key=(typeof%20keyVal==='string')?keyVal.trim().toUpperCase():'';%20if(key){%20keysFromCsv.push(key);%20let%20csvRowData={_originalCsvLineNumber:i+1};%20A17_CSV_DATA_DISPLAY_HEADERS.forEach((h,headerIdx)=%3E{%20const%20colCsvIdx=headerIdx+1;%20const%20colValFromCsv=cols[colCsvIdx];%20csvRowData[h]=(typeof%20colValFromCsv==='string')?colValFromCsv.trim():'';%20});%20importedCSVRawData.push(csvRowData);%20}%20}catch(lineErr){%20console.error(%60CSV%20Line%20${i+1}%20Parsing%20Error:%60,lineErr,%22Line%20content:%22,currentLineContent);%20displaySystemNotification(%60CSV%20%E7%AC%AC%20${i+1}%20%E8%A1%8C%E8%A7%A3%E6%9E%90%E5%A4%B1%E6%95%97%EF%BC%8C%E5%B7%B2%E8%B7%B3%E9%81%8E%E3%80%82%60,true,4000);%20}%20}%20if(keysFromCsv.length%3E0){%20selApiKey='receiptNumber';%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===selApiKey);%20if(selectedQueryDefinitionGlobal)setAB(selApiKey);%20typeBtns.forEach(tb=%3Etb.disabled=true);%20if(qvInput)qvInput.value=keysFromCsv.join('\n');%20currentTableInstance.isCSVImportModeGlobal=true;%20displaySystemNotification(%60%E5%B7%B2%E5%BE%9ECSV%E5%8C%AF%E5%85%A5%20${keysFromCsv.length}%20%E5%80%8B${selectedQueryDefinitionGlobal?selectedQueryDefinitionGlobal.queryDisplayName:'KEY'}%60,false);%20}else{%20displaySystemNotification('CSV%E6%9C%AA%E5%90%AB%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E9%8D%B5(%E7%AC%AC2%E6%AC%84)%E6%88%96%E8%B3%87%E6%96%99%E4%B8%8D%E8%B6%B3%20(%E5%B7%B2%E8%B7%B3%E9%81%8E%E8%A1%A8%E9%A0%AD).',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}else{%20displaySystemNotification('CSV%E7%82%BA%E7%A9%BA%E6%88%96%E5%83%85%E5%90%AB%E8%A1%A8%E9%A0%AD%E8%A1%8C',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}catch(globalParseErr){%20console.error(%22CSV%20Global%20File%20Processing%20Error:%22,globalParseErr);%20displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E6%95%B4%E9%AB%94%E8%99%95%E7%90%86%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E6%AA%94%E6%A1%88',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20};%20reader.onerror=()=%3EdisplaySystemNotification('%E8%AE%80%E5%8F%96%E6%AA%94%E6%A1%88%E5%A4%B1%E6%95%97',true);%20reader.readAsText(file,'Big5');%20}%20if(e.target)e.target.value=null;%20};%20%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20};%20%20document.addEventListener('keydown',k);%20%20const%20okSetupBtn=document.getElementById('qt-querysetup-ok'+V_SUFFIX);%20if(okSetupBtn)okSetupBtn.onclick=()=%3E{%20const%20vs=qvInput?qvInput.value.trim():'';%20if(!selApiKey&&!currentTableInstance.isCSVImportModeGlobal){%20displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E9%A1%9E%E5%9E%8B%E6%88%96%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88',true);%20return;%20}%20if(!vs){%20displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',true);%20if(qvInput)qvInput.focus();%20return;%20}%20c({selectedApiKey:selApiKey,queryValues:vs,csvImported:currentTableInstance.isCSVImportModeGlobal});%20};%20%20const%20cancelSetupBtn=document.getElementById('qt-querysetup-cancel'+V_SUFFIX);%20if(cancelSetupBtn)cancelSetupBtn.onclick=()=%3Ec(null);%20});%20}%20%20function%20createEnvSelectionDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20opts=[{idValue:'test',buttonText:'%E6%B8%AC%E8%A9%A6%20(UAT)',colorOverride:'#27ae60'},{idValue:'prod',buttonText:'%E6%AD%A3%E5%BC%8F%20(PROD)',colorOverride:'#d35400'}];%20const%20html=%60%3Ch3%20style=%22margin:0%200%2010px%200;color:#333;font-size:16px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;flex-wrap:wrap;gap:8px;justify-content:center;%22%3E${opts.map(opt=%3E%60%3Cbutton%20class=%22qt-env-sel-btn%22%20data-value=%22${escapeHtml(opt.idValue)}%22%20style=%22background:${opt.colorOverride};color:white;border:none;padding:10px%208px;border-radius:5px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0%201px%204px%20rgba(0,0,0,0.1);transition:opacity%200.15s%20ease;margin:3px;min-width:100px;flex-grow:1;%22%3E${escapeHtml(opt.buttonText)}%3C/button%3E%60).join('')}%3C/div%3E%60;%20const{overlay,dialog}=createDialogBase('qtEnvSelectDialog'+V_SUFFIX,html);%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20else%20if(e.key==='Enter'){%20e.preventDefault();%20c('prod');%20}%20};%20document.addEventListener('keydown',k);%20dialog.querySelectorAll('.qt-env-sel-btn').forEach(b=%3E{%20if(b){%20b.onclick=()=%3Ec(b.dataset.value);%20b.onmouseover=()=%3Eb.style.opacity='0.85';%20b.onmouseout=()=%3Eb.style.opacity='1';%20}%20});%20});%20}%20%20const%20extractName=strVal=%3E{%20if(!strVal||typeof%20strVal!=='string')return'';%20const%20m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);%20return%20m?m[0]:strVal.split('%20')[0];%20};%20%20async%20function%20performApiQuery(queryValue,isFromCSVNoRetry){%20let%20maxAttempts=isFromCSVNoRetry?1:2;%20let%20currentAttempt=0;%20let%20responseData=null,statusCode=0,success=false;%20while(currentAttempt%3CmaxAttempts&&!success){%20currentAttempt++;%20try{%20const%20reqBody={currentPage:1,pageSize:10};%20reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;%20const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};%20if(apiAuthToken){%20fetchOpts.headers['SSO-TOKEN']=apiAuthToken;%20}%20const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);%20statusCode=res.status;%20responseData=await%20res.json();%20if(statusCode===401){%20displaySystemNotification('TOKEN%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F',true);%20apiAuthToken=null;%20localStorage.removeItem(TOKEN_STORAGE_KEY);%20return{error:'token_invalid',data:null};%20}%20success=true;%20}catch(e){%20console.error(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20(%E7%AC%AC${currentAttempt}%E6%AC%A1)%20%E5%A4%B1%E6%95%97:%60,e);%20if(currentAttempt%3CmaxAttempts){%20displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E5%A4%B1%E6%95%97%EF%BC%8C2%E7%A7%92%E5%BE%8C%E9%87%8D%E8%A9%A6...%60,true,1500);%20await%20sleep(2000);%20}else{%20return{error:'network_error',data:null};%20}%20}%20}%20return{error:null,data:responseData,success:success&&responseData&&responseData.records&&responseData.records.length%3E0};%20}%20%20async%20function%20executeCaseQueryTool(){%20const%20mainContainerId='qtMainContainer'+V_SUFFIX;%20if(document.getElementById(mainContainerId)){%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',true);%20return;%20}%20const%20selectedEnv=await%20createEnvSelectionDialog();%20if(!selectedEnv){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;%20displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv==='prod'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%60);%20if(!apiAuthToken){%20const%20tokenRes=await%20createTokenDialog();%20if(tokenRes===null){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20if(tokenRes==='_QT_SKIP_'){%20displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5',false);%20apiAuthToken=null;%20}else%20if(!tokenRes){%20displaySystemNotification('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2',true);%20return;%20}else{%20apiAuthToken=tokenRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20}%20const%20querySetupRes=await%20createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);%20if(!querySetupRes){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupRes.selectedApiKey);%20const%20queryValuesRaw=querySetupRes.queryValues;%20let%20queryValues;%20if(selectedQueryDefinitionGlobal.queryApiKey==='policyNumber'){%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}else{%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}%20currentTableInstance.isCSVImportModeGlobal=!!querySetupRes.csvImported;%20if(queryValues.length===0){%20displaySystemNotification(%60%E6%9C%AA%E8%BC%B8%E5%85%A5/%E5%8C%AF%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC%60,true);%20return;%20}%20const%20loadingOverlay=document.createElement('div');%20loadingOverlay.id='qtLoadingOverlay'+V_SUFFIX;%20loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:%22Microsoft%20JhengHei%22,Arial,sans-serif;%60;%20const%20loadingP=document.createElement('p');%20loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';%20const%20loadingDiv=document.createElement('div');%20loadingDiv.style.cssText='background:#fff;padding:20px%2025px;border-radius:7px;text-align:center;box-shadow:0%203px%2012px%20rgba(0,0,0,0.1);';%20loadingDiv.innerHTML=%60%3Cdiv%20style=%22width:30px;height:30px;border:3px%20solid%20#e0e0e0;border-top:3px%20solid%20#007bff;border-radius:50%;animation:qtSpinAnimationFull%201s%20linear%20infinite;margin:0%20auto%2010px;%22%3E%3C/div%3E%60;%20loadingDiv.appendChild(loadingP);%20loadingOverlay.appendChild(loadingDiv);%20document.body.appendChild(loadingOverlay);%20const%20loadingStyle=document.createElement('style');%20loadingStyle.textContent='@keyframes%20qtSpinAnimationFull{to{transform:rotate(360deg)}}';%20document.head.appendChild(loadingStyle);%20let%20fetchedResultsCollector=[];%20let%20currentCounter=1;%20for(let%20i=0;i%3CqueryValues.length;i++){%20const%20singleQueryValue=queryValues[i];%20loadingP.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD:%20%E7%AC%AC%20${i+1}%20/%20${queryValues.length}%20%E7%AD%86%20(${singleQueryValue})...%60;%20const%20resultRowBase={'NO':String(currentCounter++),[SPECIAL_QUERIED_VALUE_KEY]:singleQueryValue};%20if(currentTableInstance.isCSVImportModeGlobal&&importedCSVRawData&&importedCSVRawData[i]){%20resultRowBase._csvData=JSON.parse(JSON.stringify(importedCSVRawData[i]));%20}%20const%20apiResult=await%20performApiQuery(singleQueryValue,currentTableInstance.isCSVImportModeGlobal);%20let%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';%20if(apiResult.error==='token_invalid'){%20apiQueryStatus='%E2%9C%97%20TOKEN%E5%A4%B1%E6%95%88';%20loadingOverlay.remove();%20const%20tokenRetryRes=await%20createTokenDialog();%20if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){%20apiAuthToken=null;%20displaySystemNotification(tokenRetryRes===null?'%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88':'TOKEN%E6%9C%AA%E6%9B%B4%E6%96%B0/%E7%95%A5%E9%81%8E',true);%20if(tokenRetryRes===null){%20if(loadingStyle)loadingStyle.remove();%20return;%20}%20}else{%20apiAuthToken=tokenRetryRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';%20else%20document.body.appendChild(loadingOverlay);%20}else%20if(apiResult.success){%20apiQueryStatus='%E2%9C%93%20%E6%88%90%E5%8A%9F';%20}else%20if(!apiResult.error){%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99';%20}%20resultRowBase._apiQueryStatus=apiQueryStatus;%20if(apiResult.success&&apiResult.data.records){%20apiResult.data.records.forEach(rec=%3E{%20const%20popRow={...resultRowBase};%20const%20mainStatusVal=rec['mainStatus']||'';%20const%20subStatusVal=rec['subStatus']||'';%20popRow['_raw_mainStatus_']=mainStatusVal;%20popRow['_raw_subStatus_']=subStatusVal;%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20let%20cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);%20if(dKey==='statusCombined'){%20popRow[dN]=%60%3Cspan%20class=%22qt-status-main%22%3E${escapeHtml(mainStatusVal)}%3C/span%3E%3Cspan%20class=%22qt-status-sub%22%3E${escapeHtml(subStatusVal)}%3C/span%3E%60;%20}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){%20const%20uVal=cVal;%20let%20uPre='';%20for(let%20k=0;k%3CuVal.length;k++){%20if(/[A-Za-z]/.test(uVal.charAt(k))){%20uPre=uVal.charAt(k).toUpperCase();%20break;%20}%20}%20const%20mName=UNIT_CODE_MAPPINGS[uPre]||uVal;%20popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName;%20}else%20if(dKey===APPROVER_FIELD_API_KEY||dKey===APPROVAL_USER_FIELD_API_KEY){%20popRow[dN]=extractName(cVal);%20}else{%20popRow[dN]=cVal;%20}%20});%20popRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(popRow);%20});%20}else{%20const%20failOrEmptyRow={...resultRowBase};%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20if(dKey==='statusCombined'){%20failOrEmptyRow['_raw_mainStatus_']='-';%20failOrEmptyRow['_raw_subStatus_']='';%20failOrEmptyRow[dN]='-';%20}else{%20failOrEmptyRow[dN]='-';%20}%20});%20if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){%20failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue;%20}%20failOrEmptyRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(failOrEmptyRow);%20}%20if(queryValues.length%3E1&&i%3CqueryValues.length-1)await%20sleep(250);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.remove();%20if(loadingStyle)loadingStyle.remove();%20originalQueryResults=[...fetchedResultsCollector];%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90',false);%20}%20%20try{%20await%20executeCaseQueryTool();%20}catch(error){%20console.error('%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:',error);%20displaySystemNotification('%E5%B7%A5%E5%85%B7%E5%9F%B7%E8%A1%8C%E5%A4%B1%E6%95%97',true);%20}%20})();

javascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',TOKEN_STORAGE_KEY='euisToken',Z_INDEX_DIALOG=2147483640,Z_INDEX_MAIN_UI=2147483630,Z_INDEX_NOTIFICATION=2147483647;let CURRENT_API_URL='',apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY),selectedQueryDefinitionGlobal=null,originalQueryResults=[],baseA17MasterData=[],isEditMode=false,currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,isCSVImportModeGlobal:false},a17ModeState={isActive:false,selectedUnits:new Set(),sortedData:[]},csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}],ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'],FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8'},UNIT_MAP_FIELD_API_KEY='uwApproverUnit',UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'},A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1',color:'#546e7a'}],A17_CSV_DISPLAY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B'],A17_API_DATA_DISPLAY_HEADERS=['%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1'],A17_COPY_ONLY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','',''],A17_PARA1=%22%E6%82%A8%E5%A5%BD%EF%BC%8C%22,A17_PARA2_TEMPLATE=%22%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9AA17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E6%9C%AC%E9%80%B1%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82%22,A17_PARA3=%22%E7%B6%93%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E6%AF%94%E5%B0%8D%E5%BE%8C%EF%BC%8C%E8%A9%B2%E7%AD%89%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;let%20textSettings={content:A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3,fontSize:10.5,lineHeight:1.5};function%20loadTextSettings(){const%20saved=localStorage.getItem('qt_a17_text_settings');if(saved)try{textSettings={...textSettings,...JSON.parse(saved)}}catch(e){}}function%20saveTextSettings(){localStorage.setItem('qt_a17_text_settings',JSON.stringify(textSettings))}function%20escapeHtml(s){return%20s===undefined||s===null?'':String(s).replace(/[&%3C%22']/g,m=%3E({'&':'&','%3C':'%3C','%22':'%22',%22'%22:'&#039;'})[m])}function%20displaySystemNotification(msg,err,dur=2000){const%20nId='qtNotif_vFinal';document.getElementById(nId)?.remove();const%20n=document.createElement('div');n.id=nId;n.style.cssText=%60position:fixed;top:10px;right:10px;background:${err?'#c0392b':'#27ae60'};color:white;padding:6px%209px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:12px;transform:translateX(calc(100%%20+%2015px));transition:transform%200.25s;box-shadow:0%201px%205px%20rgba(0,0,0,0.12);font-family:'Microsoft%20JhengHei',Arial,sans-serif;%60;n.innerHTML=%60${err?'&#x26A0;':'&#x2714;'}%20%3Cspan%3E${escapeHtml(msg)}%3C/span%3E%60;document.body.appendChild(n);setTimeout(()=%3En.style.transform='translateX(0)',20);setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2015px))';setTimeout(()=%3En.remove(),250)},dur)}function%20createDialogBase(id,contentHtml,minWidth='320px',maxWidth='480px'){document.getElementById(id)?.remove();const%20d=document.createElement('div');d.id=id;d.style.cssText=%60position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:8px;box-shadow:0%208px%2032px%20rgba(0,0,0,0.2);min-width:${minWidth};max-width:${maxWidth};z-index:${Z_INDEX_DIALOG};font-family:'Microsoft%20JhengHei',Arial,sans-serif;%60;d.innerHTML=contentHtml+%60%3Cstyle%3E.qt-dialog-btn-final{border:none;padding:8px%2016px;border-radius:4px;font-size:13px;cursor:pointer;font-weight:500;transition:all%200.2s%20ease;margin-left:4px}.qt-dialog-btn-final:hover{opacity:0.8}.qt-dialog-btn-blue{background:#007bff;color:white}.qt-dialog-btn-grey{background:#6c757d;color:white}.qt-dialog-btn-orange{background:#fd7e14;color:white}%3C/style%3E%60;document.body.appendChild(d);return{dialog:d}}function%20extractName(strVal){if(!strVal||typeof%20strVal!=='string')return'';const%20m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);return%20m?m[0]:strVal.split('%20')[0]}function%20createEnvSelectionDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2010px%200;color:#333;font-size:16px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;gap:8px;justify-content:center;%22%3E%3Cbutton%20class=%22qt-env-btn%22%20data-v=%22test%22%20style=%22background:#27ae60;color:white;padding:10px%2016px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%3Cbutton%20class=%22qt-env-btn%22%20data-v=%22prod%22%20style=%22background:#d35400;color:white;padding:10px%2016px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtEnvSelDialog',html);dialog.querySelectorAll('.qt-env-btn').forEach(b=%3E{b.onmouseover=()=%3Eb.style.opacity='0.8';b.onmouseout=()=%3Eb.style.opacity='1';b.onclick=()=%3E{dialog.remove();resolve(b.dataset.v)}})})}function%20createTokenDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2012px%200;color:#333;font-size:16px;text-align:center;font-weight:600;%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input%22%20style=%22width:100%;padding:8px;border:1px%20solid%20#ddd;border-radius:4px;font-size:14px;margin-bottom:12px;color:#333;box-sizing:border-box;outline:none;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;gap:8px;%22%3E%3Cbutton%20id=%22qt-token-skip%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20id=%22qt-token-cancel%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-token-ok%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtTokenDialog_final',html,'320px','400px');setTimeout(()=%3E{const%20inputEl=document.getElementById('qt-token-input');if(inputEl)inputEl.focus()},100);const%20cleanup=value=%3E{document.removeEventListener('keydown',keyHandler);dialog.remove();resolve(value)};const%20keyHandler=e=%3E{if(e.key==='Escape'){cleanup(null)}else%20if(e.key==='Enter'){e.preventDefault();const%20inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')}};document.addEventListener('keydown',keyHandler);document.getElementById('qt-token-ok').onclick=()=%3E{const%20inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')};document.getElementById('qt-token-cancel').onclick=()=%3Ecleanup(null);document.getElementById('qt-token-skip').onclick=()=%3Ecleanup('_QT_SKIP_')})}function%20createQuerySetupDialog(currentApiKey){return%20new%20Promise(resolve=%3E{let%20selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;const%20btns=QUERYABLE_FIELD_DEFINITIONS.map(d=%3E%60%3Cbutton%20class=%22qt-querytype-btn-final%22%20data-apikey=%22${d.queryApiKey}%22%20style=%22background-color:${d.color};color:white;border:2px%20solid%20transparent;padding:5px%200;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all%200.15s%20ease;height:26px;line-height:1.2;%22%3E${escapeHtml(d.queryDisplayName)}%3C/button%3E%60).join('');const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:15px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%3C/h3%3E%3Cdiv%20id=%22qt-querytype-buttons-final%22%20style=%22display:flex;gap:4px;margin-bottom:8px;%22%3E${btns}%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input-final%22%20style=%22width:100%;min-height:45px;padding:6px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;box-sizing:border-box;%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%22%3E%3C/textarea%3E%3Cdiv%20style=%22display:flex;justify-content:space-between;align-items:center;gap:8px;%22%3E%3Cbutton%20id=%22qt-clear-input-btn%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E6%B8%85%E9%99%A4%3C/button%3E%3Cbutton%20id=%22qt-import-csv-btn%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-cancel-final%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok-final%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E8%AA%8D%3C/button%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-csv-file-input%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;const{dialog}=createDialogBase('qtQuerySetupDialog_final',html,'420px','600px');const%20qvInput=document.getElementById('qt-queryvalues-input-final');const%20typeBtns=dialog.querySelectorAll('.qt-querytype-btn-final');const%20csvFileInput=document.getElementById('qt-csv-file-input');const%20importCsvBtn=document.getElementById('qt-import-csv-btn');function%20setActiveButton(apiKey){typeBtns.forEach(b=%3E{const%20isSel=b.dataset.apikey===apiKey;b.style.borderColor=isSel?b.style.backgroundColor:'transparent';b.style.boxShadow=isSel?%600%200%200%201.5px%20#fff,%200%200%200%203px%20${b.style.backgroundColor}%60:'none';b.style.filter=isSel?'brightness(1.12)':'brightness(1)';if(isSel){const%20selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);qvInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selDef.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E3%80%81%E5%88%86%E8%99%9F%E6%88%96%E6%8F%9B%E8%A1%8C%E5%88%86%E9%9A%94)%60}})}typeBtns.forEach(b=%3E{b.onclick=()=%3E{selApiKey=b.dataset.apikey;setActiveButton(selApiKey);qvInput.focus()}});setActiveButton(selApiKey);document.getElementById('qt-clear-input-btn').onclick=()=%3E{qvInput.value='';const%20csvColSel=document.getElementById('qt-csv-col-sel');if(csvColSel){csvColSel.parentElement.remove()}currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const%20csvFileInput=document.getElementById('qt-csv-file-input');if(csvFileInput){csvFileInput.value=''}if(selApiKey){setActiveButton(selApiKey)}qvInput.focus();displaySystemNotification('%E5%B7%B2%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E5%8C%AF%E5%85%A5%E8%B3%87%E6%96%99',false)};importCsvBtn.onclick=()=%3EcsvFileInput.click();csvFileInput.onchange=e=%3E{const%20file=e.target.files[0];if(!file)return;const%20reader=new%20FileReader();reader.onload=re=%3E{try{const%20text=re.target.result;const%20lines=text.split(/\r?\n/).filter(l=%3El.trim()!==%22%22);if(lines.length%3C2){displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E8%B3%87%E6%96%99%E4%B8%8D%E8%B6%B3',true);return}currentTableInstance.isCSVImportModeGlobal=true;csvImportState.isImported=true;csvImportState.fileName=file.name;const%20headers=lines[0].split(/,|;|\t/).map(h=%3Eh.trim());csvImportState.headers=headers;csvImportState.csvHeaders=headers;const%20oldSelector=document.getElementById('qt-csv-col-sel');if(oldSelector){oldSelector.parentElement.remove()}let%20selectHtml=%60%3Cdiv%20style=%22margin-bottom:8px;%22%3E%3Clabel%20style=%22font-weight:bold;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E4%BE%9D%E6%93%9A%E6%AC%84%E4%BD%8D%EF%BC%9A%3C/label%3E%3Cselect%20id=%22qt-csv-col-sel%22%20style=%22margin:0%208px%208px%200;%22%3E%60;headers.forEach((h,idx)=%3EselectHtml+=%60%3Coption%20value=%22${idx}%22%3E${h}%3C/option%3E%60);selectHtml+=%60%3C/select%3E%3Cspan%20style=%22font-size:11px;color:#666;%22%3E(%E6%AA%94%E6%A1%88:%20${file.name})%3C/span%3E%3C/div%3E%60;qvInput.insertAdjacentHTML('beforebegin',selectHtml);const%20colSel=document.getElementById('qt-csv-col-sel');function%20fillInputByCol(colIdx){const%20values=[];for(let%20i=1;i%3Clines.length;i++){const%20cols=lines[i].split(/,|;|\t/);if(cols[colIdx]&&cols[colIdx].trim()!==%22%22)values.push(cols[colIdx].trim())}const%20uniq=Array.from(new%20Set(values));qvInput.value=uniq.join('\n');csvImportState.selectedColumn=colIdx}colSel.onchange=()=%3EfillInputByCol(Number(colSel.value));fillInputByCol(0);displaySystemNotification('CSV%E5%8C%AF%E5%85%A5%E6%88%90%E5%8A%9F%EF%BC%8C%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E4%BE%9D%E6%93%9A%E6%AC%84%E4%BD%8D',false)}catch(err){displaySystemNotification('CSV%E8%A7%A3%E6%9E%90%E5%A4%B1%E6%95%97',true)}};reader.onerror=()=%3EdisplaySystemNotification('%E8%AE%80%E5%8F%96%E6%AA%94%E6%A1%88%E5%A4%B1%E6%95%97',true);reader.readAsText(file,'utf-8');e.target.value=null};document.getElementById('qt-querysetup-ok-final').onclick=()=%3E{const%20vs=qvInput.value.trim();if(!selApiKey){displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E9%A1%9E%E5%9E%8B',true);return}if(!vs){displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',true);qvInput.focus();return}dialog.remove();resolve({selectedApiKey:selApiKey,queryValues:vs})};document.getElementById('qt-querysetup-cancel-final').onclick=()=%3E{dialog.remove();resolve(null)}})}function%20createTextSettingDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2015px%200;color:#333;font-size:16px;text-align:center;font-weight:600;%22%3EA17%20%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin-bottom:12px;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9%EF%BC%9A%3C/label%3E%3Ctextarea%20id=%22qt-text-content%22%20style=%22width:100%;height:120px;padding:8px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;resize:vertical;font-family:'Microsoft%20JhengHei',Arial,sans-serif;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%20A17%20%E9%80%9A%E7%9F%A5%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9...%22%3E${escapeHtml(textSettings.content)}%3C/textarea%3E%3C/div%3E%3Cdiv%20style=%22display:flex;gap:15px;margin-bottom:15px;%22%3E%3Cdiv%20style=%22flex:1;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F%EF%BC%9A%3C/label%3E%3Cinput%20type=%22number%22%20id=%22qt-font-size%22%20style=%22width:100%;padding:6px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;%22%20value=%22${textSettings.fontSize}%22%20min=%228%22%20max=%2224%22%20step=%220.5%22%3E%3Csmall%20style=%22color:#666;%22%3Ept%3C/small%3E%3C/div%3E%3Cdiv%20style=%22flex:1;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E8%A1%8C%E9%AB%98%EF%BC%9A%3C/label%3E%3Cinput%20type=%22number%22%20id=%22qt-line-height%22%20style=%22width:100%;padding:6px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;%22%20value=%22${textSettings.lineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%3E%3Csmall%20style=%22color:#666;%22%3E%E5%80%8D%E6%95%B8%3C/small%3E%3C/div%3E%3C/div%3E%3Cdiv%20style=%22background:#f8f9fa;padding:10px;border-radius:4px;margin-bottom:15px;%22%3E%3Cdiv%20style=%22font-size:11px;color:#666;margin-bottom:5px;%22%3E%E9%A0%90%E8%A6%BD%E6%95%88%E6%9E%9C%EF%BC%9A%3C/div%3E%3Cdiv%20id=%22qt-text-preview%22%20style=%22font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};color:#333;max-height:80px;overflow-y:auto;border:1px%20solid%20#e9ecef;padding:8px;background:white;border-radius:3px;%22%3E${escapeHtml(textSettings.content.substring(0,100))}...%3C/div%3E%3C/div%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;gap:8px;%22%3E%3Cbutton%20id=%22qt-text-reset%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E9%87%8D%E8%A8%AD%3C/button%3E%3Cbutton%20id=%22qt-text-cancel%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-text-save%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E5%AD%98%E6%AA%94%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtTextSettingDialog_final',html,'480px','600px');function%20updatePreview(){const%20content=document.getElementById('qt-text-content').value;const%20fontSize=document.getElementById('qt-font-size').value;const%20lineHeight=document.getElementById('qt-line-height').value;const%20preview=document.getElementById('qt-text-preview');preview.style.fontSize=fontSize+'pt';preview.style.lineHeight=lineHeight;preview.textContent=content.substring(0,100)+(content.length%3E100?'...':'')}setTimeout(()=%3E{document.getElementById('qt-text-content').addEventListener('input',updatePreview);document.getElementById('qt-font-size').addEventListener('input',updatePreview);document.getElementById('qt-line-height').addEventListener('input',updatePreview)},100);document.getElementById('qt-text-save').onclick=()=%3E{const%20newSettings={content:document.getElementById('qt-text-content').value.trim(),fontSize:parseFloat(document.getElementById('qt-font-size').value),lineHeight:parseFloat(document.getElementById('qt-line-height').value)};if(!newSettings.content){displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9',true);return}textSettings=newSettings;saveTextSettings();displaySystemNotification('%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%B7%B2%E4%BF%9D%E5%AD%98',false);dialog.remove();resolve(true)};document.getElementById('qt-text-cancel').onclick=()=%3E{dialog.remove();resolve(false)};document.getElementById('qt-text-reset').onclick=()=%3E{document.getElementById('qt-text-content').value=A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3;document.getElementById('qt-font-size').value=10.5;document.getElementById('qt-line-height').value=1.5;updatePreview()}})}async%20function%20performApiQuery(queryValue){const%20reqBody={currentPage:1,pageSize:10};reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};if(apiAuthToken){fetchOpts.headers['SSO-TOKEN']=apiAuthToken}try{const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);const%20data=await%20res.json();if(res.status===401){displaySystemNotification('TOKEN%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F',true);return{error:'token_invalid',data:null}}return{error:null,data:data,success:data&&data.records&&data.records.length%3E0}}catch(e){console.error('%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97:',e);return{error:'network_error',data:null}}}function%20getFirstLetter(unitString){if(!unitString||typeof%20unitString!=='string')return'Z';for(let%20i=0;i%3CunitString.length;i++){const%20char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char)){return%20char}}return'Z'}function%20filterDataByUnit(data,unitId){if(unitId==='UNDEF'){const%20knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=%3Eb.id!=='UNDEF').map(b=%3Eb.id.toUpperCase());return%20data.filter(r=%3E{const%20uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return%20uVal.trim()===''||!knownPrefixes.some(prefix=%3EuVal.toUpperCase().startsWith(prefix))})}else{return%20data.filter(r=%3E{const%20uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return%20uVal.toUpperCase().startsWith(unitId.toUpperCase())})}}function%20createA17UnitButtons(){const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(!a17BtnsCtr)return;a17BtnsCtr.style.cssText='margin-bottom:5px;display:flex;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;visibility:visible;';a17BtnsCtr.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{const%20btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:5px%204px;border-radius:3px;cursor:pointer;font-size:9px;transition:all%200.2s%20ease;width:calc((100vw%20-%20320px)%20/%208);min-width:70px;max-width:90px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;%60;btn.textContent=%60${unitDef.label}%20(0)%60;btn.onclick=()=%3E{if(btn.disabled)return;const%20unitId=unitDef.id;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow='0%200%200%202px%20white,%200%200%200%204px%20black'}if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification(%60%E5%B7%B2%E9%81%B8%E6%93%87%20${a17ModeState.selectedUnits.size}%20%E5%80%8B%E5%96%AE%E4%BD%8D%60,false)};a17BtnsCtr.appendChild(btn)})}function%20filterA17DataBySelectedUnits(){let%20filteredData=[];a17ModeState.selectedUnits.forEach(unitId=%3E{let%20unitData=filterDataByUnit(baseA17MasterData,unitId);filteredData=filteredData.concat(unitData)});filteredData.sort((a,b)=%3E{const%20unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20firstLetterA=getFirstLetter(unitA);const%20firstLetterB=getFirstLetter(unitB);return%20firstLetterA.localeCompare(firstLetterB)});window.pTBRs(filteredData)}function%20updateA17UnitButtonCounts(){if(!a17ModeState.isActive)return;const%20unitCounts={};baseA17MasterData.forEach(r=%3E{const%20unitFull=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');let%20unitPrefix='UNDEF';for(const%20code%20in%20UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()===''){unitPrefix='UNDEF'}unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});const%20buttons=document.getElementById('qt-a17-unit-btns-ctr-final')?.querySelectorAll('button')||[];buttons.forEach(btn=%3E{const%20unitId=btn.dataset.unitId;const%20count=unitCounts[unitId]||0;const%20unitDef=A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label}%20(${count})%60;if(count===0){btn.disabled=true;btn.style.opacity='0.5';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.disabled=false;btn.style.opacity='1'}}});if(a17ModeState.selectedUnits.size===0){window.pTBRs(baseA17MasterData)}}function%20generateAndCopyA17NotificationWithSettings(dataToCopy,headers,withText){loadTextSettings();const%20htmlRows=dataToCopy.map((r,idx)=%3E%60%3Ctr%20style=%22${idx%2?'background-color:#fdfdfd;':'#f7f7f7'}%22%3E${headers.map(h=%3E{let%20cellTxt='';if(h===''){cellTxt=''}else{cellTxt=escapeHtml(String(r[h]||''))}return%60%3Ctd%20style=%22border:1px%20solid%20#bbb;padding:3px%204px;text-align:center;font-size:${textSettings.fontSize}pt;color:#333;%22%3E${cellTxt}%3C/td%3E%60}).join('')}%3C/tr%3E%60).join('');const%20htmlTab=%60%3Ctable%20style=%22border-collapse:collapse;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;width:100%;margin-top:8px;%22%3E%3Cthead%3E%3Ctr%20style=%22background-color:#34495e;color:white;%22%3E${headers.map(h=%3E%60%3Cth%20style=%22border:1px%20solid%20#2c3e50;padding:4px;text-align:center;font-weight:bold;%22%3E${escapeHtml(h)}%3C/th%3E%60).join('')}%3C/tr%3E%3C/thead%3E%3Ctbody%3E${htmlRows}%3C/tbody%3E%3C/table%3E%60;const%20htmlOut=withText?%60%3Cdiv%20style=%22font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};%22%3E${textSettings.content.split('\n').map(line=%3E%60%3Cp%3E${escapeHtml(line)}%3C/p%3E%60).join('')}${htmlTab}%3C/div%3E%60:htmlTab;const%20plainRows=dataToCopy.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');const%20plainOut=withText?textSettings.content+'\n\n'+headers.join('\t')+'\n'+plainRows:headers.join('\t')+'\n'+plainRows;try{navigator.clipboard.write([new%20ClipboardItem({'text/html':new%20Blob([htmlOut],{type:'text/html'}),'text/plain':new%20Blob([plainOut],{type:'text/plain'})})]).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%20A17%20%E9%80%9A%E7%9F%A5%E5%85%A7%E5%AE%B9',false)})}catch(e){navigator.clipboard.writeText(plainOut).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%20A17%20%E9%80%9A%E7%9F%A5%E5%85%A7%E5%AE%B9',false)})}}function%20executeA17SortAndFilter(){if(!a17ModeState.isActive){a17ModeState.isActive=true;currentTableInstance.isA17Mode=true;const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='flex'}baseA17MasterData=[...originalQueryResults];let%20a17Headers;if(currentTableInstance.isCSVImportModeGlobal&&csvImportState.csvHeaders.length%3E0){a17Headers=[...csvImportState.csvHeaders,...A17_API_DATA_DISPLAY_HEADERS]}else{a17Headers=['%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC','NO','%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','%E8%A6%86%E6%A0%B8','%E7%8B%80%E6%85%8B','%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']}currentTableInstance.currentHeaders=[...a17Headers];window.rTHs(a17Headers);createA17UnitButtons();updateA17UnitButtonCounts();window.pTBRs(baseA17MasterData);displaySystemNotification('%E5%B7%B2%E9%80%B2%E5%85%A5%20A17%20%E6%A8%A1%E5%BC%8F',false)}else{a17ModeState.isActive=false;a17ModeState.selectedUnits.clear();const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='none'}let%20originalHeaders=[];if(selectedQueryDefinitionGlobal){originalHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{originalHeaders.push(%22%E6%9F%A5%E8%A9%A2%E5%80%BC%22)}originalHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{originalHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});originalHeaders.push('%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C');currentTableInstance.currentHeaders=[...originalHeaders];window.rTHs(originalHeaders);window.pTBRs(originalQueryResults);displaySystemNotification('%E5%B7%B2%E9%80%80%E5%87%BA%20A17%20%E6%A8%A1%E5%BC%8F',false)}}function%20handleA17Copy(){const%20isTextEnabled=document.getElementById('qt-text-enable-checkbox')?.checked||false;let%20dataToCopy;if(a17ModeState.selectedUnits.size%3E0){dataToCopy=[];a17ModeState.selectedUnits.forEach(unitId=%3E{let%20unitData=filterDataByUnit(baseA17MasterData,unitId);dataToCopy=dataToCopy.concat(unitData)});dataToCopy.sort((a,b)=%3E{const%20unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20firstLetterA=getFirstLetter(unitA);const%20firstLetterB=getFirstLetter(unitB);return%20firstLetterA.localeCompare(firstLetterB)})}else{dataToCopy=[...baseA17MasterData]}generateAndCopyA17NotificationWithSettings(dataToCopy,A17_COPY_ONLY_HEADERS,isTextEnabled)}function%20sortTableByColumn(columnIndex,headerName){const%20currentData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const%20header=currentTableInstance.currentHeaders[columnIndex];const%20currentDirection=currentTableInstance.sortDirections[header]||'asc';const%20newDirection=currentDirection==='asc'?'desc':'asc';currentTableInstance.sortDirections[header]=newDirection;const%20sortedData=[...currentData].sort((a,b)=%3E{const%20aVal=String(a[header]||'');const%20bVal=String(b[header]||'');if(newDirection==='asc'){return%20aVal.localeCompare(bVal)}else{return%20bVal.localeCompare(aVal)}});if(a17ModeState.isActive){baseA17MasterData=sortedData}else{originalQueryResults=sortedData}window.pTBRs(sortedData);displaySystemNotification(%60%E5%B7%B2%E6%8C%89${headerName}${newDirection==='asc'?'%E5%8D%87%E5%BA%8F':'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%BA%8F%60,false)}function%20renderResultsTableUI(dataToRender){const%20mainId='qtMainContainer_final';document.getElementById(mainId)?.remove();const%20mainUI=document.createElement('div');mainUI.id=mainId;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:20px;transform:translateX(-50%);background:#ffffff;border-radius:12px;box-shadow:0%2010px%2040px%20rgba(0,0,0,0.15);padding:16px;width:900px;max-width:95vw;max-height:90vh;overflow:hidden;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:13px;display:flex;flex-direction:column;border:1px%20solid%20rgba(0,0,0,0.1);%60;let%20initialTableHeaders=[];if(selectedQueryDefinitionGlobal){initialTableHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{initialTableHeaders.push(%22%E6%9F%A5%E8%A9%A2%E5%80%BC%22)}initialTableHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{initialTableHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});initialTableHeaders.push('%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C');currentTableInstance.currentHeaders=[...initialTableHeaders];const%20controlsHeader=document.createElement('div');controlsHeader.style.cssText='display:flex;align-items:center;margin-bottom:5px;padding-bottom:5px;border-bottom:1px%20solid%20#ddd;flex-shrink:0;';const%20summarySec=document.createElement('div');summarySec.style.cssText='font-size:12px;font-weight:bold;color:#2c3e50;white-space:nowrap;margin-right:10px;flex-shrink:0;';summarySec.innerHTML=%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%EF%BC%9A%3Cstrong%3E${dataToRender.length}%3C/strong%3E%E7%AD%86%60;controlsHeader.appendChild(summarySec);const%20filterInput=document.createElement('input');filterInput.type='text';filterInput.id='qt-tbl-flt-final';filterInput.placeholder='%E6%89%BE%E5%87%BA%E6%88%91%E8%A6%81%E7%9A%84%E8%B3%87%E6%96%99%E3%80%82';filterInput.style.cssText='padding:5px%207px;border:1px%20solid%20#bababa;border-radius:3px;font-size:12px;width:120px;flex-shrink:0;margin-right:10px;';controlsHeader.appendChild(filterInput);const%20buttonsGroup=document.createElement('div');buttonsGroup.style.cssText='display:flex;align-items:center;gap:5px;flex-shrink:0;';const%20buttonConfigs=[{id:'qt-clr-cond-btn-final',text:'%E6%B8%85%E9%99%A4%E6%A2%9D%E4%BB%B6',style:'background:#6c757d;color:white;'},{id:'qt-req-btn-final',text:'%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2',style:'background:#ffc107;color:#212529;'},{id:'qt-a17-btn-final',text:'A17%E4%BD%9C%E6%A5%AD%E9%80%9A%E7%9F%A5',style:'background:#6f42c1;color:white;'},{id:'qt-cpy-all-btn-final',text:'%E8%A4%87%E8%A3%BD',style:'background:#28a745;color:white;'}];buttonConfigs.forEach(config=%3E{const%20btn=document.createElement('button');btn.id=config.id;btn.textContent=config.text;btn.style.cssText=config.style+'border:none;padding:5px%2010px;border-radius:3px;cursor:pointer;font-size:11.5px;font-weight:500;transition:opacity%200.1s%20ease;white-space:nowrap;';btn.onmouseover=()=%3Ebtn.style.opacity='0.8';btn.onmouseout=()=%3Ebtn.style.opacity='1';buttonsGroup.appendChild(btn)});controlsHeader.appendChild(buttonsGroup);const%20textCheckbox=document.createElement('input');textCheckbox.type='checkbox';textCheckbox.id='qt-text-enable-checkbox';textCheckbox.checked=true;textCheckbox.style.cssText='margin-left:10px;cursor:pointer;';const%20textCheckboxLabel=document.createElement('label');textCheckboxLabel.htmlFor='qt-text-enable-checkbox';textCheckboxLabel.textContent='A17%E6%96%87%E6%9C%AC';textCheckboxLabel.style.cssText='font-size:11px;color:#555;cursor:pointer;margin:0%208px%200%202px;user-select:none;';const%20textEditBtn=document.createElement('button');textEditBtn.id='qt-text-edit-btn-final';textEditBtn.textContent='%E6%96%87%E6%9C%AC%E7%B7%A8%E8%BC%AF';textEditBtn.style.cssText='background:#17a2b8;color:white;font-size:10px;padding:4px%208px;border:none;border-radius:3px;cursor:pointer;';textEditBtn.onmouseover=()=%3EtextEditBtn.style.opacity='0.8';textEditBtn.onmouseout=()=%3EtextEditBtn.style.opacity='1';controlsHeader.appendChild(textCheckbox);controlsHeader.appendChild(textCheckboxLabel);controlsHeader.appendChild(textEditBtn);const%20editModeBtn=document.createElement('button');editModeBtn.id='qt-edit-mode-btn-final';editModeBtn.textContent='%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editModeBtn.style.cssText='background:#6c757d;color:white;font-size:11px;padding:5px%2010px;margin-left:8px;border:none;border-radius:3px;cursor:pointer;';editModeBtn.onmouseover=()=%3EeditModeBtn.style.opacity='0.8';editModeBtn.onmouseout=()=%3EeditModeBtn.style.opacity='1';controlsHeader.appendChild(editModeBtn);const%20closeBtn=document.createElement('button');closeBtn.textContent='%E9%97%9C%E9%96%89';closeBtn.style.cssText='background:#dc3545;color:white;margin-left:auto;border:none;padding:5px%2010px;border-radius:3px;cursor:pointer;font-size:11.5px;';closeBtn.onmouseover=()=%3EcloseBtn.style.opacity='0.8';closeBtn.onmouseout=()=%3EcloseBtn.style.opacity='1';closeBtn.onclick=()=%3EmainUI.remove();controlsHeader.appendChild(closeBtn);mainUI.appendChild(controlsHeader);const%20a17BtnsCtr=document.createElement('div');a17BtnsCtr.id='qt-a17-unit-btns-ctr-final';a17BtnsCtr.style.cssText='margin-bottom:5px;display:none;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;';mainUI.appendChild(a17BtnsCtr);const%20tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px%20solid%20#ccc;border-radius:4px;';const%20tableEl=document.createElement('table');tableEl.id='qt-res-tbl-final';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:11.5px;';tableScrollWrap.appendChild(tableEl);mainUI.appendChild(tableScrollWrap);const%20tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:10;background-color:#34495e;';tableEl.appendChild(tHREl);const%20tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);document.body.appendChild(mainUI);function%20rTHs(hdrs){tHREl.innerHTML='';const%20hr=document.createElement('tr');hdrs.forEach((hTxt,idx)=%3E{const%20th=document.createElement('th');th.textContent=hTxt;th.style.cssText=%60color:#fff;text-align:center;padding:6px%204px;border-bottom:1px%20solid%20#2c3e50;white-space:nowrap;cursor:pointer;user-select:none;font-weight:600;border-right:1px%20solid%20#4a6075;font-size:11px;${idx===0?'background:#007bff;':''}%60;if(idx===hdrs.length-1)th.style.borderRight='none';th.onclick=()=%3E{sortTableByColumn(idx,hTxt)};hr.appendChild(th)});tHREl.appendChild(hr)}function%20pTBRs(data){tBREl.innerHTML='';data.forEach((row,idx)=%3E{const%20tr=document.createElement('tr');tr.style.backgroundColor=idx%2?'#f8f9fa':'#fff';currentTableInstance.currentHeaders.forEach((header,colIdx)=%3E{const%20td=document.createElement('td');td.style.cssText='padding:4px%206px;border-bottom:1px%20solid%20#dee2e6;font-size:11px;text-align:center;cursor:pointer;';if(colIdx===0){td.style.background='#e3f0fd';td.style.fontWeight='bold'}let%20cellContent=row[header];if(header.includes('%E7%8B%80%E6%85%8B')&&typeof%20cellContent==='string'&&cellContent.includes('%3Cspan')){td.innerHTML=cellContent}else{td.textContent=cellContent||''}td.onclick=function(e){e.stopPropagation();if(isEditMode&&colIdx%3E1){startCellEdit(td,row,header,cellContent)}else{navigator.clipboard.writeText(td.textContent).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%E5%85%A7%E5%AE%B9%EF%BC%9A'+td.textContent,false,1000)})}};tr.appendChild(td)});tBREl.appendChild(tr)});if(a17ModeState.isActive){setTimeout(()=%3E{updateA17UnitButtonCounts()},100)}}function%20startCellEdit(td,rowData,headerName,originalValue){if(td.querySelector('input'))return;const%20input=document.createElement('input');input.type='text';input.value=td.textContent;input.style.cssText=%60width:100%;border:2px%20solid%20#007bff;padding:2px%204px;font-size:11px;background:#fff3cd;box-sizing:border-box;outline:none;%60;td.innerHTML='';td.appendChild(input);input.focus();input.select();input.onkeydown=function(e){if(e.key==='Enter'){finishEdit(td,input,rowData,headerName,originalValue)}else%20if(e.key==='Escape'){td.textContent=originalValue}};input.onblur=function(){finishEdit(td,input,rowData,headerName,originalValue)}}function%20finishEdit(td,input,rowData,headerName,originalValue){const%20newValue=input.value.trim();td.textContent=newValue;rowData[headerName]=newValue;if(newValue!==originalValue){td.style.background='#d4edda';displaySystemNotification(%60%E5%B7%B2%E6%9B%B4%E6%96%B0%EF%BC%9A${headerName}%60,false,1000);if(headerName==='%E5%88%86%E5%85%AC%E5%8F%B8'&&a17ModeState.isActive){const%20rowIndex=originalQueryResults.findIndex(row=%3Erow.NO===rowData.NO);if(rowIndex!==-1){originalQueryResults[rowIndex][headerName]=newValue}baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}}}}function%20updateTableEditMode(){const%20cells=tableEl.querySelectorAll('tbody%20td');cells.forEach((cell,index)=%3E{const%20colIndex=index%currentTableInstance.currentHeaders.length;if(isEditMode&&colIndex%3E1){cell.style.cursor='text';cell.style.border='1px%20dashed%20#007bff';cell.title='%E9%BB%9E%E6%93%8A%E7%B7%A8%E8%BC%AF%EF%BC%8C%E6%8C%89%20Enter%20%E5%AE%8C%E6%88%90'}else{cell.style.cursor='pointer';cell.style.border='';cell.title='%E9%BB%9E%E6%93%8A%E8%A4%87%E8%A3%BD'}})}rTHs(currentTableInstance.currentHeaders);pTBRs(dataToRender);filterInput.oninput=()=%3E{const%20v=filterInput.value.trim().toLowerCase();if(!v){pTBRs(a17ModeState.isActive?baseA17MasterData:originalQueryResults);return}const%20sourceData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const%20filtered=sourceData.filter(row=%3EObject.values(row).some(val=%3EString(val||'').toLowerCase().includes(v)));pTBRs(filtered)};document.getElementById('qt-clr-cond-btn-final').onclick=()=%3E{a17ModeState.selectedUnits.clear();const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.querySelectorAll('button').forEach(btn=%3E{btn.classList.remove('highlighted');btn.style.boxShadow='none'})}filterInput.value='';currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};if(a17ModeState.isActive){const%20normalA17Headers=['%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC','NO','%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','%E8%A6%86%E6%A0%B8','%E7%8B%80%E6%85%8B','%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C'];currentTableInstance.currentHeaders=[...normalA17Headers];window.rTHs(normalA17Headers)}pTBRs(originalQueryResults);displaySystemNotification('%E6%A2%9D%E4%BB%B6%E5%B7%B2%E6%B8%85%E9%99%A4%EF%BC%8C%E5%8C%85%E5%90%ABCSV%E5%8C%AF%E5%85%A5%E8%B3%87%E6%96%99',false)};document.getElementById('qt-req-btn-final').onclick=()=%3E{mainUI.remove();executeCaseQueryTool()};document.getElementById('qt-a17-btn-final').onclick=()=%3E{executeA17SortAndFilter()};document.getElementById('qt-cpy-all-btn-final').onclick=()=%3E{if(a17ModeState.isActive){handleA17Copy()}else{handleNormalCopy()}};textEditBtn.onclick=()=%3E{createTextSettingDialog()};editModeBtn.onclick=()=%3E{isEditMode=!isEditMode;editModeBtn.textContent=isEditMode?'%E9%80%80%E5%87%BA%E7%B7%A8%E8%BC%AF':'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editModeBtn.style.background=isEditMode?'#dc3545':'#6c757d';updateTableEditMode();if(!isEditMode&&a17ModeState.isActive){baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification('%E5%B7%B2%E6%9B%B4%E6%96%B0A17%E5%88%86%E5%85%AC%E5%8F%B8%E7%AF%A9%E9%81%B8%E7%8B%80%E6%85%8B',false)}};window.pTBRs=pTBRs;window.rTHs=rTHs}function%20handleNormalCopy(){const%20dataToCopy=[...originalQueryResults];const%20headers=currentTableInstance.currentHeaders;const%20rows=dataToCopy.map(row=%3Eheaders.map(header=%3EString(row[header]||'')).join('\t')).join('\n');const%20textOutput=headers.join('\t')+'\n'+rows;navigator.clipboard.writeText(textOutput).then(()=%3E{displaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD%20${dataToCopy.length}%20%E7%AD%86%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%60,false)}).catch(e=%3E{console.error('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97:',e);displaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',true)})}async%20function%20executeCaseQueryTool(){const%20mainContainerId='qtMainContainer_vFinal';if(document.getElementById(mainContainerId)){displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',true);return}const%20selectedEnv=await%20createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv==='prod'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%60);if(!apiAuthToken){const%20tokenRes=await%20createTokenDialog();if(tokenRes===null){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}if(tokenRes==='_QT_SKIP_'){displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5',false);apiAuthToken=null}else%20if(!tokenRes){displaySystemNotification('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2',true);return}else{apiAuthToken=tokenRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}}const%20querySetupRes=await%20createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);if(!querySetupRes){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupRes.selectedApiKey);const%20queryValuesRaw=querySetupRes.queryValues;const%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC',true);return}const%20loadingOverlay=document.createElement('div');loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:%22Microsoft%20JhengHei%22,Arial,sans-serif;%60;const%20loadingP=document.createElement('p');loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';const%20loadingDiv=document.createElement('div');loadingDiv.style.cssText='background:#fff;padding:20px%2025px;border-radius:7px;text-align:center;box-shadow:0%203px%2012px%20rgba(0,0,0,0.1);';loadingDiv.innerHTML=%60%3Cdiv%20style=%22width:30px;height:30px;border:3px%20solid%20#e0e0e0;border-top:3px%20solid%20#007bff;border-radius:50%;animation:qtSpinAnimationFull%201s%20linear%20infinite;margin:0%20auto%2010px;%22%3E%3C/div%3E%60;loadingDiv.appendChild(loadingP);loadingOverlay.appendChild(loadingDiv);document.body.appendChild(loadingOverlay);const%20loadingStyle=document.createElement('style');loadingStyle.textContent='@keyframes%20qtSpinAnimationFull{to{transform:rotate(360deg)}}';document.head.appendChild(loadingStyle);let%20fetchedResultsCollector=[];let%20currentCounter=1;for(let%20i=0;i%3CqueryValues.length;i++){const%20singleQueryValue=queryValues[i];loadingP.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD:%20%E7%AC%AC%20${i+1}%20/%20${queryValues.length}%20%E7%AD%86%20(${singleQueryValue})...%60;const%20resultRowBase={'NO':String(currentCounter++),'_queriedValue_':singleQueryValue};const%20apiResult=await%20performApiQuery(singleQueryValue);let%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';if(apiResult.error==='token_invalid'){apiQueryStatus='%E2%9C%97%20TOKEN%E5%A4%B1%E6%95%88';loadingOverlay.remove();const%20tokenRetryRes=await%20createTokenDialog();if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){apiAuthToken=null;displaySystemNotification(tokenRetryRes===null?'%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88':'TOKEN%E6%9C%AA%E6%9B%B4%E6%96%B0/%E7%95%A5%E9%81%8E',true);if(tokenRetryRes===null){if(loadingStyle)loadingStyle.remove();return}}else{apiAuthToken=tokenRetryRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';else%20document.body.appendChild(loadingOverlay)}else%20if(apiResult.success){apiQueryStatus='%E2%9C%93%20%E6%88%90%E5%8A%9F'}else%20if(!apiResult.error){apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99'}resultRowBase._apiQueryStatus=apiQueryStatus;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=%3E{const%20popRow={...resultRowBase};const%20mainStatusVal=rec['mainStatus']||'';const%20subStatusVal=rec['subStatus']||'';popRow['_raw_mainStatus_']=mainStatusVal;popRow['_raw_subStatus_']=subStatusVal;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let%20cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){popRow[dN]=%60%3Cspan%20class=%22qt-status-main%22%3E${escapeHtml(mainStatusVal)}%3C/span%3E%3Cspan%20class=%22qt-status-sub%22%3E${escapeHtml(subStatusVal)}%3C/span%3E%60}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){const%20uVal=cVal;let%20uPre='';for(let%20k=0;k%3CuVal.length;k++){if(/[A-Za-z]/.test(uVal.charAt(k))){uPre=uVal.charAt(k).toUpperCase();break}}const%20mName=UNIT_CODE_MAPPINGS[uPre]||uVal;popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName}else%20if(dKey==='uwApprover'||dKey==='approvalUser'){popRow[dN]=extractName(cVal)}else{popRow[dN]=cVal}});popRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;fetchedResultsCollector.push(popRow)})}else{const%20failOrEmptyRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;if(dKey==='statusCombined'){failOrEmptyRow['_raw_mainStatus_']='-';failOrEmptyRow['_raw_subStatus_']='';failOrEmptyRow[dN]='-'}else{failOrEmptyRow[dN]='-'}});if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue}failOrEmptyRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;fetchedResultsCollector.push(failOrEmptyRow)}if(queryValues.length%3E1&&i%3CqueryValues.length-1)await%20new%20Promise(r=%3EsetTimeout(r,250))}if(document.body.contains(loadingOverlay))loadingOverlay.remove();if(loadingStyle)loadingStyle.remove();originalQueryResults=[...fetchedResultsCollector];renderResultsTableUI(originalQueryResults)}loadTextSettings();executeCaseQueryTool()})();

javascript:(async()=>{ const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; let CURRENT_API_URL=''; const TOKEN_STORAGE_KEY='euisToken'; const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}];%20let%20selectedQueryDefinitionGlobal=null;%20const%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];%20const%20FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8',mainStatus:'%E4%B8%BB%E7%8B%80%E6%85%8B',subStatus:'%E6%AC%A1%E7%8B%80%E6%85%8B'};%20const%20UNIT_MAP_FIELD_API_KEY='uwApproverUnit';%20const%20UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',F:'%E5%8F%B0%E4%B8%AD(%E5%98%89%E7%BE%A9)',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'};%20const%20APPROVER_FIELD_API_KEY='uwApprover';%20const%20APPROVAL_USER_FIELD_API_KEY='approvalUser';%20const%20SPECIAL_QUERIED_VALUE_KEY='_queriedValue_';%20const%20A17_BUTTON_TEXT=%22A17%E4%BD%9C%E6%A5%AD%E9%80%9A%E7%9F%A5%22;%20const%20A17_REPORT_NAME=%22A17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%22;%20const%20A17_PARA1=%22%E6%82%A8%E5%A5%BD%EF%BC%8C%22;%20const%20A17_PARA2_TEMPLATE=%22%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9A{{REPORT_NAME}}%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E6%9C%AC%E9%80%B1%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82%22;%20const%20A17_PARA3=%22%E7%B6%93%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E6%AF%94%E5%B0%8D%E5%BE%8C%EF%BC%8C%E8%A9%B2%E7%AD%89%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;%20const%20A17_GEN_DATE_OFFSET_DAYS=-3;%20const%20A17_COMP_DATE_OFFSET_DAYS=0;%20const%20A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1',color:'#546e7a'}];%20const%20A17_CSV_DATA_DISPLAY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B'];%20const%20A17_API_DATA_DISPLAY_HEADERS=['%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1'];%20const%20A17_COPY_ONLY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','',''];%20let%20baseA17MasterData=[];%20let%20activeA17UnitButtonElement=null;%20let%20apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);%20let%20originalQueryResults=[];%20let%20currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,mainTableSortState:{columnIndex:1,direction:'asc'},isCSVImportModeGlobal:false};%20let%20importedCSVRawData=null;%20const%20V_SUFFIX='_vFinal';%20const%20sleep=t=%3Enew%20Promise(r=%3EsetTimeout(r,t));%20const%20escapeHtml=unsafe=%3Eunsafe===undefined||unsafe===null?'':String(unsafe).replace(/[&%3C%22']/g,m=%3E({'&':'&amp;','%3C':'&lt;','%22':'&quot;',%22'%22:'&#039;'})[m]);%20const%20Z_INDEX_DIALOG=2147483640;%20const%20Z_INDEX_MAIN_UI=2147483630;%20const%20Z_INDEX_NOTIFICATION=2147483647;%20%20function%20displaySystemNotification(message,isError=false,duration=3000){%20const%20nId='qtNotif'+V_SUFFIX;%20document.getElementById(nId)?.remove();%20const%20n=document.createElement('div');%20n.id=nId;%20n.style.cssText=%60position:fixed;top:10px;right:10px;background:${isError?'#c0392b':'#27ae60'};color:white;padding:6px%209px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:11.5px;transform:translateX(calc(100%%20+%2015px));transition:transform%200.25s%20ease-out;box-shadow:0%201px%205px%20rgba(0,0,0,0.12);font-family:'Microsoft%20JhengHei',Arial,sans-serif;display:flex;align-items:center;gap:4px;%60;%20n.innerHTML=%60${isError?'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x26A0;%3C/span%3E':'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x2714;%3C/span%3E'}%3Cspan%3E${escapeHtml(message)}%3C/span%3E%60;%20document.body.appendChild(n);%20setTimeout(()=%3En.style.transform='translateX(0)',20);%20setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2015px))';setTimeout(()=%3En.remove(),250)},duration);%20}%20%20function%20createDialogBase(id,contentHtml,minWidth='300px',maxWidth='450px',customDialogStyle=''){%20document.getElementById(id)?.remove();%20const%20o=document.createElement('div');%20o.id=id;%20o.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:${Z_INDEX_DIALOG};display:flex;align-items:center;justify-content:center;backdrop-filter:blur(1.5px);font-family:'Microsoft%20JhengHei',Arial,sans-serif;padding:8px;box-sizing:border-box;%60;%20const%20d=document.createElement('div');%20d.style.cssText=%60background:#fff;padding:12px%2015px;border-radius:6px;box-shadow:0%203px%2015px%20rgba(0,0,0,0.12);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtModalOpenSlight%200.15s%20ease-out;${customDialogStyle}%60;%20d.innerHTML=contentHtml+%60%3Cstyle%3E@keyframes%20qtModalOpenSlight{from{opacity:0;transform:scale(0.98)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn${V_SUFFIX}{border:none;padding:5px%2010px;border-radius:3px;font-size:12px;cursor:pointer;transition:opacity%200.15s%20ease;font-weight:500;margin-left:5px;}.qt-dialog-btn${V_SUFFIX}:hover{opacity:0.8;}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;margin-right:auto!important;}%3C/style%3E%60;%20o.appendChild(d);%20document.body.appendChild(o);%20return{overlay:o,dialog:d};%20}%20%20function%20createTokenDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:14px;text-align:center;font-weight:600;%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);padding:7px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:10px;color:#333;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;%22%3E%3Cbutton%20id=%22qt-token-skip${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20id=%22qt-token-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-token-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3C/div%3E%60;%20const{overlay}=createDialogBase('qtTokenDialog'+V_SUFFIX,html);%20const%20iEl=document.getElementById('qt-token-input'+V_SUFFIX);%20if(iEl)iEl.focus();%20const%20c=v=%3E{document.removeEventListener('keydown',k);overlay.remove();resolve(v);};%20const%20k=e=%3E{if(e.key==='Escape')c(null);else%20if(e.key==='Enter'&&iEl&&iEl===document.activeElement){e.preventDefault();c(iEl.value.trim());}};%20document.addEventListener('keydown',k);%20document.getElementById('qt-token-ok'+V_SUFFIX).onclick=()=%3Ec(iEl?iEl.value.trim():'');%20document.getElementById('qt-token-cancel'+V_SUFFIX).onclick=()=%3Ec(null);%20document.getElementById('qt-token-skip'+V_SUFFIX).onclick=()=%3Ec('_QT_SKIP_');%20});%20}%20%20function%20createQuerySetupDialog(currentApiKey){%20return%20new%20Promise(resolve=%3E{%20let%20selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;%20const%20btns=QUERYABLE_FIELD_DEFINITIONS.map(d=%3E%60%3Cbutton%20class=%22qt-querytype-btn${V_SUFFIX}%22%20data-apikey=%22${d.queryApiKey}%22%20style=%22background-color:${d.color};color:white;border:2px%20solid%20transparent;padding:5px%200;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all%200.15s%20ease;height:26px;line-height:1.2;%22%3E${escapeHtml(d.queryDisplayName)}%3C/button%3E%60).join('');%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:15px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%3C/h3%3E%3Cdiv%20id=%22qt-querytype-buttons${V_SUFFIX}%22%20style=%22display:flex;gap:4px;margin-bottom:8px;%22%3E${btns}%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);min-height:45px;padding:6px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%22%3E%3C/textarea%3E%3Cdiv%20style=%22display:flex;justify-content:space-between;align-items:center;%22%3E%3Cbutton%20id=%22qt-import-csv-btn${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%20style=%22margin-left:0;%22%3E%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-querysetup-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E6%9F%A5%E8%A9%A2%3C/button%3E%3C/div%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-csv-file-input${V_SUFFIX}%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;%20const{overlay,dialog}=createDialogBase('qtQuerySetupDialog'+V_SUFFIX,html,'380px','580px');%20const%20qvInput=document.getElementById('qt-queryvalues-input'+V_SUFFIX);%20const%20typeBtns=dialog.querySelectorAll('.qt-querytype-btn'+V_SUFFIX);%20const%20csvFileInput=document.getElementById('qt-csv-file-input'+V_SUFFIX);%20const%20importCsvBtn=document.getElementById('qt-import-csv-btn'+V_SUFFIX);%20%20function%20setAB(apiKey){%20typeBtns.forEach(b=%3E{%20const%20isSel=b.dataset.apikey===apiKey;%20b.style.borderColor=isSel?b.style.backgroundColor:'transparent';%20b.style.boxShadow=isSel?%600%200%200%201.5px%20#fff,%200%200%200%203px%20${b.style.backgroundColor}%60:'none';%20b.style.filter=isSel?'brightness(1.12)':'brightness(1)';%20if(isSel){%20const%20selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);%20if(qvInput&&selDef)qvInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selDef.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E3%80%81%E5%88%86%E8%99%9F%E6%88%96%E6%8F%9B%E8%A1%8C%E5%88%86%E9%9A%94)%60;%20}%20b.onmouseover=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(0.95)';};%20b.onmouseout=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(1)';};%20});%20}%20%20typeBtns.forEach(b=%3E{%20if(b)b.onclick=()=%3E{%20selApiKey=b.dataset.apikey;%20setAB(selApiKey);%20if(qvInput)qvInput.focus();%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20typeBtns.forEach(tb=%3Etb.disabled=false);%20};%20});%20%20if(selApiKey)setAB(selApiKey);%20else%20if(QUERYABLE_FIELD_DEFINITIONS.length%3E0){%20selApiKey=QUERYABLE_FIELD_DEFINITIONS[0].queryApiKey;%20setAB(selApiKey);%20}%20%20if(importCsvBtn)importCsvBtn.onclick=()=%3EcsvFileInput?.click();%20%20if(csvFileInput)csvFileInput.onchange=e=%3E{%20const%20file=e.target.files[0];%20if(file){%20const%20reader=new%20FileReader();%20reader.onload=re=%3E{%20try{%20const%20text=re.target.result;%20const%20lines=text.split(/\r?\n/);%20if(lines.length%3E1){%20let%20keysFromCsv=[];%20importedCSVRawData=[];%20for(let%20i=1;i%3Clines.length;i++){%20const%20currentLineContent=lines[i];%20if(currentLineContent.trim()==='')continue;%20try{%20const%20cols=currentLineContent.split(',');%20const%20keyVal=cols[1];%20const%20key=(typeof%20keyVal==='string')?keyVal.trim().toUpperCase():'';%20if(key){%20keysFromCsv.push(key);%20let%20csvRowData={_originalCsvLineNumber:i+1};%20A17_CSV_DATA_DISPLAY_HEADERS.forEach((h,headerIdx)=%3E{%20const%20colCsvIdx=headerIdx+1;%20const%20colValFromCsv=cols[colCsvIdx];%20csvRowData[h]=(typeof%20colValFromCsv==='string')?colValFromCsv.trim():'';%20});%20importedCSVRawData.push(csvRowData);%20}%20}catch(lineErr){%20console.error(%60CSV%20Line%20${i+1}%20Parsing%20Error:%60,lineErr,%22Line%20content:%22,currentLineContent);%20displaySystemNotification(%60CSV%20%E7%AC%AC%20${i+1}%20%E8%A1%8C%E8%A7%A3%E6%9E%90%E5%A4%B1%E6%95%97%EF%BC%8C%E5%B7%B2%E8%B7%B3%E9%81%8E%E3%80%82%60,true,4000);%20}%20}%20if(keysFromCsv.length%3E0){%20selApiKey='receiptNumber';%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===selApiKey);%20if(selectedQueryDefinitionGlobal)setAB(selApiKey);%20typeBtns.forEach(tb=%3Etb.disabled=true);%20if(qvInput)qvInput.value=keysFromCsv.join('\n');%20currentTableInstance.isCSVImportModeGlobal=true;%20displaySystemNotification(%60%E5%B7%B2%E5%BE%9ECSV%E5%8C%AF%E5%85%A5%20${keysFromCsv.length}%20%E5%80%8B${selectedQueryDefinitionGlobal?selectedQueryDefinitionGlobal.queryDisplayName:'KEY'}%60,false);%20}else{%20displaySystemNotification('CSV%E6%9C%AA%E5%90%AB%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E9%8D%B5(%E7%AC%AC2%E6%AC%84)%E6%88%96%E8%B3%87%E6%96%99%E4%B8%8D%E8%B6%B3%20(%E5%B7%B2%E8%B7%B3%E9%81%8E%E8%A1%A8%E9%A0%AD).',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}else{%20displaySystemNotification('CSV%E7%82%BA%E7%A9%BA%E6%88%96%E5%83%85%E5%90%AB%E8%A1%A8%E9%A0%AD%E8%A1%8C',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}catch(globalParseErr){%20console.error(%22CSV%20Global%20File%20Processing%20Error:%22,globalParseErr);%20displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E6%95%B4%E9%AB%94%E8%99%95%E7%90%86%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E6%AA%94%E6%A1%88',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20};%20reader.onerror=()=%3EdisplaySystemNotification('%E8%AE%80%E5%8F%96%E6%AA%94%E6%A1%88%E5%A4%B1%E6%95%97',true);%20reader.readAsText(file,'Big5');%20}%20if(e.target)e.target.value=null;%20};%20%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20};%20%20document.addEventListener('keydown',k);%20%20const%20okSetupBtn=document.getElementById('qt-querysetup-ok'+V_SUFFIX);%20if(okSetupBtn)okSetupBtn.onclick=()=%3E{%20const%20vs=qvInput?qvInput.value.trim():'';%20if(!selApiKey&&!currentTableInstance.isCSVImportModeGlobal){%20displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E9%A1%9E%E5%9E%8B%E6%88%96%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88',true);%20return;%20}%20if(!vs){%20displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',true);%20if(qvInput)qvInput.focus();%20return;%20}%20c({selectedApiKey:selApiKey,queryValues:vs,csvImported:currentTableInstance.isCSVImportModeGlobal});%20};%20%20const%20cancelSetupBtn=document.getElementById('qt-querysetup-cancel'+V_SUFFIX);%20if(cancelSetupBtn)cancelSetupBtn.onclick=()=%3Ec(null);%20});%20}%20%20function%20createEnvSelectionDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20opts=[{idValue:'test',buttonText:'%E6%B8%AC%E8%A9%A6%20(UAT)',colorOverride:'#27ae60'},{idValue:'prod',buttonText:'%E6%AD%A3%E5%BC%8F%20(PROD)',colorOverride:'#d35400'}];%20const%20html=%60%3Ch3%20style=%22margin:0%200%2010px%200;color:#333;font-size:16px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;flex-wrap:wrap;gap:8px;justify-content:center;%22%3E${opts.map(opt=%3E%60%3Cbutton%20class=%22qt-env-sel-btn%22%20data-value=%22${escapeHtml(opt.idValue)}%22%20style=%22background:${opt.colorOverride};color:white;border:none;padding:10px%208px;border-radius:5px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0%201px%204px%20rgba(0,0,0,0.1);transition:opacity%200.15s%20ease;margin:3px;min-width:100px;flex-grow:1;%22%3E${escapeHtml(opt.buttonText)}%3C/button%3E%60).join('')}%3C/div%3E%60;%20const{overlay,dialog}=createDialogBase('qtEnvSelectDialog'+V_SUFFIX,html);%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20else%20if(e.key==='Enter'){%20e.preventDefault();%20c('prod');%20}%20};%20document.addEventListener('keydown',k);%20dialog.querySelectorAll('.qt-env-sel-btn').forEach(b=%3E{%20if(b){%20b.onclick=()=%3Ec(b.dataset.value);%20b.onmouseover=()=%3Eb.style.opacity='0.85';%20b.onmouseout=()=%3Eb.style.opacity='1';%20}%20});%20});%20}%20%20const%20extractName=strVal=%3E{%20if(!strVal||typeof%20strVal!=='string')return'';%20const%20m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);%20return%20m?m[0]:strVal.split('%20')[0];%20};%20%20async%20function%20performApiQuery(queryValue,isFromCSVNoRetry){%20let%20maxAttempts=isFromCSVNoRetry?1:2;%20let%20currentAttempt=0;%20let%20responseData=null,statusCode=0,success=false;%20while(currentAttempt%3CmaxAttempts&&!success){%20currentAttempt++;%20try{%20const%20reqBody={currentPage:1,pageSize:10};%20reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;%20const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};%20if(apiAuthToken){%20fetchOpts.headers['SSO-TOKEN']=apiAuthToken;%20}%20const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);%20statusCode=res.status;%20responseData=await%20res.json();%20if(statusCode===401){%20displaySystemNotification('TOKEN%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F',true);%20apiAuthToken=null;%20localStorage.removeItem(TOKEN_STORAGE_KEY);%20return{error:'token_invalid',data:null};%20}%20success=true;%20}catch(e){%20console.error(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20(%E7%AC%AC${currentAttempt}%E6%AC%A1)%20%E5%A4%B1%E6%95%97:%60,e);%20if(currentAttempt%3CmaxAttempts){%20displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E5%A4%B1%E6%95%97%EF%BC%8C2%E7%A7%92%E5%BE%8C%E9%87%8D%E8%A9%A6...%60,true,1500);%20await%20sleep(2000);%20}else{%20return{error:'network_error',data:null};%20}%20}%20}%20return{error:null,data:responseData,success:success&&responseData&&responseData.records&&responseData.records.length%3E0};%20}%20%20async%20function%20executeCaseQueryTool(){%20const%20mainContainerId='qtMainContainer'+V_SUFFIX;%20if(document.getElementById(mainContainerId)){%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',true);%20return;%20}%20const%20selectedEnv=await%20createEnvSelectionDialog();%20if(!selectedEnv){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;%20displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv==='prod'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%60);%20if(!apiAuthToken){%20const%20tokenRes=await%20createTokenDialog();%20if(tokenRes===null){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20if(tokenRes==='_QT_SKIP_'){%20displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5',false);%20apiAuthToken=null;%20}else%20if(!tokenRes){%20displaySystemNotification('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2',true);%20return;%20}else{%20apiAuthToken=tokenRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20}%20const%20querySetupRes=await%20createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);%20if(!querySetupRes){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupRes.selectedApiKey);%20const%20queryValuesRaw=querySetupRes.queryValues;%20let%20queryValues;%20if(selectedQueryDefinitionGlobal.queryApiKey==='policyNumber'){%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}else{%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}%20currentTableInstance.isCSVImportModeGlobal=!!querySetupRes.csvImported;%20if(queryValues.length===0){%20displaySystemNotification(%60%E6%9C%AA%E8%BC%B8%E5%85%A5/%E5%8C%AF%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC%60,true);%20return;%20}%20const%20loadingOverlay=document.createElement('div');%20loadingOverlay.id='qtLoadingOverlay'+V_SUFFIX;%20loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:%22Microsoft%20JhengHei%22,Arial,sans-serif;%60;%20const%20loadingP=document.createElement('p');%20loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';%20const%20loadingDiv=document.createElement('div');%20loadingDiv.style.cssText='background:#fff;padding:20px%2025px;border-radius:7px;text-align:center;box-shadow:0%203px%2012px%20rgba(0,0,0,0.1);';%20loadingDiv.innerHTML=%60%3Cdiv%20style=%22width:30px;height:30px;border:3px%20solid%20#e0e0e0;border-top:3px%20solid%20#007bff;border-radius:50%;animation:qtSpinAnimationFull%201s%20linear%20infinite;margin:0%20auto%2010px;%22%3E%3C/div%3E%60;%20loadingDiv.appendChild(loadingP);%20loadingOverlay.appendChild(loadingDiv);%20document.body.appendChild(loadingOverlay);%20const%20loadingStyle=document.createElement('style');%20loadingStyle.textContent='@keyframes%20qtSpinAnimationFull{to{transform:rotate(360deg)}}';%20document.head.appendChild(loadingStyle);%20let%20fetchedResultsCollector=[];%20let%20currentCounter=1;%20for(let%20i=0;i%3CqueryValues.length;i++){%20const%20singleQueryValue=queryValues[i];%20loadingP.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD:%20%E7%AC%AC%20${i+1}%20/%20${queryValues.length}%20%E7%AD%86%20(${singleQueryValue})...%60;%20const%20resultRowBase={'NO':String(currentCounter++),[SPECIAL_QUERIED_VALUE_KEY]:singleQueryValue};%20if(currentTableInstance.isCSVImportModeGlobal&&importedCSVRawData&&importedCSVRawData[i]){%20resultRowBase._csvData=JSON.parse(JSON.stringify(importedCSVRawData[i]));%20}%20const%20apiResult=await%20performApiQuery(singleQueryValue,currentTableInstance.isCSVImportModeGlobal);%20let%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';%20if(apiResult.error==='token_invalid'){%20apiQueryStatus='%E2%9C%97%20TOKEN%E5%A4%B1%E6%95%88';%20loadingOverlay.remove();%20const%20tokenRetryRes=await%20createTokenDialog();%20if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){%20apiAuthToken=null;%20displaySystemNotification(tokenRetryRes===null?'%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88':'TOKEN%E6%9C%AA%E6%9B%B4%E6%96%B0/%E7%95%A5%E9%81%8E',true);%20if(tokenRetryRes===null){%20if(loadingStyle)loadingStyle.remove();%20return;%20}%20}else{%20apiAuthToken=tokenRetryRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';%20else%20document.body.appendChild(loadingOverlay);%20}else%20if(apiResult.success){%20apiQueryStatus='%E2%9C%93%20%E6%88%90%E5%8A%9F';%20}else%20if(!apiResult.error){%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99';%20}%20resultRowBase._apiQueryStatus=apiQueryStatus;%20if(apiResult.success&&apiResult.data.records){%20apiResult.data.records.forEach(rec=%3E{%20const%20popRow={...resultRowBase};%20const%20mainStatusVal=rec['mainStatus']||'';%20const%20subStatusVal=rec['subStatus']||'';%20popRow['_raw_mainStatus_']=mainStatusVal;%20popRow['_raw_subStatus_']=subStatusVal;%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20let%20cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);%20if(dKey==='statusCombined'){%20popRow[dN]=%60%3Cspan%20class=%22qt-status-main%22%3E${escapeHtml(mainStatusVal)}%3C/span%3E%3Cspan%20class=%22qt-status-sub%22%3E${escapeHtml(subStatusVal)}%3C/span%3E%60;%20}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){%20const%20uVal=cVal;%20let%20uPre='';%20for(let%20k=0;k%3CuVal.length;k++){%20if(/[A-Za-z]/.test(uVal.charAt(k))){%20uPre=uVal.charAt(k).toUpperCase();%20break;%20}%20}%20const%20mName=UNIT_CODE_MAPPINGS[uPre]||uVal;%20popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName;%20}else%20if(dKey===APPROVER_FIELD_API_KEY||dKey===APPROVAL_USER_FIELD_API_KEY){%20popRow[dN]=extractName(cVal);%20}else{%20popRow[dN]=cVal;%20}%20});%20popRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(popRow);%20});%20}else{%20const%20failOrEmptyRow={...resultRowBase};%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20if(dKey==='statusCombined'){%20failOrEmptyRow['_raw_mainStatus_']='-';%20failOrEmptyRow['_raw_subStatus_']='';%20failOrEmptyRow[dN]='-';%20}else{%20failOrEmptyRow[dN]='-';%20}%20});%20if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){%20failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue;%20}%20failOrEmptyRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(failOrEmptyRow);%20}%20if(queryValues.length%3E1&&i%3CqueryValues.length-1)await%20sleep(250);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.remove();%20if(loadingStyle)loadingStyle.remove();%20originalQueryResults=[...fetchedResultsCollector];%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90',false);%20}%20%20try{%20await%20executeCaseQueryTool();%20}catch(error){%20console.error('%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:',error);%20displaySystemNotification('%E5%B7%A5%E5%85%B7%E5%9F%B7%E8%A1%8C%E5%A4%B1%E6%95%97',true);%20}%20})();

javascript:(async()=>{ const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query'; let CURRENT_API_URL=''; const TOKEN_STORAGE_KEY='euisToken'; const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}];%20let%20selectedQueryDefinitionGlobal=null;%20const%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];%20const%20FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8',mainStatus:'%E4%B8%BB%E7%8B%80%E6%85%8B',subStatus:'%E6%AC%A1%E7%8B%80%E6%85%8B'};%20const%20UNIT_MAP_FIELD_API_KEY='uwApproverUnit';%20const%20UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',F:'%E5%8F%B0%E4%B8%AD(%E5%98%89%E7%BE%A9)',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'};%20const%20APPROVER_FIELD_API_KEY='uwApprover';%20const%20APPROVAL_USER_FIELD_API_KEY='approvalUser';%20const%20SPECIAL_QUERIED_VALUE_KEY='_queriedValue_';%20const%20A17_BUTTON_TEXT=%22A17%E4%BD%9C%E6%A5%AD%E9%80%9A%E7%9F%A5%22;%20const%20A17_REPORT_NAME=%22A17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%22;%20const%20A17_PARA1=%22%E6%82%A8%E5%A5%BD%EF%BC%8C%22;%20const%20A17_PARA2_TEMPLATE=%22%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9A{{REPORT_NAME}}%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E6%9C%AC%E9%80%B1%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82%22;%20const%20A17_PARA3=%22%E7%B6%93%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E6%AF%94%E5%B0%8D%E5%BE%8C%EF%BC%8C%E8%A9%B2%E7%AD%89%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;%20const%20A17_GEN_DATE_OFFSET_DAYS=-3;%20const%20A17_COMP_DATE_OFFSET_DAYS=0;%20const%20A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1',color:'#546e7a'}];%20const%20A17_CSV_DATA_DISPLAY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B'];%20const%20A17_API_DATA_DISPLAY_HEADERS=['%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1'];%20const%20A17_COPY_ONLY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','',''];%20let%20baseA17MasterData=[];%20let%20activeA17UnitButtonElement=null;%20let%20apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);%20let%20originalQueryResults=[];%20let%20currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,mainTableSortState:{columnIndex:1,direction:'asc'},isCSVImportModeGlobal:false};%20let%20importedCSVRawData=null;%20const%20V_SUFFIX='_vFinal';%20const%20sleep=t=%3Enew%20Promise(r=%3EsetTimeout(r,t));%20const%20escapeHtml=unsafe=%3Eunsafe===undefined||unsafe===null?'':String(unsafe).replace(/[&%3C%22']/g,m=%3E({'&':'&amp;','%3C':'&lt;','%22':'&quot;',%22'%22:'&#039;'})[m]);%20const%20Z_INDEX_DIALOG=2147483640;%20const%20Z_INDEX_MAIN_UI=2147483630;%20const%20Z_INDEX_NOTIFICATION=2147483647;%20%20function%20displaySystemNotification(message,isError=false,duration=3000){%20const%20nId='qtNotif'+V_SUFFIX;%20document.getElementById(nId)?.remove();%20const%20n=document.createElement('div');%20n.id=nId;%20n.style.cssText=%60position:fixed;top:10px;right:10px;background:${isError?'#c0392b':'#27ae60'};color:white;padding:6px%209px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:11.5px;transform:translateX(calc(100%%20+%2015px));transition:transform%200.25s%20ease-out;box-shadow:0%201px%205px%20rgba(0,0,0,0.12);font-family:'Microsoft%20JhengHei',Arial,sans-serif;display:flex;align-items:center;gap:4px;%60;%20n.innerHTML=%60${isError?'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x26A0;%3C/span%3E':'%3Cspan%20style=%22font-size:12.5px;%22%3E&#x2714;%3C/span%3E'}%3Cspan%3E${escapeHtml(message)}%3C/span%3E%60;%20document.body.appendChild(n);%20setTimeout(()=%3En.style.transform='translateX(0)',20);%20setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2015px))';setTimeout(()=%3En.remove(),250)},duration);%20}%20%20function%20createDialogBase(id,contentHtml,minWidth='300px',maxWidth='450px',customDialogStyle=''){%20document.getElementById(id)?.remove();%20const%20o=document.createElement('div');%20o.id=id;%20o.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:${Z_INDEX_DIALOG};display:flex;align-items:center;justify-content:center;backdrop-filter:blur(1.5px);font-family:'Microsoft%20JhengHei',Arial,sans-serif;padding:8px;box-sizing:border-box;%60;%20const%20d=document.createElement('div');%20d.style.cssText=%60background:#fff;padding:12px%2015px;border-radius:6px;box-shadow:0%203px%2015px%20rgba(0,0,0,0.12);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtModalOpenSlight%200.15s%20ease-out;${customDialogStyle}%60;%20d.innerHTML=contentHtml+%60%3Cstyle%3E@keyframes%20qtModalOpenSlight{from{opacity:0;transform:scale(0.98)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn${V_SUFFIX}{border:none;padding:5px%2010px;border-radius:3px;font-size:12px;cursor:pointer;transition:opacity%200.15s%20ease;font-weight:500;margin-left:5px;}.qt-dialog-btn${V_SUFFIX}:hover{opacity:0.8;}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;margin-right:auto!important;}%3C/style%3E%60;%20o.appendChild(d);%20document.body.appendChild(o);%20return{overlay:o,dialog:d};%20}%20%20function%20createTokenDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:14px;text-align:center;font-weight:600;%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);padding:7px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:10px;color:#333;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;%22%3E%3Cbutton%20id=%22qt-token-skip${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20id=%22qt-token-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-token-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3C/div%3E%60;%20const{overlay}=createDialogBase('qtTokenDialog'+V_SUFFIX,html);%20const%20iEl=document.getElementById('qt-token-input'+V_SUFFIX);%20if(iEl)iEl.focus();%20const%20c=v=%3E{document.removeEventListener('keydown',k);overlay.remove();resolve(v);};%20const%20k=e=%3E{if(e.key==='Escape')c(null);else%20if(e.key==='Enter'&&iEl&&iEl===document.activeElement){e.preventDefault();c(iEl.value.trim());}};%20document.addEventListener('keydown',k);%20document.getElementById('qt-token-ok'+V_SUFFIX).onclick=()=%3Ec(iEl?iEl.value.trim():'');%20document.getElementById('qt-token-cancel'+V_SUFFIX).onclick=()=%3Ec(null);%20document.getElementById('qt-token-skip'+V_SUFFIX).onclick=()=%3Ec('_QT_SKIP_');%20});%20}%20%20function%20createQuerySetupDialog(currentApiKey){%20return%20new%20Promise(resolve=%3E{%20let%20selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;%20const%20btns=QUERYABLE_FIELD_DEFINITIONS.map(d=%3E%60%3Cbutton%20class=%22qt-querytype-btn${V_SUFFIX}%22%20data-apikey=%22${d.queryApiKey}%22%20style=%22background-color:${d.color};color:white;border:2px%20solid%20transparent;padding:5px%200;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all%200.15s%20ease;height:26px;line-height:1.2;%22%3E${escapeHtml(d.queryDisplayName)}%3C/button%3E%60).join('');%20const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:15px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%3C/h3%3E%3Cdiv%20id=%22qt-querytype-buttons${V_SUFFIX}%22%20style=%22display:flex;gap:4px;margin-bottom:8px;%22%3E${btns}%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input${V_SUFFIX}%22%20style=%22width:calc(100%%20-%2014px);min-height:45px;padding:6px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%22%3E%3C/textarea%3E%3Cdiv%20style=%22display:flex;justify-content:space-between;align-items:center;%22%3E%3Cbutton%20id=%22qt-import-csv-btn${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%20style=%22margin-left:0;%22%3E%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88%3C/button%3E%3Cdiv%3E%3Cbutton%20id=%22qt-querysetup-cancel${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok${V_SUFFIX}%22%20class=%22qt-dialog-btn${V_SUFFIX}%20qt-dialog-btn-blue%22%3E%E6%9F%A5%E8%A9%A2%3C/button%3E%3C/div%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-csv-file-input${V_SUFFIX}%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;%20const{overlay,dialog}=createDialogBase('qtQuerySetupDialog'+V_SUFFIX,html,'380px','580px');%20const%20qvInput=document.getElementById('qt-queryvalues-input'+V_SUFFIX);%20const%20typeBtns=dialog.querySelectorAll('.qt-querytype-btn'+V_SUFFIX);%20const%20csvFileInput=document.getElementById('qt-csv-file-input'+V_SUFFIX);%20const%20importCsvBtn=document.getElementById('qt-import-csv-btn'+V_SUFFIX);%20%20function%20setAB(apiKey){%20typeBtns.forEach(b=%3E{%20const%20isSel=b.dataset.apikey===apiKey;%20b.style.borderColor=isSel?b.style.backgroundColor:'transparent';%20b.style.boxShadow=isSel?%600%200%200%201.5px%20#fff,%200%200%200%203px%20${b.style.backgroundColor}%60:'none';%20b.style.filter=isSel?'brightness(1.12)':'brightness(1)';%20if(isSel){%20const%20selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);%20if(qvInput&&selDef)qvInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selDef.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E3%80%81%E5%88%86%E8%99%9F%E6%88%96%E6%8F%9B%E8%A1%8C%E5%88%86%E9%9A%94)%60;%20}%20b.onmouseover=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(0.95)';};%20b.onmouseout=()=%3E{if(b.dataset.apikey!==selApiKey)b.style.filter='brightness(1)';};%20});%20}%20%20typeBtns.forEach(b=%3E{%20if(b)b.onclick=()=%3E{%20selApiKey=b.dataset.apikey;%20setAB(selApiKey);%20if(qvInput)qvInput.focus();%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20typeBtns.forEach(tb=%3Etb.disabled=false);%20};%20});%20%20if(selApiKey)setAB(selApiKey);%20else%20if(QUERYABLE_FIELD_DEFINITIONS.length%3E0){%20selApiKey=QUERYABLE_FIELD_DEFINITIONS[0].queryApiKey;%20setAB(selApiKey);%20}%20%20if(importCsvBtn)importCsvBtn.onclick=()=%3EcsvFileInput?.click();%20%20if(csvFileInput)csvFileInput.onchange=e=%3E{%20const%20file=e.target.files[0];%20if(file){%20const%20reader=new%20FileReader();%20reader.onload=re=%3E{%20try{%20const%20text=re.target.result;%20const%20lines=text.split(/\r?\n/);%20if(lines.length%3E1){%20let%20keysFromCsv=[];%20importedCSVRawData=[];%20for(let%20i=1;i%3Clines.length;i++){%20const%20currentLineContent=lines[i];%20if(currentLineContent.trim()==='')continue;%20try{%20const%20cols=currentLineContent.split(',');%20const%20keyVal=cols[1];%20const%20key=(typeof%20keyVal==='string')?keyVal.trim().toUpperCase():'';%20if(key){%20keysFromCsv.push(key);%20let%20csvRowData={_originalCsvLineNumber:i+1};%20A17_CSV_DATA_DISPLAY_HEADERS.forEach((h,headerIdx)=%3E{%20const%20colCsvIdx=headerIdx+1;%20const%20colValFromCsv=cols[colCsvIdx];%20csvRowData[h]=(typeof%20colValFromCsv==='string')?colValFromCsv.trim():'';%20});%20importedCSVRawData.push(csvRowData);%20}%20}catch(lineErr){%20console.error(%60CSV%20Line%20${i+1}%20Parsing%20Error:%60,lineErr,%22Line%20content:%22,currentLineContent);%20displaySystemNotification(%60CSV%20%E7%AC%AC%20${i+1}%20%E8%A1%8C%E8%A7%A3%E6%9E%90%E5%A4%B1%E6%95%97%EF%BC%8C%E5%B7%B2%E8%B7%B3%E9%81%8E%E3%80%82%60,true,4000);%20}%20}%20if(keysFromCsv.length%3E0){%20selApiKey='receiptNumber';%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===selApiKey);%20if(selectedQueryDefinitionGlobal)setAB(selApiKey);%20typeBtns.forEach(tb=%3Etb.disabled=true);%20if(qvInput)qvInput.value=keysFromCsv.join('\n');%20currentTableInstance.isCSVImportModeGlobal=true;%20displaySystemNotification(%60%E5%B7%B2%E5%BE%9ECSV%E5%8C%AF%E5%85%A5%20${keysFromCsv.length}%20%E5%80%8B${selectedQueryDefinitionGlobal?selectedQueryDefinitionGlobal.queryDisplayName:'KEY'}%60,false);%20}else{%20displaySystemNotification('CSV%E6%9C%AA%E5%90%AB%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E9%8D%B5(%E7%AC%AC2%E6%AC%84)%E6%88%96%E8%B3%87%E6%96%99%E4%B8%8D%E8%B6%B3%20(%E5%B7%B2%E8%B7%B3%E9%81%8E%E8%A1%A8%E9%A0%AD).',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}else{%20displaySystemNotification('CSV%E7%82%BA%E7%A9%BA%E6%88%96%E5%83%85%E5%90%AB%E8%A1%A8%E9%A0%AD%E8%A1%8C',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20}catch(globalParseErr){%20console.error(%22CSV%20Global%20File%20Processing%20Error:%22,globalParseErr);%20displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E6%95%B4%E9%AB%94%E8%99%95%E7%90%86%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E6%AA%94%E6%A1%88',true);%20currentTableInstance.isCSVImportModeGlobal=false;%20importedCSVRawData=null;%20if(typeBtns)typeBtns.forEach(tb=%3Etb.disabled=false);%20}%20};%20reader.onerror=()=%3EdisplaySystemNotification('%E8%AE%80%E5%8F%96%E6%AA%94%E6%A1%88%E5%A4%B1%E6%95%97',true);%20reader.readAsText(file,'Big5');%20}%20if(e.target)e.target.value=null;%20};%20%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20};%20%20document.addEventListener('keydown',k);%20%20const%20okSetupBtn=document.getElementById('qt-querysetup-ok'+V_SUFFIX);%20if(okSetupBtn)okSetupBtn.onclick=()=%3E{%20const%20vs=qvInput?qvInput.value.trim():'';%20if(!selApiKey&&!currentTableInstance.isCSVImportModeGlobal){%20displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E9%A1%9E%E5%9E%8B%E6%88%96%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88',true);%20return;%20}%20if(!vs){%20displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',true);%20if(qvInput)qvInput.focus();%20return;%20}%20c({selectedApiKey:selApiKey,queryValues:vs,csvImported:currentTableInstance.isCSVImportModeGlobal});%20};%20%20const%20cancelSetupBtn=document.getElementById('qt-querysetup-cancel'+V_SUFFIX);%20if(cancelSetupBtn)cancelSetupBtn.onclick=()=%3Ec(null);%20});%20}%20%20function%20createEnvSelectionDialog(){%20return%20new%20Promise(resolve=%3E{%20const%20opts=[{idValue:'test',buttonText:'%E6%B8%AC%E8%A9%A6%20(UAT)',colorOverride:'#27ae60'},{idValue:'prod',buttonText:'%E6%AD%A3%E5%BC%8F%20(PROD)',colorOverride:'#d35400'}];%20const%20html=%60%3Ch3%20style=%22margin:0%200%2010px%200;color:#333;font-size:16px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;flex-wrap:wrap;gap:8px;justify-content:center;%22%3E${opts.map(opt=%3E%60%3Cbutton%20class=%22qt-env-sel-btn%22%20data-value=%22${escapeHtml(opt.idValue)}%22%20style=%22background:${opt.colorOverride};color:white;border:none;padding:10px%208px;border-radius:5px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0%201px%204px%20rgba(0,0,0,0.1);transition:opacity%200.15s%20ease;margin:3px;min-width:100px;flex-grow:1;%22%3E${escapeHtml(opt.buttonText)}%3C/button%3E%60).join('')}%3C/div%3E%60;%20const{overlay,dialog}=createDialogBase('qtEnvSelectDialog'+V_SUFFIX,html);%20const%20c=v=%3E{%20document.removeEventListener('keydown',k);%20overlay.remove();%20resolve(v);%20};%20const%20k=e=%3E{%20if(e.key==='Escape')c(null);%20else%20if(e.key==='Enter'){%20e.preventDefault();%20c('prod');%20}%20};%20document.addEventListener('keydown',k);%20dialog.querySelectorAll('.qt-env-sel-btn').forEach(b=%3E{%20if(b){%20b.onclick=()=%3Ec(b.dataset.value);%20b.onmouseover=()=%3Eb.style.opacity='0.85';%20b.onmouseout=()=%3Eb.style.opacity='1';%20}%20});%20});%20}%20%20const%20extractName=strVal=%3E{%20if(!strVal||typeof%20strVal!=='string')return'';%20const%20m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);%20return%20m?m[0]:strVal.split('%20')[0];%20};%20%20async%20function%20performApiQuery(queryValue,isFromCSVNoRetry){%20let%20maxAttempts=isFromCSVNoRetry?1:2;%20let%20currentAttempt=0;%20let%20responseData=null,statusCode=0,success=false;%20while(currentAttempt%3CmaxAttempts&&!success){%20currentAttempt++;%20try{%20const%20reqBody={currentPage:1,pageSize:10};%20reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;%20const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};%20if(apiAuthToken){%20fetchOpts.headers['SSO-TOKEN']=apiAuthToken;%20}%20const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);%20statusCode=res.status;%20responseData=await%20res.json();%20if(statusCode===401){%20displaySystemNotification('TOKEN%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F',true);%20apiAuthToken=null;%20localStorage.removeItem(TOKEN_STORAGE_KEY);%20return{error:'token_invalid',data:null};%20}%20success=true;%20}catch(e){%20console.error(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20(%E7%AC%AC${currentAttempt}%E6%AC%A1)%20%E5%A4%B1%E6%95%97:%60,e);%20if(currentAttempt%3CmaxAttempts){%20displaySystemNotification(%60%E6%9F%A5%E8%A9%A2%20${queryValue}%20%E5%A4%B1%E6%95%97%EF%BC%8C2%E7%A7%92%E5%BE%8C%E9%87%8D%E8%A9%A6...%60,true,1500);%20await%20sleep(2000);%20}else{%20return{error:'network_error',data:null};%20}%20}%20}%20return{error:null,data:responseData,success:success&&responseData&&responseData.records&&responseData.records.length%3E0};%20}%20%20async%20function%20executeCaseQueryTool(){%20const%20mainContainerId='qtMainContainer'+V_SUFFIX;%20if(document.getElementById(mainContainerId)){%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',true);%20return;%20}%20const%20selectedEnv=await%20createEnvSelectionDialog();%20if(!selectedEnv){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;%20displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv==='prod'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%60);%20if(!apiAuthToken){%20const%20tokenRes=await%20createTokenDialog();%20if(tokenRes===null){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20if(tokenRes==='_QT_SKIP_'){%20displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5',false);%20apiAuthToken=null;%20}else%20if(!tokenRes){%20displaySystemNotification('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2',true);%20return;%20}else{%20apiAuthToken=tokenRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20}%20const%20querySetupRes=await%20createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);%20if(!querySetupRes){%20displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);%20return;%20}%20selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupRes.selectedApiKey);%20const%20queryValuesRaw=querySetupRes.queryValues;%20let%20queryValues;%20if(selectedQueryDefinitionGlobal.queryApiKey==='policyNumber'){%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}else{%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);%20}%20currentTableInstance.isCSVImportModeGlobal=!!querySetupRes.csvImported;%20if(queryValues.length===0){%20displaySystemNotification(%60%E6%9C%AA%E8%BC%B8%E5%85%A5/%E5%8C%AF%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC%60,true);%20return;%20}%20const%20loadingOverlay=document.createElement('div');%20loadingOverlay.id='qtLoadingOverlay'+V_SUFFIX;%20loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:%22Microsoft%20JhengHei%22,Arial,sans-serif;%60;%20const%20loadingP=document.createElement('p');%20loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';%20const%20loadingDiv=document.createElement('div');%20loadingDiv.style.cssText='background:#fff;padding:20px%2025px;border-radius:7px;text-align:center;box-shadow:0%203px%2012px%20rgba(0,0,0,0.1);';%20loadingDiv.innerHTML=%60%3Cdiv%20style=%22width:30px;height:30px;border:3px%20solid%20#e0e0e0;border-top:3px%20solid%20#007bff;border-radius:50%;animation:qtSpinAnimationFull%201s%20linear%20infinite;margin:0%20auto%2010px;%22%3E%3C/div%3E%60;%20loadingDiv.appendChild(loadingP);%20loadingOverlay.appendChild(loadingDiv);%20document.body.appendChild(loadingOverlay);%20const%20loadingStyle=document.createElement('style');%20loadingStyle.textContent='@keyframes%20qtSpinAnimationFull{to{transform:rotate(360deg)}}';%20document.head.appendChild(loadingStyle);%20let%20fetchedResultsCollector=[];%20let%20currentCounter=1;%20for(let%20i=0;i%3CqueryValues.length;i++){%20const%20singleQueryValue=queryValues[i];%20loadingP.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD:%20%E7%AC%AC%20${i+1}%20/%20${queryValues.length}%20%E7%AD%86%20(${singleQueryValue})...%60;%20const%20resultRowBase={'NO':String(currentCounter++),[SPECIAL_QUERIED_VALUE_KEY]:singleQueryValue};%20if(currentTableInstance.isCSVImportModeGlobal&&importedCSVRawData&&importedCSVRawData[i]){%20resultRowBase._csvData=JSON.parse(JSON.stringify(importedCSVRawData[i]));%20}%20const%20apiResult=await%20performApiQuery(singleQueryValue,currentTableInstance.isCSVImportModeGlobal);%20let%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';%20if(apiResult.error==='token_invalid'){%20apiQueryStatus='%E2%9C%97%20TOKEN%E5%A4%B1%E6%95%88';%20loadingOverlay.remove();%20const%20tokenRetryRes=await%20createTokenDialog();%20if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){%20apiAuthToken=null;%20displaySystemNotification(tokenRetryRes===null?'%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88':'TOKEN%E6%9C%AA%E6%9B%B4%E6%96%B0/%E7%95%A5%E9%81%8E',true);%20if(tokenRetryRes===null){%20if(loadingStyle)loadingStyle.remove();%20return;%20}%20}else{%20apiAuthToken=tokenRetryRes;%20localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';%20else%20document.body.appendChild(loadingOverlay);%20}else%20if(apiResult.success){%20apiQueryStatus='%E2%9C%93%20%E6%88%90%E5%8A%9F';%20}else%20if(!apiResult.error){%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99';%20}%20resultRowBase._apiQueryStatus=apiQueryStatus;%20if(apiResult.success&&apiResult.data.records){%20apiResult.data.records.forEach(rec=%3E{%20const%20popRow={...resultRowBase};%20const%20mainStatusVal=rec['mainStatus']||'';%20const%20subStatusVal=rec['subStatus']||'';%20popRow['_raw_mainStatus_']=mainStatusVal;%20popRow['_raw_subStatus_']=subStatusVal;%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20let%20cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);%20if(dKey==='statusCombined'){%20popRow[dN]=%60%3Cspan%20class=%22qt-status-main%22%3E${escapeHtml(mainStatusVal)}%3C/span%3E%3Cspan%20class=%22qt-status-sub%22%3E${escapeHtml(subStatusVal)}%3C/span%3E%60;%20}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){%20const%20uVal=cVal;%20let%20uPre='';%20for(let%20k=0;k%3CuVal.length;k++){%20if(/[A-Za-z]/.test(uVal.charAt(k))){%20uPre=uVal.charAt(k).toUpperCase();%20break;%20}%20}%20const%20mName=UNIT_CODE_MAPPINGS[uPre]||uVal;%20popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName;%20}else%20if(dKey===APPROVER_FIELD_API_KEY||dKey===APPROVAL_USER_FIELD_API_KEY){%20popRow[dN]=extractName(cVal);%20}else{%20popRow[dN]=cVal;%20}%20});%20popRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(popRow);%20});%20}else{%20const%20failOrEmptyRow={...resultRowBase};%20ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{%20const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;%20if(dKey==='statusCombined'){%20failOrEmptyRow['_raw_mainStatus_']='-';%20failOrEmptyRow['_raw_subStatus_']='';%20failOrEmptyRow[dN]='-';%20}else{%20failOrEmptyRow[dN]='-';%20}%20});%20if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){%20failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue;%20}%20failOrEmptyRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;%20fetchedResultsCollector.push(failOrEmptyRow);%20}%20if(queryValues.length%3E1&&i%3CqueryValues.length-1)await%20sleep(250);%20}%20if(document.body.contains(loadingOverlay))loadingOverlay.remove();%20if(loadingStyle)loadingStyle.remove();%20originalQueryResults=[...fetchedResultsCollector];%20displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90',false);%20}%20%20try{%20await%20executeCaseQueryTool();%20}catch(error){%20console.error('%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:',error);%20displaySystemNotification('%E5%B7%A5%E5%85%B7%E5%9F%B7%E8%A1%8C%E5%A4%B1%E6%95%97',true);%20}%20})();


【CASE】
javascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',TOKEN_STORAGE_KEY='euisToken',Z_INDEX_DIALOG=2147483640,Z_INDEX_MAIN_UI=2147483630,Z_INDEX_NOTIFICATION=2147483647;let CURRENT_API_URL='',apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY),selectedQueryDefinitionGlobal=null,originalQueryResults=[],baseA17MasterData=[],isEditMode=false,currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,isCSVImportModeGlobal:false},a17ModeState={isActive:false,selectedUnits:new Set(),sortedData:[]},csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',color:'#17a2b8'}],ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'],FIELD_DISPLAY_NAMES_MAP={applyNumber:'%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC',policyNumber:'%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC',approvalNumber:'%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F',receiptNumber:'%E9%80%81%E9%87%91%E5%96%AE',insuredId:'%E8%A2%AB%E4%BF%9D%E4%BA%BA%EF%BC%A9%EF%BC%A4',statusCombined:'%E7%8B%80%E6%85%8B',uwApproverUnit:'%E5%88%86%E5%85%AC%E5%8F%B8',uwApprover:'%E6%A0%B8%E4%BF%9D%E5%93%A1',approvalUser:'%E8%A6%86%E6%A0%B8'},UNIT_MAP_FIELD_API_KEY='uwApproverUnit',UNIT_CODE_MAPPINGS={H:'%E6%A0%B8%E4%BF%9D%E9%83%A8',B:'%E5%8C%97%E4%B8%80',C:'%E5%8F%B0%E4%B8%AD',K:'%E9%AB%98%E9%9B%84',N:'%E5%8F%B0%E5%8D%97',P:'%E5%8C%97%E4%BA%8C',T:'%E6%A1%83%E7%AB%B9',G:'%E4%BF%9D%E4%BD%9C'},A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-%E7%B8%BD%E5%85%AC%E5%8F%B8',color:'#007bff'},{id:'B',label:'B-%E5%8C%97%E4%B8%80',color:'#28a745'},{id:'P',label:'P-%E5%8C%97%E4%BA%8C',color:'#ffc107'},{id:'T',label:'T-%E6%A1%83%E7%AB%B9',color:'#17a2b8'},{id:'C',label:'C-%E5%8F%B0%E4%B8%AD',color:'#fd7e14'},{id:'N',label:'N-%E5%8F%B0%E5%8D%97',color:'#6f42c1'},{id:'K',label:'K-%E9%AB%98%E9%9B%84',color:'#e83e8c'},{id:'UNDEF',label:'%E6%9F%A5%E7%84%A1',color:'#546e7a'}],A17_CSV_DISPLAY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B'],A17_API_DATA_DISPLAY_HEADERS=['%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1'],A17_COPY_ONLY_HEADERS=['%E9%80%81%E9%87%91%E5%96%AE','%E7%A7%91%E7%9B%AE%E4%BB%A3%E7%A2%BC','%E5%B9%A3%E5%88%A5','%E9%A4%98%E9%A1%8D','%E5%85%A5%E5%B8%B3%E6%97%A5%E6%9C%9F','%E5%85%A5%E5%B8%B3%E4%BA%BA%E5%93%A1','%E4%BF%9D%E5%96%AE%E7%8B%80%E6%85%8B','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','',''],A17_PARA1=%22%E6%82%A8%E5%A5%BD%EF%BC%8C%22,A17_PARA2_TEMPLATE=%22%E4%BE%9D%E6%93%9A%E3%80%90%E7%AE%A1%E7%90%86%E5%A0%B1%E8%A1%A8%EF%BC%9AA17%20%E6%96%B0%E5%A5%91%E7%B4%84%E7%95%B0%E5%B8%B8%E5%B8%B3%E5%8B%99%E3%80%91%E6%89%80%E8%BC%89%E5%85%A7%E5%AE%B9%EF%BC%8C%E6%9C%AC%E9%80%B1%E5%A0%B1%E8%A1%A8%E4%B8%AD%E5%88%97%E7%A4%BA%E4%B9%8B%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC%EF%BC%8C%E6%B6%89%E5%8F%8A%E5%A4%9A%E9%A0%85%E5%B8%B3%E5%8B%99%E7%95%B0%E5%B8%B8%E6%83%85%E5%BD%A2%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%BA%A2%E7%B9%B3%E3%80%81%E7%9F%AD%E6%94%B6%E3%80%81%E5%8F%96%E6%B6%88%E4%BB%B6%E9%9C%80%E9%80%80%E8%B2%BB%E3%80%81%E7%84%A1%E7%9B%B8%E5%B0%8D%E6%87%89%E4%B9%8B%E6%A1%88%E4%BB%B6%E7%AD%89%E5%95%8F%E9%A1%8C%E3%80%82%22,A17_PARA3=%22%E7%B6%93%E9%80%90%E7%AD%86%E6%9F%A5%E8%A9%A2%E6%AF%94%E5%B0%8D%E5%BE%8C%EF%BC%8C%E8%A9%B2%E7%AD%89%E9%80%81%E9%87%91%E5%96%AE%E6%87%89%E5%B0%8D%E6%87%89%E8%87%B3%E4%B8%8B%E8%A1%A8%E6%89%80%E5%88%97%E4%B9%8B%E6%96%B0%E5%A5%91%E7%B4%84%E6%A1%88%E4%BB%B6%EF%BC%8C%E6%95%AC%E8%AB%8B%E5%8D%94%E5%8A%A9%E7%A2%BA%E8%AA%8D%E5%90%84%E6%A1%88%E4%BB%B6%E4%B9%8B%E5%B8%B3%E5%8B%99%E7%8B%80%E6%B3%81%EF%BC%8C%E8%AC%9D%E8%AC%9D%E3%80%82%22;let%20textSettings={content:A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3,fontSize:10.5,lineHeight:1.5};function%20loadTextSettings(){const%20saved=localStorage.getItem('qt_a17_text_settings');if(saved)try{textSettings={...textSettings,...JSON.parse(saved)}}catch(e){}}function%20saveTextSettings(){localStorage.setItem('qt_a17_text_settings',JSON.stringify(textSettings))}function%20escapeHtml(s){return%20s===undefined||s===null?'':String(s).replace(/[&%3C%22']/g,m=%3E({'&':'&','%3C':'%3C','%22':'%22',%22'%22:'&#039;'})[m])}function%20displaySystemNotification(msg,err,dur=2000){const%20nId='qtNotif_vFinal';document.getElementById(nId)?.remove();const%20n=document.createElement('div');n.id=nId;n.style.cssText=%60position:fixed;top:10px;right:10px;background:${err?'#c0392b':'#27ae60'};color:white;padding:6px%209px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:12px;transform:translateX(calc(100%%20+%2015px));transition:transform%200.25s;box-shadow:0%201px%205px%20rgba(0,0,0,0.12);font-family:'Microsoft%20JhengHei',Arial,sans-serif;%60;n.innerHTML=%60${err?'&#x26A0;':'&#x2714;'}%20%3Cspan%3E${escapeHtml(msg)}%3C/span%3E%60;document.body.appendChild(n);setTimeout(()=%3En.style.transform='translateX(0)',20);setTimeout(()=%3E{n.style.transform='translateX(calc(100%%20+%2015px))';setTimeout(()=%3En.remove(),250)},dur)}function%20createDialogBase(id,contentHtml,minWidth='320px',maxWidth='480px'){document.getElementById(id)?.remove();const%20d=document.createElement('div');d.id=id;d.style.cssText=%60position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:8px;box-shadow:0%208px%2032px%20rgba(0,0,0,0.2);min-width:${minWidth};max-width:${maxWidth};z-index:${Z_INDEX_DIALOG};font-family:'Microsoft%20JhengHei',Arial,sans-serif;%60;d.innerHTML=contentHtml+%60%3Cstyle%3E.qt-dialog-btn-final{border:none;padding:8px%2016px;border-radius:4px;font-size:13px;cursor:pointer;font-weight:500;transition:all%200.2s%20ease;margin-left:4px}.qt-dialog-btn-final:hover{opacity:0.8}.qt-dialog-btn-blue{background:#007bff;color:white}.qt-dialog-btn-grey{background:#6c757d;color:white}.qt-dialog-btn-orange{background:#fd7e14;color:white}%3C/style%3E%60;document.body.appendChild(d);return{dialog:d}}function%20extractName(strVal){if(!strVal||typeof%20strVal!=='string')return'';const%20m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);return%20m?m[0]:strVal.split('%20')[0]}function%20createEnvSelectionDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2010px%200;color:#333;font-size:16px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22display:flex;gap:8px;justify-content:center;%22%3E%3Cbutton%20class=%22qt-env-btn%22%20data-v=%22test%22%20style=%22background:#27ae60;color:white;padding:10px%2016px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%3Cbutton%20class=%22qt-env-btn%22%20data-v=%22prod%22%20style=%22background:#d35400;color:white;padding:10px%2016px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtEnvSelDialog',html);dialog.querySelectorAll('.qt-env-btn').forEach(b=%3E{b.onmouseover=()=%3Eb.style.opacity='0.8';b.onmouseout=()=%3Eb.style.opacity='1';b.onclick=()=%3E{dialog.remove();resolve(b.dataset.v)}})})}function%20createTokenDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2012px%200;color:#333;font-size:16px;text-align:center;font-weight:600;%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22qt-token-input%22%20style=%22width:100%;padding:8px;border:1px%20solid%20#ddd;border-radius:4px;font-size:14px;margin-bottom:12px;color:#333;box-sizing:border-box;outline:none;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;gap:8px;%22%3E%3Cbutton%20id=%22qt-token-skip%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20id=%22qt-token-cancel%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-token-ok%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtTokenDialog_final',html,'320px','400px');setTimeout(()=%3E{const%20inputEl=document.getElementById('qt-token-input');if(inputEl)inputEl.focus()},100);const%20cleanup=value=%3E{document.removeEventListener('keydown',keyHandler);dialog.remove();resolve(value)};const%20keyHandler=e=%3E{if(e.key==='Escape'){cleanup(null)}else%20if(e.key==='Enter'){e.preventDefault();const%20inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')}};document.addEventListener('keydown',keyHandler);document.getElementById('qt-token-ok').onclick=()=%3E{const%20inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')};document.getElementById('qt-token-cancel').onclick=()=%3Ecleanup(null);document.getElementById('qt-token-skip').onclick=()=%3Ecleanup('_QT_SKIP_')})}function%20createQuerySetupDialog(currentApiKey){return%20new%20Promise(resolve=%3E{let%20selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;const%20btns=QUERYABLE_FIELD_DEFINITIONS.map(d=%3E%60%3Cbutton%20class=%22qt-querytype-btn-final%22%20data-apikey=%22${d.queryApiKey}%22%20style=%22background-color:${d.color};color:white;border:2px%20solid%20transparent;padding:5px%200;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all%200.15s%20ease;height:26px;line-height:1.2;%22%3E${escapeHtml(d.queryDisplayName)}%3C/button%3E%60).join('');const%20html=%60%3Ch3%20style=%22margin:0%200%208px%200;color:#333;font-size:15px;text-align:center;font-weight:700;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%3C/h3%3E%3Cdiv%20id=%22qt-querytype-buttons-final%22%20style=%22display:flex;gap:4px;margin-bottom:8px;%22%3E${btns}%3C/div%3E%3Ctextarea%20id=%22qt-queryvalues-input-final%22%20style=%22width:100%;min-height:45px;padding:6px;border:1px%20solid%20#ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;box-sizing:border-box;%22%20placeholder=%22%E8%AB%8B%E5%85%88%E9%81%B8%E6%93%87%E4%B8%8A%E6%96%B9%E6%9F%A5%E8%A9%A2%E6%AC%84%E4%BD%8D%22%3E%3C/textarea%3E%3Cdiv%20style=%22display:flex;justify-content:space-between;align-items:center;gap:8px;%22%3E%3Cbutton%20id=%22qt-clear-input-btn%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E6%B8%85%E9%99%A4%3C/button%3E%3Cbutton%20id=%22qt-import-csv-btn%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8C%AF%E5%85%A5%E6%AA%94%E6%A1%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-cancel-final%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-querysetup-ok-final%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E7%A2%BA%E8%AA%8D%3C/button%3E%3C/div%3E%3Cinput%20type=%22file%22%20id=%22qt-csv-file-input%22%20accept=%22.csv,.txt%22%20style=%22display:none;%22%3E%60;const{dialog}=createDialogBase('qtQuerySetupDialog_final',html,'420px','600px');const%20qvInput=document.getElementById('qt-queryvalues-input-final');const%20typeBtns=dialog.querySelectorAll('.qt-querytype-btn-final');const%20csvFileInput=document.getElementById('qt-csv-file-input');const%20importCsvBtn=document.getElementById('qt-import-csv-btn');function%20setActiveButton(apiKey){typeBtns.forEach(b=%3E{const%20isSel=b.dataset.apikey===apiKey;b.style.borderColor=isSel?b.style.backgroundColor:'transparent';b.style.boxShadow=isSel?%600%200%200%201.5px%20#fff,%200%200%200%203px%20${b.style.backgroundColor}%60:'none';b.style.filter=isSel?'brightness(1.12)':'brightness(1)';if(isSel){const%20selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=%3Ed.queryApiKey===apiKey);qvInput.placeholder=%60%E8%AB%8B%E8%BC%B8%E5%85%A5${selDef.queryDisplayName}(%E5%8F%AF%E5%A4%9A%E7%AD%86%EF%BC%8C%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E3%80%81%E5%88%86%E8%99%9F%E6%88%96%E6%8F%9B%E8%A1%8C%E5%88%86%E9%9A%94)%60}})}typeBtns.forEach(b=%3E{b.onclick=()=%3E{selApiKey=b.dataset.apikey;setActiveButton(selApiKey);qvInput.focus()}});setActiveButton(selApiKey);document.getElementById('qt-clear-input-btn').onclick=()=%3E{qvInput.value='';const%20csvColSel=document.getElementById('qt-csv-col-sel');if(csvColSel){csvColSel.parentElement.remove()}currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const%20csvFileInput=document.getElementById('qt-csv-file-input');if(csvFileInput){csvFileInput.value=''}if(selApiKey){setActiveButton(selApiKey)}qvInput.focus();displaySystemNotification('%E5%B7%B2%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E5%8C%AF%E5%85%A5%E8%B3%87%E6%96%99',false)};importCsvBtn.onclick=()=%3EcsvFileInput.click();csvFileInput.onchange=e=%3E{const%20file=e.target.files[0];if(!file)return;const%20reader=new%20FileReader();reader.onload=re=%3E{try{const%20text=re.target.result;const%20lines=text.split(/\r?\n/).filter(l=%3El.trim()!==%22%22);if(lines.length%3C2){displaySystemNotification('CSV%E6%AA%94%E6%A1%88%E8%B3%87%E6%96%99%E4%B8%8D%E8%B6%B3',true);return}currentTableInstance.isCSVImportModeGlobal=true;csvImportState.isImported=true;csvImportState.fileName=file.name;const%20headers=lines[0].split(/,|;|\t/).map(h=%3Eh.trim());csvImportState.headers=headers;csvImportState.csvHeaders=headers;const%20oldSelector=document.getElementById('qt-csv-col-sel');if(oldSelector){oldSelector.parentElement.remove()}let%20selectHtml=%60%3Cdiv%20style=%22margin-bottom:8px;%22%3E%3Clabel%20style=%22font-weight:bold;%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E4%BE%9D%E6%93%9A%E6%AC%84%E4%BD%8D%EF%BC%9A%3C/label%3E%3Cselect%20id=%22qt-csv-col-sel%22%20style=%22margin:0%208px%208px%200;%22%3E%60;headers.forEach((h,idx)=%3EselectHtml+=%60%3Coption%20value=%22${idx}%22%3E${h}%3C/option%3E%60);selectHtml+=%60%3C/select%3E%3Cspan%20style=%22font-size:11px;color:#666;%22%3E(%E6%AA%94%E6%A1%88:%20${file.name})%3C/span%3E%3C/div%3E%60;qvInput.insertAdjacentHTML('beforebegin',selectHtml);const%20colSel=document.getElementById('qt-csv-col-sel');function%20fillInputByCol(colIdx){const%20values=[];for(let%20i=1;i%3Clines.length;i++){const%20cols=lines[i].split(/,|;|\t/);if(cols[colIdx]&&cols[colIdx].trim()!==%22%22)values.push(cols[colIdx].trim())}const%20uniq=Array.from(new%20Set(values));qvInput.value=uniq.join('\n');csvImportState.selectedColumn=colIdx}colSel.onchange=()=%3EfillInputByCol(Number(colSel.value));fillInputByCol(0);displaySystemNotification('CSV%E5%8C%AF%E5%85%A5%E6%88%90%E5%8A%9F%EF%BC%8C%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E4%BE%9D%E6%93%9A%E6%AC%84%E4%BD%8D',false)}catch(err){displaySystemNotification('CSV%E8%A7%A3%E6%9E%90%E5%A4%B1%E6%95%97',true)}};reader.onerror=()=%3EdisplaySystemNotification('%E8%AE%80%E5%8F%96%E6%AA%94%E6%A1%88%E5%A4%B1%E6%95%97',true);reader.readAsText(file,'utf-8');e.target.value=null};document.getElementById('qt-querysetup-ok-final').onclick=()=%3E{const%20vs=qvInput.value.trim();if(!selApiKey){displaySystemNotification('%E8%AB%8B%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E9%A1%9E%E5%9E%8B',true);return}if(!vs){displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',true);qvInput.focus();return}dialog.remove();resolve({selectedApiKey:selApiKey,queryValues:vs})};document.getElementById('qt-querysetup-cancel-final').onclick=()=%3E{dialog.remove();resolve(null)}})}function%20createTextSettingDialog(){return%20new%20Promise(resolve=%3E{const%20html=%60%3Ch3%20style=%22margin:0%200%2015px%200;color:#333;font-size:16px;text-align:center;font-weight:600;%22%3EA17%20%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin-bottom:12px;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9%EF%BC%9A%3C/label%3E%3Ctextarea%20id=%22qt-text-content%22%20style=%22width:100%;height:120px;padding:8px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;resize:vertical;font-family:'Microsoft%20JhengHei',Arial,sans-serif;%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%20A17%20%E9%80%9A%E7%9F%A5%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9...%22%3E${escapeHtml(textSettings.content)}%3C/textarea%3E%3C/div%3E%3Cdiv%20style=%22display:flex;gap:15px;margin-bottom:15px;%22%3E%3Cdiv%20style=%22flex:1;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E5%AD%97%E9%AB%94%E5%A4%A7%E5%B0%8F%EF%BC%9A%3C/label%3E%3Cinput%20type=%22number%22%20id=%22qt-font-size%22%20style=%22width:100%;padding:6px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;%22%20value=%22${textSettings.fontSize}%22%20min=%228%22%20max=%2224%22%20step=%220.5%22%3E%3Csmall%20style=%22color:#666;%22%3Ept%3C/small%3E%3C/div%3E%3Cdiv%20style=%22flex:1;%22%3E%3Clabel%20style=%22display:block;margin-bottom:5px;font-weight:500;color:#555;%22%3E%E8%A1%8C%E9%AB%98%EF%BC%9A%3C/label%3E%3Cinput%20type=%22number%22%20id=%22qt-line-height%22%20style=%22width:100%;padding:6px;border:1px%20solid%20#ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;%22%20value=%22${textSettings.lineHeight}%22%20min=%221%22%20max=%223%22%20step=%220.1%22%3E%3Csmall%20style=%22color:#666;%22%3E%E5%80%8D%E6%95%B8%3C/small%3E%3C/div%3E%3C/div%3E%3Cdiv%20style=%22background:#f8f9fa;padding:10px;border-radius:4px;margin-bottom:15px;%22%3E%3Cdiv%20style=%22font-size:11px;color:#666;margin-bottom:5px;%22%3E%E9%A0%90%E8%A6%BD%E6%95%88%E6%9E%9C%EF%BC%9A%3C/div%3E%3Cdiv%20id=%22qt-text-preview%22%20style=%22font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};color:#333;max-height:80px;overflow-y:auto;border:1px%20solid%20#e9ecef;padding:8px;background:white;border-radius:3px;%22%3E${escapeHtml(textSettings.content.substring(0,100))}...%3C/div%3E%3C/div%3E%3Cdiv%20style=%22text-align:right;display:flex;justify-content:flex-end;gap:8px;%22%3E%3Cbutton%20id=%22qt-text-reset%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-orange%22%3E%E9%87%8D%E8%A8%AD%3C/button%3E%3Cbutton%20id=%22qt-text-cancel%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3Cbutton%20id=%22qt-text-save%22%20class=%22qt-dialog-btn-final%20qt-dialog-btn-blue%22%3E%E5%AD%98%E6%AA%94%3C/button%3E%3C/div%3E%60;const{dialog}=createDialogBase('qtTextSettingDialog_final',html,'480px','600px');function%20updatePreview(){const%20content=document.getElementById('qt-text-content').value;const%20fontSize=document.getElementById('qt-font-size').value;const%20lineHeight=document.getElementById('qt-line-height').value;const%20preview=document.getElementById('qt-text-preview');preview.style.fontSize=fontSize+'pt';preview.style.lineHeight=lineHeight;preview.textContent=content.substring(0,100)+(content.length%3E100?'...':'')}setTimeout(()=%3E{document.getElementById('qt-text-content').addEventListener('input',updatePreview);document.getElementById('qt-font-size').addEventListener('input',updatePreview);document.getElementById('qt-line-height').addEventListener('input',updatePreview)},100);document.getElementById('qt-text-save').onclick=()=%3E{const%20newSettings={content:document.getElementById('qt-text-content').value.trim(),fontSize:parseFloat(document.getElementById('qt-font-size').value),lineHeight:parseFloat(document.getElementById('qt-line-height').value)};if(!newSettings.content){displaySystemNotification('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%96%87%E6%9C%AC%E5%85%A7%E5%AE%B9',true);return}textSettings=newSettings;saveTextSettings();displaySystemNotification('%E6%96%87%E6%9C%AC%E8%A8%AD%E5%AE%9A%E5%B7%B2%E4%BF%9D%E5%AD%98',false);dialog.remove();resolve(true)};document.getElementById('qt-text-cancel').onclick=()=%3E{dialog.remove();resolve(false)};document.getElementById('qt-text-reset').onclick=()=%3E{document.getElementById('qt-text-content').value=A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3;document.getElementById('qt-font-size').value=10.5;document.getElementById('qt-line-height').value=1.5;updatePreview()}})}async%20function%20performApiQuery(queryValue){const%20reqBody={currentPage:1,pageSize:10};reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;const%20fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};if(apiAuthToken){fetchOpts.headers['SSO-TOKEN']=apiAuthToken}try{const%20res=await%20fetch(CURRENT_API_URL,fetchOpts);const%20data=await%20res.json();if(res.status===401){displaySystemNotification('TOKEN%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F',true);return{error:'token_invalid',data:null}}return{error:null,data:data,success:data&&data.records&&data.records.length%3E0}}catch(e){console.error('%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97:',e);return{error:'network_error',data:null}}}function%20getFirstLetter(unitString){if(!unitString||typeof%20unitString!=='string')return'Z';for(let%20i=0;i%3CunitString.length;i++){const%20char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char)){return%20char}}return'Z'}function%20filterDataByUnit(data,unitId){if(unitId==='UNDEF'){const%20knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=%3Eb.id!=='UNDEF').map(b=%3Eb.id.toUpperCase());return%20data.filter(r=%3E{const%20uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return%20uVal.trim()===''||!knownPrefixes.some(prefix=%3EuVal.toUpperCase().startsWith(prefix))})}else{return%20data.filter(r=%3E{const%20uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return%20uVal.toUpperCase().startsWith(unitId.toUpperCase())})}}function%20createA17UnitButtons(){const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(!a17BtnsCtr)return;a17BtnsCtr.style.cssText='margin-bottom:5px;display:flex;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;visibility:visible;';a17BtnsCtr.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=%3E{const%20btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:5px%204px;border-radius:3px;cursor:pointer;font-size:9px;transition:all%200.2s%20ease;width:calc((100vw%20-%20320px)%20/%208);min-width:70px;max-width:90px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;%60;btn.textContent=%60${unitDef.label}%20(0)%60;btn.onclick=()=%3E{if(btn.disabled)return;const%20unitId=unitDef.id;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow='0%200%200%202px%20white,%200%200%200%204px%20black'}if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification(%60%E5%B7%B2%E9%81%B8%E6%93%87%20${a17ModeState.selectedUnits.size}%20%E5%80%8B%E5%96%AE%E4%BD%8D%60,false)};a17BtnsCtr.appendChild(btn)})}function%20filterA17DataBySelectedUnits(){let%20filteredData=[];a17ModeState.selectedUnits.forEach(unitId=%3E{let%20unitData=filterDataByUnit(baseA17MasterData,unitId);filteredData=filteredData.concat(unitData)});filteredData.sort((a,b)=%3E{const%20unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20firstLetterA=getFirstLetter(unitA);const%20firstLetterB=getFirstLetter(unitB);return%20firstLetterA.localeCompare(firstLetterB)});window.pTBRs(filteredData)}function%20updateA17UnitButtonCounts(){if(!a17ModeState.isActive)return;const%20unitCounts={};baseA17MasterData.forEach(r=%3E{const%20unitFull=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');let%20unitPrefix='UNDEF';for(const%20code%20in%20UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()===''){unitPrefix='UNDEF'}unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});const%20buttons=document.getElementById('qt-a17-unit-btns-ctr-final')?.querySelectorAll('button')||[];buttons.forEach(btn=%3E{const%20unitId=btn.dataset.unitId;const%20count=unitCounts[unitId]||0;const%20unitDef=A17_UNIT_BUTTONS_DEFS.find(def=%3Edef.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label}%20(${count})%60;if(count===0){btn.disabled=true;btn.style.opacity='0.5';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.disabled=false;btn.style.opacity='1'}}});if(a17ModeState.selectedUnits.size===0){window.pTBRs(baseA17MasterData)}}function%20generateAndCopyA17NotificationWithSettings(dataToCopy,headers,withText){loadTextSettings();const%20htmlRows=dataToCopy.map((r,idx)=%3E%60%3Ctr%20style=%22${idx%2?'background-color:#fdfdfd;':'#f7f7f7'}%22%3E${headers.map(h=%3E{let%20cellTxt='';if(h===''){cellTxt=''}else{cellTxt=escapeHtml(String(r[h]||''))}return%60%3Ctd%20style=%22border:1px%20solid%20#bbb;padding:3px%204px;text-align:center;font-size:${textSettings.fontSize}pt;color:#333;%22%3E${cellTxt}%3C/td%3E%60}).join('')}%3C/tr%3E%60).join('');const%20htmlTab=%60%3Ctable%20style=%22border-collapse:collapse;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;width:100%;margin-top:8px;%22%3E%3Cthead%3E%3Ctr%20style=%22background-color:#34495e;color:white;%22%3E${headers.map(h=%3E%60%3Cth%20style=%22border:1px%20solid%20#2c3e50;padding:4px;text-align:center;font-weight:bold;%22%3E${escapeHtml(h)}%3C/th%3E%60).join('')}%3C/tr%3E%3C/thead%3E%3Ctbody%3E${htmlRows}%3C/tbody%3E%3C/table%3E%60;const%20htmlOut=withText?%60%3Cdiv%20style=%22font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};%22%3E${textSettings.content.split('\n').map(line=%3E%60%3Cp%3E${escapeHtml(line)}%3C/p%3E%60).join('')}${htmlTab}%3C/div%3E%60:htmlTab;const%20plainRows=dataToCopy.map(r=%3Eheaders.map(h=%3EString(r[h]||'')).join('\t')).join('\n');const%20plainOut=withText?textSettings.content+'\n\n'+headers.join('\t')+'\n'+plainRows:headers.join('\t')+'\n'+plainRows;try{navigator.clipboard.write([new%20ClipboardItem({'text/html':new%20Blob([htmlOut],{type:'text/html'}),'text/plain':new%20Blob([plainOut],{type:'text/plain'})})]).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%20A17%20%E9%80%9A%E7%9F%A5%E5%85%A7%E5%AE%B9',false)})}catch(e){navigator.clipboard.writeText(plainOut).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%20A17%20%E9%80%9A%E7%9F%A5%E5%85%A7%E5%AE%B9',false)})}}function%20executeA17SortAndFilter(){if(!a17ModeState.isActive){a17ModeState.isActive=true;currentTableInstance.isA17Mode=true;const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='flex'}baseA17MasterData=[...originalQueryResults];let%20a17Headers;if(currentTableInstance.isCSVImportModeGlobal&&csvImportState.csvHeaders.length%3E0){a17Headers=[...csvImportState.csvHeaders,...A17_API_DATA_DISPLAY_HEADERS]}else{a17Headers=['%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC','NO','%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','%E8%A6%86%E6%A0%B8','%E7%8B%80%E6%85%8B','%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']}currentTableInstance.currentHeaders=[...a17Headers];window.rTHs(a17Headers);createA17UnitButtons();updateA17UnitButtonCounts();window.pTBRs(baseA17MasterData);displaySystemNotification('%E5%B7%B2%E9%80%B2%E5%85%A5%20A17%20%E6%A8%A1%E5%BC%8F',false)}else{a17ModeState.isActive=false;a17ModeState.selectedUnits.clear();const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='none'}let%20originalHeaders=[];if(selectedQueryDefinitionGlobal){originalHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{originalHeaders.push(%22%E6%9F%A5%E8%A9%A2%E5%80%BC%22)}originalHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{originalHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});originalHeaders.push('%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C');currentTableInstance.currentHeaders=[...originalHeaders];window.rTHs(originalHeaders);window.pTBRs(originalQueryResults);displaySystemNotification('%E5%B7%B2%E9%80%80%E5%87%BA%20A17%20%E6%A8%A1%E5%BC%8F',false)}}function%20handleA17Copy(){const%20isTextEnabled=document.getElementById('qt-text-enable-checkbox')?.checked||false;let%20dataToCopy;if(a17ModeState.selectedUnits.size%3E0){dataToCopy=[];a17ModeState.selectedUnits.forEach(unitId=%3E{let%20unitData=filterDataByUnit(baseA17MasterData,unitId);dataToCopy=dataToCopy.concat(unitData)});dataToCopy.sort((a,b)=%3E{const%20unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const%20firstLetterA=getFirstLetter(unitA);const%20firstLetterB=getFirstLetter(unitB);return%20firstLetterA.localeCompare(firstLetterB)})}else{dataToCopy=[...baseA17MasterData]}generateAndCopyA17NotificationWithSettings(dataToCopy,A17_COPY_ONLY_HEADERS,isTextEnabled)}function%20sortTableByColumn(columnIndex,headerName){const%20currentData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const%20header=currentTableInstance.currentHeaders[columnIndex];const%20currentDirection=currentTableInstance.sortDirections[header]||'asc';const%20newDirection=currentDirection==='asc'?'desc':'asc';currentTableInstance.sortDirections[header]=newDirection;const%20sortedData=[...currentData].sort((a,b)=%3E{const%20aVal=String(a[header]||'');const%20bVal=String(b[header]||'');if(newDirection==='asc'){return%20aVal.localeCompare(bVal)}else{return%20bVal.localeCompare(aVal)}});if(a17ModeState.isActive){baseA17MasterData=sortedData}else{originalQueryResults=sortedData}window.pTBRs(sortedData);displaySystemNotification(%60%E5%B7%B2%E6%8C%89${headerName}${newDirection==='asc'?'%E5%8D%87%E5%BA%8F':'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%BA%8F%60,false)}function%20renderResultsTableUI(dataToRender){const%20mainId='qtMainContainer_final';document.getElementById(mainId)?.remove();const%20mainUI=document.createElement('div');mainUI.id=mainId;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:20px;transform:translateX(-50%);background:#ffffff;border-radius:12px;box-shadow:0%2010px%2040px%20rgba(0,0,0,0.15);padding:16px;width:900px;max-width:95vw;max-height:90vh;overflow:hidden;font-family:'Microsoft%20JhengHei',Arial,sans-serif;font-size:13px;display:flex;flex-direction:column;border:1px%20solid%20rgba(0,0,0,0.1);%60;let%20initialTableHeaders=[];if(selectedQueryDefinitionGlobal){initialTableHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{initialTableHeaders.push(%22%E6%9F%A5%E8%A9%A2%E5%80%BC%22)}initialTableHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=%3E{initialTableHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});initialTableHeaders.push('%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C');currentTableInstance.currentHeaders=[...initialTableHeaders];const%20controlsHeader=document.createElement('div');controlsHeader.style.cssText='display:flex;align-items:center;margin-bottom:5px;padding-bottom:5px;border-bottom:1px%20solid%20#ddd;flex-shrink:0;';const%20summarySec=document.createElement('div');summarySec.style.cssText='font-size:12px;font-weight:bold;color:#2c3e50;white-space:nowrap;margin-right:10px;flex-shrink:0;';summarySec.innerHTML=%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%EF%BC%9A%3Cstrong%3E${dataToRender.length}%3C/strong%3E%E7%AD%86%60;controlsHeader.appendChild(summarySec);const%20filterInput=document.createElement('input');filterInput.type='text';filterInput.id='qt-tbl-flt-final';filterInput.placeholder='%E6%89%BE%E5%87%BA%E6%88%91%E8%A6%81%E7%9A%84%E8%B3%87%E6%96%99%E3%80%82';filterInput.style.cssText='padding:5px%207px;border:1px%20solid%20#bababa;border-radius:3px;font-size:12px;width:120px;flex-shrink:0;margin-right:10px;';controlsHeader.appendChild(filterInput);const%20buttonsGroup=document.createElement('div');buttonsGroup.style.cssText='display:flex;align-items:center;gap:5px;flex-shrink:0;';const%20buttonConfigs=[{id:'qt-clr-cond-btn-final',text:'%E6%B8%85%E9%99%A4%E6%A2%9D%E4%BB%B6',style:'background:#6c757d;color:white;'},{id:'qt-req-btn-final',text:'%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2',style:'background:#ffc107;color:#212529;'},{id:'qt-a17-btn-final',text:'A17%E4%BD%9C%E6%A5%AD%E9%80%9A%E7%9F%A5',style:'background:#6f42c1;color:white;'},{id:'qt-cpy-all-btn-final',text:'%E8%A4%87%E8%A3%BD',style:'background:#28a745;color:white;'}];buttonConfigs.forEach(config=%3E{const%20btn=document.createElement('button');btn.id=config.id;btn.textContent=config.text;btn.style.cssText=config.style+'border:none;padding:5px%2010px;border-radius:3px;cursor:pointer;font-size:11.5px;font-weight:500;transition:opacity%200.1s%20ease;white-space:nowrap;';btn.onmouseover=()=%3Ebtn.style.opacity='0.8';btn.onmouseout=()=%3Ebtn.style.opacity='1';buttonsGroup.appendChild(btn)});controlsHeader.appendChild(buttonsGroup);const%20textCheckbox=document.createElement('input');textCheckbox.type='checkbox';textCheckbox.id='qt-text-enable-checkbox';textCheckbox.checked=true;textCheckbox.style.cssText='margin-left:10px;cursor:pointer;';const%20textCheckboxLabel=document.createElement('label');textCheckboxLabel.htmlFor='qt-text-enable-checkbox';textCheckboxLabel.textContent='A17%E6%96%87%E6%9C%AC';textCheckboxLabel.style.cssText='font-size:11px;color:#555;cursor:pointer;margin:0%208px%200%202px;user-select:none;';const%20textEditBtn=document.createElement('button');textEditBtn.id='qt-text-edit-btn-final';textEditBtn.textContent='%E6%96%87%E6%9C%AC%E7%B7%A8%E8%BC%AF';textEditBtn.style.cssText='background:#17a2b8;color:white;font-size:10px;padding:4px%208px;border:none;border-radius:3px;cursor:pointer;';textEditBtn.onmouseover=()=%3EtextEditBtn.style.opacity='0.8';textEditBtn.onmouseout=()=%3EtextEditBtn.style.opacity='1';controlsHeader.appendChild(textCheckbox);controlsHeader.appendChild(textCheckboxLabel);controlsHeader.appendChild(textEditBtn);const%20editModeBtn=document.createElement('button');editModeBtn.id='qt-edit-mode-btn-final';editModeBtn.textContent='%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editModeBtn.style.cssText='background:#6c757d;color:white;font-size:11px;padding:5px%2010px;margin-left:8px;border:none;border-radius:3px;cursor:pointer;';editModeBtn.onmouseover=()=%3EeditModeBtn.style.opacity='0.8';editModeBtn.onmouseout=()=%3EeditModeBtn.style.opacity='1';controlsHeader.appendChild(editModeBtn);const%20closeBtn=document.createElement('button');closeBtn.textContent='%E9%97%9C%E9%96%89';closeBtn.style.cssText='background:#dc3545;color:white;margin-left:auto;border:none;padding:5px%2010px;border-radius:3px;cursor:pointer;font-size:11.5px;';closeBtn.onmouseover=()=%3EcloseBtn.style.opacity='0.8';closeBtn.onmouseout=()=%3EcloseBtn.style.opacity='1';closeBtn.onclick=()=%3EmainUI.remove();controlsHeader.appendChild(closeBtn);mainUI.appendChild(controlsHeader);const%20a17BtnsCtr=document.createElement('div');a17BtnsCtr.id='qt-a17-unit-btns-ctr-final';a17BtnsCtr.style.cssText='margin-bottom:5px;display:none;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;';mainUI.appendChild(a17BtnsCtr);const%20tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px%20solid%20#ccc;border-radius:4px;';const%20tableEl=document.createElement('table');tableEl.id='qt-res-tbl-final';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:11.5px;';tableScrollWrap.appendChild(tableEl);mainUI.appendChild(tableScrollWrap);const%20tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:10;background-color:#34495e;';tableEl.appendChild(tHREl);const%20tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);document.body.appendChild(mainUI);function%20rTHs(hdrs){tHREl.innerHTML='';const%20hr=document.createElement('tr');hdrs.forEach((hTxt,idx)=%3E{const%20th=document.createElement('th');th.textContent=hTxt;th.style.cssText=%60color:#fff;text-align:center;padding:6px%204px;border-bottom:1px%20solid%20#2c3e50;white-space:nowrap;cursor:pointer;user-select:none;font-weight:600;border-right:1px%20solid%20#4a6075;font-size:11px;${idx===0?'background:#007bff;':''}%60;if(idx===hdrs.length-1)th.style.borderRight='none';th.onclick=()=%3E{sortTableByColumn(idx,hTxt)};hr.appendChild(th)});tHREl.appendChild(hr)}function%20pTBRs(data){tBREl.innerHTML='';data.forEach((row,idx)=%3E{const%20tr=document.createElement('tr');tr.style.backgroundColor=idx%2?'#f8f9fa':'#fff';currentTableInstance.currentHeaders.forEach((header,colIdx)=%3E{const%20td=document.createElement('td');td.style.cssText='padding:4px%206px;border-bottom:1px%20solid%20#dee2e6;font-size:11px;text-align:center;cursor:pointer;';if(colIdx===0){td.style.background='#e3f0fd';td.style.fontWeight='bold'}let%20cellContent=row[header];if(header.includes('%E7%8B%80%E6%85%8B')&&typeof%20cellContent==='string'&&cellContent.includes('%3Cspan')){td.innerHTML=cellContent}else{td.textContent=cellContent||''}td.onclick=function(e){e.stopPropagation();if(isEditMode&&colIdx%3E1){startCellEdit(td,row,header,cellContent)}else{navigator.clipboard.writeText(td.textContent).then(()=%3E{displaySystemNotification('%E5%B7%B2%E8%A4%87%E8%A3%BD%E5%85%A7%E5%AE%B9%EF%BC%9A'+td.textContent,false,1000)})}};tr.appendChild(td)});tBREl.appendChild(tr)});if(a17ModeState.isActive){setTimeout(()=%3E{updateA17UnitButtonCounts()},100)}}function%20startCellEdit(td,rowData,headerName,originalValue){if(td.querySelector('input'))return;const%20input=document.createElement('input');input.type='text';input.value=td.textContent;input.style.cssText=%60width:100%;border:2px%20solid%20#007bff;padding:2px%204px;font-size:11px;background:#fff3cd;box-sizing:border-box;outline:none;%60;td.innerHTML='';td.appendChild(input);input.focus();input.select();input.onkeydown=function(e){if(e.key==='Enter'){finishEdit(td,input,rowData,headerName,originalValue)}else%20if(e.key==='Escape'){td.textContent=originalValue}};input.onblur=function(){finishEdit(td,input,rowData,headerName,originalValue)}}function%20finishEdit(td,input,rowData,headerName,originalValue){const%20newValue=input.value.trim();td.textContent=newValue;rowData[headerName]=newValue;if(newValue!==originalValue){td.style.background='#d4edda';displaySystemNotification(%60%E5%B7%B2%E6%9B%B4%E6%96%B0%EF%BC%9A${headerName}%60,false,1000);if(headerName==='%E5%88%86%E5%85%AC%E5%8F%B8'&&a17ModeState.isActive){const%20rowIndex=originalQueryResults.findIndex(row=%3Erow.NO===rowData.NO);if(rowIndex!==-1){originalQueryResults[rowIndex][headerName]=newValue}baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}}}}function%20updateTableEditMode(){const%20cells=tableEl.querySelectorAll('tbody%20td');cells.forEach((cell,index)=%3E{const%20colIndex=index%currentTableInstance.currentHeaders.length;if(isEditMode&&colIndex%3E1){cell.style.cursor='text';cell.style.border='1px%20dashed%20#007bff';cell.title='%E9%BB%9E%E6%93%8A%E7%B7%A8%E8%BC%AF%EF%BC%8C%E6%8C%89%20Enter%20%E5%AE%8C%E6%88%90'}else{cell.style.cursor='pointer';cell.style.border='';cell.title='%E9%BB%9E%E6%93%8A%E8%A4%87%E8%A3%BD'}})}rTHs(currentTableInstance.currentHeaders);pTBRs(dataToRender);filterInput.oninput=()=%3E{const%20v=filterInput.value.trim().toLowerCase();if(!v){pTBRs(a17ModeState.isActive?baseA17MasterData:originalQueryResults);return}const%20sourceData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const%20filtered=sourceData.filter(row=%3EObject.values(row).some(val=%3EString(val||'').toLowerCase().includes(v)));pTBRs(filtered)};document.getElementById('qt-clr-cond-btn-final').onclick=()=%3E{a17ModeState.selectedUnits.clear();const%20a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.querySelectorAll('button').forEach(btn=%3E{btn.classList.remove('highlighted');btn.style.boxShadow='none'})}filterInput.value='';currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};if(a17ModeState.isActive){const%20normalA17Headers=['%E9%80%81%E9%87%91%E5%96%AE%E8%99%9F%E7%A2%BC','NO','%E5%8F%97%E7%90%86%E8%99%9F%E7%A2%BC','%E4%BF%9D%E5%96%AE%E8%99%9F%E7%A2%BC','%E7%A2%BA%E8%AA%8D%E6%9B%B8%E7%B7%A8%E8%99%9F','%E5%88%86%E5%85%AC%E5%8F%B8','%E6%A0%B8%E4%BF%9D%E5%93%A1','%E8%A6%86%E6%A0%B8','%E7%8B%80%E6%85%8B','%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C'];currentTableInstance.currentHeaders=[...normalA17Headers];window.rTHs(normalA17Headers)}pTBRs(originalQueryResults);displaySystemNotification('%E6%A2%9D%E4%BB%B6%E5%B7%B2%E6%B8%85%E9%99%A4%EF%BC%8C%E5%8C%85%E5%90%ABCSV%E5%8C%AF%E5%85%A5%E8%B3%87%E6%96%99',false)};document.getElementById('qt-req-btn-final').onclick=()=%3E{mainUI.remove();executeCaseQueryTool()};document.getElementById('qt-a17-btn-final').onclick=()=%3E{executeA17SortAndFilter()};document.getElementById('qt-cpy-all-btn-final').onclick=()=%3E{if(a17ModeState.isActive){handleA17Copy()}else{handleNormalCopy()}};textEditBtn.onclick=()=%3E{createTextSettingDialog()};editModeBtn.onclick=()=%3E{isEditMode=!isEditMode;editModeBtn.textContent=isEditMode?'%E9%80%80%E5%87%BA%E7%B7%A8%E8%BC%AF':'%E7%B7%A8%E8%BC%AF%E6%A8%A1%E5%BC%8F';editModeBtn.style.background=isEditMode?'#dc3545':'#6c757d';updateTableEditMode();if(!isEditMode&&a17ModeState.isActive){baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size%3E0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification('%E5%B7%B2%E6%9B%B4%E6%96%B0A17%E5%88%86%E5%85%AC%E5%8F%B8%E7%AF%A9%E9%81%B8%E7%8B%80%E6%85%8B',false)}};window.pTBRs=pTBRs;window.rTHs=rTHs}function%20handleNormalCopy(){const%20dataToCopy=[...originalQueryResults];const%20headers=currentTableInstance.currentHeaders;const%20rows=dataToCopy.map(row=%3Eheaders.map(header=%3EString(row[header]||'')).join('\t')).join('\n');const%20textOutput=headers.join('\t')+'\n'+rows;navigator.clipboard.writeText(textOutput).then(()=%3E{displaySystemNotification(%60%E5%B7%B2%E8%A4%87%E8%A3%BD%20${dataToCopy.length}%20%E7%AD%86%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%60,false)}).catch(e=%3E{console.error('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97:',e);displaySystemNotification('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97',true)})}async%20function%20executeCaseQueryTool(){const%20mainContainerId='qtMainContainer_vFinal';if(document.getElementById(mainContainerId)){displaySystemNotification('%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%96%8B%E5%95%9F',true);return}const%20selectedEnv=await%20createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60%E7%92%B0%E5%A2%83:%20${selectedEnv==='prod'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%60);if(!apiAuthToken){const%20tokenRes=await%20createTokenDialog();if(tokenRes===null){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}if(tokenRes==='_QT_SKIP_'){displaySystemNotification('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5',false);apiAuthToken=null}else%20if(!tokenRes){displaySystemNotification('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2',true);return}else{apiAuthToken=tokenRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}}const%20querySetupRes=await%20createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);if(!querySetupRes){displaySystemNotification('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',true);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=%3Eqdf.queryApiKey===querySetupRes.selectedApiKey);const%20queryValuesRaw=querySetupRes.queryValues;const%20queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=%3Ex.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E6%9F%A5%E8%A9%A2%E5%80%BC',true);return}const%20loadingOverlay=document.createElement('div');loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:%22Microsoft%20JhengHei%22,Arial,sans-serif;%60;const%20loadingP=document.createElement('p');loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';const%20loadingDiv=document.createElement('div');loadingDiv.style.cssText='background:#fff;padding:20px%2025px;border-radius:7px;text-align:center;box-shadow:0%203px%2012px%20rgba(0,0,0,0.1);';loadingDiv.innerHTML=%60%3Cdiv%20style=%22width:30px;height:30px;border:3px%20solid%20#e0e0e0;border-top:3px%20solid%20#007bff;border-radius:50%;animation:qtSpinAnimationFull%201s%20linear%20infinite;margin:0%20auto%2010px;%22%3E%3C/div%3E%60;loadingDiv.appendChild(loadingP);loadingOverlay.appendChild(loadingDiv);document.body.appendChild(loadingOverlay);const%20loadingStyle=document.createElement('style');loadingStyle.textContent='@keyframes%20qtSpinAnimationFull{to{transform:rotate(360deg)}}';document.head.appendChild(loadingStyle);let%20fetchedResultsCollector=[];let%20currentCounter=1;for(let%20i=0;i%3CqueryValues.length;i++){const%20singleQueryValue=queryValues[i];loadingP.textContent=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD:%20%E7%AC%AC%20${i+1}%20/%20${queryValues.length}%20%E7%AD%86%20(${singleQueryValue})...%60;const%20resultRowBase={'NO':String(currentCounter++),'_queriedValue_':singleQueryValue};const%20apiResult=await%20performApiQuery(singleQueryValue);let%20apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97';if(apiResult.error==='token_invalid'){apiQueryStatus='%E2%9C%97%20TOKEN%E5%A4%B1%E6%95%88';loadingOverlay.remove();const%20tokenRetryRes=await%20createTokenDialog();if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){apiAuthToken=null;displaySystemNotification(tokenRetryRes===null?'%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88':'TOKEN%E6%9C%AA%E6%9B%B4%E6%96%B0/%E7%95%A5%E9%81%8E',true);if(tokenRetryRes===null){if(loadingStyle)loadingStyle.remove();return}}else{apiAuthToken=tokenRetryRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';else%20document.body.appendChild(loadingOverlay)}else%20if(apiResult.success){apiQueryStatus='%E2%9C%93%20%E6%88%90%E5%8A%9F'}else%20if(!apiResult.error){apiQueryStatus='%E2%9C%97%20%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99'}resultRowBase._apiQueryStatus=apiQueryStatus;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=%3E{const%20popRow={...resultRowBase};const%20mainStatusVal=rec['mainStatus']||'';const%20subStatusVal=rec['subStatus']||'';popRow['_raw_mainStatus_']=mainStatusVal;popRow['_raw_subStatus_']=subStatusVal;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let%20cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){popRow[dN]=%60%3Cspan%20class=%22qt-status-main%22%3E${escapeHtml(mainStatusVal)}%3C/span%3E%3Cspan%20class=%22qt-status-sub%22%3E${escapeHtml(subStatusVal)}%3C/span%3E%60}else%20if(dKey===UNIT_MAP_FIELD_API_KEY){const%20uVal=cVal;let%20uPre='';for(let%20k=0;k%3CuVal.length;k++){if(/[A-Za-z]/.test(uVal.charAt(k))){uPre=uVal.charAt(k).toUpperCase();break}}const%20mName=UNIT_CODE_MAPPINGS[uPre]||uVal;popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName}else%20if(dKey==='uwApprover'||dKey==='approvalUser'){popRow[dN]=extractName(cVal)}else{popRow[dN]=cVal}});popRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;fetchedResultsCollector.push(popRow)})}else{const%20failOrEmptyRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=%3E{const%20dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;if(dKey==='statusCombined'){failOrEmptyRow['_raw_mainStatus_']='-';failOrEmptyRow['_raw_subStatus_']='';failOrEmptyRow[dN]='-'}else{failOrEmptyRow[dN]='-'}});if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue}failOrEmptyRow['%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C']=apiQueryStatus;fetchedResultsCollector.push(failOrEmptyRow)}if(queryValues.length%3E1&&i%3CqueryValues.length-1)await%20new%20Promise(r=%3EsetTimeout(r,250))}if(document.body.contains(loadingOverlay))loadingOverlay.remove();if(loadingStyle)loadingStyle.remove();originalQueryResults=[...fetchedResultsCollector];renderResultsTableUI(originalQueryResults)}loadTextSettings();executeCaseQueryTool()})();

【PLAN】
javascript:(function(){'use strict';const CONFIG={API:{PROD:"https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/",UAT:"https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/",ENDPOINTS:{planCodeQuery:"planCodeController/query",planCodeDetail:"planCodeController/queryDetail",saleDateQuery:"planCodeSaleDateController/query"}},STORAGE:{TOKEN_KEY:"euisPlanCodeToken_v2",TOKEN_FALLBACK:'euisToken'},UI:{MAIN_ID:"planCodeQueryTool_v2",Z_INDEX:{MAIN:999999,OVERLAY:1000000,NOTIFICATION:1000001}},LIMITS:{PAGE_SIZE:5000,BATCH_SIZE:50},MASTER_DATA:{CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}}};const State={currentEnv:null,apiToken:null,queryResults:[],totalRecords:0,sortKey:null,sortDirection:'none',batchMode:false,batchPages:1,currentBatchPage:1,reset(){this.queryResults=[];this.totalRecords=0;this.sortKey=null;this.sortDirection='none';this.batchMode=false;this.batchPages=1;this.currentBatchPage=1}};const Utils={normalizeInput(str){if(typeof str!=='string')return str;return str.replace(/[\uff01-\uff5e]/g,s=>String.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g," ").trim()},escapeHtml(str){if(typeof str!=='string')return str;const escapeMap={'&':'&','<':'<','>':'>','"':'"',"'":'&#039;'};return%20str.replace(/[&%3C%3E%22']/g,m=%3EescapeMap[m])},formatDate(dateStr){if(!dateStr)return%20%22%22;try{return%20dateStr.substring(0,10).replace(/-/g,%22%22)}catch{return%20%22%22}},getTodayString(){const%20now=new%20Date();return%20%60${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}%60},transformRecord(record,index){const%20startDate=this.formatDate(record.saleStartDate);const%20endDate=this.formatDate(record.saleEndDate);const%20isStillSelling=endDate===%2299991231%22||endDate%3E=this.getTodayString();let%20endDisplay=%22-%22;if(record._isErrorRow){endDisplay=%60%3Cspan%20style=%22color:red;%22%3E${record.name||'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97'}%3C/span%3E%60}else%20if(endDate){endDisplay=isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E${endDate}%3C/span%3E%60}return{_index:index,code:record.planCode||%22-%22,name:(record.shortName||%22%22).trim()||%22N/A%22,full:(record.planCodeName||%22%22).trim()||%22N/A%22,cur:CONFIG.MASTER_DATA.CUR[record.currency]||%22-%22,unit:CONFIG.MASTER_DATA.UNIT[(record.reportInsuranceAmountUnit||record.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:CONFIG.MASTER_DATA.TYPE[record.coverageType]||%22-%22,start:startDate||%22-%22,end:endDate||%22-%22,isStillSelling,originalEndDisplay:endDisplay,_isErrorRow:record._isErrorRow||false,_detailsFetched:false,polplnCode:null,polplnDisplayText:null,channelInfo:null,channelDisplayHtml:null,applyYellowBg:false}}};const%20Notification={show(message,type='info',duration=2000){const%20id='app-notification';document.getElementById(id)?.remove();const%20el=document.createElement('div');el.id=id;el.textContent=message;el.style.cssText=%60position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${type==='error'?'#dc2626':type==='success'?'#059669':'#2563eb'};color:white;padding:12px%2020px;border-radius:6px;font-size:14px;z-index:${CONFIG.UI.Z_INDEX.NOTIFICATION};font-family:sans-serif;box-shadow:0%204px%206px%20rgba(0,0,0,0.1);animation:slideIn%200.3s%20ease-out;%60;document.body.appendChild(el);if(duration%3E0)setTimeout(()=%3Eel.remove(),duration)}};const%20API={getUrl(endpoint){return%20CONFIG.API[State.currentEnv]+CONFIG.API.ENDPOINTS[endpoint]},async%20call(endpoint,payload){try{const%20response=await%20fetch(this.getUrl(endpoint),{method:'POST',headers:{'Content-Type':'application/json','SSO-TOKEN':State.apiToken},body:JSON.stringify(payload)});if(response.status===401){return{error:'TOKEN_INVALID',message:%22TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%22}}if(!response.ok){const%20errorText=await%20response.text();return{error:'API_ERROR',message:%60%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}%20(${response.statusText||errorText||'%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4'})%60}}return%20await%20response.json()}catch(error){return{error:'NETWORK_ERROR',message:%22%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E9%8C%AF%E8%AA%A4%E6%88%96API%E7%84%A1%E5%9B%9E%E6%87%89%22}}},async%20validateToken(token){if(!token)return%20false;const%20tempToken=State.apiToken;State.apiToken=token;const%20result=await%20this.call('planCodeQuery',{planCodeName:%22%22});State.apiToken=tempToken;return%20result&&!result.error}};const%20Dialog={create(content,width='400px'){const%20overlay=document.createElement('div');overlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:${CONFIG.UI.Z_INDEX.OVERLAY};display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);%60;const%20dialog=document.createElement('div');dialog.style.cssText=%60background:white;padding:24px;border-radius:8px;box-shadow:0%2010px%2015px%20rgba(0,0,0,0.1);width:${width};font-family:sans-serif;animation:fadeIn%200.3s%20ease-out;%60;dialog.innerHTML=content;overlay.appendChild(dialog);document.body.appendChild(overlay);this.insertStyles();return{overlay,dialog}},insertStyles(){if(document.getElementById('dialog-styles'))return;const%20style=document.createElement('style');style.id='dialog-styles';style.textContent=%60@keyframes%20fadeIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}@keyframes%20slideIn{from{opacity:0;transform:translateX(-50%)%20translateY(-20px)}to{opacity:1;transform:translateX(-50%)%20translateY(0)}}.dialog-btn{border:none;padding:8px%2016px;border-radius:4px;cursor:pointer;margin:0%205px;font-weight:500;transition:all%200.2s}.btn-primary{background:#2563eb;color:white}.btn-success{background:#059669;color:white}.btn-warning{background:#d97706;color:white}.btn-secondary{background:#6b7280;color:white}.dialog-input{width:100%;padding:12px;border:2px%20solid%20#e5e7eb;border-radius:6px;margin:12px%200;box-sizing:border-box;font-size:14px}.dialog-input:focus{outline:none;border-color:#2563eb;box-shadow:0%200%200%203px%20rgba(37,99,235,0.1)}.dialog-title{text-align:center;margin:0%200%2024px%200;font-size:20px;font-weight:600;color:#1f2937}.radio-option{display:block;margin-bottom:12px;cursor:pointer;padding:8px;border-radius:4px;transition:all%200.2s}.radio-option:hover{background:#f8fafc}.radio-option%20input[type=%22radio%22]{margin-right:8px}%60;document.head.appendChild(style)},async%20selectEnvironment(){return%20new%20Promise(resolve=%3E{const{overlay}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22text-align:center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-success%22%20onclick=%22resolveEnv('UAT')%22%20style=%22margin:8px;%22%3E%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83%20(UAT)%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-warning%22%20onclick=%22resolveEnv('PROD')%22%20style=%22margin:8px;%22%3E%E6%AD%A3%E5%BC%8F%E7%92%B0%E5%A2%83%20(PROD)%3C/button%3E%3Cbr%3E%3Cbr%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveEnv(null)%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'350px');window.resolveEnv=(value)=%3E{overlay.remove();delete%20window.resolveEnv;resolve(value)}})},async%20inputToken(attempt=1){return%20new%20Promise(resolve=%3E{const{overlay,dialog}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E8%BC%B8%E5%85%A5%20API%20TOKEN%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22token-input%22%20class=%22dialog-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20TOKEN%22%3E${attempt%3E1?'%3Cp%20style=%22color:red;text-align:center;%22%3ETOKEN%20%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%3C/p%3E':''}%20%20%3Cdiv%20style=%22text-align:center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-primary%22%20onclick=%22confirmToken()%22%20style=%22margin:4px;%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-warning%22%20onclick=%22resolveToken('_skip_')%22%20style=%22margin:4px;%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveToken(null)%22%20style=%22margin:4px;%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'400px');const%20input=dialog.querySelector('#token-input');input.focus();input.addEventListener('keypress',(e)=%3E{if(e.key==='Enter'){const%20value=input.value.trim();overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)}});window.confirmToken=()=%3E{const%20value=input.value.trim();overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)};window.resolveToken=(value)=%3E{overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)}})},async%20setupQuery(){return%20new%20Promise(resolve=%3E{const{overlay,dialog}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin:16px%200;%22%3E%3Clabel%20class=%22radio-option%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22planCode%22%20checked%3E%20%E5%95%86%E5%93%81%E4%BB%A3%E7%A2%BC%3C/label%3E%3Clabel%20class=%22radio-option%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22planCodeName%22%3E%20%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%3C/label%3E%3Clabel%20class=%22radio-option%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22allPlans%22%3E%20%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%3C/label%3E%3Clabel%20class=%22radio-option%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22inSale%22%3E%20%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%20(%E5%90%AB%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85)%3C/label%3E%3C/div%3E%3Ctextarea%20id=%22query-input%22%20class=%22dialog-input%22%20rows=%223%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9%22%3E%3C/textarea%3E%3Cdiv%20style=%22text-align:center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-primary%22%20onclick=%22confirmQuery()%22%20style=%22margin:4px;%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveQuery(null)%22%20style=%22margin:4px;%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'500px');dialog.querySelectorAll('input[name=%22query-type%22]').forEach(radio=%3E{radio.onchange=()=%3E{const%20input=dialog.querySelector('#query-input');const%20type=dialog.querySelector('input[name=%22query-type%22]:checked').value;if(type==='allPlans'||type==='inSale'){input.disabled=true;input.placeholder='%E7%84%A1%E9%9C%80%E8%BC%B8%E5%85%A5';input.value=''}else{input.disabled=false;input.placeholder=type==='planCode'?'%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E7%A2%BC%EF%BC%8C%E5%A4%9A%E7%AD%86%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94':'%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97'}}});window.confirmQuery=()=%3E{const%20type=dialog.querySelector('input[name=%22query-type%22]:checked').value;const%20input=dialog.querySelector('#query-input').value.trim();if((type==='planCode'||type==='planCodeName')&&!input){Notification.show('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9','error');return}if(type==='planCodeName'&&input.split(/[\s,;]+/).filter(Boolean).length%3E1){Notification.show('%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E6%9F%A5%E8%A9%A2%E5%83%85%E6%94%AF%E6%8F%B4%E5%96%AE%E4%B8%80%E9%97%9C%E9%8D%B5%E5%AD%97','error');return}overlay.remove();delete%20window.confirmQuery;delete%20window.resolveQuery;resolve({queryMode:type,inputValue:input})};window.resolveQuery=(value)=%3E{overlay.remove();delete%20window.confirmQuery;delete%20window.resolveQuery;resolve(value)}})}};const%20UI={render(){this.cleanup();this.insertStyles();this.createMainUI();this.bindEvents()},cleanup(){document.getElementById(CONFIG.UI.MAIN_ID)?.remove();document.getElementById('planCodeQueryCss_v2')?.remove()},insertStyles(){const%20style=document.createElement('style');style.id='planCodeQueryCss_v2';style.textContent=%60:root{--primary-color:#2563eb;--success-color:#059669;--warning-color:#d97706;--danger-color:#dc2626;--secondary-color:#6b7280;--background-color:#f8fafc;--surface-color:#ffffff;--text-primary:#1f2937;--border-color:#e5e7eb}#${CONFIG.UI.MAIN_ID}{position:fixed;z-index:${CONFIG.UI.Z_INDEX.MAIN};left:50%;top:20px;transform:translateX(-50%);background:var(--surface-color);border-radius:8px;box-shadow:0%2010px%2015px%20rgba(0,0,0,0.1);width:90%;max-width:1200px;max-height:90vh;display:flex;flex-direction:column;border:1px%20solid%20var(--border-color);overflow:hidden;font-family:sans-serif}#${CONFIG.UI.MAIN_ID}%20.header{background:linear-gradient(135deg,var(--primary-color),#1d4ed8);color:white;padding:16px%2024px;display:flex;justify-content:space-between;align-items:center;cursor:grab;user-select:none}#${CONFIG.UI.MAIN_ID}%20.header:active{cursor:grabbing}#${CONFIG.UI.MAIN_ID}%20.header%20h3{margin:0;font-size:18px;font-weight:600}#${CONFIG.UI.MAIN_ID}%20.close-btn{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:4px%208px;border-radius:4px;transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20.close-btn:hover{background:rgba(255,255,255,0.1)}#${CONFIG.UI.MAIN_ID}%20.controls{display:flex;justify-content:space-between;align-items:center;padding:16px%2024px;background:var(--background-color);border-bottom:1px%20solid%20var(--border-color);flex-wrap:wrap;gap:12px}#${CONFIG.UI.MAIN_ID}%20.info{font-size:14px;font-weight:500;color:var(--text-primary)}#${CONFIG.UI.MAIN_ID}%20.info%20strong{color:var(--primary-color);font-weight:600}#${CONFIG.UI.MAIN_ID}%20.buttons{display:flex;gap:8px;flex-wrap:wrap}#${CONFIG.UI.MAIN_ID}%20.btn{background:var(--primary-color);color:white;border:none;padding:8px%2016px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20.btn:hover{transform:translateY(-1px);box-shadow:0%204px%206px%20rgba(0,0,0,0.1)}#${CONFIG.UI.MAIN_ID}%20.btn-success{background:var(--success-color)}#${CONFIG.UI.MAIN_ID}%20.btn-info{background:#0ea5e9}#${CONFIG.UI.MAIN_ID}%20.btn-warning{background:var(--warning-color)}#${CONFIG.UI.MAIN_ID}%20.btn-secondary{background:var(--secondary-color)}#${CONFIG.UI.MAIN_ID}%20.table-container{flex:1;overflow:auto;padding:0%2024px%2024px%2024px}#${CONFIG.UI.MAIN_ID}%20table{width:100%;border-collapse:collapse;font-size:13px;background:var(--surface-color);border-radius:8px;overflow:hidden;box-shadow:0%201px%202px%20rgba(0,0,0,0.05)}#${CONFIG.UI.MAIN_ID}%20th{background:linear-gradient(135deg,#374151,#4b5563);color:white;padding:12px%208px;text-align:center;position:sticky;top:0;cursor:pointer;border:1px%20solid%20#6b7280;white-space:nowrap;font-weight:600;transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20th:hover{background:linear-gradient(135deg,#4b5563,#6b7280)}#${CONFIG.UI.MAIN_ID}%20td{padding:10px%208px;border:1px%20solid%20var(--border-color);text-align:center;white-space:nowrap;vertical-align:middle;transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20tr:nth-child(even){background:#f9fafb}#${CONFIG.UI.MAIN_ID}%20tr:hover{background:#f3f4f6}#${CONFIG.UI.MAIN_ID}%20.seq-cell{color:var(--primary-color);cursor:pointer;font-weight:600;transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20.seq-cell:hover{text-decoration:underline;color:#1d4ed8}#${CONFIG.UI.MAIN_ID}%20.seq-cell[data-fetched=%22true%22]{color:var(--success-color);cursor:copy;font-weight:normal}#${CONFIG.UI.MAIN_ID}%20.copy-cell{cursor:pointer;color:var(--primary-color);transition:all%200.2s}#${CONFIG.UI.MAIN_ID}%20.copy-cell:hover{background:#dbeafe;color:#1d4ed8}#${CONFIG.UI.MAIN_ID}%20.name-cell{text-align:left;max-width:200px;white-space:normal}#${CONFIG.UI.MAIN_ID}%20.date-cell{text-align:left;min-width:150px;max-width:280px;white-space:normal!important;vertical-align:top!important}#${CONFIG.UI.MAIN_ID}%20.error-row{background-color:#fef2f2!important;color:var(--danger-color)}#${CONFIG.UI.MAIN_ID}%20.highlight-row{background-color:#fef3c7!important}@media%20(max-width:768px){#${CONFIG.UI.MAIN_ID}{width:95%;max-height:95vh}#${CONFIG.UI.MAIN_ID}%20.controls{flex-direction:column;align-items:stretch}#${CONFIG.UI.MAIN_ID}%20.buttons{justify-content:center}#${CONFIG.UI.MAIN_ID}%20table{font-size:12px}#${CONFIG.UI.MAIN_ID}%20th,#${CONFIG.UI.MAIN_ID}%20td{padding:8px%204px}}%60;document.head.appendChild(style)},createMainUI(){const%20mainDiv=document.createElement('div');mainDiv.id=CONFIG.UI.MAIN_ID;mainDiv.innerHTML=%60%3Cdiv%20class=%22header%22%3E%3Ch3%3E%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%20%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%3C/h3%3E%3Cbutton%20class=%22close-btn%22%20onclick=%22App.close()%22%3E%C3%97%3C/button%3E%3C/div%3E%3Cdiv%20class=%22controls%22%3E%3Cdiv%20class=%22info%22%3E%E7%B8%BD%E5%85%B1%20%3Cstrong%3E${State.totalRecords}%3C/strong%3E%20%E7%AD%86%3C/div%3E%3Cdiv%20class=%22buttons%22%3E%3Cbutton%20class=%22btn%20btn-success%22%20onclick=%22App.copyAll()%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%3Cbutton%20class=%22btn%20btn-info%22%20onclick=%22App.queryDetails()%22%3E%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E8%B3%87%E6%96%99%3C/button%3E%3Cbutton%20class=%22btn%22%20onclick=%22App.reload()%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%3Cbutton%20class=%22btn%20btn-secondary%22%20onclick=%22App.close()%22%3E%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C%3C/button%3E%3C/div%3E%3C/div%3E%3Cdiv%20class=%22table-container%22%3E%3Ctable%3E%3Cthead%3E%3Ctr%3E%3Cth%20onclick=%22App.sort('_index')%22%3ENo%3C/th%3E%3Cth%20onclick=%22App.sort('code')%22%3E%E4%BB%A3%E8%99%9F%3C/th%3E%3Cth%20onclick=%22App.sort('name')%22%3E%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%3C/th%3E%3Cth%20onclick=%22App.sort('cur')%22%3E%E5%B9%A3%E5%88%A5%3C/th%3E%3Cth%20onclick=%22App.sort('unit')%22%3E%E5%96%AE%E4%BD%8D%3C/th%3E%3Cth%20onclick=%22App.sort('type')%22%3E%E9%A1%9E%E5%9E%8B%3C/th%3E%3Cth%20onclick=%22App.sort('start')%22%3E%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%3C/th%3E%3Cth%20onclick=%22App.sort('end')%22%3E%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%3C/th%3E%3C/tr%3E%3C/thead%3E%3Ctbody%3E${this.createTableRows()}%3C/tbody%3E%3C/table%3E%3C/div%3E%60;document.body.appendChild(mainDiv)},createTableRows(){return%20State.queryResults.map((item,index)=%3E%60%3Ctr%20${item._isErrorRow?'class=%22error-row%22':''}%20${item.applyYellowBg?'class=%22highlight-row%22':''}%3E%3Ctd%20class=%22seq-cell%22%20data-index=%22${index}%22%20data-plancode=%22${item.code}%22%20data-fetched=%22${item._detailsFetched}%22%3E${item._index+1}%3C/td%3E%3Ctd%20class=%22copy-cell%22%20data-copy=%22${item.polplnCode?%60${item.code}\n${item.polplnCode}%60:item.code}%22%20title=%22${item.code}%22%3E${item.polplnDisplayText||Utils.escapeHtml(item.code)}%3C/td%3E%3Ctd%20class=%22copy-cell%20name-cell%22%20data-copy=%22${item.full}%22%20title=%22${item.full}%22%3E${Utils.escapeHtml(item.name)}%3C/td%3E%3Ctd%3E${item.cur}%3C/td%3E%3Ctd%3E${item.unit}%3C/td%3E%3Ctd%3E${item.type}%3C/td%3E%3Ctd%20class=%22copy-cell%22%20data-copy=%22${item.start}%22%3E${item.start}%3C/td%3E%3Ctd%20class=%22copy-cell%20date-cell%22%20data-copy=%22${item.channelInfo?item.channelInfo.copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()}%22%3E${item.channelDisplayHtml||item.originalEndDisplay}%3C/td%3E%3C/tr%3E%60).join('')},bindEvents(){const%20mainDiv=document.getElementById(CONFIG.UI.MAIN_ID);const%20header=mainDiv.querySelector('.header');let%20isDragging=false,startX=0,startY=0;header.onmousedown=(e)=%3E{if(e.target.classList.contains('close-btn'))return;isDragging=true;startX=e.clientX-mainDiv.offsetLeft;startY=e.clientY-mainDiv.offsetTop;header.style.cursor='grabbing';document.onmousemove=(moveEvent)=%3E{if(!isDragging)return;mainDiv.style.left=(moveEvent.clientX-startX)+'px';mainDiv.style.top=(moveEvent.clientY-startY)+'px'};document.onmouseup=()=%3E{isDragging=false;header.style.cursor='grab';document.onmousemove=null;document.onmouseup=null}};mainDiv.querySelectorAll('.copy-cell').forEach(cell=%3E{cell.onclick=()=%3E{navigator.clipboard.writeText(cell.dataset.copy);Notification.show('%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81','success')}});mainDiv.querySelectorAll('.seq-cell').forEach(cell=%3E{cell.onclick=async()=%3E{await%20App.handleSequenceClick(cell)}})},updateTable(){const%20tbody=document.querySelector(%60#${CONFIG.UI.MAIN_ID}%20tbody%60);if(tbody){tbody.innerHTML=this.createTableRows();this.bindEvents()}}};const%20App={async%20init(){try{const%20env=await%20Dialog.selectEnvironment();if(!env)return;State.currentEnv=env;let%20token=localStorage.getItem(CONFIG.STORAGE.TOKEN_KEY)||localStorage.getItem(CONFIG.STORAGE.TOKEN_FALLBACK);let%20attempt=1;while(!(token&&await%20API.validateToken(token))){const%20result=await%20Dialog.inputToken(attempt);if(!result||result==='_skip_')break;if(await%20API.validateToken(result)){token=result;localStorage.setItem(CONFIG.STORAGE.TOKEN_KEY,token);break}attempt++;if(attempt%3E3){Notification.show('TOKEN%20%E5%A4%9A%E6%AC%A1%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E7%A2%BA%E8%AA%8D%E5%BE%8C%E9%87%8D%E8%A9%A6','error');return}}State.apiToken=token;Notification.show(%60%E5%B7%B2%E9%80%A3%E6%8E%A5%E5%88%B0${env==='PROD'?'%E6%AD%A3%E5%BC%8F':'%E6%B8%AC%E8%A9%A6'}%E7%92%B0%E5%A2%83%60,'success');const%20queryConfig=await%20Dialog.setupQuery();if(!queryConfig)return;await%20this.executeQuery(queryConfig)}catch(error){console.error('%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E6%95%97:',error);Notification.show('%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E6%95%97:%20'+error.message,'error')}},async%20executeQuery(config){State.reset();Notification.show('%E6%9F%A5%E8%A9%A2%E4%B8%AD...','info');let%20endpoint,params;switch(config.queryMode){case%20'planCode':const%20codes=config.inputValue.split(/[\s,;]+/).filter(Boolean).map(code=%3Ecode.trim().toUpperCase());await%20this.queryByCodes(codes);return;case%20'planCodeName':endpoint='planCodeQuery';params={planCodeName:config.inputValue,pageSize:CONFIG.LIMITS.PAGE_SIZE};break;case%20'allPlans':endpoint='planCodeQuery';params={planCodeName:%22%22,pageSize:CONFIG.LIMITS.PAGE_SIZE};break;case%20'inSale':endpoint='saleDateQuery';params={planCodeName:%22%22,saleEndDate:Utils.getTodayString(),pageSize:CONFIG.LIMITS.PAGE_SIZE};break}const%20response=await%20API.call(endpoint,params);if(response&&!response.error&&response.records){State.queryResults=response.records.map(Utils.transformRecord);State.totalRecords=response.records.length;if(State.totalRecords%3ECONFIG.LIMITS.BATCH_SIZE){const%20userConfirm=confirm(%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%E5%85%B1%20${State.totalRecords}%20%E7%AD%86%EF%BC%8C%E8%B6%85%E9%81%8E${CONFIG.LIMITS.BATCH_SIZE}%E7%AD%86%E5%B0%87%E5%88%86%E6%89%B9%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%EF%BC%8C%E6%98%AF%E5%90%A6%E7%B9%BC%E7%BA%8C%EF%BC%9F%60);if(!userConfirm){Notification.show('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88','info');return}State.batchMode=true;State.batchPages=Math.ceil(State.totalRecords/CONFIG.LIMITS.BATCH_SIZE)}UI.render();Notification.show(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%8C%E6%89%BE%E5%88%B0%20${State.totalRecords}%20%E7%AD%86%E8%B3%87%E6%96%99%60,'success')}else{Notification.show(response?.message||'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97','error')}},async%20queryByCodes(codes){const%20responses=await%20Promise.all(codes.map(async%20code=%3E{const%20response=await%20API.call('planCodeQuery',{planCode:code});if(response&&!response.error&&response.records?.length%3E0){return%20response.records.map(record=%3EUtils.transformRecord(record,0))}else{return[Utils.transformRecord({planCode:code,shortName:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,planCodeName:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,_isErrorRow:true},0)]}}));State.queryResults=responses.flat().map((item,index)=%3E({...item,_index:index}));State.totalRecords=State.queryResults.length;UI.render();Notification.show(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%8C%E6%89%BE%E5%88%B0%20${State.totalRecords}%20%E7%AD%86%E8%B3%87%E6%96%99%60,'success')},async%20handleSequenceClick(cell){const%20planCode=cell.dataset.plancode;const%20index=parseInt(cell.dataset.index);const%20item=State.queryResults[index];if(cell.dataset.fetched===%22true%22){const%20headerText=%22No\t%E4%BB%A3%E8%99%9F\t%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1\t%E5%B9%A3%E5%88%A5\t%E5%96%AE%E4%BD%8D\t%E9%A1%9E%E5%9E%8B\t%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5\t%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5\n%22;const%20rowData=[cell.textContent,item.polplnCode?%60${item.code}\n${item.polplnCode}%60:item.code,item.full,item.cur,item.unit,item.type,item.start,item.channelInfo?item.channelInfo.copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()];navigator.clipboard.writeText(headerText+rowData.join('\t'));Notification.show('%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(%E5%90%AB%E8%A1%A8%E9%A0%AD)%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81','success');return}if(item._isErrorRow){Notification.show('%E9%8C%AF%E8%AA%A4%E8%B3%87%E6%96%99%E7%84%A1%E6%B3%95%E6%9F%A5%E8%A9%A2%E8%A9%B3%E6%83%85','error');return}cell.style.cursor='wait';Notification.show(%60%E6%9F%A5%E8%A9%A2%20${planCode}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A...%60,'info');const[polplnResponse,channelResponse]=await%20Promise.all([API.call('planCodeDetail',{planCode:planCode,pageNo:1,pageSize:20}),API.call('saleDateQuery',{planCode:planCode,pageNo:1,pageSize:50})]);cell.style.cursor='default';if(polplnResponse&&!polplnResponse.error&&polplnResponse.records?.length%3E0){const%20polpln=Utils.processMultiplePolpln?Utils.processMultiplePolpln(polplnResponse.records.map(r=%3Er.polpln)):%22-%22;if(polpln!==%22-%22&&polpln!==%22%22){item.polplnCode=polpln;item.polplnDisplayText=%60${item.code}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${polpln}%3C/span%3E%60}}if(channelResponse&&!channelResponse.error){item.channelInfo=Utils.formatChannelInfo?Utils.formatChannelInfo(channelResponse,planCode,item.originalEndDisplay,item.isStillSelling):{html:item.originalEndDisplay,copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim(),applyYellowBg:false};item.channelDisplayHtml=item.channelInfo.html;item.applyYellowBg=item.channelInfo.applyYellowBg}item._detailsFetched=true;cell.dataset.fetched=%22true%22;UI.updateTable()},sort(key){if(State.sortKey===key){State.sortDirection=State.sortDirection==='asc'?'desc':'asc'}else{State.sortKey=key;State.sortDirection='asc'}State.queryResults.sort((a,b)=%3E{let%20valA=a[key]||'';let%20valB=b[key]||'';if(typeof%20valA==='number'&&typeof%20valB==='number'){return%20State.sortDirection==='asc'?valA-valB:valB-valA}return%20State.sortDirection==='asc'?String(valA).localeCompare(String(valB),'zh-Hant-TW',{sensitivity:'base',numeric:true}):String(valB).localeCompare(String(valA),'zh-Hant-TW',{sensitivity:'base',numeric:true})});UI.updateTable();const%20headerText=document.querySelector(%60#${CONFIG.UI.MAIN_ID}%20th[onclick=%22App.sort('${key}')%22]%60)?.textContent?.replace(/[%E2%96%B2%E2%96%BC\s]*/g,'')||key;Notification.show(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerText}%E3%80%8D${State.sortDirection==='asc'?'%E5%8D%87%E5%BA%8F':'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,'info',1500)},copyAll(){let%20text=%22No\t%E4%BB%A3%E8%99%9F\t%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1\t%E5%B9%A3%E5%88%A5\t%E5%96%AE%E4%BD%8D\t%E9%A1%9E%E5%9E%8B\t%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5\t%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5\n%22;State.queryResults.forEach((item,index)=%3E{const%20rowData=[index+1,item.polplnCode?%60${item.code}\n${item.polplnCode}%60:item.code,item.full,item.cur,item.unit,item.type,item.start,item.channelInfo?item.channelInfo.copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()];text+=rowData.map(cell=%3EString(cell).replace(/\n/g,'%20/%20')).join('\t')+'\n'});navigator.clipboard.writeText(text);Notification.show('%E8%A1%A8%E6%A0%BC%E5%85%A7%E5%AE%B9%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81','success')},async%20queryDetails(){if(!State.queryResults||State.queryResults.length===0){Notification.show('%E7%9B%AE%E5%89%8D%E6%B2%92%E6%9C%89%E5%8F%AF%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E7%9A%84%E5%95%86%E5%93%81','error');return}Notification.show('%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E5%8F%8APOLPLN%E8%B3%87%E8%A8%8A...','info');const%20planCodes=State.queryResults.map(item=%3Eitem.code).filter(Boolean);if(planCodes.length===0){Notification.show('%E6%B2%92%E6%9C%89%E6%9C%89%E6%95%88%E7%9A%84%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2','error');return}const%20queryPromises=planCodes.map(async%20planCode=%3E{const%20productItem=State.queryResults.find(item=%3Eitem.code===planCode);if(!productItem||productItem._isErrorRow||productItem._detailsFetched){return{planCode,status:'skipped'}}const[polplnResponse,channelResponse]=await%20Promise.all([API.call('planCodeDetail',{planCode:planCode,pageNo:1,pageSize:20}),API.call('saleDateQuery',{planCode:planCode,pageNo:1,pageSize:50})]);return{planCode,polplnResponse,channelResponse,productItem}});const%20results=await%20Promise.allSettled(queryPromises);let%20queryCount=0;results.forEach(result=%3E{if(result.status!=='fulfilled'||!result.value||result.value.status==='skipped'){return}const{planCode,polplnResponse,channelResponse,productItem}=result.value;if(polplnResponse&&!polplnResponse.error&&polplnResponse.records?.length%3E0){const%20polpln=Utils.processMultiplePolpln?Utils.processMultiplePolpln(polplnResponse.records.map(r=%3Er.polpln)):%22-%22;if(polpln!==%22-%22&&polpln!==%22%22){productItem.polplnCode=polpln;productItem.polplnDisplayText=%60${productItem.code}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${polpln}%3C/span%3E%60}}if(channelResponse&&!channelResponse.error){productItem.channelInfo=Utils.formatChannelInfo?Utils.formatChannelInfo(channelResponse,planCode,productItem.originalEndDisplay,productItem.isStillSelling):{html:productItem.originalEndDisplay,copyText:productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim(),applyYellowBg:false};productItem.channelDisplayHtml=productItem.channelInfo.html;productItem.applyYellowBg=productItem.channelInfo.applyYellowBg}productItem._detailsFetched=true;queryCount++});UI.updateTable();if(queryCount%3E0){Notification.show(%60%E5%85%B1%20${queryCount}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E5%8F%8APOLPLN%E8%B3%87%E8%A8%8A%E5%B7%B2%E6%9B%B4%E6%96%B0%60,'success')}else{Notification.show('%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E8%B3%87%E6%96%99','info')}},reload(){this.init()},close(){document.getElementById(CONFIG.UI.MAIN_ID)?.remove();document.getElementById('planCodeQueryCss_v2')?.remove();document.getElementById('dialog-styles')?.remove()}};Utils.processMultiplePolpln=function(polplnRecords){if(!polplnRecords||polplnRecords.length===0)return%22-%22;if(polplnRecords.length===1)return%20this.extractPolpln(polplnRecords[0])||%22-%22;const%20extractedPolplns=polplnRecords.map(r=%3Ethis.extractPolpln(r)).filter(p=%3Ep!==%22%22);if(extractedPolplns.length===0)return%22-%22;const%20firstPolpln=extractedPolplns[0];return%20extractedPolplns.every(p=%3Ep===firstPolpln)?firstPolpln:%22-%22};Utils.extractPolpln=function(polplnString){if(!polplnString||typeof%20polplnString!=='string')return%22%22;let%20processed=polplnString.trim();if(processed.endsWith(%22%%22))processed=processed.substring(0,processed.length-1);return%20processed.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim()||%22%22};Utils.formatChannelInfo=function(response,planCode,baseDisplay,isBaseStillSelling){const%20todayStr=this.getTodayString();let%20channelDetailsHtml=%22%22;let%20copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();let%20hasActiveChannel=false;let%20hasAnyChannelInfo=false;if(response?.planCodeSaleDates?.records?.length%3E0){hasAnyChannelInfo=true;const%20channelRecords=response.planCodeSaleDates.records.filter(rec=%3Erec.planCode===planCode&&rec.channel&&rec.saleEndDate).map(rec=%3E{const%20channelEndDate=this.formatDate(rec.saleEndDate);const%20channelStartDate=this.formatDate(rec.saleStartDate);const%20isChannelSelling=channelEndDate===%2299991231%22||channelEndDate%3E=todayStr;if(isChannelSelling)hasActiveChannel=true;const%20titleText=%60${rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelStartDate||%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelEndDate===%2299991231%22?%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22:channelEndDate||%22%E6%9C%AA%E7%9F%A5%22}%60;let%20displayText,plainTextPart;if(isChannelSelling){displayText=%60%3Cspan%20title=%22${this.escapeHtml(titleText)}%22%20style=%22color:blue;%22%3E${this.escapeHtml(rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%3C/span%3E%60;plainTextPart=%60${rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%60}else{displayText=%60%3Cspan%20title=%22${this.escapeHtml(titleText)}%22%20style=%22color:red;%22%3E${this.escapeHtml(rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%20(${channelEndDate||'%E6%9C%AA%E7%9F%A5'})%3C/span%3E%60;plainTextPart=%60${rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelEndDate||'%E6%9C%AA%E7%9F%A5'})%60}return{channel:rec.channel,text:displayText,isSelling:isChannelSelling,plainText:plainTextPart}}).sort((a,b)=%3E{if(a.isSelling!==b.isSelling)return%20a.isSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});const%20sellingChannels=channelRecords.filter(r=%3Er.isSelling);const%20stoppedChannels=channelRecords.filter(r=%3E!r.isSelling);let%20currentCopyTextParts=[];if(sellingChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r=%3Er.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r=%3Er.plainText).join(%22%E3%80%81%22)}%60)}if(stoppedChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(r=%3Er.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(r=%3Er.plainText).join(%22%E3%80%81%22)}%60)}if(currentCopyTextParts.length%3E0){copyTextContent=currentCopyTextParts.join(%22\n%22)}else%20if(hasAnyChannelInfo){copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%3C/div%3E%60}}else%20if(response?.planCodeSaleDates?.records?.length===0){hasAnyChannelInfo=true;copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%3C/div%3E%60}let%20finalHtml=baseDisplay;if(channelDetailsHtml){finalHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelDetailsHtml}%3C/div%3E%60}const%20applyYellowBg=!isBaseStillSelling&&hasActiveChannel;return{html:finalHtml,copyText:copyTextContent.trim(),applyYellowBg:applyYellowBg,hasChannelInfo:hasAnyChannelInfo}};window.App=App;document.addEventListener('keydown',(e)=%3E{if(e.key==='Escape'&&document.getElementById(CONFIG.UI.MAIN_ID)){App.close()}});App.init()})();

javascript:(async function(){function showCustomInputDialog(titleText,placeholderText,confirmButtonText='%E7%A2%BA%E8%AA%8D',cancelButtonText='%E5%8F%96%E6%B6%88',skipButtonText=null){return new Promise((resolve)=>{const existingDialog=document.getElementById('customBookmarkletDialog');if(existingDialog){existingDialog.remove()}const dialogDiv=document.createElement('div');dialogDiv.id='customBookmarkletDialog';dialogDiv.style.cssText=`                position: fixed;                top: 50%;                left: 50%;                transform: translate(-50%, -50%);                background-color: #fff;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%201px%20solid%20#ccc;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20box-shadow:%200%204px%208px%20rgba(0,0,0,0.2);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%2020px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z-index:%20100001;%20/*%20%E6%AF%94%E4%B8%BB%E8%A1%A8%E6%A0%BC%E9%AB%98%20*/%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%208px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-family:%20sans-serif;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min-width:%20300px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20max-width:%2090vw;%20%20%20%20%20%20%20%20%20%20%20%20%60;const%20title=document.createElement('h3');title.innerText=titleText;title.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-top:%200;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20#333;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2016px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-align:%20center;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-bottom:%2015px;%20%20%20%20%20%20%20%20%20%20%20%20%60;dialogDiv.appendChild(title);const%20input=document.createElement('input');input.type='text';input.placeholder=placeholderText;input.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20width:%20calc(100%%20-%2020px);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%208px%2010px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-bottom:%2015px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%201px%20solid%20#ddd;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%204px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2014px;%20%20%20%20%20%20%20%20%20%20%20%20%60;dialogDiv.appendChild(input);const%20buttonContainer=document.createElement('div');buttonContainer.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text-align:%20right;%20%20%20%20%20%20%20%20%20%20%20%20%60;if(skipButtonText){const%20skipBtn=document.createElement('button');skipBtn.innerText=skipButtonText;skipBtn.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20background-color:%20#f0ad4e;%20/*%20%E8%AD%A6%E5%91%8A%E8%89%B2%20*/%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20white;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%208px%2015px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%205px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2014px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-right:%2010px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60;skipBtn.addEventListener('click',()=%3E{dialogDiv.remove();resolve('SKIP_TOKEN')});buttonContainer.appendChild(skipBtn)}const%20cancelBtn=document.createElement('button');cancelBtn.innerText=cancelButtonText;cancelBtn.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20background-color:%20#6c757d;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20white;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%208px%2015px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%205px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2014px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-left:%2010px;%20%20%20%20%20%20%20%20%20%20%20%20%60;cancelBtn.addEventListener('click',()=%3E{dialogDiv.remove();resolve(null)});buttonContainer.appendChild(cancelBtn);const%20confirmBtn=document.createElement('button');confirmBtn.innerText=confirmButtonText;confirmBtn.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20background-color:%20#007bff;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color:%20white;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%208px%2015px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%205px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font-size:%2014px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin-left:%2010px;%20%20%20%20%20%20%20%20%20%20%20%20%60;confirmBtn.addEventListener('click',()=%3E{dialogDiv.remove();resolve(input.value)});buttonContainer.appendChild(confirmBtn);dialogDiv.appendChild(buttonContainer);document.body.appendChild(dialogDiv);input.focus();const%20overlay=document.createElement('div');overlay.id='customBookmarkletOverlay';overlay.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20position:%20fixed;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20top:%200;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20left:%200;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20width:%20100%;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height:%20100%;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20background:%20rgba(0,%200,%200,%200.5);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z-index:%20100000;%20%20%20%20%20%20%20%20%20%20%20%20%60;overlay.addEventListener('click',()=%3E{dialogDiv.remove();overlay.remove();resolve(null)});document.body.appendChild(overlay);dialogDiv.style.zIndex='100001'})}function%20showToastMessage(message){const%20existingToast=document.querySelector(%22.pcr-toast%22);if(existingToast)existingToast.remove();const%20toastElement=document.createElement(%22div%22);toastElement.className=%22pcr-toast%22;toastElement.innerText=message;document.body.appendChild(toastElement);setTimeout(()=%3E{toastElement.remove()},2000)}async%20function%20initializeBookmarklet(){const%20API_URL_PLANCODE_QUERY=%22https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query%22;const%20API_URL_PLANCODE_DETAIL=%22https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail%22;const%20API_URL_SALEDATE_QUERY=%22https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query%22;const%20MASTER_DATA={CUR:{1:%22TWD%22,2:%22USD%22,3:%22AUD%22,4:%22CNT%22,5:%22USD%22},UNIT:{A1:%22%E5%85%83%22,A3:%22%E4%BB%9F%E5%85%83%22,A4:%22%E8%90%AC%E5%85%83%22,B1:%22%E8%A8%88%E7%95%AB%22,C1:%22%E5%96%AE%E4%BD%8D%22},TYPE:{M:%22%E4%B8%BB%E7%B4%84%22,R:%22%E9%99%84%E7%B4%84%22}};const%20BOOKMARKLET_MAIN_DIV_ID=%22pcrBookMarkletDivV17%22;const%20BOOKMARKLET_CSS_ID=%22pcrBookMarkletCssV17%22;let%20displayedDataArray=[];let%20totalRecordsFromServer=0;let%20isCurrentlyQueryingAllMode=!1;let%20currentKeyword=%22%22;let%20currentPlanCodesArray=[];let%20currentApiParamsObject={};let%20lastQueryWasSpecialInSale=!1;let%20currentToken;const%20toHalfWidth=(str)=%3E{if(typeof%20str!==%22string%22)return%20str;return%20str.replace(/[\uff01-\uff5e]/g,(char)=%3EString.fromCharCode(char.charCodeAt(0)-0xfee0)).replace(/\u3000/g,%22%20%22)};const%20formatDateToYYYYMMDDString=(dateString)=%3E{if(!dateString)return%22%22;try{return%20dateString.substring(0,10).replace(/-/g,%22%22)}catch(error){console.warn(%22Error%20formatting%20date:%22,dateString,error);return%22%22}};const%20getTodayYYYYMMDDString=()=%3E{const%20now=new%20Date();const%20year=now.getFullYear();const%20month=(now.getMonth()+1).toString().padStart(2,'0');const%20day=now.getDate().toString().padStart(2,'0');return%20%60${year}${month}${day}%60};const%20callApi=async(token,params,apiUrl=API_URL_PLANCODE_QUERY)=%3E{try{const%20response=await%20fetch(apiUrl,{method:%22POST%22,headers:{%22Content-Type%22:%22application/json%22,%22SSO-TOKEN%22:token},body:JSON.stringify(params)});if(!response.ok){console.warn(%60API%20call%20to%20${apiUrl}%20failed%20with%20status:%20${response.status}%60);showToastMessage(%60API%20%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}%60);return%20null}return%20await%20response.json()}catch(error){console.warn(%60API%20call%20to%20${apiUrl}%20failed%20with%20error:%60,error);showToastMessage(%22API%20%E8%AB%8B%E6%B1%82%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E3%80%82%22);return%20null}};const%20checkTokenValidity=async(token)=%3E!!await%20callApi(token,{planCodeName:%22%22});try{currentToken=localStorage.euisPlanCodeToken||localStorage.euisToken}catch(e){console.warn(%22Error%20accessing%20localStorage%20for%20token:%22,e);currentToken=null}while(!(currentToken&&await%20checkTokenValidity(currentToken))){let%20rawTokenInput=await%20showCustomInputDialog(%22%E8%AB%8B%E8%BC%B8%E5%85%A5TOKEN%22,%22%E5%9C%A8%E6%AD%A4%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84TOKEN%EF%BC%8C%E6%88%96%E9%BB%9E%E6%93%8A%E7%95%A5%E9%81%8E%E3%80%82%22,%22%E7%A2%BA%E8%AA%8D%22,%22%E5%8F%96%E6%B6%88%22,%22%E7%95%A5%E9%81%8E%22);if(rawTokenInput===null)return;if(rawTokenInput==='SKIP_TOKEN'){currentToken=null;break}currentToken=toHalfWidth(rawTokenInput).trim();if(currentToken&&await%20checkTokenValidity(currentToken)){try{localStorage.euisPlanCodeToken=currentToken}catch(e){console.warn(%22Error%20saving%20token%20to%20localStorage:%22,e)}}else{showToastMessage(%22TOKEN%E7%84%A1%E6%95%88%EF%BC%81%22);currentToken=null}}const%20formatItemDataFromApi1=(item)=%3E{const%20todayString=getTodayYYYYMMDDString();const%20apiSaleStartDate=item.saleStartDate||%22%22;const%20apiSaleEndDate=item.saleEndDate||%22%22;const%20startDateYYYYMMDD=formatDateToYYYYMMDDString(apiSaleStartDate);const%20saleEndDateYYYYMMDD=formatDateToYYYYMMDDString(apiSaleEndDate);let%20isStillSelling=!1;if(saleEndDateYYYYMMDD){isStillSelling=(saleEndDateYYYYMMDD===%2299991231%22||saleEndDateYYYYMMDD%3E=todayString)}let%20originalEndDisplayHTML=%22-%22;if(saleEndDateYYYYMMDD){if(isStillSelling){originalEndDisplayHTML=%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60}else{originalEndDisplayHTML=%60%3Cspan%20style=%22color:red;%22%3E${saleEndDateYYYYMMDD}%3C/span%3E%60}}return{code:item.planCode,name:(item.shortName||%22%22).trim(),full:(item.planCodeName||%22%22).trim(),cur:MASTER_DATA.CUR[item.currency]||%22-%22,unit:MASTER_DATA.UNIT[(item.reportInsuranceAmountUnit||item.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:MASTER_DATA.TYPE[item.coverageType]||%22-%22,start:startDateYYYYMMDD||%22-%22,end:saleEndDateYYYYMMDD,isStillSelling:isStillSelling,originalEndDisplay:originalEndDisplayHTML}};const%20extractCorePolplnString=(polplnString)=%3E{if(!polplnString||typeof%20polplnString!==%22string%22)return%22%22;let%20tempString=polplnString.trim();if(tempString.endsWith(%22%%22)){tempString=tempString.substring(0,tempString.length-1)}return(tempString.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim())||%22%22};const%20processPolplnValuesArray=(polplnValuesArray)=%3E{if(!polplnValuesArray||polplnValuesArray.length===0)return%22-%22;if(polplnValuesArray.length===1){return%20extractCorePolplnString(polplnValuesArray[0])||%22-%22}else{const%20corePolplnStrings=polplnValuesArray.map(p=%3EextractCorePolplnString(p)).filter(p=%3Ep!==%22%22);if(corePolplnStrings.length===0)return%22-%22;const%20firstCoreString=corePolplnStrings[0];return%20corePolplnStrings.every(coreStr=%3EcoreStr===firstCoreString)?firstCoreString:%22-%22}};const%20formatChannelSaleDetails=(saleDateResponse,planCodeToQuery,initialSaleDateHTML,originalItemIsStillSelling)=%3E{const%20todayStringForComparison=getTodayYYYYMMDDString();let%20channelInfoArray=[],anyChannelIsActive=!1;let%20saleDateCellCopyText=initialSaleDateHTML.replace(/%3C[^%3E]*%3E/g,%22%22).trim();if(saleDateResponse&&saleDateResponse.planCodeSaleDates&&saleDateResponse.planCodeSaleDates.records&&saleDateResponse.planCodeSaleDates.records.length%3E0){const%20relevantChannelsData=saleDateResponse.planCodeSaleDates.records.filter(r=%3Er.planCode===planCodeToQuery&&r.channel&&r.saleEndDate).map(channelData=%3E{const%20channelSaleEndDateYYYYMMDD=formatDateToYYYYMMDDString(channelData.saleEndDate);const%20channelSaleStartDateYYYYMMDD=formatDateToYYYYMMDDString(channelData.saleStartDate);const%20isChannelStillSelling=channelSaleEndDateYYYYMMDD===%2299991231%22||channelSaleEndDateYYYYMMDD%3E=todayStringForComparison;if(isChannelStillSelling)anyChannelIsActive=!0;const%20title=%60${channelData.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelSaleStartDateYYYYMMDD%20||%20%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelSaleEndDateYYYYMMDD%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22%20:%20(channelSaleEndDateYYYYMMDD%20||%20%22%E6%9C%AA%E7%9F%A5%22)}%60;let%20displayText,plainText;if(isChannelStillSelling){displayText=%60%3Cspan%20title=%22${title}%22%20style=%22color:blue;%22%3E${channelData.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%3C/span%3E%60;plainText=%60${channelData.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%60}else{displayText=%60%3Cspan%20title=%22${title}%22%20style=%22color:red;%22%3E${channelData.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelSaleEndDateYYYYMMDD})%3C/span%3E%60;plainText=%60${channelData.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelSaleEndDateYYYYMMDD})%60}return{channel:channelData.channel,text:displayText,isStillSelling:isChannelStillSelling,plainText:plainText}}).sort((a,b)=%3E{if(a.isStillSelling!==b.isStillSelling)return%20a.isStillSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});channelInfoArray=relevantChannelsData}let%20finalSaleDateHTMLOutput=initialSaleDateHTML;const%20sellingChannels=channelInfoArray.filter(ch=%3Ech.isStillSelling);const%20stoppedChannels=channelInfoArray.filter(ch=%3E!ch.isStillSelling);let%20channelBlockHTML=%22%22;if(sellingChannels.length%3E0){channelBlockHTML+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(ch%20=%3E%20ch.text).join(%22%E3%80%81%22)}%3C/div%3E%60;saleDateCellCopyText+=%60\n%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(ch%20=%3E%20ch.plainText).join(%22%E3%80%81%22)}%60}if(stoppedChannels.length%3E0){channelBlockHTML+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(ch%20=%3E%20ch.text).join(%22%E3%80%81%22)}%3C/div%3E%60;saleDateCellCopyText+=%60\n%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(ch%20=%3E%20ch.plainText).join(%22%E3%80%81%22)}%60}if(channelBlockHTML){finalSaleDateHTMLOutput+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelBlockHTML}%3C/div%3E%60}const%20needsYellowBackground=!originalItemIsStillSelling&&anyChannelIsActive;return{html:finalSaleDateHTMLOutput,copyText:saleDateCellCopyText.trim(),applyYellowBg:needsYellowBackground,hasChannelInfo:channelInfoArray.length%3E0}};async%20function%20loadAndRenderData(queryParams,isAllQueryType,isSpecialInSaleQuery=!1){try{currentApiParamsObject=JSON.parse(JSON.stringify(queryParams));isCurrentlyQueryingAllMode=isAllQueryType;lastQueryWasSpecialInSale=isSpecialInSaleQuery;let%20responseApi1;let%20finalProcessedData=[];let%20cumulativeTotalFromApiInBranch=0;if(isAllQueryType||isSpecialInSaleQuery){responseApi1=await%20callApi(currentToken,queryParams);if(responseApi1){totalRecordsFromServer=responseApi1.totalRecords||(responseApi1.records?responseApi1.records.length:0);if(responseApi1.records){finalProcessedData=responseApi1.records.map(record=%3EformatItemDataFromApi1(record))}}else{totalRecordsFromServer=0}}else{const%20resultsPerCode=await%20Promise.all(queryParams.codes.map(async(code)=%3E{const%20responseForCode=await%20callApi(currentToken,{planCode:code,pageNo:1,pageSize:queryParams.pageSize});if(responseForCode){cumulativeTotalFromApiInBranch+=(responseForCode.totalRecords||(responseForCode.records?responseForCode.records.length:0));if(responseForCode.records&&responseForCode.records.length%3E0){return%20responseForCode.records.map(record=%3EformatItemDataFromApi1(record))}}return[{code:code,name:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,full:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,cur:%22-%22,unit:%22-%22,type:%22-%22,start:%22-%22,end:%22-%22,isStillSelling:!1,_isErrorRow:!0,originalEndDisplay:%22-%22}]}));finalProcessedData=resultsPerCode.flat();totalRecordsFromServer=cumulativeTotalFromApiInBranch}displayedDataArray=finalProcessedData;renderTable(displayedDataArray,totalRecordsFromServer,isCurrentlyQueryingAllMode)}catch(error){console.warn(%22Error%20in%20loadAndRenderData:%22,error);showToastMessage(%22%E8%BC%89%E5%85%A5%E6%88%96%E8%99%95%E7%90%86%E8%B3%87%E6%96%99%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E4%B8%BB%E6%8E%A7%E5%8F%B0%E3%80%82%22)}}async%20function%20handleQueryChannelSales(){const%20pcrDiv=document.getElementById(BOOKMARKLET_MAIN_DIV_ID);if(!pcrDiv){showToastMessage(%22%E8%A1%A8%E6%A0%BC%E5%AE%B9%E5%99%A8%E4%B8%8D%E5%AD%98%E5%9C%A8%E3%80%82%22);return}if(!displayedDataArray||displayedDataArray.length===0){showToastMessage(%22%E7%9B%AE%E5%89%8D%E6%B2%92%E6%9C%89%E5%8F%AF%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E7%9A%84%E5%95%86%E5%93%81%E3%80%82%22);return}if(displayedDataArray.length%3E888){showToastMessage(%60%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E7%AD%86%E6%95%B8%E9%81%8E%E5%A4%9A%20(%E6%9C%80%E5%A4%9A888%E7%AD%86)%EF%BC%8C%E8%AB%8B%E7%B8%AE%E5%B0%8F%E6%9F%A5%E8%A9%A2%E7%AF%84%E5%9C%8D%E3%80%82%60);return}showToastMessage(%60%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%20${displayedDataArray.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E8%B3%87%E8%A8%8A...%60);const%20planCodesToQuery=displayedDataArray.map(item=%3Eitem.code).filter(Boolean);if(planCodesToQuery.length===0){showToastMessage(%22%E6%B2%92%E6%9C%89%E6%9C%89%E6%95%88%E7%9A%84%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2%E3%80%82%22);return}const%20loadingPromises=planCodesToQuery.map(async(planCode)=%3E{const%20originalItemDataForLoading=displayedDataArray.find(dataItem=%3EdataItem.code===planCode);const%20tableRowElement=pcrDiv.querySelector(%60.pcr-seq-cell[data-plancode=%22${planCode}%22]%60)?.parentNode;if(!tableRowElement)return{planCode,status:'skipped',reason:'Row%20not%20found%20in%20DOM'};const%20saleDateCellElement=tableRowElement.querySelector(%22.pcr-saledate-cell%22);if(!saleDateCellElement)return{planCode,status:'skipped',reason:'Sale%20date%20cell%20not%20found%20in%20DOM'};if(!originalItemDataForLoading)return{planCode,status:'skipped',reason:'Original%20item%20data%20not%20found%20for%20loading%20state'};const%20originalCellHTML=saleDateCellElement.innerHTML;saleDateCellElement.innerHTML=%60${originalItemDataForLoading.originalEndDisplay}%3Cbr%3E%3Cspan%20style=%22color:grey;font-style:italic;%22%3E%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E4%B8%AD...%3C/span%3E%60;const%20saleDateParams={planCode:planCode,pageNo:1,pageSize:50};const%20saleDateResponse=await%20callApi(currentToken,saleDateParams,API_URL_SALEDATE_QUERY);return{planCode,saleDateResponse,tableRowElement,saleDateCellElement,originalCellHTML,originalItemData:originalItemDataForLoading}});const%20results=await%20Promise.allSettled(loadingPromises);let%20successfulQueries=0;results.forEach(result=%3E{if(result.status!==%22fulfilled%22||!result.value||result.value.status==='skipped'){if(result.value&&result.value.planCode&&result.value.reason){console.warn(%60Skipped%20or%20error%20for%20${result.value.planCode}:%20${result.value.reason}%60)}else%20if(result.reason){console.warn(%60Promise%20rejected%20for%20a%20planCode%20query:%60,result.reason)}if(result.value&&result.value.saleDateCellElement&&typeof%20result.value.originalCellHTML==='string'){result.value.saleDateCellElement.innerHTML=result.value.originalCellHTML}return}const{planCode,saleDateResponse,saleDateCellElement,originalItemData}=result.value;if(saleDateResponse){const%20channelDetails=formatChannelSaleDetails(saleDateResponse,planCode,originalItemData.originalEndDisplay,originalItemData.isStillSelling);saleDateCellElement.innerHTML=channelDetails.html;saleDateCellElement.dataset.copy=channelDetails.copyText;saleDateCellElement.dataset.copyForExcel=channelDetails.copyText.replace(/\n/g,%22%20/%20%22);saleDateCellElement.style.backgroundColor=channelDetails.applyYellowBg?%22yellow%22:%22%22;saleDateCellElement.onclick=()=%3E{navigator.clipboard.writeText(saleDateCellElement.dataset.copy);showToastMessage(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)};successfulQueries++}else{console.warn(%60%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E8%B3%87%E8%A8%8A%E5%A4%B1%E6%95%97%20(API%20returned%20null)%20for%20planCode%20${planCode}%60);saleDateCellElement.innerHTML=%60${originalItemData.originalEndDisplay}%3Cbr%3E%3Cspan%20style=%22color:orange;font-style:italic;%22%3E%E9%80%9A%E8%B7%AF%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97%3C/span%3E%60;saleDateCellElement.dataset.copy=originalItemData.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();saleDateCellElement.dataset.copyForExcel=(originalItemData.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()).replace(/\n/g,%22%20/%20%22)}});if(successfulQueries%3E0){showToastMessage(%60%E5%85%B1%20${successfulQueries}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E8%B3%87%E8%A8%8A%E5%B7%B2%E6%9B%B4%E6%96%B0%E3%80%82%60)}else%20if(planCodesToQuery.length%3E0){showToastMessage(%22%E6%89%80%E6%9C%89%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E8%B3%87%E8%A8%8A%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E8%B3%87%E6%96%99%E3%80%82%22)}}function%20renderTable(dataToRender,totalRecords,isAllQueryMode){try{document.getElementById(BOOKMARKLET_MAIN_DIV_ID)?.remove();document.getElementById(BOOKMARKLET_CSS_ID)?.remove();const%20styleElement=document.createElement(%22style%22);styleElement.id=BOOKMARKLET_CSS_ID;styleElement.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}{position:fixed;z-index:99999;left:50%;top:20px;transform:translateX(-50%);background:#fff;border-radius:10px;box-shadow:0%204px%2016px%20rgba(0,0,0,.18);padding:10px;max-width:90vw;width:auto;min-width:680px;max-height:94vh;overflow:auto;font-family:sans-serif;font-size:11px}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_controls_header{position:sticky;top:0;background:#fff;z-index:30;padding:5px%200;border-bottom:1px%20solid%20#eee;display:flex;justify-content:space-between;align-items:center}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_summary_and_research{display:flex;align-items:center;flex-grow:1}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_info_summary{font-size:18px;font-weight:bold;color:#000;margin-right:8px}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group{display:flex;align-items:center;flex-wrap:nowrap;margin-left:auto}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20button,.research-btn{color:#fff;border:none;padding:3px%209px;border-radius:5px;cursor:pointer;font-family:sans-serif;font-size:12px;font-weight:bold;box-shadow:0%201px%204px%20rgba(0,0,0,.1);margin-left:5px;white-space:nowrap}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20button:hover,.research-btn:hover{opacity:.85}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20.copy-all-btn{background:#28a745}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20.in-sale-btn{background:#ffc107;color:#212529}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20.query-channel-btn{background:#17a2b8}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.research-btn{background:#6c757d}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20.reload-btn{background:#007bff}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#pcr_buttons_group%20.close-btn{background:#e72424}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20table%20thead{position:sticky;z-index:10;background:#4467b0}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20table%20thead%20th{background:#4467b0;color:#fff;text-align:center;padding:5px%208px;font-size:13px}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20table{width:100%;border-collapse:collapse;font-size:13px;margin-top:0}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20td{padding:2px%208px;text-align:center;border:1px%20solid%20#ddd;white-space:nowrap;vertical-align:middle}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20th{padding:5px%208px;text-align:center;border:1px%20solid%20#ddd;white-space:nowrap;font-size:13px}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20tbody%20tr%20td:nth-child(3){text-align:left}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20tr:nth-child(even)%20td{background:#f4f7fa}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20td[data-copy]{cursor:pointer;color:#0a51a6;text-decoration:none%20!important}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20td[data-copy]:hover{background:#e3ecf7;color:#0056b3}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20.pcr-seq-cell{color:#007bff;cursor:pointer;text-decoration:none%20!important}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20.pcr-seq-cell:hover{color:#0056b3}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20#${BOOKMARKLET_MAIN_DIV_ID}%20.pcr-seq-cell[data-fetched=%22true%22]{color:inherit;cursor:default}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20body%20%3E%20.pcr-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,123,255,.9);color:#fff;padding:3px%209px;border-radius:5px;font-size:12px;z-index:100000!important;display:inline-block;width:auto}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60;document.head.appendChild(styleElement);const%20pcrElement=document.createElement(%22div%22);pcrElement.id=BOOKMARKLET_MAIN_DIV_ID;const%20summaryBaseText=%60%20%E6%9C%AC%E6%AC%A1%E6%9F%A5%E8%A9%A2%E5%85%B1%20%3Cstrong%3E${totalRecords}%3C/strong%3E%20%E7%AD%86%E3%80%82%20%60;const%20researchMoreButtonHTML=%60%3Cbutton%20class=%22research-btn%22%20id=%22pcr_research_more%22%20style=%22display:none;margin-left:8px;%22%3E%E5%86%8D%E6%AC%A1%E6%9F%A5%E8%A9%A2%3C/button%3E%60;const%20otherButtonsHTML=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22copy-all-btn%22%20id=%22pcr_copy_all%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22in-sale-btn%22%20id=%22pcr_in_sale%22%3E%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22query-channel-btn%22%20id=%22pcr_query_channel_sales%22%3E%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22reload-btn%22%20id=%22pcr_reload%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22close-btn%22%20id=%22pcr_close%22%3E%E9%97%9C%E9%96%89%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60;pcrElement.innerHTML=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id=%22pcr_controls_header%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id=%22pcr_summary_and_research%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%20id=%22pcr_info_summary%22%3E${summaryBaseText}%3C/span%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20${researchMoreButtonHTML}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id=%22pcr_buttons_group%22%3E${otherButtonsHTML}%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctable%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cthead%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%3E%3Cth%3ENo%3C/th%3E%3Cth%3E%E4%BB%A3%E8%99%9F%3C/th%3E%3Cth%3E%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%3C/th%3E%3Cth%3E%E5%B9%A3%E5%88%A5%3C/th%3E%3Cth%3E%E5%96%AE%E4%BD%8D%3C/th%3E%3Cth%3E%E9%A1%9E%E5%9E%8B%3C/th%3E%3Cth%3E%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%3C/th%3E%3Cth%3E%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%3C/th%3E%3C/tr%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/thead%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctbody%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20${dataToRender.map((item,%20index)%20=%3E%20%60%3Ctr%3E%3Ctd%20class=%22pcr-seq-cell%22%20data-plancode=%22${item.code||%22%22}%22%20data-item-code=%22${item.code||%22-%22}%22%20data-fetched=%22false%22%3E${index+1}%3C/td%3E%3Ctd%20class=%22pcr-code-cell%22%20data-copy=%22${item.code||%22-%22}%22%3E${item.code||%22-%22}%3C/td%3E%3Ctd%20data-copy=%22${item.full}%22%20title=%22${item.full}%22%3E${item.name||%22-%22}%3C/td%3E%3Ctd%3E${item.cur}%3C/td%3E%3Ctd%3E${item.unit}%3C/td%3E%3Ctd%3E${item.type}%3C/td%3E%3Ctd%20data-copy=%22${item.start||%22-%22}%22%3E${item.start||%22-%22}%3C/td%3E%3Ctd%20class=%22pcr-saledate-cell%22%20data-initial-copy=%22${item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()}%22%3E${item.originalEndDisplay}%3C/td%3E%3C/tr%3E%60).join(%22%22)}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tbody%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/table%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%60;document.body.appendChild(pcrElement);const%20controlsHeaderElement=pcrElement.querySelector(%22#pcr_controls_header%22);const%20tableTheadElement=pcrElement.querySelector(%22table%20thead%22);if(controlsHeaderElement&&tableTheadElement){tableTheadElement.style.top=controlsHeaderElement.offsetHeight+%22px%22}const%20researchMoreButtonElement=pcrElement.querySelector(%22#pcr_research_more%22);if(researchMoreButtonElement){const%20currentPageSizeForLogic=currentApiParamsObject.pageSize||(isCurrentlyQueryingAllMode&&!currentKeyword?4000:100);researchMoreButtonElement.style.display=totalRecords%3EcurrentPageSizeForLogic?%22inline-block%22:%22none%22;researchMoreButtonElement.onclick=()=%3E{if(!currentApiParamsObject)return;const%20newParams={...currentApiParamsObject};newParams.pageSize=totalRecords;newParams.pageNo=1;loadAndRenderData(newParams,isCurrentlyQueryingAllMode,lastQueryWasSpecialInSale)}}pcrElement.querySelectorAll(%22td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%22).forEach(cell=%3E{cell.onclick=()=%3E{navigator.clipboard.writeText(cell.dataset.copy);showToastMessage(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)}});pcrElement.querySelectorAll(%22td.pcr-code-cell,%20td.pcr-saledate-cell%22).forEach(cell=%3E{cell.onclick=()=%3E{let%20textToCopy=cell.dataset.copy||cell.dataset.initialCopy||cell.innerText;if(cell.classList.contains(%22pcr-saledate-cell%22)&&(!cell.dataset.copy&&cell.dataset.initialCopy)){textToCopy=cell.dataset.initialCopy}else%20if(cell.classList.contains(%22pcr-saledate-cell%22)&&cell.dataset.copy){textToCopy=cell.dataset.copy}navigator.clipboard.writeText(textToCopy);showToastMessage(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)}});pcrElement.querySelectorAll(%22.pcr-seq-cell%22).forEach(sequenceCell=%3E{sequenceCell.onclick=async%20function(){const%20isAlreadyFetched=this.dataset.fetched===%22true%22;const%20planCodeToQuery=this.dataset.plancode;const%20tableRowElement=this.parentNode;if(isAlreadyFetched){let%20textToCopy=%22%22;const%20headersArray=[%22No%22,%22%E4%BB%A3%E8%99%9F%22,%22%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%22,%22%E5%B9%A3%E5%88%A5%22,%22%E5%96%AE%E4%BD%8D%22,%22%E9%A1%9E%E5%9E%8B%22,%22%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%22,%22%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%22];textToCopy+=headersArray.join(%22\t%22)+%22\n%22;const%20cellsInRow=tableRowElement.querySelectorAll(%22td%22);const%20displayedRowValues=Array.from(cellsInRow).map(cell=%3E{let%20cellText=cell.innerText;if(cell.classList.contains('pcr-code-cell')||cell.classList.contains('pcr-saledate-cell')){cellText=(cell.dataset.copyForExcel||cell.dataset.copy||cell.innerText).replace(/\n/g,%22%20/%20%22)}return%20cellText.replace(/\s+/g,'%20')});textToCopy+=displayedRowValues.join(%22\t%22)+%22\n%22;navigator.clipboard.writeText(textToCopy.trim());showToastMessage(%22%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(%E5%90%AB%E8%A1%A8%E9%A0%AD)%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22);return}const%20originalItemCode=this.dataset.itemCode;const%20codeCellElement=tableRowElement.querySelector(%22.pcr-code-cell%22);const%20saleDateCellElement=tableRowElement.querySelector(%22.pcr-saledate-cell%22);const%20originalItemData=displayedDataArray.find(dataItem=%3EdataItem.code===planCodeToQuery);if(!planCodeToQuery||!codeCellElement||!saleDateCellElement||!originalItemData){this.dataset.fetched=%22true%22;this.style.cursor=%22default%22;this.style.color=%22inherit%22;if(codeCellElement)codeCellElement.innerText=originalItemCode;if(saleDateCellElement&&originalItemData)saleDateCellElement.innerHTML=originalItemData.originalEndDisplay;return}this.style.cursor=%22wait%22;showToastMessage(%60%E6%9F%A5%E8%A9%A2%20${planCodeToQuery}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A...%60);const%20polplnParams={planCode:planCodeToQuery,pageNo:1,pageSize:20};const%20saleDateParams={planCode:planCodeToQuery,pageNo:1,pageSize:50};const[polplnResponse,saleDateResponse]=await%20Promise.all([callApi(currentToken,polplnParams,API_URL_PLANCODE_DETAIL),callApi(currentToken,saleDateParams,API_URL_SALEDATE_QUERY)]);this.style.cursor=%22default%22;let%20corePolplnResult=%22-%22;if(polplnResponse&&polplnResponse.records&&polplnResponse.records.length%3E0){corePolplnResult=processPolplnValuesArray(polplnResponse.records.map(r=%3Er.polpln))}let%20newCodeCellHTML;let%20newCodeCellCopyText;if(corePolplnResult==='-'||corePolplnResult===''){newCodeCellHTML=originalItemCode;newCodeCellCopyText=originalItemCode}else{newCodeCellHTML=%60${originalItemCode}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${corePolplnResult}%3C/span%3E%60;newCodeCellCopyText=%60${originalItemCode}\n${corePolplnResult}%60}codeCellElement.innerHTML=newCodeCellHTML;codeCellElement.dataset.copy=newCodeCellCopyText;codeCellElement.dataset.copyForExcel=newCodeCellCopyText.replace(/\n/g,%22%20/%20%22);codeCellElement.onclick=()=%3E{navigator.clipboard.writeText(codeCellElement.dataset.copy);showToastMessage(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)};const%20channelDetails=formatChannelSaleDetails(saleDateResponse,planCodeToQuery,originalItemData.originalEndDisplay,originalItemData.isStillSelling);saleDateCellElement.innerHTML=channelDetails.html;saleDateCellElement.dataset.copy=channelDetails.copyText;saleDateCellElement.dataset.copyForExcel=channelDetails.copyText.replace(/\n/g,%22%20/%20%22);saleDateCellElement.style.backgroundColor=channelDetails.applyYellowBg?%22yellow%22:%22%22;saleDateCellElement.onclick=()=%3E{navigator.clipboard.writeText(saleDateCellElement.dataset.copy);showToastMessage(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)};this.dataset.fetched=%22true%22;this.style.color=%22inherit%22}});pcrElement.querySelector(%22#pcr_copy_all%22).onclick=function(){let%20textToCopy=%22%22;const%20headersArray=[%22No%22,%22%E4%BB%A3%E8%99%9F%22,%22%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%22,%22%E5%B9%A3%E5%88%A5%22,%22%E5%96%AE%E4%BD%8D%22,%22%E9%A1%9E%E5%9E%8B%22,%22%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%22,%22%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%22];textToCopy+=headersArray.join(%22\t%22)+%22\n%22;displayedDataArray.forEach((item,index)=%3E{const%20tableRowElement=pcrElement.querySelector(%60tbody%20tr:nth-child(${index%20+%201})%60);if(!tableRowElement)return;const%20sequenceValue=tableRowElement.querySelector(%22td.pcr-seq-cell%22)?.innerText||(index+1).toString();let%20codeCellValue=%22%22;const%20codeCellDOMElement=tableRowElement.querySelector(%22td.pcr-code-cell%22);if(codeCellDOMElement){codeCellValue=codeCellDOMElement.dataset.copyForExcel||codeCellDOMElement.dataset.copy||codeCellDOMElement.innerText}else{codeCellValue=item.code||%22-%22}let%20saleDateTextValue=%22%22;const%20saleDateCellDOMElement=tableRowElement.querySelector(%22td.pcr-saledate-cell%22);if(saleDateCellDOMElement){saleDateTextValue=saleDateCellDOMElement.dataset.copyForExcel||saleDateCellDOMElement.dataset.copy||Array.from(saleDateCellDOMElement.childNodes).map(node=%3Enode.nodeType===Node.ELEMENT_NODE&&node.tagName===%22BR%22?%22%20/%20%22:(node.textContent?.trim()||%22%22)).filter(Boolean).join(%22%22).trim().replace(/\s*\/\s*/g,%22%20/%20%22)}else{const%20originalItemCopy=displayedDataArray.find(d=%3Ed.code===item.code);saleDateTextValue=originalItemCopy?originalItemCopy.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim():%22-%22}const%20rowDataArray=[sequenceValue,codeCellValue.replace(/\n/g,%22%20/%20%22),item.full||%22-%22,item.cur||%22-%22,item.unit||%22-%22,item.type||%22-%22,item.start||%22-%22,saleDateTextValue.replace(/\n/g,%22%20/%20%22)];textToCopy+=rowDataArray.join(%22\t%22)+%22\n%22});navigator.clipboard.writeText(textToCopy.trim());showToastMessage(%22%E8%A1%A8%E6%A0%BC%E5%85%A7%E5%AE%B9%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22)};pcrElement.querySelector(%22#pcr_in_sale%22).onclick=()=%3E{const%20params={saleEndDate:%229999-12-31%2000:00:00%22,pageNo:1,pageSize:4000,planCodeName:%22%22,orderBy:%22planCode%20asc%22};loadAndRenderData(params,!0,!0)};pcrElement.querySelector(%22#pcr_query_channel_sales%22).onclick=handleQueryChannelSales;pcrElement.querySelector(%22#pcr_reload%22).onclick=()=%3E{document.getElementById(BOOKMARKLET_MAIN_DIV_ID)?.remove();const%20cssElement=document.getElementById(BOOKMARKLET_CSS_ID);if(cssElement)cssElement.remove();setTimeout(initializeBookmarklet,50)};pcrElement.querySelector(%22#pcr_close%22).onclick=()=%3E{document.getElementById(BOOKMARKLET_MAIN_DIV_ID)?.remove();document.getElementById(BOOKMARKLET_CSS_ID)?.remove()}}catch(error){console.warn(%22Error%20in%20renderTable:%22,error);showToastMessage(%22%E6%B8%B2%E6%9F%93%E8%A1%A8%E6%A0%BC%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E4%B8%BB%E6%8E%A7%E5%8F%B0%E3%80%82%22)}}async%20function%20startQueryProcess(){try{const%20existingDiv=document.getElementById(BOOKMARKLET_MAIN_DIV_ID);if(existingDiv){existingDiv.querySelector(%22#pcr_close%22)?.click()}let%20rawPlanCodeInput=await%20showCustomInputDialog(%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%22,%22%E4%BE%8B%E5%A6%82%EF%BC%9AALL%20%E6%88%96%20T001,T002%22);if(rawPlanCodeInput===null)return;const%20planCodeInputString=toHalfWidth(rawPlanCodeInput).trim().toUpperCase();const%20inputString=planCodeInputString;const%20isAllQueryMode=inputString.startsWith(%22ALL%22);currentKeyword=isAllQueryMode?inputString.substring(3).trim():%22%22;let%20pageSizeValue;let%20queryParameters;if(isAllQueryMode){pageSizeValue=currentKeyword?100:4000;queryParameters={planCodeName:currentKeyword,pageNo:1,pageSize:pageSizeValue,orderBy:%22planCode%20asc%22}}else{currentPlanCodesArray=[...new%20Set(inputString.split(/[\s,;]+/).map(c=%3Ec.trim().toUpperCase()).filter(Boolean).map(c=%3Ec.slice(0,4)))];if(currentPlanCodesArray.length===0){showToastMessage(%22%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E7%9A%84%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%81%22);return}pageSizeValue=100;queryParameters={codes:currentPlanCodesArray,pageSize:pageSizeValue}}loadAndRenderData(queryParameters,isAllQueryMode)}catch(error){console.warn(%22Error%20in%20startQueryProcess%20function:%22,error);showToastMessage(%22%E5%95%9F%E5%8B%95%E6%9B%B8%E7%B1%A4%E5%B7%A5%E5%85%B7%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4%E3%80%82%22)}}let%20escapeKeyHandler=function(event){if(event.key===%22Escape%22){const%20mainDiv=document.getElementById(BOOKMARKLET_MAIN_DIV_ID);if(mainDiv){mainDiv.remove();const%20cssElement=document.getElementById(BOOKMARKLET_CSS_ID);if(cssElement)cssElement.remove();document.removeEventListener(%22keydown%22,escapeKeyHandler)}}};document.removeEventListener(%22keydown%22,escapeKeyHandler);document.addEventListener(%22keydown%22,escapeKeyHandler);await%20startQueryProcess()}try{await%20initializeBookmarklet()}catch(error){showToastMessage(%60%E6%9B%B8%E7%B1%A4%E5%B7%A5%E5%85%B7%E5%9F%B7%E8%A1%8C%E5%A4%B1%E6%95%97%EF%BC%9A${error.message}%60);console.error(%22Bookmarklet%20top-level%20execution%20error:%22,error)}})()

javascript:(async function(){    'use strict';          const state={        currentPage:1,totalPages:1,allDataArray:[],recordsPerPage:100,currentToken:null,        displayedDataArray:[],isShowingAllData:!1,queriedDataCache:new Map(),        currentSortColumn:null,currentSortDirection:'asc',apiAbortController:null,        currentFilters:{}   };          const API_URLS={        PLANCODE_QUERY:"https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query",        PLANCODE_DETAIL:"https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail",        SALEDATE_QUERY:"https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query"   };    const MASTER_DATA={        CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},        UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},        TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}   };       const Utils={        toHalfWidth(str){if(typeof str!=="string")return str;return str.replace(/[\uff01-\uff5e]/g,(char)=>String.fromCharCode(char.charCodeAt(0)-0xfee0)).replace(/\u3000/g," ")},        formatDateToYYYYMMDD(dateString){if(!dateString)return"";try{return dateString.substring(0,10).replace(/-/g,"")}catch(e){console.warn("Date format error:",e);return""}},        getTodayString(){const now=new Date();const year=now.getFullYear();const month=(now.getMonth()+1).toString().padStart(2,'0');const day=now.getDate().toString().padStart(2,'0');return `${year}${month}${day}`}   };       const UIComponents={        showInputDialog(titleText,placeholderText,confirmText='%E7%A2%BA%E8%AA%8D',cancelText='%E5%8F%96%E6%B6%88',skipText=null){            return new Promise((resolve)=>{                document.getElementById('customBookmarkletOverlay')?.remove();%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20overlay=document.createElement(%27div%27);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20overlay.id=%27customBookmarkletOverlay%27;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20overlay.style.cssText=`position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%;%20height:%20100%;%20background:%20rgba(0,0,0,0.5);%20z-index:%20100000;`;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20dialog=document.createElement(%27div%27);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dialog.style.cssText=`position:%20fixed;%20top:%2050%;%20left:%2050%;%20transform:%20translate(-50%,-50%);%20background:%20#fff;%20padding:%2020px;%20border-radius:%208px;%20box-shadow:%200%204px%208px%20rgba(0,0,0,0.2);%20z-index:%20100001;%20min-width:%20300px;%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dialog.innerHTML=%60%3Ch3%20style=%22margin-top:0;%20text-align:center;%20margin-bottom:15px;%22%3E${titleText}%3C/h3%3E%3Cinput%20type=%22text%22%20id=%22bm-input%22%20placeholder=%22${placeholderText}%22%20style=%22width:calc(100%%20-%2022px);%20padding:%2010px;%20border:1px%20solid%20#ccc;%20border-radius:4px;%20margin-bottom:15px;%22%3E%3Cdiv%20id=%22bm-btn-container%22%20style=%22text-align:right;%22%3E%3C/div%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20overlay.appendChild(dialog);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20btnContainer=dialog.querySelector('#bm-btn-container');%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20createBtn=(text,onClick,bgColor)=%3E{const%20btn=document.createElement('button');btn.textContent=text;btn.style.cssText=%60background-color:${bgColor};%20color:white;%20border:none;%20padding:8px%2015px;%20border-radius:5px;%20cursor:pointer;%20margin-left:10px;%60;btn.onclick=onClick;return%20btn};%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20input=dialog.querySelector('#bm-input');%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20resolveAndClose=(val)=%3E{overlay.remove();resolve(val)};%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(skipText)btnContainer.appendChild(createBtn(skipText,()=%3EresolveAndClose('SKIP_TOKEN'),'#f0ad4e'));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20btnContainer.appendChild(createBtn(cancelText,()=%3EresolveAndClose(null),'#6c757d'));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20btnContainer.appendChild(createBtn(confirmText,()=%3EresolveAndClose(input.value),'#007bff'));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20document.body.appendChild(overlay);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20input.focus();%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20input.onkeypress=(e)=%3E{if(e.key==='Enter')resolveAndClose(input.value);};%20%20%20%20%20%20%20%20%20%20%20});%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20showToast(message,type='info'){%20%20%20%20%20%20%20%20%20%20%20%20document.querySelector('.toast-message')?.remove();%20%20%20%20%20%20%20%20%20%20%20%20const%20colors={info:'#007bff',success:'#28a745',error:'#dc3545',warning:'#ffc107'};%20%20%20%20%20%20%20%20%20%20%20%20const%20toast=document.createElement('div');%20%20%20%20%20%20%20%20%20%20%20%20toast.className='toast-message';%20%20%20%20%20%20%20%20%20%20%20%20toast.textContent=message;%20%20%20%20%20%20%20%20%20%20%20%20toast.style.cssText=%60position:fixed;%20top:20px;%20left:50%;%20transform:translateX(-50%);%20background:${colors[type]};%20color:#fff;%20padding:10px%2020px;%20border-radius:5px;%20z-index:100002;%20font-size:14px;%60;%20%20%20%20%20%20%20%20%20%20%20%20document.body.appendChild(toast);%20%20%20%20%20%20%20%20%20%20%20%20setTimeout(()=%3Etoast.remove(),2500);%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20%20%20%20const%20ApiManager={%20%20%20%20%20%20%20%20async%20callApi(token,params,apiUrl,signal){%20%20%20%20%20%20%20%20%20%20%20%20if(token==='SKIP_TOKEN'){return'SKIPPED_TOKEN'}%20%20%20%20%20%20%20%20%20%20%20%20if(!token){UIComponents.showToast(%22TOKEN%20%E7%82%BA%E7%A9%BA%22,'error');return%20null}%20%20%20%20%20%20%20%20%20%20%20%20try{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20response=await%20fetch(apiUrl,{method:%22POST%22,headers:{%22Content-Type%22:%22application/json%22,%22SSO-TOKEN%22:token},body:JSON.stringify(params),signal});%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(!response.ok){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response.status===401||response.status===403){UIComponents.showToast(%22TOKEN%20%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%22,'error');return%22TOKEN_INVALID%22}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20UIComponents.showToast(%60API%20%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}%60,'error');return%20null;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20await%20response.json();%20%20%20%20%20%20%20%20%20%20%20}catch(error){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(error.name==='AbortError'){return'ABORTED'}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20UIComponents.showToast(%22API%20%E8%AB%8B%E6%B1%82%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E4%B8%BB%E6%A9%9F%E9%80%A3%E7%B7%9A%22,'error');return%20null;%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20async%20checkTokenValidity(token){return%20token?(await%20this.callApi(token,{planCodeName:%22%22}))!=='TOKEN_INVALID':!1}%20%20%20};%20%20%20%20%20%20%20const%20DataFormatter={%20%20%20%20%20%20%20%20formatItemData(item){%20%20%20%20%20%20%20%20%20%20%20%20const%20today=Utils.getTodayString();%20%20%20%20%20%20%20%20%20%20%20%20const%20endDate=Utils.formatDateToYYYYMMDD(item.saleEndDate);%20%20%20%20%20%20%20%20%20%20%20%20const%20isStillSelling=!!endDate&&(endDate===%2299991231%22||endDate%3E=today);%20%20%20%20%20%20%20%20%20%20%20%20return{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20code:item.planCode,name:(item.shortName||%22%22).trim(),full:(item.planCodeName||%22%22).trim(),%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cur:MASTER_DATA.CUR[item.currency]||%22-%22,unit:MASTER_DATA.UNIT[(item.reportInsuranceAmountUnit||item.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type:MASTER_DATA.TYPE[item.coverageType]||%22-%22,start:Utils.formatDateToYYYYMMDD(item.saleStartDate)||%22-%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20end:endDate,isStillSelling:isStillSelling,originalEndDisplay:endDate?(isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E%E5%81%9C%E5%94%AE%3C/span%3E%60):%22-%22,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20polpln:null,channelDetails:null,isQueried:!1%20%20%20%20%20%20%20%20%20%20%20};%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20formatChannelDetails(saleDateResponse,planCode,originalEndDisplay,originalIsStillSelling){%20%20%20%20%20%20%20%20%20%20%20%20const%20today=Utils.getTodayString();let%20channelInfo=[],anyChannelActive=!1,copyText=originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();%20%20%20%20%20%20%20%20%20%20%20%20if(saleDateResponse?.planCodeSaleDates?.records){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20channelInfo=saleDateResponse.planCodeSaleDates.records.filter(r=%3Er.planCode===planCode&&r.channel&&r.saleEndDate).map(d=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20endDate=Utils.formatDateToYYYYMMDD(d.saleEndDate),startDate=Utils.formatDateToYYYYMMDD(d.saleStartDate);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20isActive=endDate===%2299991231%22||endDate%3E=today;if(isActive)anyChannelActive=!0;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20title=%60${d.channel}%20%E5%8F%AF%E9%8A%B7%E5%94%AE:%20${startDate%20||%20%22?%22}%20~%20${endDate%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%22%20:%20(endDate%20||%20%22?%22)}%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return{channel:d.channel,isActive,title,endDate};%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}).sort((a,b)=%3E(a.isActive!==b.isActive)?(a.isActive?-1:1):a.channel.localeCompare(b.channel));%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20let%20finalHTML=originalEndDisplay;%20%20%20%20%20%20%20%20%20%20%20%20if(channelInfo.length%3E0){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20formatCh=(ch)=%3E%60%3Cspan%20title=%22${ch.title}%22%20style=%22color:${ch.isActive%20?%20'blue'%20:%20'red'};%22%3E${ch.channel}${ch.isActive%20?%20''%20:%20%60(${ch.endDate})%60}%3C/span%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20active=channelInfo.filter(c=%3Ec.isActive),inactive=channelInfo.filter(c=%3E!c.isActive);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20channelHTML='';%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(active.length%3E0)channelHTML+=%60%3Cdiv%3E%E5%8F%AF%E5%94%AE:%20${active.map(formatCh).join(',%20')}%3C/div%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(inactive.length%3E0)channelHTML+=%60%3Cdiv%3E%E5%81%9C%E5%94%AE:%20${inactive.map(formatCh).join(',%20')}%3C/div%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20finalHTML+=%60%3Cdiv%20style=%22text-align:left;%20margin-top:4px;%20padding-top:4px;%20border-top:1px%20solid%20#eee;%20line-height:1.4;%22%3E${channelHTML}%3C/div%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20copyText=channelInfo.map(c=%3E%60${c.isActive%20?%20'%E5%8F%AF%E5%94%AE'%20:%20'%E5%81%9C%E5%94%AE'}:%20${c.channel}%20(${c.title})%60).join('\n');%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20return{html:finalHTML,copyText,applyYellowBg:!originalIsStillSelling&&anyChannelActive};%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20%20%20%20%20%20%20const%20FilterManager={%20%20%20%20%20%20%20%20filterData(column,value){%20%20%20%20%20%20%20%20%20%20%20%20state.currentFilters[column]=(state.currentFilters[column]===value)?null:value;%20%20%20%20%20%20%20%20%20%20%20%20this.applyFilters();%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20applyFilters(){%20%20%20%20%20%20%20%20%20%20%20%20state.displayedDataArray=state.allDataArray.filter(item=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for(const%20key%20in%20state.currentFilters){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20value=state.currentFilters[key];%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(value!==null&&item[key]!==value)return!1;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return!0;%20%20%20%20%20%20%20%20%20%20%20});%20%20%20%20%20%20%20%20%20%20%20%20state.currentPage=1;%20%20%20%20%20%20%20%20%20%20%20%20TableRenderer.render();%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20const%20PaginationManager={%20%20%20%20%20%20%20%20calculatePagination(){%20%20%20%20%20%20%20%20%20%20%20%20const%20data=state.displayedDataArray;%20%20%20%20%20%20%20%20%20%20%20%20if(state.isShowingAllData){return{totalPages:1,currentPage:1,startIndex:0,endIndex:data.length,hasNextPage:!1,hasPrevPage:!1,currentPageData:data}}%20%20%20%20%20%20%20%20%20%20%20%20state.totalPages=Math.ceil(data.length/state.recordsPerPage)||1;%20%20%20%20%20%20%20%20%20%20%20%20const%20startIndex=(state.currentPage-1)*state.recordsPerPage;%20%20%20%20%20%20%20%20%20%20%20%20return{totalPages:state.totalPages,currentPage:state.currentPage,startIndex,endIndex:Math.min(startIndex+state.recordsPerPage,data.length),hasNextPage:state.currentPage%3Cstate.totalPages,hasPrevPage:state.currentPage%3E1,currentPageData:data.slice(startIndex,startIndex+state.recordsPerPage)};%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20goToPage(page){if(!state.isShowingAllData&&page%3E=1&&page%3C=state.totalPages){state.currentPage=page;TableRenderer.render()}},%20%20%20%20%20%20%20%20toggleShowAllMode(){state.isShowingAllData=!state.isShowingAllData;state.currentPage=1;TableRenderer.render()}%20%20%20};%20%20%20%20%20%20%20const%20SortManager={%20%20%20%20%20%20%20%20sortTable(columnName){%20%20%20%20%20%20%20%20%20%20%20%20if(state.currentSortColumn===columnName){state.currentSortDirection=state.currentSortDirection==='asc'?'desc':'asc'}else{state.currentSortColumn=columnName;state.currentSortDirection='asc'}%20%20%20%20%20%20%20%20%20%20%20%20state.allDataArray.sort((a,b)=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20valA=a[columnName],valB=b[columnName];%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20comparison=String(valA).localeCompare(String(valB),'zh-TW',{numeric:!0});%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20state.currentSortDirection==='asc'?comparison:-comparison;%20%20%20%20%20%20%20%20%20%20%20});%20%20%20%20%20%20%20%20%20%20%20%20FilterManager.applyFilters();%20%20%20%20%20%20%20}%20%20%20};const%20ProductQueryManager={%20%20%20%20%20%20%20%20async%20batchQueryInfo(){%20%20%20%20%20%20%20%20%20%20%20%20if(!document.getElementById('pcrBookMarkletDivV17'))return;%20%20%20%20%20%20%20%20%20%20%20%20const%20currentPageData=PaginationManager.calculatePagination().currentPageData;%20%20%20%20%20%20%20%20%20%20%20%20if(!currentPageData||currentPageData.length===0)return%20UIComponents.showToast('%E6%B2%92%E6%9C%89%E5%8F%AF%E6%9F%A5%E8%A9%A2%E7%9A%84%E5%95%86%E5%93%81','warning');%20%20%20%20%20%20%20%20%20%20%20%20state.apiAbortController=new%20AbortController();%20%20%20%20%20%20%20%20%20%20%20%20const%20signal=state.apiAbortController.signal,cancelButton=document.getElementById('btn-cancel-query');%20%20%20%20%20%20%20%20%20%20%20%20try{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(cancelButton)cancelButton.style.display='inline-block';%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20UIComponents.showToast(%60%E6%9F%A5%E8%A9%A2%20${currentPageData.length}%20%E7%AD%86%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A...%60,'info');%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20await%20Promise.all(currentPageData.map(async(item)=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(item.isQueried)return;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20cached=state.queriedDataCache.get(item.code);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(cached){item.polpln=cached.polpln;item.channelDetails=cached.channel.details;item.isQueried=!0;return}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const[polplnResponse,saleDateResponse]=await%20Promise.all([%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ApiManager.callApi(state.currentToken,{planCode:item.code},API_URLS.PLANCODE_DETAIL,signal),%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ApiManager.callApi(state.currentToken,{planCode:item.code},API_URLS.SALEDATE_QUERY,signal)%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20]);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(polplnResponse==='ABORTED'||saleDateResponse==='ABORTED')throw%20new%20Error('ABORTED');%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20polplnResult=%22-%22;if(polplnResponse?.records?.length%3E0)polplnResult=DataFormatter.processPolplnData(polplnResponse.records.map(r=%3Er.polpln));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20channelDetails=DataFormatter.formatChannelDetails(saleDateResponse,item.code,item.originalEndDisplay,item.isStillSelling);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state.queriedDataCache.set(item.code,{polpln:polplnResult,channel:{details:channelDetails,response:saleDateResponse}});%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20item.polpln=polplnResult;item.channelDetails=channelDetails;item.isQueried=!0;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20UIComponents.showToast('%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A%E5%B7%B2%E6%9B%B4%E6%96%B0','success');%20%20%20%20%20%20%20%20%20%20%20}catch(e){if(e.message!=='ABORTED')UIComponents.showToast('%E6%9F%A5%E8%A9%A2%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4','error');%20%20%20%20%20%20%20%20%20%20%20}finally{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(cancelButton)cancelButton.style.display='none';%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state.apiAbortController=null;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20TableRenderer.render();%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20%20%20%20const%20DataLoader={%20%20%20%20%20%20%20%20async%20loadAndRenderData(queryParams,queryType){%20%20%20%20%20%20%20%20%20%20%20%20state.apiAbortController=new%20AbortController();const%20signal=state.apiAbortController.signal;%20%20%20%20%20%20%20%20%20%20%20%20const%20cancelButton=document.getElementById('btn-cancel-query');%20%20%20%20%20%20%20%20%20%20%20%20try{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(cancelButton)cancelButton.style.display='inline-block';%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20finalData=[];%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(queryType==='single'){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20response=await%20ApiManager.callApi(state.currentToken,queryParams,API_URLS.PLANCODE_QUERY,signal);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response==='SKIPPED_TOKEN'){state.allDataArray=[];FilterManager.applyFilters();UIComponents.showToast('%E6%9C%AA%E6%8F%90%E4%BE%9BTOKEN%EF%BC%8C%E7%84%A1%E6%B3%95%E6%9F%A5%E8%A9%A2','warning');return}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response==='ABORTED')return;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response==='TOKEN_INVALID'){await%20initializeApp();return}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response?.records)finalData=response.records.map(DataFormatter.formatItemData);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}else{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20results=await%20Promise.all(queryParams.codes.map(async(code)=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20response=await%20ApiManager.callApi(state.currentToken,{planCode:code},API_URLS.PLANCODE_QUERY,signal);%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(response===%22TOKEN_INVALID%22||response==='ABORTED')return%20response;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20response?.records?.length%3E0?response.records.map(DataFormatter.formatItemData):[{code,name:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,full:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,isStillSelling:!1}];%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}));%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(results.some(r=%3Er==='ABORTED'))return;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(results.some(r=%3Er===%22TOKEN_INVALID%22)){await%20initializeApp();return}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20finalData=results.flat();%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state.allDataArray=finalData;state.currentFilters={};FilterManager.applyFilters();%20%20%20%20%20%20%20%20%20%20%20}catch(error){if(error.name!=='AbortError')UIComponents.showToast(%22%E8%BC%89%E5%85%A5%E8%B3%87%E6%96%99%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4%22,'error');%20%20%20%20%20%20%20%20%20%20%20}finally{if(cancelButton)cancelButton.style.display='none';state.apiAbortController=null}%20%20%20%20%20%20%20}%20%20%20};const%20CopyManager={%20%20%20%20%20%20%20%20async%20copyTableData(){%20%20%20%20%20%20%20%20%20%20%20%20const%20dataToRender=PaginationManager.calculatePagination().currentPageData;%20%20%20%20%20%20%20%20%20%20%20%20if(!dataToRender||dataToRender.length===0){UIComponents.showToast('%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD','warning');return}%20%20%20%20%20%20%20%20%20%20%20%20const%20headers=['%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F','%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1','%E5%B9%A3%E5%88%A5','%E5%96%AE%E4%BD%8D','%E9%A1%9E%E5%9E%8B','%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5','%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5','POLPLN'];%20%20%20%20%20%20%20%20%20%20%20%20let%20copyText=headers.join('\t')+'\n';%20%20%20%20%20%20%20%20%20%20%20%20dataToRender.forEach((item)=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20row=[%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20item.code||'',item.full||item.name||'',item.cur||'',item.unit||'',item.type||'',item.start||'',item.channelDetails?.copyText||item.originalEndDisplay?.replace(/%3C[^%3E]*%3E/g,'')||'',item.polpln||''%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20];%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20copyText+=row.join('\t')+'\n';%20%20%20%20%20%20%20%20%20%20%20});%20%20%20%20%20%20%20%20%20%20%20%20try{await%20navigator.clipboard.writeText(copyText);UIComponents.showToast('%E8%A1%A8%E6%A0%BC%E8%B3%87%E6%96%99%E5%B7%B2%E8%A4%87%E8%A3%BD','success')}%20%20%20%20%20%20%20%20%20%20%20%20catch(e){UIComponents.showToast('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97','error')}%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20%20%20%20%20%20%20const%20TableRenderer={%20%20%20%20%20%20%20%20render(){this.cleanup();this.createStyles();this.createTable();this.setupGlobalFunctions()},%20%20%20%20%20%20%20%20cleanup(){document.getElementById('pcrBookMarkletDivV17')?.remove()},%20%20%20%20%20%20%20%20createStyles(){%20%20%20%20%20%20%20%20%20%20%20%20if(document.getElementById('pcrBookMarkletCssV17'))return;%20%20%20%20%20%20%20%20%20%20%20%20const%20style=document.createElement('style');style.id='pcrBookMarkletCssV17';%20%20%20%20%20%20%20%20%20%20%20%20style.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20%20#pcrBookMarkletDivV17%20{%20position:fixed;%20z-index:99999;%20left:50%;%20top:20px;%20transform:translateX(-50%);%20background:#fff;%20border:2px%20solid%20#333;%20padding:10px;%20max-width:95vw;%20width:auto;%20min-width:800px;%20max-height:94vh;%20font-family:system-ui,sans-serif;%20font-size:13px;%20display:flex;%20flex-direction:column;%20border-radius:8px;%20box-shadow:0%205px%2025px%20rgba(0,0,0,0.3);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.top-button-row%20{%20display:flex;%20justify-content:space-between;%20align-items:center;%20padding:5px%200%2010px;%20border-bottom:1px%20solid%20#ccc;%20margin-bottom:5px;%20flex-shrink:0;%20cursor:move;%20user-select:none;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.left-buttons,%20.right-buttons,%20.filter-controls%20{%20display:flex;%20gap:6px;%20align-items:center;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.info-row%20{%20display:flex;%20justify-content:space-between;%20align-items:center;%20padding:5px%200;%20margin-bottom:5px;%20flex-shrink:0;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.data-summary%20{%20font-size:14px;%20font-weight:bold;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.table-container%20{%20flex:1;%20overflow-y:auto;%20border:1px%20solid%20#ccc;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.btn%20{%20border:1px%20solid%20#555;%20padding:6px%2012px;%20cursor:pointer;%20font-size:13px;%20font-weight:bold;%20border-radius:4px;%20transition:all%200.2s;%20}%20.btn:hover%20{%20opacity:0.8;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.btn-in-sale{background:#ffc107;color:#000}%20.btn-query-info{background:#17a2b8;color:white}%20.btn-copy-all{background:#28a745;color:white}%20.btn-show-all{background:#6f42c1;color:white}%20.btn-reload{background:#007bff;color:white}%20.btn-close{background:#dc3545;color:white}%20.btn-cancel{background:#fd7e14;color:white}%20%20%20%20%20%20%20%20%20%20%20%20%20.pagination-nav%20{%20display:flex;%20align-items:center;%20gap:8px;%20}%20.nav-btn%20{%20background:#007bff;%20color:white;%20}%20.nav-btn:disabled%20{%20background:#6c757d;%20cursor:not-allowed;%20opacity:0.7;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.filter-btn-group%20{%20margin:%200%208px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.filter-btn%20{%20padding:%203px%2010px;%20font-size:%2012px;%20border:%201px%20solid%20#ccc;%20border-radius:%2012px;%20cursor:%20pointer;%20transition:%20all%200.2s;%20background:%20#f0f0f0;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.filter-btn.isStillSelling%20{%20background-color:%20#e9ecef;%20}%20.filter-btn.cur%20{%20background-color:%20#e7f5ff;%20}%20.filter-btn.type%20{%20background-color:%20#e6f9f1;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.filter-btn.active%20{%20background-color:%20#007bff;%20color:%20white;%20border-color:%20#007bff;%20font-weight:%20bold;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20#pcrBookMarkletDivV17%20table%20{%20width:100%;%20border-collapse:collapse;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20#pcrBookMarkletDivV17%20thead%20th%20{%20background:#343a40;%20color:#fff;%20text-align:center;%20padding:8px;%20border:1px%20solid%20#ccc;%20cursor:pointer;%20position:sticky;%20top:0;%20z-index:10;%20}%20#pcrBookMarkletDivV17%20thead%20th:hover%20{%20background:#495057;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20#pcrBookMarkletDivV17%20td%20{%20padding:6px%208px;%20text-align:center;%20border:1px%20solid%20#ddd;%20white-space:nowrap;%20vertical-align:middle;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pcr-saledate-cell%20{%20white-space:normal;%20text-align:left;%20min-width:180px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%60;%20%20%20%20%20%20%20%20%20%20%20%20document.head.appendChild(style);%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20createTable(){%20%20%20%20%20%20%20%20%20%20%20%20const%20pagination=PaginationManager.calculatePagination();%20%20%20%20%20%20%20%20%20%20%20%20const%20container=document.createElement('div');container.id='pcrBookMarkletDivV17';%20%20%20%20%20%20%20%20%20%20%20%20const%20summaryText=%60%E8%B3%87%E6%96%99%E5%85%B1%20${state.allDataArray.length}%20%E7%AD%86%EF%BC%8C%E9%A1%AF%E7%A4%BA%20${state.displayedDataArray.length}%20%E7%AD%86%60;%20%20%20%20%20%20%20%20%20%20%20%20const%20filterControlsHTML=this.generateFilterControls();%20%20%20%20%20%20%20%20%20%20%20%20container.innerHTML=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22top-button-row%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22left-buttons%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-in-sale%22%20onclick=%22window.bookmarkletFuncs.handleInSale()%22%3E%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-query-info%22%20onclick=%22window.bookmarkletFuncs.batchQueryInfo()%22%3E%E5%95%86%E5%93%81%E8%B3%87%E8%A8%8A%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-copy-all%22%20onclick=%22window.bookmarkletFuncs.copyTableData()%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-show-all%22%20onclick=%22window.bookmarkletFuncs.toggleShowAllMode()%22%3E${state.isShowingAllData%20?%20'%E5%88%86%E9%A0%81%E9%A1%AF%E7%A4%BA'%20:%20'%E4%B8%80%E9%A0%81%E9%A1%AF%E7%A4%BA'}%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22btn-cancel-query%22%20class=%22btn%20btn-cancel%22%20onclick=%22window.bookmarkletFuncs.cancelQuery()%22%20style=%22display:none;%22%3E%E5%8F%96%E6%B6%88%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22right-buttons%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-reload%22%20onclick=%22window.bookmarkletFuncs.reload()%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22btn%20btn-close%22%20onclick=%22window.bookmarkletFuncs.close()%22%3E%E9%97%9C%E9%96%89%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22info-row%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22data-summary%22%3E${summaryText}%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22filter-controls%22%3E${filterControlsHTML}%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pagination-nav%22%3E${state.isShowingAllData%20?%20''%20:%20%60%3Cbutton%20class=%22btn%20nav-btn%22%20${!pagination.hasPrevPage&&'disabled'}onclick=%22window.bookmarkletFuncs.goToPage(${state.currentPage-1})%22%3E%E5%BE%80%E5%89%8D%3C/button%3E%3Cspan%20style=%22font-weight:bold;%22%3E${state.currentPage}/${pagination.totalPages}%3C/span%3E%3Cbutton%20class=%22btn%20nav-btn%22%20${!pagination.hasNextPage&&'disabled'}onclick=%22window.bookmarkletFuncs.goToPage(${state.currentPage+1})%22%3E%E5%BE%80%E5%BE%8C%3C/button%3E%60}%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22table-container%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctable%3E%3Cthead%3E%3Ctr%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('code')%22%3E%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%3C/th%3E%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('name')%22%3E%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%3C/th%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('cur')%22%3E%E5%B9%A3%E5%88%A5%3C/th%3E%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('unit')%22%3E%E5%96%AE%E4%BD%8D%3C/th%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('type')%22%3E%E9%A1%9E%E5%9E%8B%3C/th%3E%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('start')%22%3E%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%3C/th%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cth%20onclick=%22window.bookmarkletFuncs.sortTable('isStillSelling')%22%3E%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%3C/th%3E%3Cth%3EPOLPLN%3C/th%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%3C/thead%3E%3Ctbody%3E${this.generateTableRows(pagination.currentPageData)}%3C/tbody%3E%3C/table%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%60;%20%20%20%20%20%20%20%20%20%20%20%20document.body.appendChild(container);%20%20%20%20%20%20%20%20%20%20%20%20this.makeDraggable(container,container.querySelector('.top-button-row'));%20%20%20%20%20%20%20},%20%20%20%20%20%20generateFilterControls(){%20%20%20%20%20%20%20%20%20%20%20%20let%20html='';%20%20%20%20%20%20%20%20%20%20%20%20const%20createBtnHTML=(group,value,label)=%3E%60%3Cbutton%20class=%22filter-btn%20${group}%20${state.currentFilters[group]%20===%20value%20?%20'active'%20:%20''}%22%20onclick=%22window.bookmarkletFuncs.filterData('${group}',%20${typeof%20value%20===%20'boolean'%20?%20value%20:%20%60'${value}'%60})%22%3E${label}%3C/button%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20html+=%60%3Cspan%20class=%22filter-btn-group%22%3E${createBtnHTML('isStillSelling',%20true,%20'%E7%8F%BE%E5%94%AE')}%20${createBtnHTML('isStillSelling',%20false,%20'%E5%81%9C%E5%94%AE')}%3C/span%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20if(state.allDataArray.length%3E30){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20['cur','type'].forEach(key=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20values=[...new%20Set(state.allDataArray.map(item=%3Eitem[key]))].filter(v=%3Ev&&v!=='-').sort();%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(values.length%3E1)html+=%60%3Cspan%20class=%22filter-btn-group%22%3E${values.map(v%20=%3E%20createBtnHTML(key,%20v,%20v)).join('%20')}%3C/span%3E%60;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20});%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20return%20html;%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20generateTableRows(data){%20%20%20%20%20%20%20%20%20%20%20%20if(data.length===0)return'%3Ctr%3E%3Ctd%20colspan=%228%22%20style=%22text-align:center;padding:20px;color:#777;%22%3E%E6%B2%92%E6%9C%89%E7%AC%A6%E5%90%88%E6%A2%9D%E4%BB%B6%E7%9A%84%E8%B3%87%E6%96%99%3C/td%3E%3C/tr%3E';%20%20%20%20%20%20%20%20%20%20%20%20return%20data.map(item=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20saleDateHTML=item.channelDetails?item.channelDetails.html:item.originalEndDisplay;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20bgColor=item.channelDetails?.applyYellowBg?'background-color:#fffde7;':'';%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%60%3Ctr%20style=%22${bgColor}%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20title=%22%E8%A4%87%E8%A3%BD:%20${item.code}%22%20onclick=%22window.bookmarkletFuncs.copyText('${item.code}')%22%3E${item.code||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20title=%22${item.full}%22%20onclick=%22window.bookmarkletFuncs.copyText('${item.full||item.name}')%22%3E${item.name||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20onclick=%22window.bookmarkletFuncs.copyText('${item.cur}')%22%3E${item.cur||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20onclick=%22window.bookmarkletFuncs.copyText('${item.unit}')%22%3E${item.unit||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20onclick=%22window.bookmarkletFuncs.copyText('${item.type}')%22%3E${item.type||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20onclick=%22window.bookmarkletFuncs.copyText('${item.start}')%22%3E${item.start||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-saledate-cell%22%20onclick=%22window.bookmarkletFuncs.copyText('${item.channelDetails?.copyText%20||%20''}')%22%3E${saleDateHTML}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20onclick=%22window.bookmarkletFuncs.copyText('${item.polpln||''}')%22%3E${item.polpln||''}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%60;%20%20%20%20%20%20%20%20%20%20%20}).join('');%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20makeDraggable(el,handle){%20%20%20%20%20%20%20%20%20%20%20%20let%20pos1=0,pos2=0,pos3=0,pos4=0;%20%20%20%20%20%20%20%20%20%20%20%20handle.onmousedown=e=%3E{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20e.preventDefault();pos3=e.clientX;pos4=e.clientY;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if(el.style.transform){const%20rect=el.getBoundingClientRect();el.style.left=rect.left+'px';el.style.top=rect.top+'px';el.style.transform=''}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20document.onmouseup=()=%3E{document.onmouseup=document.onmousemove=null};%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20document.onmousemove=e=%3E{e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;el.style.top=(el.offsetTop-pos2)+%22px%22;el.style.left=(el.offsetLeft-pos1)+%22px%22};%20%20%20%20%20%20%20%20%20%20%20};%20%20%20%20%20%20%20},%20%20%20%20%20%20%20%20setupGlobalFunctions(){%20%20%20%20%20%20%20%20%20%20%20%20window.bookmarkletFuncs={%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20goToPage:PaginationManager.goToPage,toggleShowAllMode:PaginationManager.toggleShowAllMode,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sortTable:SortManager.sortTable,batchQueryInfo:ProductQueryManager.batchQueryInfo,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20copyTableData:CopyManager.copyTableData,close:this.cleanup,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20reload:()=%3E{this.cleanup();initializeApp()},handleInSale:()=%3EDataLoader.loadAndRenderData({saleStatus:'Y'},'single'),%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cancelQuery:()=%3E{if(state.apiAbortController)state.apiAbortController.abort();},%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20copyText:async(text)=%3E{if(!text)return;try{await%20navigator.clipboard.writeText(text);UIComponents.showToast('%E5%B7%B2%E8%A4%87%E8%A3%BD:%20'+text,'success')}catch(e){UIComponents.showToast('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97','error')}},%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20filterData:FilterManager.filterData%20%20%20%20%20%20%20%20%20%20%20};%20%20%20%20%20%20%20}%20%20%20};%20%20%20%20%20%20%20%20%20%20async%20function%20initializeApp(){%20%20%20%20%20%20%20%20try{%20%20%20%20%20%20%20%20%20%20%20%20if(await%20ApiManager.checkTokenValidity(state.currentToken)){await%20startMainFlow();return}%20%20%20%20%20%20%20%20%20%20%20%20const%20token=await%20UIComponents.showInputDialog('%E8%AB%8B%E8%BC%B8%E5%85%A5%20SSO%20TOKEN','%E8%AB%8B%E8%B2%BC%E4%B8%8A%E6%82%A8%E7%9A%84%20TOKEN...','%E7%A2%BA%E8%AA%8D','%E5%8F%96%E6%B6%88','%E7%95%A5%E9%81%8E%E9%A9%97%E8%AD%89');%20%20%20%20%20%20%20%20%20%20%20%20if(token===null){TableRenderer.cleanup();return%20UIComponents.showToast('%E5%B7%B2%E5%8F%96%E6%B6%88%E6%93%8D%E4%BD%9C','info')}%20%20%20%20%20%20%20%20%20%20%20%20if(token==='SKIP_TOKEN'||(token.trim()&&await%20ApiManager.checkTokenValidity(token.trim()))){%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state.currentToken=token.trim();%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20UIComponents.showToast(token==='SKIP_TOKEN'?'%E5%B7%B2%E7%95%A5%E9%81%8E%E9%A9%97%E8%AD%89':'TOKEN%20%E9%A9%97%E8%AD%89%E6%88%90%E5%8A%9F','success');%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20await%20startMainFlow();%20%20%20%20%20%20%20%20%20%20%20}else{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20TableRenderer.cleanup();await%20initializeApp();%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20}catch(error){UIComponents.showToast('%E5%88%9D%E5%A7%8B%E5%8C%96%E9%8C%AF%E8%AA%A4','error')}%20%20%20}%20%20%20%20%20%20%20async%20function%20startMainFlow(){%20%20%20%20%20%20%20%20const%20queryInput=await%20UIComponents.showInputDialog('%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%E6%9F%A5%E8%A9%A2','%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%20(%E5%A4%9A%E7%AD%86%E8%AB%8B%E7%94%A8%E9%80%97%E8%99%9F,%E9%9A%94%E9%96%8B)','%E6%9F%A5%E8%A9%A2','%E5%8F%96%E6%B6%88');%20%20%20%20%20%20%20%20if(queryInput===null){TableRenderer.cleanup();return%20UIComponents.showToast('%E5%B7%B2%E5%8F%96%E6%B6%88%E6%9F%A5%E8%A9%A2','info')}%20%20%20%20%20%20%20%20const%20trimmedInput=queryInput.trim();%20%20%20%20%20%20%20%20if(!trimmedInput){await%20startMainFlow();return}%20%20%20%20%20%20%20%20UIComponents.showToast('%E6%AD%A3%E5%9C%A8%E6%9F%A5%E8%A9%A2%E5%95%86%E5%93%81%E8%B3%87%E6%96%99...','info');%20%20%20%20%20%20%20%20if(trimmedInput.includes(',')){%20%20%20%20%20%20%20%20%20%20%20%20const%20codes=[...new%20Set(trimmedInput.split(',').map(c=%3EUtils.toHalfWidth(c.trim())).filter(Boolean))];%20%20%20%20%20%20%20%20%20%20%20%20await%20DataLoader.loadAndRenderData({codes},'multiple');%20%20%20%20%20%20%20}else{%20%20%20%20%20%20%20%20%20%20%20%20await%20DataLoader.loadAndRenderData({planCode:Utils.toHalfWidth(trimmedInput)},'single');%20%20%20%20%20%20%20}%20%20%20}%20%20%20%20%20%20%20%20%20%20TableRenderer.render();%20%20%20%20await%20initializeApp();%20%20%20})()

javascript:(async function(){const API_URL_TEMPLATES_PQ={uat:{planCodeQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'},prod:{planCodeQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'}};const TOKEN_STORAGE_KEY_PQ='euisPlanCodeToken_v2';const TOKEN_STORAGE_KEY_PQ_FALLBACK='euisToken';const MAIN_UI_ID_PQ='productQueryBookmarkletDiv_Structured_v2';const CSS_ID_PQ='productQueryBookmarkletCss_Structured_v2';const Z_INDEX_OVERLAY_PQ=2147483640;const Z_INDEX_DIALOG_PQ=2147483641;const Z_INDEX_MAIN_UI_PQ=2147483630;const Z_INDEX_NOTIFICATION_PQ=2147483647;const PRODUCT_FIELD_DEFINITIONS_PQ={CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}};const maxProductListPageSize_PQ=5000;const MAX_CHANNEL_QUERY_LIMIT_PQ=888;let currentApiUrls_PQ={};let apiAuthToken_PQ=null;let tokenStatus_PQ="initial";let productQueryResults_PQ=[];let totalRecords_PQ=0;let currentQueryParameters_PQ={};let currentSortKey_PQ=null;let currentSortDirection_PQ='none';let autoFetchDetailsAfterLoad_PQ=!1;let mainUIDraggableState_PQ={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};function escapeHtml_PQ(unsafe){if(typeof unsafe!=='string')return unsafe===null||unsafe===undefined?%27%27:String(unsafe);return%20unsafe.replace(/[&%3C%3E%22%27]/g,m=%3E({%27&%27:%27&%27,%27%3C%27:%27%3C%27,%27%3E%27:%27%3E%27,%27%22%27:%27%22%27,%22%27%22:%27&#039;'})[m])}function%20displaySystemNotification_PQ(message,isError=!1,duration=2000){const%20notificationId='pqToolNotification_S_v2';document.getElementById(notificationId)?.remove();const%20notification=document.createElement('div');notification.id=notificationId;notification.className='pcr-toast';notification.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20position:%20fixed;%20top:%2020px;%20left:%2050%;%20transform:%20translateX(-50%);%20%20%20%20%20%20%20%20%20%20%20%20background:%20${isError%20?%20'rgba(220,%2053,%2069,%200.9)'%20:%20'rgba(0,%20123,%20255,%200.9)'};%20color:%20#fff;%20%20%20%20%20%20%20%20%20%20%20%20padding:%205px%2012px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20%20%20%20%20%20%20z-index:%20${Z_INDEX_NOTIFICATION_PQ};%20display:%20inline-block;%20width:%20auto;%20%20%20%20%20%20%20%20%20%20%20%20box-shadow:%200%202px%208px%20rgba(0,0,0,.15);%20%20%20%20%20%20%20%20%20%20%20%20opacity:%201;%20transition:%20opacity%200.5s%20ease-out%20${Math.max(0,%20duration%20-%20500)}ms;%20%20%20%20%20%20%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20text-align:%20center;%20%20%20%20%20%20%20%20%60;notification.innerText=message;document.body.appendChild(notification);if(duration%3E0){setTimeout(()=%3E{notification.style.opacity='0';setTimeout(()=%3Enotification.remove(),500)},duration)}}function%20makeElementDraggable_PQ(element){let%20pos1=0,pos2=0,pos3=0,pos4=0;let%20header=element.querySelector('.pq-dialog-title')||element.querySelector('.pcr-title-bar');if(!header)return;header.style.cursor='move';header.onmousedown=dragMouseDown;function%20dragMouseDown(e){e=e||window.event;e.preventDefault();pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDragElement;document.onmousemove=elementDrag}function%20elementDrag(e){e=e||window.event;e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;element.style.top=(element.offsetTop-pos2)+%22px%22;element.style.left=(element.offsetLeft-pos1)+%22px%22}function%20closeDragElement(){document.onmouseup=null;document.onmousemove=null}}function%20createDialogBase_PQ(id,contentHtml,minWidth='300px',maxWidth='500px',customStyles=''){const%20overlayId=id+'_overlay_pq';const%20dialogId=id+'_dialog_pq';document.getElementById(overlayId)?.remove();document.getElementById(dialogId)?.remove();const%20overlay=document.createElement('div');overlay.id=overlayId;overlay.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%;%20height:%20100%;%20%20%20%20%20%20%20%20%20%20%20%20background:%20rgba(0,0,0,0.6);%20z-index:%20${Z_INDEX_OVERLAY_PQ};%20%20%20%20%20%20%20%20%20%20%20%20display:%20flex;%20align-items:%20center;%20justify-content:%20center;%20%20%20%20%20%20%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20%20%20%20%20%20%20%20%20%20%20%20backdrop-filter:%20blur(2px);%20%20%20%20%20%20%20%20%60;document.body.appendChild(overlay);const%20dialog=document.createElement('div');dialog.id=dialogId;dialog.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20background:%20#fff;%20padding:%2020px%2025px;%20border-radius:%208px;%20%20%20%20%20%20%20%20%20%20%20%20box-shadow:%200%205px%2020px%20rgba(0,0,0,0.25);%20%20%20%20%20%20%20%20%20%20%20%20min-width:%20${minWidth};%20max-width:%20${maxWidth};%20width:%20auto;%20%20%20%20%20%20%20%20%20%20%20%20animation:%20pqDialogAppear_S%200.2s%20ease-out;%20%20%20%20%20%20%20%20%20%20%20%20z-index:%20${Z_INDEX_DIALOG_PQ};%20%20%20%20%20%20%20%20%20%20%20%20${customStyles}%20%20%20%20%20%20%20%20%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);if(!document.getElementById('pq-dialog-style')){const%20style=document.createElement('style');style.id='pq-dialog-style';style.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20@keyframes%20pqDialogAppear_S%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20from%20{%20opacity:%200;%20transform:%20scale(0.95)%20translateY(-10px);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%20{%20opacity:%201;%20transform:%20scale(1)%20translateY(0);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%20padding:%208px%2015px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%20transition:%20opacity%200.2s%20ease,%20transform%200.1s%20ease;%20font-weight:%20500;%20margin-left:%208px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn:hover%20{%20opacity:%200.85;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn:active%20{%20transform:%20scale(0.98);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-blue%20{%20background:%20#007bff;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-orange%20{%20background:%20#fd7e14;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-green%20{%20background:%20#28a745;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-grey%20{%20background:%20#6c757d;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-red%20{%20background:%20#dc3545;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-title%20{%20margin:%200%200%2018px%200;%20color:%20#333;%20font-size:%2018px;%20text-align:%20center;%20font-weight:%20600;%20cursor:%20move;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-input,%20.pq-textarea%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20width:%20calc(100%%20-%2018px);%20padding:%209px;%20border:%201px%20solid%20#ccc;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%204px;%20font-size:%2013px;%20margin-bottom:%2012px;%20box-sizing:%20border-box;%20color:%20#333;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-textarea%20{%20min-height:%2070px;%20resize:%20vertical;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-flex-end%20{%20display:%20flex;%20justify-content:%20flex-end;%20margin-top:%2020px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20{%20margin-bottom:%2012px;%20text-align:%20left;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20label%20{%20margin-right:%2015px;%20font-size:%2014px;%20cursor:pointer;%20display:%20block;%20margin-bottom:%208px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20input[type=%22radio%22]%20{%20margin-right:%206px;%20vertical-align:%20middle;%20}%20%20%20%20%20%20%20%20%20%20%20%20%60;document.head.appendChild(style)}makeElementDraggable_PQ(dialog);return{overlay,dialog}}function%20normalizeInput_PQ(str){if(typeof%20str!=='string')return%20str;return%20str.replace(/[\uff01-\uff5e]/g,s=%3EString.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g,%22%20%22).trim()}function%20formatDateForQuery_PQ(dateStr){if(!dateStr)return%22%22;try{return%20dateStr.substring(0,10).replace(/-/g,%22%22)}catch(t){console.warn(%22Error%20formatting%20date:%22,dateStr,t);return%22%22}}function%20getTodayDateString_PQ(){let%20e=new%20Date(),t=e.getFullYear(),r=(e.getMonth()+1).toString().padStart(2,%220%22),l=e.getDate().toString().padStart(2,%220%22);return%20%60${t}${r}${l}%60}function%20createEnvSelectionDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style=%22display:flex;%20gap:10px;%20justify-content:center;%20margin-bottom:20px;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-uat%22%20class=%22pq-dialog-btn%20pq-dialog-btn-green%22%20style=%22flex-grow:1;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-prod%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22flex-grow:1;%20background-color:#ffc107;%20color:#212529;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style=%22text-align:center;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%60;const{overlay}=createDialogBase_PQ('pqEnvSelect_S_v2',contentHtml,'320px');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#pq-env-uat').onclick=()=%3EcloseDialog('uat');overlay.querySelector('#pq-env-prod').onclick=()=%3EcloseDialog('prod');overlay.querySelector('#pq-env-cancel').onclick=()=%3EcloseDialog(null)})}function%20createTokenDialog_PQ(attempt=1){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cinput%20type=%22password%22%20id=%22pq-token-input%22%20class=%22pq-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%20autocomplete=%22current-password%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20${attempt%20%3E%201%20?%20%60%3Cp%20style=%22color:red;%20font-size:12px;%20text-align:center;%20margin-bottom:10px;%22%3ETOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%3C/p%3E%60%20:%20''}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-skip%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22margin-right:auto;%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-close-tool%22%20class=%22pq-dialog-btn%20pq-dialog-btn-red%22%3E%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E${attempt%20%3E%201%20?%20'%E9%87%8D%E8%A9%A6'%20:%20'%E7%A2%BA%E5%AE%9A'}%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%60;const{overlay,dialog}=createDialogBase_PQ('pqToken_S_v2',contentHtml,'390px');const%20inputEl=dialog.querySelector('#pq-token-input');inputEl.focus();if(attempt%3E2){dialog.querySelector('#pq-token-ok').disabled=!0;dialog.querySelector('#pq-token-ok').style.opacity='0.5';dialog.querySelector('#pq-token-ok').style.cursor='not-allowed';displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E5%98%97%E8%A9%A6%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E7%A2%BA%E8%AA%8D%20TOKEN%E3%80%81%E9%81%B8%E6%93%87%E7%95%A5%E9%81%8E%E6%88%96%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%E3%80%82',!0,4000)}const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog('_token_dialog_cancel_pq_');};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-token-ok').onclick=()=%3EcloseDialog(inputEl.value.trim());dialog.querySelector('#pq-token-close-tool').onclick=()=%3EcloseDialog('_close_tool_pq_');dialog.querySelector('#pq-token-skip').onclick=()=%3EcloseDialog('_skip_token_pq_')})}function%20createQuerySetupDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-radio-group%22%20style=%22margin-bottom:%2010px;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCode%22%20checked%3E%20%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCodeName%22%3E%20%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22allPlans%22%3E%20%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22inSaleWithDetails%22%3E%20%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%20(%E5%90%AB%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85)%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctextarea%20id=%22pq-queryvalues-input%22%20class=%22pq-textarea%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94%22%3E%3C/textarea%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%60;const{overlay,dialog}=createDialogBase_PQ('pqQuerySetup_S_v2',contentHtml,'520px');const%20queryValuesInput=dialog.querySelector('#pq-queryvalues-input');const%20radioButtons=dialog.querySelectorAll('input[name=%22pq-query-type%22]');function%20updateInputState(){const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;const%20disableInputModes=['allPlans','inSaleWithDetails'];if(disableInputModes.includes(selectedType)){queryValuesInput.placeholder='%E7%84%A1%E9%9C%80%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6';queryValuesInput.value='';queryValuesInput.disabled=!0}else%20if(selectedType==='planCode'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94';queryValuesInput.disabled=!1}else%20if(selectedType==='planCodeName'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%96%AE%E4%B8%80%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97';queryValuesInput.disabled=!1}}radioButtons.forEach(radio=%3Eradio.onchange=updateInputState);updateInputState();queryValuesInput.addEventListener('keydown',(e)=%3E{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();dialog.querySelector('#pq-querysetup-ok').click()}});const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-querysetup-ok').onclick=()=%3E{const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;let%20inputValue=normalizeInput_PQ(queryValuesInput.value);const%20requiresInputModes=['planCode','planCodeName'];if(requiresInputModes.includes(selectedType)&&!inputValue){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81',!0);queryValuesInput.focus();return}if(selectedType==='planCodeName'&&inputValue.split(/[\s,;]+/).filter(Boolean).length%3E1){displaySystemNotification_PQ('%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E6%9F%A5%E8%A9%A2%E5%83%85%E6%94%AF%E6%8F%B4%E5%96%AE%E4%B8%80%E9%97%9C%E9%8D%B5%E5%AD%97%E3%80%82',!0);queryValuesInput.focus();return}closeDialog({queryMode:selectedType,inputValue:inputValue,showAllOnOnePage:!0})};dialog.querySelector('#pq-querysetup-cancel').onclick=()=%3EcloseDialog(null)})}async%20function%20callProductApi_PQ(token,payload,apiEndpointKey){const%20apiUrl=currentApiUrls_PQ[apiEndpointKey];try{const%20headers={'Content-Type':'application/json'};if(token){headers['SSO-TOKEN']=token}const%20response=await%20fetch(apiUrl,{method:'POST',headers:headers,body:JSON.stringify(payload)});if(response.status===401){return{error:'TOKEN_INVALID',data:null,message:%22TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%E3%80%82%22}}if(!response.ok){const%20errorText=await%20response.text();const%20specificErrorMsg=%60%20(${response.statusText%20||%20errorText%20||%20'%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4'})%60;return{error:%60API_ERROR_${response.status}%60,data:null,message:%60%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}${specificErrorMsg}%60}}return%20await%20response.json()}catch(error){return{error:'NETWORK_ERROR',data:null,message:%22%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E9%8C%AF%E8%AA%A4%E6%88%96API%E7%84%A1%E5%9B%9E%E6%87%89%E3%80%82%22}}}async%20function%20checkTokenValidity_PQ(token){const%20response=await%20callProductApi_PQ(token,{planCodeName:%22%22},'planCodeQuery');return!response.error}function%20transformProductData_PQ(apiRecord,indexInOriginalFetch){const%20saleStartDate=apiRecord.saleStartDate||%22%22;const%20saleEndDate=apiRecord.saleEndDate||%22%22;const%20formattedStartDate=formatDateForQuery_PQ(saleStartDate);const%20formattedEndDate=formatDateForQuery_PQ(saleEndDate);let%20isStillSelling=!1;if(formattedEndDate){isStillSelling=formattedEndDate===%2299991231%22||formattedEndDate%3E=getTodayDateString_PQ()}let%20endDateDisplay=%22-%22;if(apiRecord._isErrorRow){endDateDisplay=%60%3Cspan%20style=%22color:red;%22%3E${apiRecord.name%20||%20'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97'}%3C/span%3E%60}else%20if(formattedEndDate){endDateDisplay=isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E${formattedEndDate}%3C/span%3E%60}return{_originalSequentialIndex:indexInOriginalFetch,code:apiRecord.planCode,name:(apiRecord.shortName||(apiRecord._isErrorRow?%22%22:%22N/A%22)).trim(),full:(apiRecord.planCodeName||(apiRecord._isErrorRow?apiRecord.name:%22N/A%22)).trim(),cur:PRODUCT_FIELD_DEFINITIONS_PQ.CUR[apiRecord.currency]||%22-%22,unit:PRODUCT_FIELD_DEFINITIONS_PQ.UNIT[(apiRecord.reportInsuranceAmountUnit||apiRecord.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:PRODUCT_FIELD_DEFINITIONS_PQ.TYPE[apiRecord.coverageType]||%22-%22,start:formattedStartDate||%22-%22,end:formattedEndDate,isStillSelling:isStillSelling,originalEndDisplay:endDateDisplay,_isErrorRow:apiRecord._isErrorRow||!1,_detailsFetched:!1,polplnEnrichedCodeForCopy:null,channelEnrichedEndDateForCopy:null,polplnDisplayText:null,channelDisplayHtml:null,applyYellowBgForDisplay:!1}}function%20extractPolpln_PQ(polplnString){if(!polplnString||typeof%20polplnString!=='string')return%22%22;let%20t=polplnString.trim();if(t.endsWith(%22%%%22))t=t.substring(0,t.length-2);return%20t.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim()||%22%22}function%20processMultiplePolpln_PQ(polplnRecords){if(!polplnRecords||polplnRecords.length===0)return%22-%22;if(polplnRecords.length===1)return%20extractPolpln_PQ(polplnRecords[0])||%22-%22;const%20extractedPolplns=polplnRecords.map(r=%3EextractPolpln_PQ(r)).filter(p=%3Ep!==%22%22);if(extractedPolplns.length===0)return%22-%22;const%20firstPolpln=extractedPolplns[0];return%20extractedPolplns.every(p=%3Ep===firstPolpln)?firstPolpln:%22-%22}function%20formatChannelSalesInfo_PQ(saleDateApiResponse,planCode,baseEndDisplay,isBaseStillSelling){const%20todayStr=getTodayDateString_PQ();let%20channelDetailsHtml=%22%22;let%20copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();let%20hasActiveChannel=!1;let%20hasAnyChannelInfo=!1;if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length%3E0){hasAnyChannelInfo=!0;const%20channelRecords=saleDateApiResponse.planCodeSaleDates.records.filter(rec=%3Erec.planCode===planCode&&rec.channel&&rec.saleEndDate).map(rec=%3E{const%20channelEndDate=formatDateForQuery_PQ(rec.saleEndDate);const%20channelStartDate=formatDateForQuery_PQ(rec.saleStartDate);const%20isChannelSelling=channelEndDate===%2299991231%22||channelEndDate%3E=todayStr;if(isChannelSelling)hasActiveChannel=!0;const%20channelName=(rec.channel||%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22).replace(/OT/g,'BK');const%20titleText=%60${channelName}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelStartDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelEndDate%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22%20:%20channelEndDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%60;let%20displayText,plainTextPart;if(isChannelSelling){displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:blue;%22%3E${escapeHtml_PQ(channelName)}%3C/span%3E%60;plainTextPart=%60${channelName}%60}else{displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:red;%22%3E${escapeHtml_PQ(channelName)}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%3C/span%3E%60;plainTextPart=%60${channelName}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%60}return{channel:channelName,text:displayText,isSelling:isChannelSelling,plainText:plainTextPart,startDate:channelStartDate,endDate:channelEndDate}}).sort((a,b)=%3E{if(a.isSelling!==b.isSelling)return%20a.isSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});const%20sellingChannels=channelRecords.filter(r=%3Er.isSelling);const%20stoppedChannels=channelRecords.filter(r=%3E!r.isSelling);let%20currentCopyTextParts=[];const%20channelStyle=%60text-align:%20left;%20margin-left:%200;%20padding-left:%200;%20display:%20block;%20line-height:%201.4;%60;if(sellingChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22${channelStyle}%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.plainText).join(%22%E3%80%81%22)}%60)}if(stoppedChannels.length%3E0){const%20stoppedDisplayParts=stoppedChannels.map(r=%3E%60%3Cdiv%20style=%22${channelStyle}%22%3E${r.text}%3C/div%3E%60).join('');const%20stoppedCopyParts=stoppedChannels.map(r=%3Er.plainText);channelDetailsHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-left:%200;%20padding-left:%200;%20display:%20block;%20line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedDisplayParts.startsWith('%3Cdiv')%20?%20''%20:%20'%20'}%20${stoppedDisplayParts}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedCopyParts.join(%22\n%22)}%60)}if(currentCopyTextParts.length%3E0){copyTextContent=currentCopyTextParts.join(%22\n%22)}else%20if(hasAnyChannelInfo){copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%3C/div%3E%60}else{copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}}else%20if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length===0){hasAnyChannelInfo=!0;copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%3C/div%3E%60}let%20finalHtml=baseEndDisplay;if(channelDetailsHtml){finalHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelDetailsHtml}%3C/div%3E%60}const%20applyYellowBg=!isBaseStillSelling&&hasActiveChannel;return{html:finalHtml,copyText:copyTextContent.trim(),applyYellowBg:applyYellowBg,hasChannelInfo:hasAnyChannelInfo}}function%20handleSortRequest_PQ(sortKey){if(currentSortKey_PQ===sortKey){currentSortDirection_PQ=currentSortDirection_PQ==='asc'?'desc':'asc'}else{currentSortKey_PQ=sortKey;currentSortDirection_PQ='asc'}sortProductResults_PQ();renderMainResultsUI_PQ();const%20headerText=document.querySelector(%60#${MAIN_UI_ID_PQ}%20th[data-sort-key=%22${sortKey}%22]%60)?.textContent?.replace(/[%E2%96%B2%E2%96%BC\s]*/g,'')||sortKey;displaySystemNotification_PQ(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerText}%E3%80%8D${currentSortDirection_PQ%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1,1500)}function%20sortProductResults_PQ(){if(!currentSortKey_PQ||currentSortDirection_PQ==='none'||!productQueryResults_PQ)return;productQueryResults_PQ.sort((a,b)=%3E{let%20valA=a[currentSortKey_PQ];let%20valB=b[currentSortKey_PQ];if(valA===null||valA===undefined)valA=%22%22;if(valB===null||valB===undefined)valB=%22%22;if(currentSortKey_PQ==='_originalSequentialIndex'){return%20currentSortDirection_PQ==='asc'?valA-valB:valB-valA}else%20if(currentSortKey_PQ==='start'||currentSortKey_PQ==='end'){return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB)):String(valB).localeCompare(String(valA))}else{return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB),'zh-Hant-TW',{sensitivity:'base',numeric:!0}):String(valB).localeCompare(String(valA),'zh-Hant-TW',{sensitivity:'base',numeric:!0})}})}function%20renderMainResultsUI_PQ(){document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();const%20styleEl=document.createElement(%22style%22);styleEl.id=CSS_ID_PQ;styleEl.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20{position:fixed;z-index:${Z_INDEX_MAIN_UI_PQ};left:50%;top:20px;transform:translateX(-50%);background:#f8f9fa;border-radius:10px;box-shadow:0%206px%2024px%20rgba(0,0,0,.15);padding:18px;width:auto;min-width:750px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft%20JhengHei',%20Arial,%20sans-serif;font-size:13px;%20border:%201px%20solid%20#dee2e6;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar%20{padding:10px%2015px;background-color:#343a40;color:white;font-weight:bold;font-size:15px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;margin:-18px%20-18px%2012px%20-18px;%20display:%20flex;%20justify-content:%20space-between;%20align-items:%20center;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar-text%20{%20flex-grow:%201;%20text-align:%20center;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-window-close-btn%20{background:transparent;color:white;border:none;font-size:20px;cursor:pointer;padding:0%208px;%20line-height:%201;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-controls-header_pq%20{background:#fff;padding:10px;border:1px%20solid%20#ddd;%20border-radius:%206px;%20margin-bottom:12px;%20display:flex;justify-content:space-between;align-items:center;%20flex-wrap:%20wrap;%20gap:10px;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-summary-and-research_pq%20{display:flex;align-items:center;flex-grow:1;%20gap:15px;%20flex-wrap:wrap;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20{font-size:14px;font-weight:500;color:#212529;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20strong%20{color:#007bff;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20{display:flex;align-items:center;flex-wrap:nowrap;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button%20{border:none;padding:6px%2014px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;box-shadow:0%201px%203px%20rgba(0,0,0,.1);margin-left:8px;white-space:nowrap;%20transition:%20opacity%200.2s%20ease;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button:hover%20{opacity:.85}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-copy-all-btn%20{background:#28a745;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-query-data-btn%20{background:#17a2b8;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-reload-btn%20{background:#007bff;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-clear-results-btn%20{background:#6c757d;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-table-container_pq%20{flex-grow:1;%20overflow:auto;%20border:1px%20solid%20#ddd;%20border-radius:6px;%20background:white;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20{width:100%;border-collapse:collapse;font-size:12px;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20{position:sticky;top:0;z-index:2;background:#343a40;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th%20{background:#343a40;color:#fff;text-align:center;padding:8px%2010px;font-size:13px;%20border-bottom:%202px%20solid%20#454d55;%20border-right:%201px%20solid%20#454d55;%20white-space:nowrap;%20cursor:pointer;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th:last-child%20{border-right:none;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td,%20#${MAIN_UI_ID_PQ}%20th%20{padding:7px%2010px;text-align:center;border:1px%20solid%20#e9ecef;white-space:nowrap;vertical-align:middle}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tbody%20tr%20td:nth-child(3)%20{text-align:left;%20white-space:normal;%20min-width:150px;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:nth-child(even)%20td%20{background:#f8f9fa}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:hover%20td%20{background:#e9ecef;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%20{cursor:pointer;color:#0056b3;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell%20{color:#007bff;cursor:pointer;font-weight:bold;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell:hover%20{text-decoration:underline;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell[data-fetched=%22true%22]%20{color:#28a745;cursor:copy;font-weight:normal;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-saledate-cell%20{white-space:normal%20!important;vertical-align:top%20!important;min-width:200px;%20max-width:280px;%20text-align:left%20!important;}%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-error-row%20td%20{background-color:%20#ffebee%20!important;%20color:%20#c62828;}%20%20%20%20%20%20%20%20%60;document.head.appendChild(styleEl);const%20mainDiv=document.createElement(%22div%22);mainDiv.id=MAIN_UI_ID_PQ;const%20titleBar=document.createElement(%22div%22);titleBar.className=%22pcr-title-bar%22;const%20titleTextEl=document.createElement(%22span%22);titleTextEl.className=%22pcr-title-bar-text%22;titleTextEl.textContent=%22%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%20%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%22;const%20closeWindowBtn=document.createElement(%22button%22);closeWindowBtn.className=%22pcr-window-close-btn%22;closeWindowBtn.innerHTML=%22&#x2715;%22;closeWindowBtn.onclick=()=%3E{handleCloseMainUI_PQ()};titleBar.appendChild(titleTextEl);titleBar.appendChild(closeWindowBtn);mainDiv.appendChild(titleBar);const%20controlsHeader=document.createElement(%22div%22);controlsHeader.className=%22pcr-controls-header_pq%22;const%20summaryResearchDiv=document.createElement(%22div%22);summaryResearchDiv.className=%22pcr-summary-and-research_pq%22;const%20infoSummarySpan=document.createElement(%22span%22);infoSummarySpan.className=%22pcr-info-summary_pq%22;let%20summaryText=%60%E7%B8%BD%E5%85%B1%20%3Cstrong%3E${totalRecords_PQ}%3C/strong%3E%20%E7%AD%86%60;infoSummarySpan.innerHTML=summaryText;summaryResearchDiv.appendChild(infoSummarySpan);controlsHeader.appendChild(summaryResearchDiv);const%20buttonsGroupDiv=document.createElement(%22div%22);buttonsGroupDiv.className=%22pcr-buttons-group_pq%22;const%20currentDisplayedCount=productQueryResults_PQ.length;const%20initialPageSize=currentQueryParameters_PQ.pageSize;const%20showOnePageButton=totalRecords_PQ%3EinitialPageSize&&currentDisplayedCount%3CtotalRecords_PQ;const%20onePageButtonHtml=showOnePageButton?%60%3Cbutton%20class=%22pcr-query-data-btn%22%20id=%22pcr_one_page_display_pq_s%22%3E%E4%B8%80%E9%A0%81%E9%A1%AF%E7%A4%BA%3C/button%3E%60:'';const%20isChannelQueryDisabled=currentDisplayedCount%3EMAX_CHANNEL_QUERY_LIMIT_PQ;const%20channelQueryButtonHtml=%60%3Cbutton%20class=%22pcr-query-data-btn%22%20id=%22pcr_query_data_pq_s%22%20${isChannelQueryDisabled%20?%20'disabled'%20:%20''}%20title=%22${isChannelQueryDisabled%20?%20%60%E7%9B%AE%E5%89%8D%E9%A1%AF%E7%A4%BA%E7%AD%86%E6%95%B8(${currentDisplayedCount}%E7%AD%86)%E8%B6%85%E9%81%8E%E9%80%9A%E8%B7%AF%E6%9F%A5%E8%A9%A2%E4%B8%8A%E9%99%90(${MAX_CHANNEL_QUERY_LIMIT_PQ}%E7%AD%86)%EF%BC%8C%E8%AB%8B%E7%B8%AE%E5%B0%8F%E6%9F%A5%E8%A9%A2%E7%AF%84%E5%9C%8D%E3%80%82%60%20:%20'%E6%9F%A5%E8%A9%A2%E7%9B%AE%E5%89%8D%E8%A1%A8%E6%A0%BC%E4%B8%AD%E6%89%80%E6%9C%89%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85'}%22%3E%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E8%B3%87%E6%96%99%3C/button%3E%60;buttonsGroupDiv.innerHTML=%60%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-copy-all-btn%22%20id=%22pcr_copy_all_pq_s%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20${channelQueryButtonHtml}%20%20%20%20%20%20%20%20%20%20%20%20${onePageButtonHtml}%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-reload-btn%22%20id=%22pcr_reload_pq_s%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-clear-results-btn%22%20id=%22pcr_clear_results_pq_s%22%3E%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C%3C/button%3E%20%20%20%20%20%20%20%20%60;controlsHeader.appendChild(buttonsGroupDiv);mainDiv.appendChild(controlsHeader);const%20tableContainer=document.createElement(%22div%22);tableContainer.className=%22pcr-table-container_pq%22;const%20tableEl=document.createElement(%22table%22);const%20headers=[{key:'_originalSequentialIndex',display:'No'},{key:'code',display:'%E4%BB%A3%E8%99%9F'},{key:'name',display:'%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1'},{key:'cur',display:'%E5%B9%A3%E5%88%A5'},{key:'unit',display:'%E5%96%AE%E4%BD%8D'},{key:'type',display:'%E9%A1%9E%E5%9E%8B'},{key:'start',display:'%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5'},{key:'end',display:'%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5'}];let%20headerHtml='%3Ctr%3E';headers.forEach(h=%3E{let%20indicator='';if(h.key===currentSortKey_PQ){if(currentSortDirection_PQ==='asc')indicator='%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%B2%3C/span%3E';else%20if(currentSortDirection_PQ==='desc')indicator='%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%BC%3C/span%3E'}headerHtml+=%60%3Cth%20data-sort-key=%22${h.key}%22%3E${h.display}${indicator}%3C/th%3E%60});headerHtml+='%3C/tr%3E';let%20tableBodyHtml=productQueryResults_PQ.map((p,indexInRenderedList)=%3E{const%20displayNo=p._originalSequentialIndex+1;return%20%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%20class=%22${p._isErrorRow%20?%20'pcr-error-row'%20:%20''}%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-seq-cell%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-plancode=%22${p.code%20||%20''}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-item-index-in-rendered-list=%22${indexInRenderedList}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-original-sequential-index=%22${p._originalSequentialIndex}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-fetched=%22${p._detailsFetched%20?%20'true'%20:%20'false'}%22%3E${displayNo}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-code-cell%22%20data-copy=%22${escapeHtml_PQ(p.polplnEnrichedCodeForCopy%20||%20p.code%20||%20'-')}%22%20title=%22${escapeHtml_PQ(p.code%20||%20'-')}%22%3E${p.polplnDisplayText%20||%20escapeHtml_PQ(p.code%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20data-copy=%22${escapeHtml_PQ(p.full%20||%20'-')}%22%20title=%22${escapeHtml_PQ(p.full%20||%20'-')}%22%3E${escapeHtml_PQ(p.name%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.cur)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.unit)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.type)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20data-copy=%22${escapeHtml_PQ(p.start%20||%20'-')}%22%3E${escapeHtml_PQ(p.start%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-saledate-cell%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-initial-copy=%22${escapeHtml_PQ(p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%20%22%22).trim())}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-copy=%22${escapeHtml_PQ(p.channelEnrichedEndDateForCopy%20||%20p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%20%22%22).trim())}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20style=%22${p.applyYellowBgForDisplay%20?%20'background-color:yellow;'%20:%20''}%22%3E${p.channelDisplayHtml%20||%20p.originalEndDisplay}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%20%20%20%20%20%20%20%20%20%20%20%20%60}).join('');tableEl.innerHTML=%60%3Cthead%3E${headerHtml}%3C/thead%3E%3Ctbody%3E${tableBodyHtml}%3C/tbody%3E%60;tableContainer.appendChild(tableEl);mainDiv.appendChild(tableContainer);document.body.appendChild(mainDiv);makeElementDraggable_PQ(mainDiv);titleBar.onmousedown=(e)=%3E{if(e.target.classList.contains('pcr-window-close-btn'))return;mainUIDraggableState_PQ.dragging=!0;mainUIDraggableState_PQ.startX=e.clientX-mainDiv.offsetLeft;mainUIDraggableState_PQ.startY=e.clientY-mainDiv.offsetTop;titleBar.style.cursor='grabbing';document.onmousemove=(moveEvent)=%3E{if(!mainUIDraggableState_PQ.dragging)return;mainDiv.style.left=(moveEvent.clientX-mainUIDraggableState_PQ.startX)+'px';mainDiv.style.top=(moveEvent.clientY-mainUIDraggableState_PQ.startY)+'px'};document.onmouseup=()=%3E{mainUIDraggableState_PQ.dragging=!1;titleBar.style.cursor='grab';document.onmousemove=null;document.onmouseup=null}};mainDiv.querySelectorAll(%22table%20thead%20th[data-sort-key]%22).forEach(thElement=%3E{thElement.onclick=()=%3EhandleSortRequest_PQ(thElement.dataset.sortKey)});mainDiv.querySelector(%22#pcr_copy_all_pq_s%22).onclick=handleCopyAll_PQ;mainDiv.querySelector(%22#pcr_query_data_pq_s%22).onclick=handleQueryAllData_PQ;if(showOnePageButton){mainDiv.querySelector(%22#pcr_one_page_display_pq_s%22).onclick=handleOnePageDisplay_PQ}mainDiv.querySelector(%22#pcr_reload_pq_s%22).onclick=handleReload_PQ;mainDiv.querySelector(%22#pcr_clear_results_pq_s%22).onclick=()=%3E{handleCloseMainUI_PQ()};mainDiv.querySelectorAll(%22td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%22).forEach(el=%3E{el.onclick=()=%3E{navigator.clipboard.writeText(el.dataset.copy);displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1000)}});mainDiv.querySelectorAll(%22td.pcr-code-cell,%20td.pcr-saledate-cell%22).forEach(el=%3E{el.onclick=()=%3E{let%20textToCopy=el.dataset.copy||el.dataset.initialCopy||el.innerText;textToCopy=textToCopy.replace(/\n%3Cbr\s*\/?%3E/gi,%22\n%22).replace(/%3Cbr\s*\/?%3E/gi,%22%20/%20%22).replace(/%3C[^%3E]*%3E/g,%22%22);navigator.clipboard.writeText(textToCopy);displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1000)}});mainDiv.querySelectorAll(%22.pcr-seq-cell%22).forEach(cell=%3E{cell.onclick=async%20function(){await%20handleSeqCellClick_PQ(this)}});document.addEventListener('keydown',mainUIEscListener_PQ)}async%20function%20handleSeqCellClick_PQ(cellElement){const%20originalSequentialIndex=parseInt(cellElement.dataset.originalSequentialIndex);const%20productItem=productQueryResults_PQ.find(p=%3Ep._originalSequentialIndex===originalSequentialIndex);if(!productItem){displaySystemNotification_PQ(%22%E7%84%A1%E6%B3%95%E6%89%BE%E5%88%B0%E5%B0%8D%E6%87%89%E5%95%86%E5%93%81%E8%B3%87%E6%96%99%E9%80%B2%E8%A1%8C%E6%93%8D%E4%BD%9C%E3%80%82%22,!0);return}if(productItem._isErrorRow){displaySystemNotification_PQ(%22%E6%AD%A4%E5%88%97%E7%82%BA%E9%8C%AF%E8%AA%A4%E8%B3%87%E6%96%99%EF%BC%8C%E7%84%A1%E6%B3%95%E6%9F%A5%E8%A9%A2%E8%A9%B3%E6%83%85%E3%80%82%22,!0);return}if(productItem._detailsFetched){let%20headerText=headersForCopy_PQ().join(%22\t%22)+%22\n%22;let%20rowElement=cellElement.parentNode;let%20rowCells=Array.from(rowElement.querySelectorAll(%22td%22));let%20rowContent=headersForCopy_PQ().map((headerKey,idx)=%3E{let%20cellText=rowCells[idx]?rowCells[idx].innerText:'';if(headerKey==='%E4%BB%A3%E8%99%9F')cellText=productItem.polplnEnrichedCodeForCopy||productItem.code||%22-%22;if(headerKey==='%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5')cellText=productItem.channelEnrichedEndDateForCopy||productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();return(cellText||%22%22).replace(/\s+/g,%22%20%22).replace(/\n/g,%22%20/%20%22)}).join(%22\t%22);navigator.clipboard.writeText(headerText+rowContent.trim());displaySystemNotification_PQ(%60%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(No.${productItem._originalSequentialIndex%20+%201})%E5%B7%B2%E8%A4%87%E8%A3%BD(%E5%90%AB%E8%A1%A8%E9%A0%AD)%EF%BC%81%60,!1,1500);return}cellElement.style.cursor=%22wait%22;const%20currentNoTextInCell=cellElement.textContent.match(/^\d+/);cellElement.textContent=%60${currentNoTextInCell%20?%20currentNoTextInCell[0]%20:%20'?'}%20(%E6%9F%A5...)%60;const%20originalSeqDisplayNoInCell=cellElement.textContent.replace(%22%20(%E6%9F%A5...)%22,%22%22);const%20codeCell=cellElement.parentNode.querySelector(%22.pcr-code-cell%22);const%20saleDateCell=cellElement.parentNode.querySelector(%22.pcr-saledate-cell%22);displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,0);const[detailRes,saleDateRes]=await%20Promise.all([callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:20},'planCodeDetail'),callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:50},'saleDateQuery')]);const%20currentDetailToast=document.getElementById('pqToolNotification_S_v2');if(currentDetailToast&&currentDetailToast.innerText.includes(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60)){currentDetailToast.remove()}displaySystemNotification_PQ(%22%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%AE%8C%E7%95%A2%E3%80%82%22,!1,1000);cellElement.textContent=originalSeqDisplayNoInCell;cellElement.style.cursor=%22pointer%22;let%20polplnText=%22-%22;if(detailRes&&detailRes.records&&detailRes.records.length%3E0){polplnText=processMultiplePolpln_PQ(detailRes.records.map(r=%3Er.polpln))}let%20codeDisplayHtml=escapeHtml_PQ(productItem.code||%22-%22);let%20codeCopyToClipboard=productItem.code||%22-%22;if(detailRes&&detailRes.error){codeDisplayHtml+=%60%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3EPOLPLN:%20${escapeHtml_PQ(detailRes.message%20||%20detailRes.error)}%3C/span%3E%60}else%20if(polplnText!==%22-%22&&polplnText!==%22%22){codeDisplayHtml=%60${escapeHtml_PQ(productItem.code%20||%20%22-%22)}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${escapeHtml_PQ(polplnText)}%3C/span%3E%60;codeCopyToClipboard=%60${productItem.code%20||%20%22-%22}\n${polplnText}%60}productItem.polplnDisplayText=codeDisplayHtml;productItem.polplnEnrichedCodeForCopy=codeCopyToClipboard;if(codeCell){codeCell.innerHTML=productItem.polplnDisplayText;codeCell.dataset.copy=productItem.polplnEnrichedCodeForCopy;codeCell.dataset.copyForExcel=productItem.polplnEnrichedCodeForCopy.replace(/\n/g,%22%20/%20%22)}const%20channelInfo=formatChannelSalesInfo_PQ(saleDateRes,productItem.code,productItem.originalEndDisplay,productItem.isStillSelling);productItem.channelDisplayHtml=channelInfo.html;productItem.channelEnrichedEndDateForCopy=channelInfo.copyText;productItem.applyYellowBgForDisplay=channelInfo.applyYellowBg;if(saleDateCell){if(saleDateRes&&saleDateRes.error){saleDateCell.innerHTML=%60${productItem.originalEndDisplay}%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3E%E9%80%9A%E8%B7%AF:%20${escapeHtml_PQ(saleDateRes.message%20||%20saleDateRes.error)}%3C/span%3E%60;saleDateCell.dataset.copy=productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}else{saleDateCell.innerHTML=productItem.channelDisplayHtml;saleDateCell.dataset.copy=channelInfo.copyText;saleDateCell.style.backgroundColor=productItem.applyYellowBgForDisplay?%22yellow%22:%22%22}saleDateCell.dataset.copyForExcel=productItem.channelEnrichedEndDateForCopy.replace(/\n/g,%22%20/%20%22)}cellElement.dataset.fetched=%22true%22;cellElement.style.color=%22#28a745%22;cellElement.style.cursor=%22copy%22;productItem._detailsFetched=!0}function%20headersForCopy_PQ(){return['No','%E4%BB%A3%E8%99%9F','%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1','%E5%B9%A3%E5%88%A5','%E5%96%AE%E4%BD%8D','%E9%A1%9E%E5%9E%8B','%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5','%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5']}function%20handleCopyAll_PQ(){let%20tsvContent=headersForCopy_PQ().join(%22\t%22)+%22\n%22;const%20itemsToCopy=productQueryResults_PQ;if(!itemsToCopy||itemsToCopy.length===0){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD%E3%80%82%22,!0);return}displaySystemNotification_PQ(%60%E6%BA%96%E5%82%99%E8%A4%87%E8%A3%BD%E5%85%A8%E9%83%A8%20${itemsToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99...%60,!1,1500);itemsToCopy.forEach((product)=%3E{let%20codeData=product.polplnEnrichedCodeForCopy||product.code||%22-%22;let%20saleDateData=product.channelEnrichedEndDateForCopy||product.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();const%20rowValues=[(product._originalSequentialIndex+1).toString(),(codeData||%22%22).replace(/\n/g,%22%20/%20%22),escapeHtml_PQ(product.full||%22-%22),escapeHtml_PQ(product.cur||%22-%22),escapeHtml_PQ(product.unit||%22-%22),escapeHtml_PQ(product.type||%22-%22),escapeHtml_PQ(product.start||%22-%22),(saleDateData||%22%22).replace(/\n/g,%22%20/%20%22)];tsvContent+=rowValues.join(%22\t%22)+%22\n%22});navigator.clipboard.writeText(tsvContent.trim());displaySystemNotification_PQ(%60%E5%85%B1%20${itemsToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99%E5%B7%B2%E8%A4%87%E8%A3%BD%20(TSV%E6%A0%BC%E5%BC%8F)%EF%BC%81%60,!1,2500)}async%20function%20handleQueryAllData_PQ(){const%20mainUIDiv=document.getElementById(MAIN_UI_ID_PQ);if(!mainUIDiv){displaySystemNotification_PQ(%22%E8%A1%A8%E6%A0%BC%E4%B8%8D%E5%AD%98%E5%9C%A8%E3%80%82%22,!0);return}const%20itemsForDetailProcessing=productQueryResults_PQ;const%20currentDisplayedCount=itemsForDetailProcessing.length;if(!itemsForDetailProcessing||currentDisplayedCount===0){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E5%95%86%E5%93%81%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E3%80%82%22,!1);return}if(currentDisplayedCount%3EMAX_CHANNEL_QUERY_LIMIT_PQ){displaySystemNotification_PQ(%60%E7%9B%AE%E5%89%8D%E9%A1%AF%E7%A4%BA%E7%AD%86%E6%95%B8(${currentDisplayedCount}%E7%AD%86)%E8%B6%85%E9%81%8E%E9%80%9A%E8%B7%AF%E6%9F%A5%E8%A9%A2%E4%B8%8A%E9%99%90(${MAX_CHANNEL_QUERY_LIMIT_PQ}%E7%AD%86)%EF%BC%8C%E7%84%A1%E6%B3%95%E4%B8%80%E6%AC%A1%E6%9F%A5%E8%A9%A2%E6%89%80%E6%9C%89%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85%EF%BC%8C%E8%AB%8B%E5%85%88%E7%B8%AE%E5%B0%8F%E6%9F%A5%E8%A9%A2%E7%AF%84%E5%9C%8D%E3%80%82%60,!0,5000);return}displaySystemNotification_PQ(%60%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%20${currentDisplayedCount}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,0);let%20successCount=0;for(let%20i=0;i%3CitemsForDetailProcessing.length;i++){const%20seqCell=mainUIDiv.querySelector(%60.pcr-seq-cell[data-item-index-in-rendered-list=%22${i}%22]%60);if(seqCell){const%20originalIdx=parseInt(seqCell.dataset.originalSequentialIndex);const%20masterProductItem=productQueryResults_PQ.find(p=%3Ep._originalSequentialIndex===originalIdx);if(masterProductItem&&!masterProductItem._detailsFetched&&!masterProductItem._isErrorRow){await%20handleSeqCellClick_PQ(seqCell);successCount++}}else{console.warn(%22Could%20not%20find%20seqCell%20for%20item%20at%20rendered%20index:%20%22+i,itemsForDetailProcessing[i])}}const%20currentDetailProcessingToast=document.getElementById('pqToolNotification_S_v2');if(currentDetailProcessingToast&&currentDetailProcessingToast.innerText.startsWith(%22%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%22)){currentDetailProcessingToast.remove()}if(successCount%3E0){displaySystemNotification_PQ(%60%E6%9C%AC%E6%89%B9%20${successCount}%20%E7%AD%86%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E5%B7%B2%E6%9B%B4%E6%96%B0%E3%80%82%60,!1,2000)}else{displaySystemNotification_PQ(%22%E6%9C%AC%E6%89%B9%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E4%BB%BB%E4%BD%95%E6%9B%B4%E6%96%B0%E9%A0%85%E7%9B%AE%E3%80%82%22,!1,2000)}}async%20function%20handleOnePageDisplay_PQ(){if(!currentQueryParameters_PQ){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E5%8F%AF%E7%94%A8%E7%9A%84%E6%9F%A5%E8%A9%A2%E5%8F%83%E6%95%B8%E3%80%82%22,!0);return}const%20newParams={...currentQueryParameters_PQ};newParams.pageSize=totalRecords_PQ;displaySystemNotification_PQ(%60%E6%AD%A3%E5%9C%A8%E8%BC%89%E5%85%A5%E6%89%80%E6%9C%89%20${totalRecords_PQ}%20%E7%AD%86%E8%B3%87%E6%96%99%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...%60,!1,0);await%20fetchProductListPage_PQ(!0)}function%20handleReload_PQ(){displaySystemNotification_PQ(%22%E6%BA%96%E5%82%99%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2...%22,!1,1000);handleCloseMainUI_PQ(!1);document.removeEventListener('keydown',mainUIEscListener_PQ);document.getElementById('pqEnvSelect_S_v2_overlay_pq')?.remove();document.getElementById('pqEnvSelect_S_v2_dialog_pq')?.remove();document.getElementById('pqToken_S_v2_overlay_pq')?.remove();document.getElementById('pqToken_S_v2_dialog_pq')?.remove();document.getElementById('pqQuerySetup_S_v2_overlay_pq')?.remove();document.getElementById('pqQuerySetup_S_v2_dialog_pq')?.remove();document.getElementById('pqToolNotification_S_v2')?.remove();setTimeout(async()=%3E{const%20authResult=await%20executeAuthenticationFlow();if(authResult.success){await%20startQueryProcess()}else{displaySystemNotification_PQ(%22%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%E6%B5%81%E7%A8%8B%E4%B8%AD%E6%AD%A2%E3%80%82%22,!0)}},50)}function%20handleCloseMainUI_PQ(removeEscListener=!0){document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();if(removeEscListener){document.removeEventListener('keydown',mainUIEscListener_PQ)}}async%20function%20fetchProductListPage_PQ(isOnePageDisplay=!1){productQueryResults_PQ=[];let%20queryPayload={...currentQueryParameters_PQ,pageNo:1};if(isOnePageDisplay){queryPayload.pageSize=maxProductListPageSize_PQ}else{if(currentQueryParameters_PQ.queryMode==='allPlans'||currentQueryParameters_PQ.queryMode==='inSaleWithDetails'){queryPayload.pageSize=maxProductListPageSize_PQ}else{queryPayload.pageSize=100}currentQueryParameters_PQ.pageSize=queryPayload.pageSize}if(queryPayload.codes!==undefined&&queryPayload.codes!==null){delete%20queryPayload.planCodeName}else%20if(queryPayload.planCodeName!==undefined&&queryPayload.planCodeName!==null){delete%20queryPayload.codes}let%20loadingMessage=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD%EF%BC%8C%E7%AD%86%E6%95%B8%E8%BC%83%E5%A4%9A%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E8%BC%83%E9%95%B7%E6%99%82%E9%96%93%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...%60;displaySystemNotification_PQ(loadingMessage,!1,0);const%20apiResponse=await%20callProductApi_PQ(apiAuthToken_PQ,queryPayload,'planCodeQuery');const%20loadingToast=document.getElementById('pqToolNotification_S_v2');if(loadingToast&&loadingToast.innerText===loadingMessage){loadingToast.remove()}if(apiResponse&&apiResponse.error==='TOKEN_INVALID'){if(tokenStatus_PQ===%22skipped_by_user%22&&apiAuthToken_PQ===null){displaySystemNotification_PQ(%22%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97%EF%BC%9ATOKEN%20%E6%9C%AA%E6%8F%90%E4%BE%9B%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}apiAuthToken_PQ=null;localStorage.removeItem(TOKEN_STORAGE_KEY_PQ);localStorage.removeItem(TOKEN_STORAGE_KEY_PQ_FALLBACK);displaySystemNotification_PQ(%22TOKEN%20%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%22,!0,0);const%20newToken=await%20solicitNewToken_PQ();if(newToken===null){tokenStatus_PQ=%22failed_solicitation%22}else%20if(newToken==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E5%86%8D%E6%AC%A1%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1);displaySystemNotification_PQ(%22TOKEN%E7%8B%80%E6%85%8B%E5%B7%B2%E8%AE%8A%E6%9B%B4%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E6%93%8D%E4%BD%9C%E3%80%82%22,!1,3000)}else{apiAuthToken_PQ=newToken;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ(%22%E6%96%B0%20TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E3%80%82%22,!1,3000)}productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}else%20if(apiResponse&&apiResponse.error){displaySystemNotification_PQ(apiResponse.message||%22%E6%9F%A5%E8%A9%A2%E6%99%82%E7%99%BC%E7%94%9F%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}if(apiResponse&&apiResponse.records){totalRecords_PQ=apiResponse.totalRecords||apiResponse.records.length;productQueryResults_PQ=apiResponse.records.map((rec,idx)=%3EtransformProductData_PQ(rec,idx))}else{totalRecords_PQ=0;productQueryResults_PQ=[]}renderMainResultsUI_PQ();if(totalRecords_PQ===0){displaySystemNotification_PQ(%22%E6%9F%A5%E7%84%A1%E7%AC%A6%E5%90%88%E5%95%86%E5%93%81%E3%80%82%22,!1,3000)}else{displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%20${totalRecords_PQ}%20%E7%AD%86%E3%80%82%60,!1,2500)}if(autoFetchDetailsAfterLoad_PQ&&productQueryResults_PQ.length%3E0){autoFetchDetailsAfterLoad_PQ=!1;displaySystemNotification_PQ(%60%E6%AD%A3%E5%9C%A8%E8%87%AA%E5%8B%95%E7%8D%B2%E5%8F%96%E6%9C%AC%E9%A0%81%20${productQueryResults_PQ.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99...%60,!1,0);await%20handleQueryAllData_PQ();const%20autoToast=document.getElementById('pqToolNotification_S_v2');if(autoToast&&autoToast.innerText.includes(%22%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%22)){autoToast.remove()}displaySystemNotification_PQ(%22%E6%9C%AC%E9%A0%81%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%E5%B7%B2%E8%BC%89%E5%85%A5%E3%80%82%22,!1,2500)}}async%20function%20processQuerySetupAndExecute_PQ(querySetupResult){autoFetchDetailsAfterLoad_PQ=!1;currentSortKey_PQ=null;currentSortDirection_PQ='none';let%20baseParams={pageNo:1,showAllOnOnePage:!0,queryMode:querySetupResult.queryMode};if(querySetupResult.queryMode==='planCode'){const%20planCodes=querySetupResult.inputValue.split(/[\s,;]+/).map(c=%3Ec.trim().toUpperCase()).filter(Boolean).map(c=%3Ec.slice(0,4));if(planCodes.length===0){displaySystemNotification_PQ(%22%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%81%22,!0);return}currentQueryParameters_PQ={...baseParams,codes:planCodes}}else%20if(querySetupResult.queryMode==='planCodeName'){const%20k=querySetupResult.inputValue.trim().split(/[\s,;]+/)[0];if(!k){displaySystemNotification_PQ(%22%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81%22,!0);return}currentQueryParameters_PQ={...baseParams,planCodeName:k,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='allPlans'){currentQueryParameters_PQ={...baseParams,planCodeName:%22%22,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='inSaleWithDetails'){currentQueryParameters_PQ={...baseParams,saleEndDate:%229999-12-31%2000:00:00%22,planCodeName:%22%22,orderBy:%22planCode%20asc%22};autoFetchDetailsAfterLoad_PQ=!0}else{displaySystemNotification_PQ(%22%E6%9C%AA%E7%9F%A5%E7%9A%84%E6%9F%A5%E8%A9%A2%E6%A8%A1%E5%BC%8F%E6%88%96%E5%8A%9F%E8%83%BD%E5%BE%85%E5%AE%9A%E7%BE%A9%E3%80%82%22,!0);return}await%20fetchProductListPage_PQ()}async%20function%20solicitNewToken_PQ(attempt=1){const%20tokenResult=await%20createTokenDialog_PQ(attempt);if(tokenResult==='_close_tool_pq_'){displaySystemNotification_PQ('%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%97%9C%E9%96%89',!0);return%20null}if(tokenResult==='_token_dialog_cancel_pq_'){displaySystemNotification_PQ('Token%20%E8%BC%B8%E5%85%A5%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return%20null}if(tokenResult==='_skip_token_pq_'){return'_skip_token_pq_'}const%20trimmedToken=normalizeInput_PQ(tokenResult||%22%22);if(trimmedToken){return%20trimmedToken}else{displaySystemNotification_PQ('TOKEN%20%E6%9C%AA%E8%BC%B8%E5%85%A5%E3%80%82',!0);if(attempt%3C3){return%20await%20solicitNewToken_PQ(attempt+1)}else{displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E8%BC%B8%E5%85%A5%E7%84%A1%E6%95%88%E3%80%82',!0);return%20null}}}const%20mainUIEscListener_PQ=(e)=%3E{if(e.key===%22Escape%22&&!document.querySelector('[id$=%22_overlay_pq%22]')){handleCloseMainUI_PQ()}};async%20function%20executeProductQueryTool(){handleCloseMainUI_PQ();currentSortKey_PQ=null;currentSortDirection_PQ='none';const%20selectedEnv=await%20createEnvSelectionDialog_PQ();if(!selectedEnv){displaySystemNotification_PQ('%E7%92%B0%E5%A2%83%E9%81%B8%E6%93%87%E5%B7%B2%E5%8F%96%E6%B6%88',!0);tokenStatus_PQ=%22initial%22;return}currentApiUrls_PQ=API_URL_TEMPLATES_PQ[selectedEnv];displaySystemNotification_PQ(%60%E7%92%B0%E5%A2%83%E5%B7%B2%E8%A8%AD%E7%82%BA:%20${selectedEnv.toUpperCase()}%60,!1,1500);apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ);if(!apiAuthToken_PQ){apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ_FALLBACK)}if(!apiAuthToken_PQ){const%20newToken=await%20solicitNewToken_PQ();if(newToken===null){tokenStatus_PQ=%22failed_solicitation%22;return}else%20if(newToken==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1,2000)}else{apiAuthToken_PQ=newToken;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ('TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%E3%80%82',!1,1500)}}else{const%20isValid=await%20checkTokenValidity_PQ(apiAuthToken_PQ);if(!isValid){displaySystemNotification_PQ(%22%E6%9C%AC%E5%9C%B0%E5%84%B2%E5%AD%98%E7%9A%84%20TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%22,!0,0);localStorage.removeItem(TOKEN_STORAGE_KEY_PQ);localStorage.removeItem(TOKEN_STORAGE_KEY_PQ_FALLBACK);const%20newToken=await%20solicitNewToken_PQ();if(newToken===null){tokenStatus_PQ=%22failed_solicitation%22;return}else%20if(newToken==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1,2000)}else{apiAuthToken_PQ=newToken;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ('%E6%96%B0%20TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%E3%80%82',!1,1500)}}else{tokenStatus_PQ=%22valid%22;displaySystemNotification_PQ('%E5%B7%B2%E5%BE%9E%E6%9C%AC%E5%9C%B0%E8%BC%89%E5%85%A5%20TOKEN%E3%80%82',!1,1500)}}const%20querySetupResult=await%20createQuerySetupDialog_PQ();if(!querySetupResult){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E8%A8%AD%E5%AE%9A%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}await%20processQuerySetupAndExecute_PQ(querySetupResult)}try{document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();document.getElementById(%22pcrBookMarkletDivV17%22)?.remove();document.getElementById(%22pcrBookMarkletCssV17%22)?.remove();document.getElementById('pqToolNotification_S_v2')?.remove();document.getElementById('qt-dialog_EnvSelect')?.remove();document.getElementById('qt-overlay_EnvSelect')?.remove();document.getElementById('qt-dialog_GenericInput')?.remove();document.getElementById('qt-overlay_GenericInput')?.remove();document.getElementById('pqEnvSelect_S_v2_overlay_pq')?.remove();document.getElementById('pqToken_S_v2_overlay_pq')?.remove();document.getElementById('pqQuerySetup_S_v2_overlay_pq')?.remove();document.removeEventListener('keydown',mainUIEscListener_PQ);document.addEventListener('keydown',mainUIEscListener_PQ);await%20executeProductQueryTool()}catch(err){console.error(%22%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E8%85%B3%E6%9C%AC%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:%22,err);displaySystemNotification_PQ(%22%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E8%85%B3%E6%9C%AC%E5%9F%B7%E8%A1%8C%E6%99%82%E7%99%BC%E7%94%9F%E5%9A%B4%E9%87%8D%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%A9%B3%E8%A6%8B%E6%8E%A7%E5%88%B6%E5%8F%B0%E3%80%82\n%22+(err.message||err),!0,0)}})()

javascript:(async()=>{const API_URL="https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query";let token=localStorage.getItem("euisPlanCodeToken")||localStorage.getItem("euisToken");async function validateToken(token){try{const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json","SSO-TOKEN":token},body:JSON.stringify({planCodeName:""})});return res.ok}catch{return false}}async function getValidToken(){if(token&&await validateToken(token))return token;while(true){token=prompt("%E8%AB%8B%E8%BC%B8%E5%85%A5 TOKEN");if(!token)return null;if(await validateToken(token)){localStorage.setItem("euisPlanCodeToken",token);return token}alert("TOKEN %E7%84%A1%E6%95%88%EF%BC%81")}}token=await getValidToken();if(!token)return;const input=prompt("%E8%BC%B8%E5%85%A5 PlanCode%EF%BC%88%E5%A4%9A%E7%AD%86%E8%AB%8B%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94%EF%BC%89");if(!input)return;const isAll=input.trim().toUpperCase()==="ALL";const planCodes=isAll?[]:[...new%20Set(input.toUpperCase().split(/[\s,;]+/).filter(Boolean))];const%20formatDate=date=%3Edate?date.replace(/[^0-9]/g,%22%22).slice(0,8):%22%22;async%20function%20fetchPlanCodes(params){try{const%20res=await%20fetch(API_URL,{method:%22POST%22,headers:{%22Content-Type%22:%22application/json%22,%22SSO-TOKEN%22:token},body:JSON.stringify(params)});return%20await%20res.json()}catch{return%20null}}function%20transformItem(item,code=null){return{planCode:code||item.planCode,planCodeName:item.planCodeName||%22%22,currency:{1:%22TWD%22,2:%22USD%22,3:%22AUD%22,4:%22CNT%22}[item.currency]||%22%E6%9C%AA%E7%9F%A5%22,unit:{A1:%22%E5%85%83%22,A3:%22%E5%8D%83%E5%85%83%22,A4:%22%E8%90%AC%E5%85%83%22}[item.reportInsuranceAmountUnit?.toUpperCase()]||%22%E6%9C%AA%E7%9F%A5%22,type:{M:%22%E4%B8%BB%E7%B4%84%22,R:%22%E9%99%84%E7%B4%84%22}[item.coverageType]||%22%E6%9C%AA%E7%9F%A5%22,start:formatDate(item.saleStartDate),end:formatDate(item.saleEndDate)}}let%20results=[];if(isAll){const%20data=await%20fetchPlanCodes({planCodeName:%22%22});if(data?.records)results=data.records.map(item=%3EtransformItem(item))}else{for(const%20code%20of%20planCodes){const%20data=await%20fetchPlanCodes({planCode:code});if(data?.records?.[0]){results.push(transformItem(data.records[0],code))}else{results.push({planCode:code,planCodeName:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,currency:%22%22,unit:%22%22,type:%22%22,start:%22%22,end:%22%22})}}}const%20oldResult=document.getElementById(%22planCodeResult%22);if(oldResult)oldResult.remove();const%20resultDiv=document.createElement(%22div%22);resultDiv.id=%22planCodeResult%22;resultDiv.style=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#fefefe;padding:10px%2015px;box-shadow:0%200%2010px%20rgba(0,0,0,0.2);z-index:9999;max-height:80vh;overflow:auto;font-family:sans-serif;border-radius:8px;width:90%;max-width:800px;font-size:16px;%60;const%20truncateName=name=%3Ename&&name.length%3E25?%60${name.slice(0,25)}...%60:name;const%20tableRows=results.map(item=%3E%60%3Ctr%3E%3Ctd%20data-copy=%22${item.planCode}%22%20style=%22padding:6px%208px;%22%3E${item.planCode}%3C/td%3E%3Ctd%20data-copy=%22${item.planCodeName}%22%20style=%22padding:6px%208px;%22%20title=%22${item.planCodeName}%22%3E${truncateName(item.planCodeName)}%3C/td%3E%3Ctd%20style=%22padding:6px%208px;%22%3E${item.currency}%3C/td%3E%3Ctd%20style=%22padding:6px%208px;%22%3E${item.unit}%3C/td%3E%3Ctd%20style=%22padding:6px%208px;%22%3E${item.type}%3C/td%3E%3Ctd%20data-copy=%22${item.start}%22%20style=%22padding:6px%208px;%22%3E${item.start}%3C/td%3E%3Ctd%20data-copy=%22${item.end}%22%20style=%22padding:6px%208px;%22%3E${item.end}%3C/td%3E%3C/tr%3E%60).join(%22%22);resultDiv.innerHTML=%60%3Cdiv%20style=%22text-align:right;margin-bottom:8px;%22%3E%3Cbutton%20style=%22background:#e74c3c;color:white;border:none;padding:5px%2010px;border-radius:4px;cursor:pointer;%22%20onclick=%22this.parentNode.parentNode.remove()%22%3E%E9%97%9C%E9%96%89%3C/button%3E%3C/div%3E%3Ctable%20border=%221%22%20style=%22border-collapse:collapse;width:100%;font-size:15px;%22%3E%3Cthead%20style=%22background:#3498db;color:white;%22%3E%3Ctr%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E4%BB%A3%E8%99%9F%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E5%B9%A3%E5%88%A5%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E5%96%AE%E4%BD%8D%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E9%9A%AA%E5%88%A5%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E9%8A%B7%E5%94%AE%E6%97%A5%3C/th%3E%3Cth%20style=%22padding:8px%2010px;%22%3E%E5%81%9C%E5%94%AE%E6%97%A5%3C/th%3E%3C/tr%3E%3C/thead%3E%3Ctbody%3E${tableRows}%3C/tbody%3E%3C/table%3E%60;resultDiv.querySelectorAll(%22td[data-copy]%22).forEach(td=%3E{td.style.cursor=%22pointer%22;td.onclick=()=%3E{navigator.clipboard.writeText(td.getAttribute(%22data-copy%22));const%20msg=document.createElement(%22div%22);msg.textContent=%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22;msg.style=%22position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:5px%2010px;border-radius:4px;z-index:10000;%22;document.body.appendChild(msg);setTimeout(()=%3Emsg.remove(),1000)}});document.body.appendChild(resultDiv);document.addEventListener(%22keydown%22,e=%3E{if(e.key===%22Escape%22&&resultDiv)resultDiv.remove()})})()

javascript:(async()=>{const API_URL_TEMPLATES_PQ={uat:{planCodeQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'},prod:{planCodeQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'}};const TOKEN_STORAGE_KEY_PQ='euisPlanCodeToken_v2';const TOKEN_STORAGE_KEY_PQ_FALLBACK='euisToken';const MAIN_UI_ID_PQ='productQueryBookmarkletDiv_Structured_v2';const CSS_ID_PQ='productQueryBookmarkletCss_Structured_v2';const Z_INDEX_OVERLAY_PQ=2147483640;const Z_INDEX_DIALOG_PQ=2147483641;const Z_INDEX_MAIN_UI_PQ=2147483630;const Z_INDEX_NOTIFICATION_PQ=2147483647;const PRODUCT_FIELD_DEFINITIONS_PQ={CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}};const maxProductListPageSize_PQ=5000;let currentApiUrls_PQ={};let apiAuthToken_PQ=null;let tokenStatus_PQ="initial";let productQueryResults_PQ=[];let totalRecords_PQ=0;let currentQueryParameters_PQ={};let currentSortKey_PQ=null;let currentSortDirection_PQ='none';let autoFetchDetailsAfterLoad_PQ=!1;let mainUIDraggableState_PQ={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};function escapeHtml_PQ(unsafe){if(typeof unsafe!=='string')return unsafe===null||unsafe===undefined?%27%27:String(unsafe);return%20unsafe.replace(/[&%3C%3E%22%27]/g,m=%3E({%27&%27:%27&%27,%27%3C%27:%27%3C%27,%27%3E%27:%27%3E%27,%27%22%27:%27%22%27,%22%27%22:%27&#039;'})[m])}%20function%20displaySystemNotification_PQ(message,isError=!1,duration=2000){const%20notificationId='pqToolNotification_S_v2';document.getElementById(notificationId)?.remove();const%20notification=document.createElement('div');notification.id=notificationId;notification.className='pcr-toast';notification.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20position:%20fixed;%20top:%2020px;%20left:%2050%;%20transform:%20translateX(-50%);%20%20%20%20%20%20%20%20%20%20%20%20%20background:%20${isError%20?%20'rgba(220,%2053,%2069,%200.9)'%20:%20'rgba(0,%20123,%20255,%200.9)'};%20color:%20#fff;%20%20%20%20%20%20%20%20%20%20%20%20%20padding:%205px%2012px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20%20%20%20%20%20%20%20z-index:%20${Z_INDEX_NOTIFICATION_PQ};%20display:%20inline-block;%20width:%20auto;%20%20%20%20%20%20%20%20%20%20%20%20%20box-shadow:%200%202px%208px%20rgba(0,0,0,.15);%20%20%20%20%20%20%20%20%20%20%20%20%20opacity:%201;%20transition:%20opacity%200.5s%20ease-out%20${Math.max(0,%20duration%20-%20500)}ms;%20%20%20%20%20%20%20%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20text-align:%20center;%20%20%20%20%20%20%20%20%20%60;notification.innerText=message;document.body.appendChild(notification);if(duration%3E0){setTimeout(()=%3E{notification.style.opacity='0';setTimeout(()=%3Enotification.remove(),500)},duration)}}%20function%20createDialogBase_PQ(id,contentHtml,minWidth='300px',maxWidth='500px',customStyles=''){document.getElementById(id+'_overlay_pq')?.remove();const%20overlay=document.createElement('div');overlay.id=id+'_overlay_pq';overlay.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%;%20height:%20100%;%20%20%20%20%20%20%20%20%20%20%20%20%20background:%20rgba(0,0,0,0.6);%20z-index:%20${Z_INDEX_OVERLAY_PQ};%20%20%20%20%20%20%20%20%20%20%20%20%20display:%20flex;%20align-items:%20center;%20justify-content:%20center;%20%20%20%20%20%20%20%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20%20%20%20%20%20%20%20%20%20%20%20%20backdrop-filter:%20blur(2px);%20%20%20%20%20%20%20%20%20%60;const%20dialog=document.createElement('div');dialog.id=id+'_dialog_pq';dialog.style.cssText=%60%20%20%20%20%20%20%20%20%20%20%20%20%20background:%20#fff;%20padding:%2020px%2025px;%20border-radius:%208px;%20%20%20%20%20%20%20%20%20%20%20%20%20box-shadow:%200%205px%2020px%20rgba(0,0,0,0.25);%20%20%20%20%20%20%20%20%20%20%20%20%20min-width:%20${minWidth};%20max-width:%20${maxWidth};%20width:%20auto;%20%20%20%20%20%20%20%20%20%20%20%20%20animation:%20pqDialogAppear_S%200.2s%20ease-out;%20%20%20%20%20%20%20%20%20%20%20%20%20${customStyles}%20%20%20%20%20%20%20%20%20%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);document.body.appendChild(overlay);const%20styleEl=document.createElement('style');styleEl.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20%20@keyframes%20pqDialogAppear_S%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20from%20{%20opacity:%200;%20transform:%20scale(0.95)%20translateY(-10px);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%20{%20opacity:%201;%20transform:%20scale(1)%20translateY(0);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border:%20none;%20padding:%208px%2015px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cursor:%20pointer;%20transition:%20opacity%200.2s%20ease,%20transform%200.1s%20ease;%20font-weight:%20500;%20margin-left:%208px;%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn:hover%20{%20opacity:%200.85;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn:active%20{%20transform:%20scale(0.98);%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-blue%20{%20background:%20#007bff;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-orange%20{%20background:%20#fd7e14;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-green%20{%20background:%20#28a745;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-grey%20{%20background:%20#6c757d;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-btn-red%20{%20background:%20#dc3545;%20color:%20white;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-title%20{%20margin:%200%200%2018px%200;%20color:%20#333;%20font-size:%2018px;%20text-align:%20center;%20font-weight:%20600;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-input,%20.pq-textarea%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20width:%20calc(100%%20-%2018px);%20padding:%209px;%20border:%201px%20solid%20#ccc;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20border-radius:%204px;%20font-size:%2013px;%20margin-bottom:%2012px;%20box-sizing:%20border-box;%20color:%20#333;%20%20%20%20%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-textarea%20{%20min-height:%2070px;%20resize:%20vertical;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-dialog-flex-end%20{%20display:%20flex;%20justify-content:%20flex-end;%20margin-top:%2020px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20{%20margin-bottom:%2012px;%20text-align:%20left;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20label%20{%20margin-right:%2015px;%20font-size:%2014px;%20cursor:pointer;%20display:%20block;%20margin-bottom:%208px;%20}%20%20%20%20%20%20%20%20%20%20%20%20%20.pq-radio-group%20input[type=%22radio%22]%20{%20margin-right:%206px;%20vertical-align:%20middle;%20}%20%20%20%20%20%20%20%20%20%60;dialog.appendChild(styleEl);return{overlay,dialog}}%20function%20normalizeInput_PQ(str){if(typeof%20str!=='string')return%20str;return%20str.replace(/[\uff01-\uff5e]/g,s=%3EString.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g,%22%20%22).trim()}%20function%20formatDateForQuery_PQ(dateStr){if(!dateStr)return%22%22;try{return%20dateStr.substring(0,10).replace(/-/g,%22%22)}catch(t){console.warn(%22Error%20formatting%20date:%22,dateStr,t);return%22%22}}%20function%20getTodayDateString_PQ(){let%20e=new%20Date(),t=e.getFullYear(),r=(e.getMonth()+1).toString().padStart(2,%220%22),l=e.getDate().toString().padStart(2,%220%22);return%20%60${t}${r}${l}%60}%20function%20createEnvSelectionDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style=%22display:flex;%20gap:10px;%20justify-content:center;%20margin-bottom:20px;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-uat%22%20class=%22pq-dialog-btn%20pq-dialog-btn-green%22%20style=%22flex-grow:1;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-prod%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22flex-grow:1;%20background-color:#ffc107;%20color:#212529;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style=%22text-align:center;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay}=createDialogBase_PQ('pqEnvSelect_S_v2',contentHtml,'320px');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#pq-env-uat').onclick=()=%3EcloseDialog('uat');overlay.querySelector('#pq-env-prod').onclick=()=%3EcloseDialog('prod');overlay.querySelector('#pq-env-cancel').onclick=()=%3EcloseDialog(null)})}%20function%20createTokenDialog_PQ(attempt=1){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cinput%20type=%22password%22%20id=%22pq-token-input%22%20class=%22pq-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%20autocomplete=%22current-password%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20${attempt%20%3E%201%20?%20%60%3Cp%20style=%22color:red;%20font-size:12px;%20text-align:center;%20margin-bottom:10px;%22%3ETOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%3C/p%3E%60%20:%20''}%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-skip%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22margin-right:auto;%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-close-tool%22%20class=%22pq-dialog-btn%20pq-dialog-btn-red%22%3E%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E${attempt%20%3E%201%20?%20'%E9%87%8D%E8%A9%A6'%20:%20'%E7%A2%BA%E5%AE%9A'}%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay,dialog}=createDialogBase_PQ('pqToken_S_v2',contentHtml,'390px');const%20inputEl=dialog.querySelector('#pq-token-input');inputEl.focus();if(attempt%3E2){dialog.querySelector('#pq-token-ok').disabled=!0;dialog.querySelector('#pq-token-ok').style.opacity='0.5';dialog.querySelector('#pq-token-ok').style.cursor='not-allowed';displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E5%98%97%E8%A9%A6%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E7%A2%BA%E8%AA%8D%20TOKEN%E3%80%81%E9%81%B8%E6%93%87%E7%95%A5%E9%81%8E%E6%88%96%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%E3%80%82',!0,4000)}%20const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog('_token_dialog_cancel_pq_');};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-token-ok').onclick=()=%3EcloseDialog(inputEl.value.trim());dialog.querySelector('#pq-token-close-tool').onclick=()=%3EcloseDialog('_close_tool_pq_');dialog.querySelector('#pq-token-skip').onclick=()=%3EcloseDialog('_skip_token_pq_')})}%20function%20createQuerySetupDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-radio-group%22%20style=%22margin-bottom:%2010px;%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCode%22%20checked%3E%20%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCodeName%22%3E%20%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22allPlans%22%3E%20%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22inSaleWithDetails%22%3E%20%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%20(%E5%90%AB%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85)%3C/label%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctextarea%20id=%22pq-queryvalues-input%22%20class=%22pq-textarea%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94%22%3E%3C/textarea%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay,dialog}=createDialogBase_PQ('pqQuerySetup_S_v2',contentHtml,'520px');const%20queryValuesInput=dialog.querySelector('#pq-queryvalues-input');const%20radioButtons=dialog.querySelectorAll('input[name=%22pq-query-type%22]');function%20updateInputState(){const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;const%20disableInputModes=['allPlans','inSaleWithDetails'];if(disableInputModes.includes(selectedType)){queryValuesInput.placeholder='%E7%84%A1%E9%9C%80%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6';queryValuesInput.value='';queryValuesInput.disabled=!0}else%20if(selectedType==='planCode'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94';queryValuesInput.disabled=!1}else%20if(selectedType==='planCodeName'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%96%AE%E4%B8%80%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97';queryValuesInput.disabled=!1}}%20radioButtons.forEach(radio=%3Eradio.onchange=updateInputState);updateInputState();const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-querysetup-ok').onclick=()=%3E{const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;let%20inputValue=queryValuesInput.value.trim();const%20requiresInputModes=['planCode','planCodeName'];if(requiresInputModes.includes(selectedType)&&!inputValue){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81',!0);queryValuesInput.focus();return}%20if(selectedType==='planCodeName'&&inputValue.split(/[\s,;]+/).filter(Boolean).length%3E1){displaySystemNotification_PQ('%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E6%9F%A5%E8%A9%A2%E5%83%85%E6%94%AF%E6%8F%B4%E5%96%AE%E4%B8%80%E9%97%9C%E9%8D%B5%E5%AD%97%E3%80%82',!0);queryValuesInput.focus();return}%20closeDialog({queryMode:selectedType,inputValue:inputValue,showAllOnOnePage:!0})};dialog.querySelector('#pq-querysetup-cancel').onclick=()=%3EcloseDialog(null)})}%20async%20function%20callProductApi_PQ(token,payload,apiUrl){try{const%20headers={'Content-Type':'application/json'};if(token){headers['SSO-TOKEN']=token}%20const%20response=await%20fetch(apiUrl,{method:'POST',headers:headers,body:JSON.stringify(payload)});if(response.status===401)return{error:'TOKEN_INVALID',data:null,message:%22TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%E3%80%82%22};if(!response.ok){const%20errorText=await%20response.text();const%20specificErrorMsg=%60%20(${response.statusText%20||%20errorText%20||%20'%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4'})%60;return{error:%60API_ERROR_${response.status}%60,data:null,message:%60%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}${specificErrorMsg}%60}}%20return%20await%20response.json()}catch(error){return{error:'NETWORK_ERROR',data:null,message:%22%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E9%8C%AF%E8%AA%A4%E6%88%96API%E7%84%A1%E5%9B%9E%E6%87%89%E3%80%82%22}}}%20function%20transformProductData_PQ(apiRecord,indexInOriginalFetch){const%20saleStartDate=apiRecord.saleStartDate||%22%22;const%20saleEndDate=apiRecord.saleEndDate||%22%22;const%20formattedStartDate=formatDateForQuery_PQ(saleStartDate);const%20formattedEndDate=formatDateForQuery_PQ(saleEndDate);let%20isStillSelling=!1;if(formattedEndDate){isStillSelling=formattedEndDate===%2299991231%22||formattedEndDate%3E=getTodayDateString_PQ()}%20let%20endDateDisplay=%22-%22;if(apiRecord._isErrorRow){endDateDisplay=%60%3Cspan%20style=%22color:red;%22%3E${apiRecord.name%20||%20'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97'}%3C/span%3E%60}else%20if(formattedEndDate){endDateDisplay=isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E${formattedEndDate}%3C/span%3E%60}%20return{_originalSequentialIndex:indexInOriginalFetch,code:apiRecord.planCode,name:(apiRecord.shortName||(apiRecord._isErrorRow?%22%22:%22N/A%22)).trim(),full:(apiRecord.planCodeName||(apiRecord._isErrorRow?apiRecord.name:%22N/A%22)).trim(),cur:PRODUCT_FIELD_DEFINITIONS_PQ.CUR[apiRecord.currency]||%22-%22,unit:PRODUCT_FIELD_DEFINITIONS_PQ.UNIT[(apiRecord.reportInsuranceAmountUnit||apiRecord.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:PRODUCT_FIELD_DEFINITIONS_PQ.TYPE[apiRecord.coverageType]||%22-%22,start:formattedStartDate||%22-%22,end:formattedEndDate,isStillSelling:isStillSelling,originalEndDisplay:endDateDisplay,_isErrorRow:apiRecord._isErrorRow||!1,_detailsFetched:!1,polplnEnrichedCodeForCopy:null,channelEnrichedEndDateForCopy:null,polplnDisplayText:null,channelDisplayHtml:null,applyYellowBgForDisplay:!1}}%20function%20extractPolpln_PQ(polplnString){if(!polplnString||typeof%20polplnString!=='string')return%22%22;let%20t=polplnString.trim();if(t.endsWith(%22%%%22))t=t.substring(0,t.length-2);return%20t.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim()||%22%22}%20function%20processMultiplePolpln_PQ(polplnRecords){if(!polplnRecords||polplnRecords.length===0)return%22-%22;if(polplnRecords.length===1)return%20extractPolpln_PQ(polplnRecords[0])||%22-%22;const%20extractedPolplns=polplnRecords.map(r=%3EextractPolpln_PQ(r)).filter(p=%3Ep!==%22%22);if(extractedPolplns.length===0)return%22-%22;const%20firstPolpln=extractedPolplns[0];return%20extractedPolplns.every(p=%3Ep===firstPolpln)?firstPolpln:%22-%22}%20function%20formatChannelSalesInfo_PQ(saleDateApiResponse,planCode,baseEndDisplay,isBaseStillSelling){const%20todayStr=getTodayDateString_PQ();let%20channelDetailsHtml=%22%22;let%20copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();let%20hasActiveChannel=!1;let%20hasAnyChannelInfo=!1;if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length%3E0){hasAnyChannelInfo=!0;const%20channelRecords=saleDateApiResponse.planCodeSaleDates.records.filter(rec=%3Erec.planCode===planCode&&rec.channel&&rec.saleEndDate).map(rec=%3E{const%20channelEndDate=formatDateForQuery_PQ(rec.saleEndDate);const%20channelStartDate=formatDateForQuery_PQ(rec.saleStartDate);const%20isChannelSelling=channelEndDate===%2299991231%22||channelEndDate%3E=todayStr;if(isChannelSelling)hasActiveChannel=!0;const%20titleText=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelStartDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelEndDate%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22%20:%20channelEndDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%60;let%20displayText,plainTextPart;if(isChannelSelling){displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:blue;%22%3E${escapeHtml_PQ(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%60}else{displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:red;%22%3E${escapeHtml_PQ(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%60}%20return{channel:rec.channel,text:displayText,isSelling:isChannelSelling,plainText:plainTextPart,startDate:channelStartDate,endDate:channelEndDate}}).sort((a,b)=%3E{if(a.isSelling!==b.isSelling)return%20a.isSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});const%20sellingChannels=channelRecords.filter(r=%3Er.isSelling);const%20stoppedChannels=channelRecords.filter(r=%3E!r.isSelling);let%20currentCopyTextParts=[];if(sellingChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.plainText).join(%22%E3%80%81%22)}%60)}%20if(stoppedChannels.length%3E0){let%20stoppedDisplayParts=stoppedChannels.map(r=%3Er.text);let%20stoppedCopyParts=stoppedChannels.map(r=%3Er.plainText);channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedDisplayParts.join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedCopyParts.join(%22%E3%80%81%22)}%60)}%20if(currentCopyTextParts.length%3E0){copyTextContent=currentCopyTextParts.join(%22\n%22)}else%20if(hasAnyChannelInfo){copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%3C/div%3E%60}else{copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}}else%20if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length===0){hasAnyChannelInfo=!0;copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%3C/div%3E%60}%20let%20finalHtml=baseEndDisplay;if(channelDetailsHtml){finalHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelDetailsHtml}%3C/div%3E%60}%20const%20applyYellowBg=!isBaseStillSelling&&hasActiveChannel;return{html:finalHtml,copyText:copyTextContent.trim(),applyYellowBg:applyYellowBg,hasChannelInfo:hasAnyChannelInfo}}%20function%20handleSortRequest_PQ(sortKey){if(currentSortKey_PQ===sortKey){currentSortDirection_PQ=currentSortDirection_PQ==='asc'?'desc':'asc'}else{currentSortKey_PQ=sortKey;currentSortDirection_PQ='asc'}%20sortProductResults_PQ();renderMainResultsUI_PQ();const%20headerText=document.querySelector(%60#${MAIN_UI_ID_PQ}%20th[data-sort-key=%22${sortKey}%22]%60)?.textContent?.replace(/[%E2%96%B2%E2%96%BC\s]*/g,'')||sortKey;displaySystemNotification_PQ(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerText}%E3%80%8D${currentSortDirection_PQ%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1,1500)}%20function%20sortProductResults_PQ(){if(!currentSortKey_PQ||currentSortDirection_PQ==='none'||!productQueryResults_PQ)return;productQueryResults_PQ.sort((a,b)=%3E{let%20valA=a[currentSortKey_PQ];let%20valB=b[currentSortKey_PQ];if(valA===null||valA===undefined)valA=%22%22;if(valB===null||valB===undefined)valB=%22%22;if(currentSortKey_PQ==='_originalSequentialIndex'){return%20currentSortDirection_PQ==='asc'?valA-valB:valB-valA}else%20if(currentSortKey_PQ==='start'||currentSortKey_PQ==='end'){return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB)):String(valB).localeCompare(String(valA))}else{return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB),'zh-Hant-TW',{sensitivity:'base',numeric:!0}):String(valB).localeCompare(String(valA),'zh-Hant-TW',{sensitivity:'base',numeric:!0})}})}%20function%20renderMainResultsUI_PQ(){document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();const%20styleEl=document.createElement(%22style%22);styleEl.id=CSS_ID_PQ;styleEl.textContent=%60%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20{position:fixed;z-index:${Z_INDEX_MAIN_UI_PQ};left:50%;top:20px;transform:translateX(-50%);background:#f8f9fa;border-radius:10px;box-shadow:0%206px%2024px%20rgba(0,0,0,.15);padding:18px;width:auto;min-width:750px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft%20JhengHei',%20Arial,%20sans-serif;font-size:13px;%20border:%201px%20solid%20#dee2e6;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar%20{padding:10px%2015px;background-color:#343a40;color:white;font-weight:bold;font-size:15px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;margin:-18px%20-18px%2012px%20-18px;%20display:%20flex;%20justify-content:%20space-between;%20align-items:%20center;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar-text%20{%20flex-grow:%201;%20text-align:%20center;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-window-close-btn%20{background:transparent;color:white;border:none;font-size:20px;cursor:pointer;padding:0%208px;%20line-height:%201;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-controls-header_pq%20{background:#fff;padding:10px;border:1px%20solid%20#ddd;%20border-radius:%206px;%20margin-bottom:12px;%20display:flex;justify-content:space-between;align-items:center;%20flex-wrap:%20wrap;%20gap:10px;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-summary-and-research_pq%20{display:flex;align-items:center;flex-grow:1;%20gap:15px;%20flex-wrap:wrap;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20{font-size:14px;font-weight:500;color:#212529;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20strong%20{color:#007bff;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20{display:flex;align-items:center;flex-wrap:nowrap;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button%20{border:none;padding:6px%2014px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;box-shadow:0%201px%203px%20rgba(0,0,0,.1);margin-left:8px;white-space:nowrap;%20transition:%20opacity%200.2s%20ease;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button:hover%20{opacity:.85}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-copy-all-btn%20{background:#28a745;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-query-data-btn%20{background:#17a2b8;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-reload-btn%20{background:#007bff;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-clear-results-btn%20{background:#6c757d;%20color:white;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-table-container_pq%20{flex-grow:1;%20overflow:auto;%20border:1px%20solid%20#ddd;%20border-radius:6px;%20background:white;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20{width:100%;border-collapse:collapse;font-size:12px;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20{position:sticky;top:0;z-index:2;background:#343a40;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th%20{background:#343a40;color:#fff;text-align:center;padding:8px%2010px;font-size:13px;%20border-bottom:%202px%20solid%20#454d55;%20border-right:%201px%20solid%20#454d55;%20white-space:nowrap;%20cursor:pointer;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th:last-child%20{border-right:none;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td,%20#${MAIN_UI_ID_PQ}%20th%20{padding:7px%2010px;text-align:center;border:1px%20solid%20#e9ecef;white-space:nowrap;vertical-align:middle}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tbody%20tr%20td:nth-child(3)%20{text-align:left;%20white-space:normal;%20min-width:150px;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:nth-child(even)%20td%20{background:#f8f9fa}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:hover%20td%20{background:#e9ecef;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%20{cursor:pointer;color:#0056b3;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell%20{color:#007bff;cursor:pointer;font-weight:bold;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell:hover%20{text-decoration:underline;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell[data-fetched=%22true%22]%20{color:#28a745;cursor:copy;font-weight:normal;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-saledate-cell%20{white-space:normal%20!important;vertical-align:top%20!important;min-width:200px;%20max-width:280px;%20text-align:left%20!important;}%20%20%20%20%20%20%20%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-error-row%20td%20{background-color:%20#ffebee%20!important;%20color:%20#c62828;}%20%20%20%20%20%20%20%20%20%60;document.head.appendChild(styleEl);const%20mainDiv=document.createElement(%22div%22);mainDiv.id=MAIN_UI_ID_PQ;const%20titleBar=document.createElement(%22div%22);titleBar.className=%22pcr-title-bar%22;const%20titleTextEl=document.createElement(%22span%22);titleTextEl.className=%22pcr-title-bar-text%22;titleTextEl.textContent=%22%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%20%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%22;const%20closeWindowBtn=document.createElement(%22button%22);closeWindowBtn.className=%22pcr-window-close-btn%22;closeWindowBtn.innerHTML=%22&#x2715;%22;closeWindowBtn.onclick=()=%3E{handleCloseMainUI_PQ()};titleBar.appendChild(titleTextEl);titleBar.appendChild(closeWindowBtn);mainDiv.appendChild(titleBar);const%20controlsHeader=document.createElement(%22div%22);controlsHeader.className=%22pcr-controls-header_pq%22;const%20summaryResearchDiv=document.createElement(%22div%22);summaryResearchDiv.className=%22pcr-summary-and-research_pq%22;const%20infoSummarySpan=document.createElement(%22span%22);infoSummarySpan.className=%22pcr-info-summary_pq%22;let%20summaryText=%60%E7%B8%BD%E5%85%B1%20%3Cstrong%3E${totalRecords_PQ}%3C/strong%3E%20%E7%AD%86%60;infoSummarySpan.innerHTML=summaryText;summaryResearchDiv.appendChild(infoSummarySpan);controlsHeader.appendChild(summaryResearchDiv);const%20buttonsGroupDiv=document.createElement(%22div%22);buttonsGroupDiv.className=%22pcr-buttons-group_pq%22;buttonsGroupDiv.innerHTML=%60%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-copy-all-btn%22%20id=%22pcr_copy_all_pq_s%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-query-data-btn%22%20id=%22pcr_query_data_pq_s%22%3E%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E8%B3%87%E6%96%99%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-reload-btn%22%20id=%22pcr_reload_pq_s%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cbutton%20class=%22pcr-clear-results-btn%22%20id=%22pcr_clear_results_pq_s%22%3E%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C%3C/button%3E%20%20%20%20%20%20%20%20%20%60;controlsHeader.appendChild(buttonsGroupDiv);mainDiv.appendChild(controlsHeader);const%20tableContainer=document.createElement(%22div%22);tableContainer.className=%22pcr-table-container_pq%22;const%20tableEl=document.createElement(%22table%22);const%20headers=[{key:'_originalSequentialIndex',display:'No'},{key:'code',display:'%E4%BB%A3%E8%99%9F'},{key:'name',display:'%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1'},{key:'cur',display:'%E5%B9%A3%E5%88%A5'},{key:'unit',display:'%E5%96%AE%E4%BD%8D'},{key:'type',display:'%E9%A1%9E%E5%9E%8B'},{key:'start',display:'%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5'},{key:'end',display:'%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5'}];let%20headerHtml='%3Ctr%3E';headers.forEach(h=%3E{let%20indicator='';if(h.key===currentSortKey_PQ){if(currentSortDirection_PQ==='asc')indicator='%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%B2%3C/span%3E';else%20if(currentSortDirection_PQ==='desc')indicator='%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%BC%3C/span%3E'}%20headerHtml+=%60%3Cth%20data-sort-key=%22${h.key}%22%3E${h.display}${indicator}%3C/th%3E%60});headerHtml+='%3C/tr%3E';let%20tableBodyHtml=productQueryResults_PQ.map((p,indexInRenderedList)=%3E{const%20displayNo=p._originalSequentialIndex+1;return%20%60%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctr%20class=%22${p._isErrorRow%20?%20'pcr-error-row'%20:%20''}%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-seq-cell%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-plancode=%22${p.code%20||%20''}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-item-index-in-rendered-list=%22${indexInRenderedList}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-original-sequential-index=%22${p._originalSequentialIndex}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-fetched=%22${p._detailsFetched%20?%20'true'%20:%20'false'}%22%3E${displayNo}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-code-cell%22%20data-copy=%22${p.polplnEnrichedCodeForCopy%20||%20p.code%20||%20'-'}%22%20title=%22${escapeHtml_PQ(p.code%20||%20'-')}%22%3E${p.polplnDisplayText%20||%20escapeHtml_PQ(p.code%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20data-copy=%22${p.full%20||%20'-'}%22%20title=%22${escapeHtml_PQ(p.full%20||%20'-')}%22%3E${escapeHtml_PQ(p.name%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.cur)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.unit)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%3E${escapeHtml_PQ(p.type)}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20data-copy=%22${p.start%20||%20'-'}%22%3E${escapeHtml_PQ(p.start%20||%20'-')}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ctd%20class=%22pcr-saledate-cell%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-initial-copy=%22${escapeHtml_PQ(p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%20%22%22).trim())}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20data-copy=%22${p.channelEnrichedEndDateForCopy%20||%20p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%20%22%22).trim()}%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20style=%22${p.applyYellowBgForDisplay%20?%20'background-color:yellow;'%20:%20''}%22%3E${p.channelDisplayHtml%20||%20p.originalEndDisplay}%3C/td%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C/tr%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%60}).join('');tableEl.innerHTML=%60%3Cthead%3E${headerHtml}%3C/thead%3E%3Ctbody%3E${tableBodyHtml}%3C/tbody%3E%60;tableContainer.appendChild(tableEl);mainDiv.appendChild(tableContainer);document.body.appendChild(mainDiv);titleBar.onmousedown=(e)=%3E{if(e.target.classList.contains('pcr-window-close-btn'))return;mainUIDraggableState_PQ.dragging=!0;mainUIDraggableState_PQ.startX=e.clientX-mainDiv.offsetLeft;mainUIDraggableState_PQ.startY=e.clientY-mainDiv.offsetTop;titleBar.style.cursor='grabbing';document.onmousemove=(moveEvent)=%3E{if(!mainUIDraggableState_PQ.dragging)return;mainDiv.style.left=(moveEvent.clientX-mainUIDraggableState_PQ.startX)+'px';mainDiv.style.top=(moveEvent.clientY-mainUIDraggableState_PQ.startY)+'px'};document.onmouseup=()=%3E{mainUIDraggableState_PQ.dragging=!1;titleBar.style.cursor='grab';document.onmousemove=null;document.onmouseup=null}};mainDiv.querySelector(%22#pcr_copy_all_pq_s%22).onclick=handleCopyAll_PQ;mainDiv.querySelector(%22#pcr_query_data_pq_s%22).onclick=handleQueryAllData_PQ;mainDiv.querySelector(%22#pcr_reload_pq_s%22).onclick=handleReload_PQ;mainDiv.querySelector(%22#pcr_clear_results_pq_s%22).onclick=()=%3E{handleCloseMainUI_PQ()};mainDiv.querySelectorAll(%22table%20thead%20th[data-sort-key]%22).forEach(thElement=%3E{thElement.onclick=()=%3EhandleSortRequest_PQ(thElement.dataset.sortKey)});mainDiv.querySelectorAll(%22td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%22).forEach(el=%3E{el.onclick=()=%3E{navigator.clipboard.writeText(el.dataset.copy);displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1000)}});mainDiv.querySelectorAll(%22td.pcr-code-cell,%20td.pcr-saledate-cell%22).forEach(el=%3E{el.onclick=()=%3E{let%20textToCopy=el.dataset.copy||el.dataset.initialCopy||el.innerText;navigator.clipboard.writeText(textToCopy.replace(/\n%3Cbr\s*\/?%3E/gi,%22\n%22).replace(/%3Cbr\s*\/?%3E/gi,%22%20/%20%22).replace(/%3C[^%3E]*%3E/g,%22%22));displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1000)}});mainDiv.querySelectorAll(%22.pcr-seq-cell%22).forEach(cell=%3E{cell.onclick=async%20function(){await%20handleSeqCellClick_PQ(this)}});document.addEventListener('keydown',mainUIEscListener_PQ)}%20async%20function%20handleSeqCellClick_PQ(cellElement){const%20originalSequentialIndex=parseInt(cellElement.dataset.originalSequentialIndex);const%20productItem=productQueryResults_PQ.find(p=%3Ep._originalSequentialIndex===originalSequentialIndex);if(!productItem){displaySystemNotification_PQ(%22%E7%84%A1%E6%B3%95%E6%89%BE%E5%88%B0%E5%B0%8D%E6%87%89%E5%95%86%E5%93%81%E8%B3%87%E6%96%99%E9%80%B2%E8%A1%8C%E6%93%8D%E4%BD%9C%E3%80%82%22,!0);return}%20if(productItem._isErrorRow){displaySystemNotification_PQ(%22%E6%AD%A4%E5%88%97%E7%82%BA%E9%8C%AF%E8%AA%A4%E8%B3%87%E6%96%99%EF%BC%8C%E7%84%A1%E6%B3%95%E6%9F%A5%E8%A9%A2%E8%A9%B3%E6%83%85%E3%80%82%22,!0);return}%20if(productItem._detailsFetched){let%20headerText=headersForCopy_PQ().join(%22\t%22)+%22\n%22;let%20rowElement=cellElement.parentNode;let%20rowCells=Array.from(rowElement.querySelectorAll(%22td%22));let%20rowContent=headersForCopy_PQ().map((headerKey,idx)=%3E{let%20cellText=rowCells[idx]?rowCells[idx].innerText:'';if(headerKey==='%E4%BB%A3%E8%99%9F')cellText=productItem.polplnEnrichedCodeForCopy||productItem.code||%22-%22;if(headerKey==='%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5')cellText=productItem.channelEnrichedEndDateForCopy||productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();return(cellText||%22%22).replace(/\s+/g,%22%20%22).replace(/\n/g,%22%20/%20%22)}).join(%22\t%22);navigator.clipboard.writeText(headerText+rowContent.trim());displaySystemNotification_PQ(%60%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(No.${productItem._originalSequentialIndex+1})%E5%B7%B2%E8%A4%87%E8%A3%BD(%E5%90%AB%E8%A1%A8%E9%A0%AD)%EF%BC%81%60,!1,1500);return}%20cellElement.style.cursor=%22wait%22;const%20currentNoTextInCell=cellElement.textContent.match(/^\d+/);cellElement.textContent=%60${currentNoTextInCell%20?%20currentNoTextInCell[0]%20:%20'?'}%20(%E6%9F%A5...)%60;const%20originalSeqDisplayNoInCell=cellElement.textContent.replace(%22%20(%E6%9F%A5...)%22,%22%22);const%20codeCell=cellElement.parentNode.querySelector(%22.pcr-code-cell%22);const%20saleDateCell=cellElement.parentNode.querySelector(%22.pcr-saledate-cell%22);displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,0);const[detailRes,saleDateRes]=await%20Promise.all([callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:20},currentApiUrls_PQ.planCodeDetail),callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:50},currentApiUrls_PQ.saleDateQuery)]);const%20currentDetailToast=document.getElementById('pqToolNotification_S_v2');if(currentDetailToast&&currentDetailToast.innerText.includes(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60)){currentDetailToast.remove()}%20displaySystemNotification_PQ(%22%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%AE%8C%E7%95%A2%E3%80%82%22,!1,1000);cellElement.textContent=originalSeqDisplayNoInCell;let%20polplnText=%22-%22;if(detailRes&&detailRes.records&&detailRes.records.length%3E0){polplnText=processMultiplePolpln_PQ(detailRes.records.map(r=%3Er.polpln))}%20let%20codeDisplayHtml=escapeHtml_PQ(productItem.code||%22-%22);let%20codeCopyToClipboard=productItem.code||%22-%22;if(detailRes&&detailRes.error){codeDisplayHtml+=%60%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3EPOLPLN:%20${detailRes.message%20||%20detailRes.error}%3C/span%3E%60}else%20if(polplnText!==%22-%22&&polplnText!==%22%22){codeDisplayHtml=%60${escapeHtml_PQ(productItem.code%20||%20%22-%22)}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${escapeHtml_PQ(polplnText)}%3C/span%3E%60;codeCopyToClipboard=%60${productItem.code%20||%20%22-%22}\n${polplnText}%60}%20productItem.polplnDisplayText=codeDisplayHtml;productItem.polplnEnrichedCodeForCopy=codeCopyToClipboard;if(codeCell){codeCell.innerHTML=productItem.polplnDisplayText;codeCell.dataset.copy=productItem.polplnEnrichedCodeForCopy}%20const%20channelInfo=formatChannelSalesInfo_PQ(saleDateRes,productItem.code,productItem.originalEndDisplay,productItem.isStillSelling);productItem.channelDisplayHtml=channelInfo.html;productItem.channelEnrichedEndDateForCopy=channelInfo.copyText;productItem.applyYellowBgForDisplay=channelInfo.applyYellowBg;if(saleDateCell){if(saleDateRes&&saleDateRes.error){saleDateCell.innerHTML=%60${productItem.originalEndDisplay}%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3E%E9%80%9A%E8%B7%AF:%20${saleDateRes.message%20||%20saleDateRes.error}%3C/span%3E%60;saleDateCell.dataset.copy=productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}else{saleDateCell.innerHTML=productItem.channelDisplayHtml;saleDateCell.dataset.copy=productItem.channelEnrichedEndDateForCopy;saleDateCell.style.backgroundColor=productItem.applyYellowBgForDisplay?%22yellow%22:%22%22}}%20cellElement.dataset.fetched=%22true%22;cellElement.style.color=%22#28a745%22;cellElement.style.cursor=%22copy%22;productItem._detailsFetched=!0}%20function%20headersForCopy_PQ(){return['No','%E4%BB%A3%E8%99%9F','%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1','%E5%B9%A3%E5%88%A5','%E5%96%AE%E4%BD%8D','%E9%A1%9E%E5%9E%8B','%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5','%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5']}%20const%20mainUIEscListener_PQ=(e)=%3E{if(e.key===%22Escape%22&&!document.querySelector('[id$=%22_overlay_pq%22]')){handleCloseMainUI_PQ()}};function%20handleCopyAll_PQ(){let%20tsvContent=headersForCopy_PQ().join(%22\t%22)+%22\n%22;const%20itemsToCopy=productQueryResults_PQ;if(!itemsToCopy||itemsToCopy.length===0){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD%E3%80%82%22,!0);return}%20displaySystemNotification_PQ(%60%E6%BA%96%E5%82%99%E8%A4%87%E8%A3%BD%E5%85%A8%E9%83%A8%20${itemsToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99...%60,!1,1500);itemsToCopy.forEach((product)=%3E{let%20codeData=product.polplnEnrichedCodeForCopy||product.code||%22-%22;let%20saleDateData=product.channelEnrichedEndDateForCopy||product.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();const%20rowValues=[(product._originalSequentialIndex+1).toString(),(codeData||%22%22).replace(/\n/g,%22%20/%20%22),escapeHtml_PQ(product.full||%22-%22),escapeHtml_PQ(product.cur||%22-%22),escapeHtml_PQ(product.unit||%22-%22),escapeHtml_PQ(product.type||%22-%22),escapeHtml_PQ(product.start||%22-%22),(saleDateData||%22%22).replace(/\n/g,%22%20/%20%22)];tsvContent+=rowValues.join(%22\t%22)+%22\n%22});navigator.clipboard.writeText(tsvContent.trim());displaySystemNotification_PQ(%60%E5%85%B1%20${itemsToCopy.length}%20%E7%AD%86%E8%B3%87%E6%96%99%E5%B7%B2%E8%A4%87%E8%A3%BD%20(TSV%E6%A0%BC%E5%BC%8F)%EF%BC%81%60,!1,2500)}%20async%20function%20handleQueryAllData_PQ(){const%20mainUITable=document.getElementById(MAIN_UI_ID_PQ);if(!mainUITable){displaySystemNotification_PQ(%22%E8%A1%A8%E6%A0%BC%E4%B8%8D%E5%AD%98%E5%9C%A8%E3%80%82%22,!0);return}%20const%20itemsForDetailProcessing=productQueryResults_PQ;if(!itemsForDetailProcessing||itemsForDetailProcessing.length===0){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E5%95%86%E5%93%81%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E3%80%82%22,!1);return}%20displaySystemNotification_PQ(%60%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%20${itemsForDetailProcessing.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,0);let%20successCount=0;for(let%20i=0;i%3CitemsForDetailProcessing.length;i++){const%20seqCell=mainUITable.querySelector(%60.pcr-seq-cell[data-item-index-in-rendered-list=%22${i}%22]%60);if(seqCell){const%20originalIdx=parseInt(seqCell.dataset.originalSequentialIndex);const%20masterProductItem=productQueryResults_PQ.find(p=%3Ep._originalSequentialIndex===originalIdx);if(masterProductItem&&!masterProductItem._detailsFetched&&!masterProductItem._isErrorRow){await%20handleSeqCellClick_PQ(seqCell);successCount++}}else{console.warn(%22Could%20not%20find%20seqCell%20for%20item%20at%20rendered%20index:%20%22+i,itemsForDetailProcessing[i])}}%20const%20currentDetailProcessingToast=document.getElementById('pqToolNotification_S_v2');if(currentDetailProcessingToast&&currentDetailProcessingToast.innerText.startsWith(%22%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%22)){currentDetailProcessingToast.remove()}%20if(successCount%3E0){displaySystemNotification_PQ(%60%E6%9C%AC%E6%89%B9%20${successCount}%20%E7%AD%86%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E5%B7%B2%E6%9B%B4%E6%96%B0%E3%80%82%60,!1,2000)}else{displaySystemNotification_PQ(%22%E6%9C%AC%E6%89%B9%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E4%BB%BB%E4%BD%95%E6%9B%B4%E6%96%B0%E9%A0%85%E7%9B%AE%E3%80%82%22,!1,2000)}}%20function%20handleReload_PQ(){displaySystemNotification_PQ(%22%E6%BA%96%E5%82%99%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2...%22,!1,1000);handleCloseMainUI_PQ(!1);document.removeEventListener('keydown',mainUIEscListener_PQ);setTimeout(async()=%3E{await%20executeProductQueryTool()},50)}%20function%20handleCloseMainUI_PQ(removeEscListener=!0){document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();if(removeEscListener){document.removeEventListener('keydown',mainUIEscListener_PQ)}}%20async%20function%20fetchProductListPage_PQ(){productQueryResults_PQ=[];let%20queryPayload={...currentQueryParameters_PQ,pageNo:1};if(queryPayload.codes!==undefined&&queryPayload.codes!==null){delete%20queryPayload.planCodeName}else%20if(queryPayload.planCodeName!==undefined&&queryPayload.planCodeName!==null){delete%20queryPayload.codes}%20let%20loadingMessage=%60%E6%9F%A5%E8%A9%A2%E4%B8%AD%EF%BC%8C%E7%AD%86%E6%95%B8%E8%BC%83%E5%A4%9A%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E8%BC%83%E9%95%B7%E6%99%82%E9%96%93%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...%60;displaySystemNotification_PQ(loadingMessage,!1,0);const%20apiResponse=await%20callProductApi_PQ(apiAuthToken_PQ,queryPayload,currentApiUrls_PQ.planCodeQuery);const%20loadingToast=document.getElementById('pqToolNotification_S_v2');if(loadingToast&&loadingToast.innerText===loadingMessage){loadingToast.remove()}%20if(apiResponse&&apiResponse.error==='TOKEN_INVALID'){if(tokenStatus_PQ===%22skipped_by_user%22&&apiAuthToken_PQ===null){displaySystemNotification_PQ(%22%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97%EF%BC%9ATOKEN%20%E6%9C%AA%E6%8F%90%E4%BE%9B%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}%20apiAuthToken_PQ=null;localStorage.removeItem(TOKEN_STORAGE_KEY_PQ);localStorage.removeItem(TOKEN_STORAGE_KEY_PQ_FALLBACK);displaySystemNotification_PQ(%22TOKEN%20%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%22,!0,0);const%20o=await%20solicitNewToken_PQ();if(o===null){tokenStatus_PQ=%22failed_solicitation%22}else%20if(o==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E5%86%8D%E6%AC%A1%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1);displaySystemNotification_PQ(%22TOKEN%E7%8B%80%E6%85%8B%E5%B7%B2%E8%AE%8A%E6%9B%B4%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E6%93%8D%E4%BD%9C%E3%80%82%22,!1,3e3)}else{apiAuthToken_PQ=o;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ(%22%E6%96%B0%20TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E3%80%82%22,!1,3e3)}%20productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}else%20if(apiResponse&&apiResponse.error){displaySystemNotification_PQ(apiResponse.message||%22%E6%9F%A5%E8%A9%A2%E6%99%82%E7%99%BC%E7%94%9F%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}%20if(apiResponse&&apiResponse.records){totalRecords_PQ=apiResponse.totalRecords||apiResponse.records.length;productQueryResults_PQ=apiResponse.records.map((rec,idx)=%3EtransformProductData_PQ(rec,idx))}else{totalRecords_PQ=0;productQueryResults_PQ=[]}%20renderMainResultsUI_PQ();if(totalRecords_PQ===0){displaySystemNotification_PQ(%22%E6%9F%A5%E7%84%A1%E7%AC%A6%E5%90%88%E5%95%86%E5%93%81%E3%80%82%22,!1,3000)}else{displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%20${totalRecords_PQ}%20%E7%AD%86%E3%80%82%60,!1,2500)}%20if(autoFetchDetailsAfterLoad_PQ&&productQueryResults_PQ.length%3E0){autoFetchDetailsAfterLoad_PQ=!1;displaySystemNotification_PQ(%60%E6%AD%A3%E5%9C%A8%E8%87%AA%E5%8B%95%E7%8D%B2%E5%8F%96%E6%9C%AC%E9%A0%81%20${productQueryResults_PQ.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99...%60,!1,0);await%20handleQueryAllData_PQ();const%20autoToast=document.getElementById('pqToolNotification_S_v2');if(autoToast&&autoToast.innerText.includes(%22%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%22)){autoToast.remove()}%20displaySystemNotification_PQ(%22%E6%9C%AC%E9%A0%81%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%E5%B7%B2%E8%BC%89%E5%85%A5%E3%80%82%22,!1,2500)}}%20async%20function%20processQuerySetupAndExecute_PQ(querySetupResult){autoFetchDetailsAfterLoad_PQ=!1;currentSortKey_PQ=null;currentSortDirection_PQ='none';let%20baseParams={pageNo:1,pageSize:maxProductListPageSize_PQ,showAllOnOnePage:!0,queryMode:querySetupResult.queryMode};if(querySetupResult.queryMode==='planCode'){const%20planCodes=querySetupResult.inputValue.split(/[\s,;]+/).map(c=%3Ec.trim().toUpperCase()).filter(Boolean).map(c=%3Ec.slice(0,4));if(planCodes.length===0){displaySystemNotification_PQ(%22%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%81%22,!0);return}%20currentQueryParameters_PQ={...baseParams,codes:planCodes}}else%20if(querySetupResult.queryMode==='planCodeName'){const%20k=querySetupResult.inputValue.trim().split(/[\s,;]+/)[0];if(!k){displaySystemNotification_PQ(%22%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81%22,!0);return}%20currentQueryParameters_PQ={...baseParams,planCodeName:k,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='allPlans'){currentQueryParameters_PQ={...baseParams,planCodeName:%22%22,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='inSaleWithDetails'){currentQueryParameters_PQ={...baseParams,saleEndDate:%229999-12-31%2000:00:00%22,planCodeName:%22%22,orderBy:%22planCode%20asc%22};autoFetchDetailsAfterLoad_PQ=!0}else{displaySystemNotification_PQ(%22%E6%9C%AA%E7%9F%A5%E7%9A%84%E6%9F%A5%E8%A9%A2%E6%A8%A1%E5%BC%8F%E6%88%96%E5%8A%9F%E8%83%BD%E5%BE%85%E5%AE%9A%E7%BE%A9%E3%80%82%22,!0);return}%20await%20fetchProductListPage_PQ()}%20async%20function%20solicitNewToken_PQ(attempt=1){const%20tokenResult=await%20createTokenDialog_PQ(attempt);if(tokenResult==='_close_tool_pq_'||tokenResult==='_token_dialog_cancel_pq_'){displaySystemNotification_PQ(tokenResult==='_close_tool_pq_'?'%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%97%9C%E9%96%89':'Token%20%E8%BC%B8%E5%85%A5%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return%20null}%20if(tokenResult==='_skip_token_pq_'){return'_skip_token_pq_'}%20const%20trimmedToken=normalizeInput_PQ(tokenResult||%22%22);if(trimmedToken){return%20trimmedToken}else{displaySystemNotification_PQ('TOKEN%20%E6%9C%AA%E8%BC%B8%E5%85%A5%E3%80%82',!0);if(attempt%3C3){return%20await%20solicitNewToken_PQ(attempt+1)}else{displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E8%BC%B8%E5%85%A5%E7%84%A1%E6%95%88%E3%80%82',!0);return%20null}}}%20async%20function%20executeProductQueryTool(){handleCloseMainUI_PQ();currentSortKey_PQ=null;currentSortDirection_PQ='none';const%20selectedEnv=await%20createEnvSelectionDialog_PQ();if(!selectedEnv){displaySystemNotification_PQ('%E7%92%B0%E5%A2%83%E9%81%B8%E6%93%87%E5%B7%B2%E5%8F%96%E6%B6%88',!0);tokenStatus_PQ=%22initial%22;return}%20currentApiUrls_PQ=API_URL_TEMPLATES_PQ[selectedEnv];displaySystemNotification_PQ(%60%E7%92%B0%E5%A2%83%E5%B7%B2%E8%A8%AD%E7%82%BA:%20${selectedEnv.toUpperCase()}%60,!1,1500);apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ);if(!apiAuthToken_PQ){apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ_FALLBACK)}%20if(!apiAuthToken_PQ){const%20o=await%20solicitNewToken_PQ();if(o===null){tokenStatus_PQ=%22failed_solicitation%22;return}else%20if(o==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1,2e3)}else{apiAuthToken_PQ=o;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ('TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%E3%80%82',!1,1500)}}else{tokenStatus_PQ=%22valid%22;displaySystemNotification_PQ('%E5%B7%B2%E5%BE%9E%E6%9C%AC%E5%9C%B0%E8%BC%89%E5%85%A5%20TOKEN%E3%80%82',!1,1500)}%20const%20querySetupResult=await%20createQuerySetupDialog_PQ();if(!querySetupResult){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E8%A8%AD%E5%AE%9A%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return}%20await%20processQuerySetupAndExecute_PQ(querySetupResult)}%20try{document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();document.getElementById(%22pcrBookMarkletDivV17%22)?.remove();document.getElementById(%22pcrBookMarkletCssV17%22)?.remove();document.getElementById('pqToolNotification_S_v2')?.remove();await%20executeProductQueryTool()}catch(err){console.error(%22%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E8%85%B3%E6%9C%AC%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:%22,err);alert(%22%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E8%85%B3%E6%9C%AC%E5%9F%B7%E8%A1%8C%E6%99%82%E7%99%BC%E7%94%9F%E5%9A%B4%E9%87%8D%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%A9%B3%E8%A6%8B%E6%8E%A7%E5%88%B6%E5%8F%B0%E3%80%82\n%22+(err.message||err))}})()

javascript:(async()=>{console.log('[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC] %E8%85%B3%E6%9C%AC%E9%96%8B%E5%A7%8B%E5%9F%B7%E8%A1%8C R3-debug...');const API_URL_TEMPLATES_PQ={uat:{planCodeQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'},prod:{planCodeQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/query',planCodeDetail:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeController/queryDetail',saleDateQuery:'https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/planCodeSaleDateController/query'}};const TOKEN_STORAGE_KEY_PQ='euisPlanCodeToken_v2';const TOKEN_STORAGE_KEY_PQ_FALLBACK='euisToken';const MAIN_UI_ID_PQ='productQueryBookmarkletDiv_Structured_v2';const CSS_ID_PQ='productQueryBookmarkletCss_Structured_v2';const Z_INDEX_OVERLAY_PQ=2147483640;const Z_INDEX_DIALOG_PQ=2147483641;const Z_INDEX_MAIN_UI_PQ=2147483630;const Z_INDEX_NOTIFICATION_PQ=2147483647;const PRODUCT_FIELD_DEFINITIONS_PQ={CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}};const productListPageSize_PQ=50;const maxProductListPageSize_PQ=5000;const detailFetchSwitchThreshold_PQ=300;let currentApiUrls_PQ={};let apiAuthToken_PQ=null;let tokenStatus_PQ="initial";let productQueryResults_PQ=[];let totalRecords_PQ=0;let currentQueryParameters_PQ={};let productListCurrentPage_PQ=1;let productListTotalPages_PQ=1;let batchModeActive_PQ=!1;let currentSortKey_PQ=null;let currentSortDirection_PQ='none';let autoFetchDetailsAfterLoad_PQ=!1;let mainUIDraggableState_PQ={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};function escapeHtml_PQ(unsafe){if(typeof unsafe!=='string')return unsafe===null||unsafe===undefined?%27%27:String(unsafe);return%20unsafe.replace(/[&%3C%3E%22%27]/g,m=%3E({%27&%27:%27&%27,%27%3C%27:%27%3C%27,%27%3E%27:%27%3E%27,%27%22%27:%27%22%27,%22%27%22:%27&#039;'})[m])}function%20displaySystemNotification_PQ(message,isError=!1,duration=2000){const%20notificationId='pqToolNotification_S_v2';console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20%E7%B3%BB%E7%B5%B1%E6%8F%90%E7%A4%BA:%20${message}%20(%E9%8C%AF%E8%AA%A4:%20${isError},%20%E6%8C%81%E7%BA%8C:%20${duration})%60);document.getElementById(notificationId)?.remove();const%20notification=document.createElement('div');notification.id=notificationId;notification.className='pcr-toast';notification.style.cssText=%60%20%20%20%20%20%20position:%20fixed;%20top:%2020px;%20left:%2050%;%20transform:%20translateX(-50%);%20%20%20%20%20%20background:%20${isError%20?%20'rgba(220,%2053,%2069,%200.9)'%20:%20'rgba(0,%20123,%20255,%200.9)'};%20color:%20#fff;%20%20%20%20%20%20padding:%205px%2012px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20z-index:%20${Z_INDEX_NOTIFICATION_PQ};%20display:%20inline-block;%20width:%20auto;%20%20%20%20%20%20box-shadow:%200%202px%208px%20rgba(0,0,0,.15);%20%20%20%20%20%20opacity:%201;%20transition:%20opacity%200.5s%20ease-out%20${Math.max(0,%20duration%20-%20500)}ms;%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20text-align:%20center;%20%20%20%20%60;notification.innerText=message;document.body.appendChild(notification);if(duration%3E0){setTimeout(()=%3E{notification.style.opacity='0';setTimeout(()=%3Enotification.remove(),500)},duration)}}function%20createDialogBase_PQ(id,contentHtml,minWidth='300px',maxWidth='500px',customStyles=''){const%20overlayId=id+'_overlay_pq';document.getElementById(overlayId)?.remove();const%20overlay=document.createElement('div');overlay.id=overlayId;overlay.style.cssText=%60%20%20%20%20%20%20position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%;%20height:%20100%;%20%20%20%20%20%20background:%20rgba(0,0,0,0.6);%20z-index:%20${Z_INDEX_OVERLAY_PQ};%20%20%20%20%20%20display:%20flex;%20align-items:%20center;%20justify-content:%20center;%20%20%20%20%20%20font-family:%20'Microsoft%20JhengHei',%20Arial,%20sans-serif;%20%20%20%20%20%20backdrop-filter:%20blur(2px);%20%20%20%20%60;const%20dialog=document.createElement('div');dialog.id=id+'_dialog_pq';dialog.style.cssText=%60%20%20%20%20%20%20background:%20#fff;%20padding:%2020px%2025px;%20border-radius:%208px;%20%20%20%20%20%20box-shadow:%200%205px%2020px%20rgba(0,0,0,0.25);%20%20%20%20%20%20min-width:%20${minWidth};%20max-width:%20${maxWidth};%20width:%20auto;%20%20%20%20%20%20animation:%20pqDialogAppear_S%200.2s%20ease-out;%20%20%20%20%20%20${customStyles}%20%20%20%20%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);document.body.appendChild(overlay);const%20styleEl=document.createElement('style');styleEl.textContent=%60%20%20%20%20%20%20@keyframes%20pqDialogAppear_S%20{%20%20%20%20%20%20%20%20from%20{%20opacity:%200;%20transform:%20scale(0.95)%20translateY(-10px);%20}%20%20%20%20%20%20%20%20to%20{%20opacity:%201;%20transform:%20scale(1)%20translateY(0);%20}%20%20%20%20%20%20}%20%20%20%20%20%20.pq-dialog-btn%20{%20%20%20%20%20%20%20%20border:%20none;%20padding:%208px%2015px;%20border-radius:%205px;%20font-size:%2013px;%20%20%20%20%20%20%20%20cursor:%20pointer;%20transition:%20opacity%200.2s%20ease,%20transform%200.1s%20ease;%20font-weight:%20500;%20margin-left:%208px;%20%20%20%20%20%20}%20%20%20%20%20%20.pq-dialog-btn:hover%20{%20opacity:%200.85;%20}%20%20%20%20%20%20.pq-dialog-btn:active%20{%20transform:%20scale(0.98);%20}%20%20%20%20%20%20.pq-dialog-btn-blue%20{%20background:%20#007bff;%20color:%20white;%20}%20%20%20%20%20%20.pq-dialog-btn-orange%20{%20background:%20#fd7e14;%20color:%20white;%20}%20%20%20%20%20%20%20.pq-dialog-btn-green%20{%20background:%20#28a745;%20color:%20white;%20}%20%20%20%20%20%20.pq-dialog-btn-grey%20{%20background:%20#6c757d;%20color:%20white;%20}%20%20%20%20%20%20.pq-dialog-btn-red%20{%20background:%20#dc3545;%20color:%20white;%20}%20%20%20%20%20%20.pq-dialog-title%20{%20margin:%200%200%2018px%200;%20color:%20#333;%20font-size:%2018px;%20text-align:%20center;%20font-weight:%20600;%20}%20%20%20%20%20%20.pq-input,%20.pq-textarea%20{%20%20%20%20%20%20%20%20width:%20calc(100%%20-%2018px);%20padding:%209px;%20border:%201px%20solid%20#ccc;%20%20%20%20%20%20%20%20border-radius:%204px;%20font-size:%2013px;%20margin-bottom:%2012px;%20box-sizing:%20border-box;%20color:%20#333;%20%20%20%20%20%20}%20%20%20%20%20%20.pq-textarea%20{%20min-height:%2070px;%20resize:%20vertical;%20}%20%20%20%20%20%20.pq-dialog-flex-end%20{%20display:%20flex;%20justify-content:%20flex-end;%20margin-top:%2020px;%20}%20%20%20%20%20%20.pq-radio-group%20{%20margin-bottom:%2012px;%20text-align:%20left;%20}%20%20%20%20%20%20.pq-radio-group%20label%20{%20margin-right:%2015px;%20font-size:%2014px;%20cursor:pointer;%20display:%20block;%20margin-bottom:%205px;%20}%20%20%20%20%20%20.pq-radio-group%20input[type=%22radio%22]%20{%20margin-right:%206px;%20vertical-align:%20middle;%20}%20%20%20%20%20%20.pq-checkbox-group%20label%20{%20font-size:%2013px;%20cursor:pointer;%20display:%20flex;%20align-items:%20center;%20}%20%20%20%20%20%20.pq-checkbox-group%20input[type=%22checkbox%22]%20{%20margin-right:%206px;%20transform:%20scale(1.1);%20}%20%20%20%20%60;dialog.appendChild(styleEl);return{overlay,dialog}}function%20normalizeInput_PQ(str){if(typeof%20str!=='string')return%20str;return%20str.replace(/[\uff01-\uff5e]/g,s=%3EString.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g,%22%20%22).trim()}function%20formatDateForQuery_PQ(dateStr){if(!dateStr)return%22%22;try{return%20dateStr.substring(0,10).replace(/-/g,%22%22)}catch(t){console.warn(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%97%A5%E6%9C%9F%E9%8C%AF%E8%AA%A4:%22,dateStr,t);return%22%22}}function%20getTodayDateString_PQ(){let%20e=new%20Date(),t=e.getFullYear(),r=(e.getMonth()+1).toString().padStart(2,%220%22),l=e.getDate().toString().padStart(2,%220%22);return%20%60${t}${r}${l}%60}function%20createEnvSelectionDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%20%20%20%20%20%20%20%20%3Cdiv%20style=%22display:flex;%20gap:10px;%20justify-content:center;%20margin-bottom:20px;%22%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-uat%22%20class=%22pq-dialog-btn%20pq-dialog-btn-green%22%20style=%22flex-grow:1;%22%3E%E6%B8%AC%E8%A9%A6%20(UAT)%3C/button%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-prod%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22flex-grow:1;%20background-color:#ffc107;%20color:#212529;%22%3E%E6%AD%A3%E5%BC%8F%20(PROD)%3C/button%3E%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%3Cdiv%20style=%22text-align:center;%22%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-env-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay}=createDialogBase_PQ('pqEnvSelect_S_v2',contentHtml,'320px');const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#pq-env-uat').onclick=()=%3EcloseDialog('uat');overlay.querySelector('#pq-env-prod').onclick=()=%3EcloseDialog('prod');overlay.querySelector('#pq-env-cancel').onclick=()=%3EcloseDialog(null)})}function%20createTokenDialog_PQ(attempt=1){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3EAPI%20TOKEN%20%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%3Cinput%20type=%22password%22%20id=%22pq-token-input%22%20class=%22pq-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20API%20TOKEN%22%20autocomplete=%22current-password%22%3E%20%20%20%20%20%20%20%20${attempt%20%3E%201%20?%20%60%3Cp%20style=%22color:red;%20font-size:12px;%20text-align:center;%20margin-bottom:10px;%22%3ETOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%3C/p%3E%60%20:%20''}%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-skip%22%20class=%22pq-dialog-btn%20pq-dialog-btn-orange%22%20style=%22margin-right:auto;%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-close-tool%22%20class=%22pq-dialog-btn%20pq-dialog-btn-red%22%3E%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%3C/button%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-token-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E${attempt%20%3E%201%20?%20'%E9%87%8D%E8%A9%A6'%20:%20'%E7%A2%BA%E5%AE%9A'}%3C/button%3E%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay,dialog}=createDialogBase_PQ('pqToken_S_v2',contentHtml,'390px');const%20inputEl=dialog.querySelector('#pq-token-input');inputEl.focus();if(attempt%3E2){dialog.querySelector('#pq-token-ok').disabled=!0;dialog.querySelector('#pq-token-ok').style.opacity='0.5';dialog.querySelector('#pq-token-ok').style.cursor='not-allowed';displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E5%98%97%E8%A9%A6%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E7%A2%BA%E8%AA%8D%20TOKEN%E3%80%81%E9%81%B8%E6%93%87%E7%95%A5%E9%81%8E%E6%88%96%E9%97%9C%E9%96%89%E5%B7%A5%E5%85%B7%E3%80%82',!0,4000)}const%20closeDialog=(value)=%3E{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog('_token_dialog_cancel_pq_');};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-token-ok').onclick=()=%3EcloseDialog(inputEl.value.trim());dialog.querySelector('#pq-token-close-tool').onclick=()=%3EcloseDialog('_close_tool_pq_');dialog.querySelector('#pq-token-skip').onclick=()=%3EcloseDialog('_skip_token_pq_')})}function%20createQuerySetupDialog_PQ(){return%20new%20Promise(resolve=%3E{const%20contentHtml=%60%20%20%20%20%20%20%20%20%3Ch3%20class=%22pq-dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A%3C/h3%3E%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-radio-group%22%20style=%22margin-bottom:%2010px;%22%3E%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCode%22%20checked%3E%20%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%3C/label%3E%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22planCodeName%22%3E%20%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%3C/label%3E%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22allPlans%22%3E%20%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%3C/label%3E%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%3Cinput%20type=%22radio%22%20name=%22pq-query-type%22%20value=%22inSaleWithDetails%22%3E%20%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%20(%E5%90%AB%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85)%3C/label%3E%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-checkbox-group%22%20style=%22margin-bottom:%2015px;%20padding-left:%205px;%22%3E%20%20%20%20%20%20%20%20%20%20%3Clabel%3E%20%20%20%20%20%20%20%20%20%20%20%20%3Cinput%20type=%22checkbox%22%20id=%22pq-showall-checkbox%22%20style=%22margin-right:%205px;%20vertical-align:%20middle;%22%3E%E4%B8%80%E9%A0%81%E9%A1%AF%E7%A4%BA%E6%89%80%E6%9C%89%E7%B5%90%E6%9E%9C%20(%E6%9C%80%E5%A4%9A%20${maxProductListPageSize_PQ}%20%E7%AD%86)%20%20%20%20%20%20%20%20%20%20%3C/label%3E%20%20%20%20%20%20%20%20%3C/div%3E%20%20%20%20%20%20%20%20%3Ctextarea%20id=%22pq-queryvalues-input%22%20class=%22pq-textarea%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94%22%3E%3C/textarea%3E%20%20%20%20%20%20%20%20%3Cdiv%20class=%22pq-dialog-flex-end%22%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-cancel%22%20class=%22pq-dialog-btn%20pq-dialog-btn-grey%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%20%20%20%20%20%20%20%20%20%20%3Cbutton%20id=%22pq-querysetup-ok%22%20class=%22pq-dialog-btn%20pq-dialog-btn-blue%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%20%20%20%20%20%20%20%20%3C/div%3E%60;const{overlay,dialog}=createDialogBase_PQ('pqQuerySetup_S_v2',contentHtml,'520px');const%20queryValuesInput=dialog.querySelector('#pq-queryvalues-input');const%20radioButtons=dialog.querySelectorAll('input[name=%22pq-query-type%22]');const%20showAllCheckbox=dialog.querySelector('#pq-showall-checkbox');function%20updateInputState(){const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;const%20disableInputModes=['allPlans','inSaleWithDetails'];if(disableInputModes.includes(selectedType)){queryValuesInput.placeholder='%E7%84%A1%E9%9C%80%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E6%A2%9D%E4%BB%B6';queryValuesInput.value='';queryValuesInput.disabled=!0}else%20if(selectedType==='planCode'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%8C%E5%A4%9A%E7%AD%86%E5%8F%AF%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94';queryValuesInput.disabled=!1}else%20if(selectedType==='planCodeName'){queryValuesInput.placeholder='%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%96%AE%E4%B8%80%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97';queryValuesInput.disabled=!1}}radioButtons.forEach(radio=%3Eradio.onchange=updateInputState);updateInputState();const%20closeDialog=(value)=%3E{console.log('[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20QuerySetupDialog%20closeDialog%20called%20with:',value);overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const%20escListener=(e)=%3E{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelector('#pq-querysetup-ok').onclick=()=%3E{const%20selectedType=dialog.querySelector('input[name=%22pq-query-type%22]:checked').value;let%20inputValue=queryValuesInput.value.trim();const%20showAllOnOnePage=showAllCheckbox.checked;console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20QuerySetupDialog%20OK%20clicked.%20Mode:%20${selectedType},%20Input:%20%22${inputValue}%22,%20ShowAll:%20${showAllOnOnePage}%60);const%20requiresInputModes=['planCode','planCodeName'];if(requiresInputModes.includes(selectedType)&&!inputValue){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81',!0);queryValuesInput.focus();return}if(selectedType==='planCodeName'&&inputValue.split(/[\s,;]+/).filter(Boolean).length%3E1){displaySystemNotification_PQ('%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E6%9F%A5%E8%A9%A2%E5%83%85%E6%94%AF%E6%8F%B4%E5%96%AE%E4%B8%80%E9%97%9C%E9%8D%B5%E5%AD%97%E3%80%82',!0);queryValuesInput.focus();return}closeDialog({queryMode:selectedType,inputValue:inputValue,showAllOnOnePage:showAllOnOnePage})};dialog.querySelector('#pq-querysetup-cancel').onclick=()=%3EcloseDialog(null)})}async%20function%20callProductApi_PQ(token,payload,apiUrl){console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20callProductApi_PQ:%20URL=${apiUrl},%20Payload=%60,JSON.stringify(payload));try{const%20headers={'Content-Type':'application/json'};if(token){headers['SSO-TOKEN']=token}const%20response=await%20fetch(apiUrl,{method:'POST',headers:headers,body:JSON.stringify(payload)});if(response.status===401){console.warn(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20API%20401%20%E9%8C%AF%E8%AA%A4%20(Token%E7%84%A1%E6%95%88):%22,response);return{error:'TOKEN_INVALID',data:null,message:%22TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%E3%80%82%22}}if(!response.ok){const%20errorText=await%20response.text();console.warn(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20API%20${response.status}%20%E9%8C%AF%E8%AA%A4:%60,errorText,response);const%20specificErrorMsg=%60%20(${response.statusText%20||%20errorText%20||%20'%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4'})%60;return{error:%60API_ERROR_${response.status}%60,data:null,message:%60%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}${specificErrorMsg}%60}}const%20jsonData=await%20response.json();console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20API%20callProductApi_PQ%20%E6%88%90%E5%8A%9F%E5%9B%9E%E6%87%89:%22,JSON.stringify(jsonData).substring(0,300)+%22...%22);return%20jsonData}catch(error){console.error(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20API%20callProductApi_PQ%20%E7%B6%B2%E8%B7%AF%E6%88%96%E8%A7%A3%E6%9E%90%E9%8C%AF%E8%AA%A4:%22,error);return{error:'NETWORK_ERROR',data:null,message:%22%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E9%8C%AF%E8%AA%A4%E6%88%96API%E7%84%A1%E5%9B%9E%E6%87%89%E3%80%82%22}}}function%20transformProductData_PQ(apiRecord,globalIndex){const%20saleStartDate=apiRecord.saleStartDate||%22%22;const%20saleEndDate=apiRecord.saleEndDate||%22%22;const%20formattedStartDate=formatDateForQuery_PQ(saleStartDate);const%20formattedEndDate=formatDateForQuery_PQ(saleEndDate);let%20isStillSelling=!1;if(formattedEndDate){isStillSelling=formattedEndDate===%2299991231%22||formattedEndDate%3E=getTodayDateString_PQ()}let%20endDateDisplay=%22-%22;if(formattedEndDate){endDateDisplay=isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E${formattedEndDate}%3C/span%3E%60}return{_originalSequentialIndex:globalIndex,code:apiRecord.planCode,name:(apiRecord.shortName||%22%22).trim(),full:(apiRecord.planCodeName||%22%22).trim(),cur:PRODUCT_FIELD_DEFINITIONS_PQ.CUR[apiRecord.currency]||%22-%22,unit:PRODUCT_FIELD_DEFINITIONS_PQ.UNIT[(apiRecord.reportInsuranceAmountUnit||apiRecord.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:PRODUCT_FIELD_DEFINITIONS_PQ.TYPE[apiRecord.coverageType]||%22-%22,start:formattedStartDate||%22-%22,end:formattedEndDate,isStillSelling:isStillSelling,originalEndDisplay:endDateDisplay,_isErrorRow:!1,_detailsFetched:!1,polplnEnrichedCodeForCopy:null,channelEnrichedEndDateForCopy:null,polplnDisplayText:null,channelDisplayHtml:null,applyYellowBgForDisplay:!1}}function%20extractPolpln_PQ(polplnString){if(!polplnString||typeof%20polplnString!=='string')return%22%22;let%20t=polplnString.trim();if(t.endsWith(%22%%%22))t=t.substring(0,t.length-2);return%20t.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim()||%22%22}function%20processMultiplePolpln_PQ(polplnRecords){if(!polplnRecords||polplnRecords.length===0)return%22-%22;if(polplnRecords.length===1)return%20extractPolpln_PQ(polplnRecords[0])||%22-%22;const%20extractedPolplns=polplnRecords.map(r=%3EextractPolpln_PQ(r)).filter(p=%3Ep!==%22%22);if(extractedPolplns.length===0)return%22-%22;const%20firstPolpln=extractedPolplns[0];return%20extractedPolplns.every(p=%3Ep===firstPolpln)?firstPolpln:%22-%22}function%20formatChannelSalesInfo_PQ(saleDateApiResponse,planCode,baseEndDisplay,isBaseStillSelling){const%20todayStr=getTodayDateString_PQ();let%20channelDetailsHtml=%22%22;let%20copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();let%20hasActiveChannel=!1;let%20hasAnyChannelInfo=!1;if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length%3E0){hasAnyChannelInfo=!0;const%20channelRecords=saleDateApiResponse.planCodeSaleDates.records.filter(rec=%3Erec.planCode===planCode&&rec.channel&&rec.saleEndDate).map(rec=%3E{const%20channelEndDate=formatDateForQuery_PQ(rec.saleEndDate);const%20channelStartDate=formatDateForQuery_PQ(rec.saleStartDate);const%20isChannelSelling=channelEndDate===%2299991231%22||channelEndDate%3E=todayStr;if(isChannelSelling)hasActiveChannel=!0;const%20titleText=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelStartDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelEndDate%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22%20:%20channelEndDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%60;let%20displayText,plainTextPart;if(isChannelSelling){displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:blue;%22%3E${escapeHtml_PQ(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%60}else{displayText=%60%3Cspan%20title=%22${escapeHtml_PQ(titleText)}%22%20style=%22color:red;%22%3E${escapeHtml_PQ(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%60}return{channel:rec.channel,text:displayText,isSelling:isChannelSelling,plainText:plainTextPart,startDate:channelStartDate,endDate:channelEndDate}}).sort((a,b)=%3E{if(a.isSelling!==b.isSelling)return%20a.isSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});const%20sellingChannels=channelRecords.filter(r=%3Er.isSelling);const%20stoppedChannels=channelRecords.filter(r=%3E!r.isSelling);let%20currentCopyTextParts=[];if(sellingChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.plainText).join(%22%E3%80%81%22)}%60)}if(stoppedChannels.length%3E0){let%20stoppedDisplayParts=stoppedChannels.map(r=%3Er.text);let%20stoppedCopyParts=stoppedChannels.map(r=%3Er.plainText);channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedDisplayParts.join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedCopyParts.join(%22%E3%80%81%22)}%60)}if(currentCopyTextParts.length%3E0){copyTextContent=currentCopyTextParts.join(%22\n%22)}else%20if(hasAnyChannelInfo){copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%3C/div%3E%60}else{copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}}else%20if(saleDateApiResponse&&saleDateApiResponse.planCodeSaleDates&&saleDateApiResponse.planCodeSaleDates.records&&saleDateApiResponse.planCodeSaleDates.records.length===0){hasAnyChannelInfo=!0;copyTextContent=baseEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%3C/div%3E%60}let%20finalHtml=baseEndDisplay;if(channelDetailsHtml){finalHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelDetailsHtml}%3C/div%3E%60}const%20applyYellowBg=!isBaseStillSelling&&hasActiveChannel;return{html:finalHtml,copyText:copyTextContent.trim(),applyYellowBg:applyYellowBg,hasChannelInfo:hasAnyChannelInfo}}function%20handleSortRequest_PQ(sortKey){console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleSortRequest_PQ:%20sortKey=${sortKey}%60);if(currentSortKey_PQ===sortKey){currentSortDirection_PQ=currentSortDirection_PQ==='asc'?'desc':'asc'}else{currentSortKey_PQ=sortKey;currentSortDirection_PQ='asc'}sortProductResults_PQ();productListCurrentPage_PQ=1;renderMainResultsUI_PQ();const%20headerText=document.querySelector(%60#${MAIN_UI_ID_PQ}%20th[data-sort-key=%22${sortKey}%22]%60)?.textContent?.replace(/[%E2%96%B2%E2%96%BC\s]*/g,'')||sortKey;displaySystemNotification_PQ(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerText}%E3%80%8D${currentSortDirection_PQ%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1,1500)}function%20sortProductResults_PQ(){if(!currentSortKey_PQ||currentSortDirection_PQ==='none'||!productQueryResults_PQ)return;console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20sortProductResults_PQ:%20Sorting%20by%20${currentSortKey_PQ}%20${currentSortDirection_PQ}%60);productQueryResults_PQ.sort((a,b)=%3E{let%20valA=a[currentSortKey_PQ];let%20valB=b[currentSortKey_PQ];if(valA===null||valA===undefined)valA=%22%22;if(valB===null||valB===undefined)valB=%22%22;if(currentSortKey_PQ==='_originalSequentialIndex'){return%20currentSortDirection_PQ==='asc'?valA-valB:valB-valA}else%20if(currentSortKey_PQ==='start'||currentSortKey_PQ==='end'){return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB)):String(valB).localeCompare(String(valA))}else{return%20currentSortDirection_PQ==='asc'?String(valA).localeCompare(String(valB),'zh-Hant-TW',{sensitivity:'base',numeric:!0}):String(valB).localeCompare(String(valA),'zh-Hant-TW',{sensitivity:'base',numeric:!0})}})}function%20renderMainResultsUI_PQ(){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20renderMainResultsUI_PQ:%20Rendering%20UI...%22);document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();const%20styleEl=document.createElement(%22style%22);styleEl.id=CSS_ID_PQ;styleEl.textContent=%60%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20{position:fixed;z-index:${Z_INDEX_MAIN_UI_PQ};left:50%;top:20px;transform:translateX(-50%);background:#f8f9fa;border-radius:10px;box-shadow:0%206px%2024px%20rgba(0,0,0,.15);padding:18px;width:auto;min-width:750px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft%20JhengHei',%20Arial,%20sans-serif;font-size:13px;%20border:%201px%20solid%20#dee2e6;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar%20{padding:10px%2015px;background-color:#343a40;color:white;font-weight:bold;font-size:15px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;margin:-18px%20-18px%2012px%20-18px;%20display:%20flex;%20justify-content:%20space-between;%20align-items:%20center;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-title-bar-text%20{%20flex-grow:%201;%20text-align:%20center;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-window-close-btn%20{background:transparent;color:white;border:none;font-size:20px;cursor:pointer;padding:0%208px;%20line-height:%201;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-controls-header_pq%20{background:#fff;padding:10px;border:1px%20solid%20#ddd;%20border-radius:%206px;%20margin-bottom:12px;%20display:flex;justify-content:space-between;align-items:center;%20flex-wrap:%20wrap;%20gap:10px;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-summary-and-research_pq%20{display:flex;align-items:center;flex-grow:1;%20gap:15px;%20flex-wrap:wrap;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20{font-size:14px;font-weight:500;color:#212529;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-info-summary_pq%20strong%20{color:#007bff;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-batch-pagination_pq%20{display:flex;align-items:center;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-batch-pagination_pq%20button%20{color:#fff;border:none;padding:5px%2012px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;box-shadow:0%201px%203px%20rgba(0,0,0,.1);margin:0%205px;background:#007bff;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-batch-pagination_pq%20button:disabled%20{background:#adb5bd;cursor:not-allowed}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-batch-pagination_pq%20span%20{font-size:13px;margin:0%2010px;color:#495057;font-weight:500}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20{display:flex;align-items:center;flex-wrap:nowrap;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button%20{border:none;padding:6px%2014px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;box-shadow:0%201px%203px%20rgba(0,0,0,.1);margin-left:8px;white-space:nowrap;%20transition:%20opacity%200.2s%20ease;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20button:hover%20{opacity:.85}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-copy-all-btn%20{background:#28a745;%20color:white;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-query-data-btn%20{background:#17a2b8;%20color:white;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-reload-btn%20{background:#007bff;%20color:white;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-buttons-group_pq%20.pcr-clear-results-btn%20{background:#6c757d;%20color:white;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-table-container_pq%20{flex-grow:1;%20overflow:auto;%20border:1px%20solid%20#ddd;%20border-radius:6px;%20background:white;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20{width:100%;border-collapse:collapse;font-size:12px;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20{position:sticky;top:0;z-index:2;background:#343a40;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th%20{background:#343a40;color:#fff;text-align:center;padding:8px%2010px;font-size:13px;%20border-bottom:%202px%20solid%20#454d55;%20border-right:%201px%20solid%20#454d55;%20white-space:nowrap;%20cursor:pointer;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20table%20thead%20th:last-child%20{border-right:none;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td,%20#${MAIN_UI_ID_PQ}%20th%20{padding:7px%2010px;text-align:center;border:1px%20solid%20#e9ecef;white-space:nowrap;vertical-align:middle}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tbody%20tr%20td:nth-child(3)%20{text-align:left;%20white-space:normal;%20min-width:150px;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:nth-child(even)%20td%20{background:#f8f9fa}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20tr:hover%20td%20{background:#e9ecef;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%20{cursor:pointer;color:#0056b3;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell%20{color:#007bff;cursor:pointer;font-weight:bold;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell:hover%20{text-decoration:underline;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-seq-cell[data-fetched=%22true%22]%20{color:#28a745;cursor:copy;font-weight:normal;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-saledate-cell%20{white-space:normal%20!important;vertical-align:top%20!important;min-width:200px;%20max-width:280px;%20text-align:left%20!important;}%20%20%20%20%20%20#${MAIN_UI_ID_PQ}%20.pcr-error-row%20td%20{background-color:%20#ffebee%20!important;%20color:%20#c62828;}%20%20%20%20%60;document.head.appendChild(styleEl);const%20mainDiv=document.createElement(%22div%22);mainDiv.id=MAIN_UI_ID_PQ;const%20titleBar=document.createElement(%22div%22);titleBar.className=%22pcr-title-bar%22;const%20titleTextEl=document.createElement(%22span%22);titleTextEl.className=%22pcr-title-bar-text%22;titleTextEl.textContent=%22%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%20%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%22;const%20closeWindowBtn=document.createElement(%22button%22);closeWindowBtn.className=%22pcr-window-close-btn%22;closeWindowBtn.innerHTML=%22&#x2715;%22;closeWindowBtn.onclick=()=%3E{handleCloseMainUI_PQ()};titleBar.appendChild(titleTextEl);titleBar.appendChild(closeWindowBtn);mainDiv.appendChild(titleBar);const%20controlsHeader=document.createElement(%22div%22);controlsHeader.className=%22pcr-controls-header_pq%22;const%20summaryResearchDiv=document.createElement(%22div%22);summaryResearchDiv.className=%22pcr-summary-and-research_pq%22;const%20infoSummarySpan=document.createElement(%22span%22);infoSummarySpan.className=%22pcr-info-summary_pq%22;let%20summaryText=%60%E7%B8%BD%E5%85%B1%20%3Cstrong%3E${totalRecords_PQ}%3C/strong%3E%20%E7%AD%86%60;const%20userChoseShowAllForQuery=currentQueryParameters_PQ.showAllOnOnePage||!1;if(totalRecords_PQ%3E0){if(userChoseShowAllForQuery&&!batchModeActive_PQ){summaryText+=%60%20(%E5%85%A8%E9%83%A8%E9%A1%AF%E7%A4%BA%E6%96%BC%E6%9C%AC%E9%A0%81)%60}else%20if(batchModeActive_PQ||(!userChoseShowAllForQuery&&totalRecords_PQ%3E0)){const%20startRecord=((productListCurrentPage_PQ-1)*productListPageSize_PQ)+1;const%20endRecord=Math.min(productListCurrentPage_PQ*productListPageSize_PQ,totalRecords_PQ);summaryText+=%60%20(%E6%9C%AC%E9%A0%81%E9%A1%AF%E7%A4%BA%20${startRecord}%20-%20${endRecord}%20%E7%AD%86)%60}}infoSummarySpan.innerHTML=summaryText;summaryResearchDiv.appendChild(infoSummarySpan);if(batchModeActive_PQ){const%20batchPaginationDiv=document.createElement(%22div%22);batchPaginationDiv.className=%22pcr-batch-pagination_pq%22;batchPaginationDiv.innerHTML=%60%3Cbutton%20id=%22pcr_list_prev_pq_s%22%20${productListCurrentPage_PQ%20===%201%20?%20'disabled'%20:%20''}%3E%3C%3C%20%E4%B8%8A%E4%B8%80%E9%A0%81%3C/button%3E%3Cspan%3E%E7%AC%AC%20${productListCurrentPage_PQ}%20/%20${productListTotalPages_PQ}%20%E9%A0%81%3C/span%3E%3Cbutton%20id=%22pcr_list_next_pq_s%22%20${productListCurrentPage_PQ%20%3E=%20productListTotalPages_PQ%20?%20'disabled'%20:%20''}%3E%E4%B8%8B%E4%B8%80%E9%A0%81%20%3E%3E%3E%3C/button%3E%60;summaryResearchDiv.appendChild(batchPaginationDiv)}controlsHeader.appendChild(summaryResearchDiv);const%20buttonsGroupDiv=document.createElement(%22div%22);buttonsGroupDiv.className=%22pcr-buttons-group_pq%22;buttonsGroupDiv.innerHTML=%60%3Cbutton%20class=%22pcr-copy-all-btn%22%20id=%22pcr_copy_all_pq_s%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%3Cbutton%20class=%22pcr-query-data-btn%22%20id=%22pcr_query_data_pq_s%22%3E%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E8%B3%87%E6%96%99%3C/button%3E%3Cbutton%20class=%22pcr-reload-btn%22%20id=%22pcr_reload_pq_s%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%3Cbutton%20class=%22pcr-clear-results-btn%22%20id=%22pcr_clear_results_pq_s%22%3E%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C%3C/button%3E%60;controlsHeader.appendChild(buttonsGroupDiv);mainDiv.appendChild(controlsHeader);const%20tableContainer=document.createElement(%22div%22);tableContainer.className=%22pcr-table-container_pq%22;const%20tableEl=document.createElement(%22table%22);const%20headers=[{key:'_originalSequentialIndex',display:'No'},{key:'code',display:'%E4%BB%A3%E8%99%9F'},{key:'name',display:'%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1'},{key:'cur',display:'%E5%B9%A3%E5%88%A5'},{key:'unit',display:'%E5%96%AE%E4%BD%8D'},{key:'type',display:'%E9%A1%9E%E5%9E%8B'},{key:'start',display:'%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5'},{key:'end',display:'%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5'}];let%20headerHtml='%3Ctr%3E';headers.forEach(h=%3E{let%20i='';if(h.key===currentSortKey_PQ){i=currentSortDirection_PQ==='asc'?'%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%B2%3C/span%3E':'%20%3Cspan%20style=%22font-size:0.8em;%22%3E%E2%96%BC%3C/span%3E'}headerHtml+=%60%3Cth%20data-sort-key=%22${h.key}%22%3E${h.display}${i}%3C/th%3E%60});headerHtml+='%3C/tr%3E';let%20itemsToRenderInTable;const%20effectivelyShowAllDisplay=userChoseShowAllForQuery&&!batchModeActive_PQ;if(effectivelyShowAllDisplay){itemsToRenderInTable=productQueryResults_PQ}else{const%20s=(productListCurrentPage_PQ-1)*productListPageSize_PQ;itemsToRenderInTable=productQueryResults_PQ.slice(s,s+productListPageSize_PQ)}let%20tableBodyHtml=itemsToRenderInTable.map((p,idxInRendered)=%3E{const%20dNo=p._originalSequentialIndex!==undefined?p._originalSequentialIndex+1:(effectivelyShowAllDisplay?idxInRendered+1:((productListCurrentPage_PQ-1)*productListPageSize_PQ)+idxInRendered+1);return%20%60%3Ctr%20class=%22${p._isErrorRow?'pcr-error-row':''}%22%3E%3Ctd%20class=%22pcr-seq-cell%22%20data-plancode=%22${p.code||''}%22%20data-item-index-in-rendered-list=%22${idxInRendered}%22%20data-original-sequential-index=%22${p._originalSequentialIndex%20!==%20undefined%20?%20p._originalSequentialIndex%20:%20'-1'}%22%20data-fetched=%22${p._detailsFetched?'true':'false'}%22%3E${dNo}%3C/td%3E%3Ctd%20class=%22pcr-code-cell%22%20data-copy=%22${p.polplnEnrichedCodeForCopy||p.code||'-'}%22%20title=%22${escapeHtml_PQ(p.code||'-')}%22%3E${p.polplnDisplayText||escapeHtml_PQ(p.code||'-')}%3C/td%3E%3Ctd%20data-copy=%22${p.full||'-'}%22%20title=%22${escapeHtml_PQ(p.full||'-')}%22%3E${escapeHtml_PQ(p.name||'-')}%3C/td%3E%3Ctd%3E${escapeHtml_PQ(p.cur)}%3C/td%3E%3Ctd%3E${escapeHtml_PQ(p.unit)}%3C/td%3E%3Ctd%3E${escapeHtml_PQ(p.type)}%3C/td%3E%3Ctd%20data-copy=%22${p.start||'-'}%22%3E${escapeHtml_PQ(p.start||'-')}%3C/td%3E%3Ctd%20class=%22pcr-saledate-cell%22%20data-initial-copy=%22${escapeHtml_PQ(p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim())}%22%20data-copy=%22${p.channelEnrichedEndDateForCopy||p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}%22%20style=%22${p.applyYellowBgForDisplay?'background-color:yellow;':''}%22%3E${p.channelDisplayHtml||p.originalEndDisplay}%3C/td%3E%3C/tr%3E%60}).join('');tableEl.innerHTML=%60%3Cthead%3E${headerHtml}%3C/thead%3E%3Ctbody%3E${tableBodyHtml}%3C/tbody%3E%60;tableContainer.appendChild(tableEl);mainDiv.appendChild(tableContainer);document.body.appendChild(mainDiv);titleBar.onmousedown=(e)=%3E{if(e.target.classList.contains('pcr-window-close-btn'))return;mainUIDraggableState_PQ.dragging=!0;mainUIDraggableState_PQ.startX=e.clientX-mainDiv.offsetLeft;mainUIDraggableState_PQ.startY=e.clientY-mainDiv.offsetTop;titleBar.style.cursor='grabbing';document.onmousemove=(m)=%3E{if(!mainUIDraggableState_PQ.dragging)return;mainDiv.style.left=(m.clientX-mainUIDraggableState_PQ.startX)+'px';mainDiv.style.top=(m.clientY-mainUIDraggableState_PQ.startY)+'px'};document.onmouseup=()=%3E{mainUIDraggableState_PQ.dragging=!1;titleBar.style.cursor='grab';document.onmousemove=null;document.onmouseup=null}};if(batchModeActive_PQ){const%20pB=mainDiv.querySelector(%22#pcr_list_prev_pq_s%22),nB=mainDiv.querySelector(%22#pcr_list_next_pq_s%22);if(pB)pB.onclick=async()=%3E{if(productListCurrentPage_PQ%3E1)await%20fetchProductListPage_PQ(productListCurrentPage_PQ-1)};if(nB)nB.onclick=async()=%3E{if(productListCurrentPage_PQ%3CproductListTotalPages_PQ)await%20fetchProductListPage_PQ(productListCurrentPage_PQ+1)}};mainDiv.querySelector(%22#pcr_copy_all_pq_s%22).onclick=handleCopyAll_PQ;mainDiv.querySelector(%22#pcr_query_data_pq_s%22).onclick=handleQueryAllData_PQ;mainDiv.querySelector(%22#pcr_reload_pq_s%22).onclick=handleReload_PQ;mainDiv.querySelector(%22#pcr_clear_results_pq_s%22).onclick=()=%3E{handleCloseMainUI_PQ()};mainDiv.querySelectorAll(%22table%20thead%20th[data-sort-key]%22).forEach(th=%3Eth.onclick=()=%3EhandleSortRequest_PQ(th.dataset.sortKey));mainDiv.querySelectorAll(%22td[data-copy]:not(.pcr-code-cell):not(.pcr-saledate-cell)%22).forEach(el=%3E{el.onclick=()=%3E{navigator.clipboard.writeText(el.dataset.copy);displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1e3)}});mainDiv.querySelectorAll(%22td.pcr-code-cell,%20td.pcr-saledate-cell%22).forEach(el=%3E{el.onclick=()=%3E{let%20t=el.dataset.copy||el.dataset.initialCopy||el.innerText;navigator.clipboard.writeText(t.replace(/\n%3Cbr\s*\/?%3E/gi,%22\n%22).replace(/%3Cbr\s*\/?%3E/gi,%22%20/%20%22).replace(/%3C[^%3E]*%3E/g,%22%22));displaySystemNotification_PQ(%22%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81%22,!1,1e3)}});mainDiv.querySelectorAll(%22.pcr-seq-cell%22).forEach(c=%3E{c.onclick=async%20function(){await%20handleSeqCellClick_PQ(this)}});document.addEventListener('keydown',mainUIEscListener_PQ);console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20renderMainResultsUI_PQ:%20UI%20%E6%B8%B2%E6%9F%93%E5%AE%8C%E7%95%A2%E3%80%82%22)}async%20function%20handleSeqCellClick_PQ(cellElement){const%20originalSequentialIndex=parseInt(cellElement.dataset.originalSequentialIndex);const%20productItem=productQueryResults_PQ.find(p=%3Ep._originalSequentialIndex===originalSequentialIndex);if(!productItem){console.error(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleSeqCellClick_PQ:%20%E6%89%BE%E4%B8%8D%E5%88%B0%E5%95%86%E5%93%81%20for%20originalSequentialIndex:%22,originalSequentialIndex);displaySystemNotification_PQ(%22%E7%84%A1%E6%B3%95%E6%89%BE%E5%88%B0%E5%B0%8D%E6%87%89%E5%95%86%E5%93%81%E8%B3%87%E6%96%99%E3%80%82%22,!0);return}console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleSeqCellClick_PQ:%20Item%20No.${originalSequentialIndex%20+%201},%20Code:%20${productItem.code},%20Fetched:%20${productItem._detailsFetched}%60);if(productItem._detailsFetched){let%20h=headersForCopy_PQ().join(%22\t%22)+%22\n%22,r=cellElement.parentNode,cs=Array.from(r.querySelectorAll(%22td%22)),rc=headersForCopy_PQ().map((k,x)=%3E{let%20ct=cs[x]?cs[x].innerText:'';if(k==='%E4%BB%A3%E8%99%9F')ct=productItem.polplnEnrichedCodeForCopy||productItem.code||%22-%22;if(k==='%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5')ct=productItem.channelEnrichedEndDateForCopy||productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();return(ct||%22%22).replace(/\s+/g,%22%20%22).replace(/\n/g,%22%20/%20%22)}).join(%22\t%22);navigator.clipboard.writeText(h+rc.trim());displaySystemNotification_PQ(%60%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(No.${productItem._originalSequentialIndex+1})%E5%B7%B2%E8%A4%87%E8%A3%BD(%E5%90%AB%E8%A1%A8%E9%A0%AD)%EF%BC%81%60,!1,1500);return}cellElement.style.cursor=%22wait%22;const%20cNo=cellElement.textContent.match(/^\d+/);cellElement.textContent=%60${cNo?cNo[0]:'?'}%20(%E6%9F%A5...)%60;const%20oSNo=cellElement.textContent.replace(%22%20(%E6%9F%A5...)%22,%22%22);const%20codeCell=cellElement.parentNode.querySelector(%22.pcr-code-cell%22),saleDateCell=cellElement.parentNode.querySelector(%22.pcr-saledate-cell%22);displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,0);const[detailRes,saleDateRes]=await%20Promise.all([callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:20},currentApiUrls_PQ.planCodeDetail),callProductApi_PQ(apiAuthToken_PQ,{planCode:productItem.code,pageNo:1,pageSize:50},currentApiUrls_PQ.saleDateQuery)]);const%20cT=document.getElementById('pqToolNotification_S_v2');if(cT&&cT.innerText.includes(%60%E6%9F%A5%E8%A9%A2%20${productItem.code}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60))cT.remove();displaySystemNotification_PQ(%22%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%AE%8C%E7%95%A2%E3%80%82%22,!1,1e3);cellElement.textContent=oSNo;let%20pTxt=%22-%22;if(detailRes&&detailRes.records&&detailRes.records.length%3E0)pTxt=processMultiplePolpln_PQ(detailRes.records.map(r=%3Er.polpln));let%20cDHtml=escapeHtml_PQ(productItem.code||%22-%22),cCToCl=productItem.code||%22-%22;if(detailRes&&detailRes.error){cDHtml+=%60%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3EPOLPLN:%20${detailRes.message||detailRes.error}%3C/span%3E%60}else%20if(pTxt!==%22-%22&&pTxt!==%22%22){cDHtml=%60${escapeHtml_PQ(productItem.code||%22-%22)}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${escapeHtml_PQ(pTxt)}%3C/span%3E%60;cCToCl=%60${productItem.code||%22-%22}\n${pTxt}%60}productItem.polplnDisplayText=cDHtml;productItem.polplnEnrichedCodeForCopy=cCToCl;if(codeCell){codeCell.innerHTML=cDHtml;codeCell.dataset.copy=cCToCl}const%20chanInfo=formatChannelSalesInfo_PQ(saleDateRes,productItem.code,productItem.originalEndDisplay,productItem.isStillSelling);productItem.channelDisplayHtml=chanInfo.html;productItem.channelEnrichedEndDateForCopy=chanInfo.copyText;productItem.applyYellowBgForDisplay=chanInfo.applyYellowBg;if(saleDateCell){if(saleDateRes&&saleDateRes.error){saleDateCell.innerHTML=%60${productItem.originalEndDisplay}%3Cbr%3E%3Cspan%20style=%22color:orange;font-size:0.9em;font-style:italic;%22%3E%E9%80%9A%E8%B7%AF:%20${saleDateRes.message||saleDateRes.error}%3C/span%3E%60;saleDateCell.dataset.copy=productItem.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()}else{saleDateCell.innerHTML=chanInfo.html;saleDateCell.dataset.copy=chanInfo.copyText;saleDateCell.style.backgroundColor=chanInfo.applyYellowBg?%22yellow%22:%22%22}}cellElement.dataset.fetched=%22true%22;cellElement.style.color=%22#28a745%22;cellElement.style.cursor=%22copy%22;productItem._detailsFetched=!0}function%20headersForCopy_PQ(){return['No','%E4%BB%A3%E8%99%9F','%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1','%E5%B9%A3%E5%88%A5','%E5%96%AE%E4%BD%8D','%E9%A1%9E%E5%9E%8B','%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5','%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5']}const%20mainUIEscListener_PQ=(e)=%3E{if(e.key===%22Escape%22&&!document.querySelector('[id$=%22_overlay_pq%22]')){handleCloseMainUI_PQ()}};function%20handleCopyAll_PQ(){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleCopyAll_PQ:%20Initiated.%22);let%20tsv=headersForCopy_PQ().join(%22\t%22)+%22\n%22;const%20uCSAQ=currentQueryParameters_PQ.showAllOnOnePage||!1;let%20iTC;if(uCSAQ){iTC=productQueryResults_PQ;console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleCopyAll_PQ:%20Copying%20ALL%20fetched%20results:%22,iTC.length,%22items%22)}else{const%20s=(productListCurrentPage_PQ-1)*productListPageSize_PQ;iTC=productQueryResults_PQ.slice(s,s+productListPageSize_PQ);console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleCopyAll_PQ:%20Copying%20CURRENT%20PAGE%20(${productListCurrentPage_PQ})%20results:%60,iTC.length,%22items%20from%20master%20list%20of%22,productQueryResults_PQ.length)}if(!iTC||iTC.length===0){displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E8%B3%87%E6%96%99%E5%8F%AF%E8%A4%87%E8%A3%BD%E3%80%82%22,!0);return}iTC.forEach(p=%3E{let%20cD=p.polplnEnrichedCodeForCopy||p.code||%22-%22,sDD=p.channelEnrichedEndDateForCopy||p.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();const%20rV=[(p._originalSequentialIndex!==undefined?p._originalSequentialIndex+1:'-').toString(),(cD||%22%22).replace(/\n/g,%22%20/%20%22),escapeHtml_PQ(p.full||%22-%22),escapeHtml_PQ(p.cur||%22-%22),escapeHtml_PQ(p.unit||%22-%22),escapeHtml_PQ(p.type||%22-%22),escapeHtml_PQ(p.start||%22-%22),(sDD||%22%22).replace(/\n/g,%22%20/%20%22)];tsv+=rV.join(%22\t%22)+%22\n%22});navigator.clipboard.writeText(tsv.trim());displaySystemNotification_PQ(%60%E5%85%B1%20${iTC.length}%20%E7%AD%86%E8%B3%87%E6%96%99%E5%B7%B2%E8%A4%87%E8%A3%BD%20(TSV%E6%A0%BC%E5%BC%8F)%EF%BC%81%60,!1,2500)}async%20function%20handleQueryAllData_PQ(){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20Initiated.%22);const%20mainUITable=document.getElementById(MAIN_UI_ID_PQ);if(!mainUITable){displaySystemNotification_PQ(%22%E8%A1%A8%E6%A0%BC%E4%B8%8D%E5%AD%98%E5%9C%A8%E3%80%82%22,!0);return}const%20userChoseShowAllForQuery=currentQueryParameters_PQ.showAllOnOnePage||!1;let%20itemsEffectivelyInProductQueryResults=productQueryResults_PQ.length;let%20itemsForDetailProcessing,notificationMessage,currentlyDisplayedItemsCount;const%20effectivelyShowAllDisplay=userChoseShowAllForQuery&&!batchModeActive_PQ;if(effectivelyShowAllDisplay){currentlyDisplayedItemsCount=productQueryResults_PQ.length}else{currentlyDisplayedItemsCount=itemsEffectivelyInProductQueryResults%3E0?Math.min(productListPageSize_PQ,itemsEffectivelyInProductQueryResults-((productListCurrentPage_PQ-1)*productListPageSize_PQ)):0}console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20userChoseShowAllForQuery=${userChoseShowAllForQuery},%20itemsInMasterList=${itemsEffectivelyInProductQueryResults},%20effectivelyShowAllDisplay=${effectivelyShowAllDisplay},%20currentlyDisplayedItemsCount=${currentlyDisplayedItemsCount}%60);if(currentlyDisplayedItemsCount===0){displaySystemNotification_PQ(%22%E6%9C%AC%E9%A0%81%E6%B2%92%E6%9C%89%E5%8F%AF%E6%9F%A5%E8%A9%A2%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E7%9A%84%E5%95%86%E5%93%81%E3%80%82%22,!0);return}if(userChoseShowAllForQuery&&!batchModeActive_PQ&&itemsEffectivelyInProductQueryResults%3EdetailFetchSwitchThreshold_PQ){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20Switching%20to%20paginated%20display%20due%20to%20%3E300%20items%20in%20showAll%20mode.%22);displaySystemNotification_PQ(%60%E8%B3%87%E6%96%99%E9%87%8F%E8%B6%85%E9%81%8E%20${detailFetchSwitchThreshold_PQ}%20%E7%AD%86%20(%E5%85%B1%20${itemsEffectivelyInProductQueryResults}%20%E7%AD%86)%EF%BC%8C%E5%B7%B2%E5%88%87%E6%8F%9B%E7%82%BA%E5%88%86%E9%A0%81%E9%A1%AF%E7%A4%BA%E6%A8%A1%E5%BC%8F%E3%80%82\n%E6%AD%A3%E5%9C%A8%E6%9F%A5%E8%A9%A2%E7%AC%AC%E4%B8%80%E9%A0%81%20(1-${productListPageSize_PQ}%E7%AD%86)%20%E7%9A%84%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60,!1,4500);productListCurrentPage_PQ=1;batchModeActive_PQ=!0;productListTotalPages_PQ=Math.ceil(totalRecords_PQ/productListPageSize_PQ);renderMainResultsUI_PQ();itemsForDetailProcessing=productQueryResults_PQ.slice(0,productListPageSize_PQ);notificationMessage=%60%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E7%AC%AC%201%20%E9%A0%81%20(${itemsForDetailProcessing.length}%E7%AD%86)%20%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60}else{if(effectivelyShowAllDisplay){itemsForDetailProcessing=productQueryResults_PQ}else{const%20s=(productListCurrentPage_PQ-1)*productListPageSize_PQ;itemsForDetailProcessing=productQueryResults_PQ.slice(s,s+productListPageSize_PQ)}notificationMessage=%60%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%20${itemsForDetailProcessing.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99...%60}if(!itemsForDetailProcessing||itemsForDetailProcessing.length===0){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20No%20items%20for%20detail%20processing%20after%20logic.%22);displaySystemNotification_PQ(%22%E6%B2%92%E6%9C%89%E5%95%86%E5%93%81%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E3%80%82%22,!1);return}console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20Processing%20${itemsForDetailProcessing.length}%20items%20for%20details.%60);displaySystemNotification_PQ(notificationMessage,!1,0);let%20sC=0;for(let%20i=0;i%3CitemsForDetailProcessing.length;i++){const%20pItem=itemsForDetailProcessing[i];const%20seqCell=mainUITable.querySelector(%60.pcr-seq-cell[data-original-sequential-index=%22${pItem._originalSequentialIndex}%22]%60);if(seqCell){if(!pItem._detailsFetched&&!pItem._isErrorRow){await%20handleSeqCellClick_PQ(seqCell);sC++}}else{console.warn(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleQueryAllData_PQ:%20Could%20not%20find%20seqCell%20for%20originalSequentialIndex:%22,pItem._originalSequentialIndex,pItem)}}const%20cDPToast=document.getElementById('pqToolNotification_S_v2');if(cDPToast&&cDPToast.innerText.startsWith(%22%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%22))cDPToast.remove();if(sC%3E0){displaySystemNotification_PQ(%60%E6%9C%AC%E6%89%B9%20${sC}%20%E7%AD%86%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E5%B7%B2%E6%9B%B4%E6%96%B0%E3%80%82%60,!1,2e3)}else{displaySystemNotification_PQ(%22%E6%9C%AC%E6%89%B9%E5%95%86%E5%93%81%E8%A9%B3%E7%B4%B0%E8%B3%87%E6%96%99%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E4%BB%BB%E4%BD%95%E6%9B%B4%E6%96%B0%E9%A0%85%E7%9B%AE%E3%80%82%22,!1,2e3)}}function%20handleReload_PQ(){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleReload_PQ:%20Reloading%20query%20setup.%22);displaySystemNotification_PQ(%22%E6%BA%96%E5%82%99%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2...%22,!1,1000);handleCloseMainUI_PQ(!1);productQueryResults_PQ=[];totalRecords_PQ=0;currentQueryParameters_PQ={};keywordSearchTerm_PQ=%22%22;planCodesToSearch_PQ=[];productListCurrentPage_PQ=1;productListTotalPages_PQ=1;batchModeActive_PQ=!1;autoFetchDetailsAfterLoad_PQ=!1;currentSortKey_PQ=null;currentSortDirection_PQ='none';document.removeEventListener('keydown',mainUIEscListener_PQ);setTimeout(async()=%3E{const%20querySetupResult=await%20createQuerySetupDialog_PQ();if(!querySetupResult){displaySystemNotification_PQ('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88',!0);tokenStatus_PQ='initial';return}await%20processQuerySetupAndExecute_PQ(querySetupResult)},50)}function%20handleCloseMainUI_PQ(removeEscListener=!0){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20handleCloseMainUI_PQ:%20Closing%20main%20UI.%22);document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();if(removeEscListener){document.removeEventListener('keydown',mainUIEscListener_PQ)}}async%20function%20fetchProductListPage_PQ(pageToFetch){console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20Fetching%20page%20${pageToFetch}.%20Current%20query%20mode:%20${currentQueryParameters_PQ.queryMode}%60);if(pageToFetch===1&&!(currentQueryParameters_PQ.showAllOnOnePage||!1)){}const%20userChoseShowAllForQuery=currentQueryParameters_PQ.showAllOnOnePage||!1;let%20effectivePageNo=userChoseShowAllForQuery?1:pageToFetch;let%20queryPayload={...currentQueryParameters_PQ,pageNo:effectivePageNo};if('codes'%20in%20queryPayload){delete%20queryPayload.planCodeName}else%20if('planCodeName'%20in%20queryPayload){delete%20queryPayload.codes}delete%20queryPayload.showAllOnOnePage;delete%20queryPayload.queryMode;let%20loadingMessage=%22%E6%9F%A5%E8%A9%A2%E4%B8%AD%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...%22;if(userChoseShowAllForQuery&&effectivePageNo===1){loadingMessage=%60%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%E5%95%86%E5%93%81%20(%E6%9C%80%E5%A4%9A%20${queryPayload.pageSize}%20%E7%AD%86)%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...%60}else%20if(!userChoseShowAllForQuery&&effectivePageNo%3E1){loadingMessage=%60%E6%AD%A3%E5%9C%A8%E8%BC%89%E5%85%A5%E7%AC%AC%20${effectivePageNo}%20%E9%A0%81...%60}displaySystemNotification_PQ(loadingMessage,!1,0);console.log('[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20%E6%9C%80%E7%B5%82%E7%99%BC%E9%80%81%E7%B5%A6%20API%20%E7%9A%84%E8%AB%8B%E6%B1%82%E5%85%A7%E5%AE%B9%20(Payload):',JSON.stringify(queryPayload));const%20apiResponse=await%20callProductApi_PQ(apiAuthToken_PQ,queryPayload,currentApiUrls_PQ.planCodeQuery);console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20API%20%E5%B0%8D%E6%96%BC%E7%AC%AC%20${effectivePageNo}%20%E9%A0%81%E7%9A%84%E5%9B%9E%E6%87%89%20(%E5%89%8D500%E5%AD%97%E5%85%83):%20${apiResponse%20?%20JSON.stringify(apiResponse).substring(0,%20500)%20+%20(JSON.stringify(apiResponse).length%20%3E%20500%20?%20'...'%20:%20'')%20:%20'null/undefined'}%60);const%20loadingToast=document.getElementById('pqToolNotification_S_v2');if(loadingToast&&loadingToast.innerText===loadingMessage){loadingToast.remove()}if(apiResponse&&apiResponse.error==='TOKEN_INVALID'){if(tokenStatus_PQ===%22skipped_by_user%22&&apiAuthToken_PQ===null){displaySystemNotification_PQ(%22%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97%EF%BC%9ATOKEN%20%E6%9C%AA%E6%8F%90%E4%BE%9B%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}apiAuthToken_PQ=null;localStorage.removeItem(TOKEN_STORAGE_KEY_PQ);localStorage.removeItem(TOKEN_STORAGE_KEY_PQ_FALLBACK);displaySystemNotification_PQ(%22TOKEN%20%E5%B7%B2%E5%A4%B1%E6%95%88%E6%88%96%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%E3%80%82%22,!0,0);const%20o=await%20solicitNewToken_PQ();if(o===null){tokenStatus_PQ=%22failed_solicitation%22}else%20if(o==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E5%86%8D%E6%AC%A1%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1);displaySystemNotification_PQ(%22TOKEN%E7%8B%80%E6%85%8B%E5%B7%B2%E8%AE%8A%E6%9B%B4%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E6%93%8D%E4%BD%9C%E3%80%82%22,!1,3e3)}else{apiAuthToken_PQ=o;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ(%22%E6%96%B0%20TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E5%9F%B7%E8%A1%8C%E6%9F%A5%E8%A9%A2%E3%80%82%22,!1,3e3)}productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}else%20if(apiResponse&&apiResponse.error){displaySystemNotification_PQ(apiResponse.message||%22%E6%9F%A5%E8%A9%A2%E6%99%82%E7%99%BC%E7%94%9F%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4%E3%80%82%22,!0,3000);productQueryResults_PQ=[];totalRecords_PQ=0;renderMainResultsUI_PQ();return}if(apiResponse&&apiResponse.records){if(effectivePageNo===1||userChoseShowAllForQuery){totalRecords_PQ=apiResponse.totalRecords!==undefined?apiResponse.totalRecords:apiResponse.records.length;console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20%E6%9B%B4%E6%96%B0%20totalRecords_PQ%20=%20${totalRecords_PQ}%60)}const%20firstItemAbsoluteIndexOnThisPage=userChoseShowAllForQuery?0:(effectivePageNo-1)*productListPageSize_PQ;productQueryResults_PQ=apiResponse.records.map((rec,idxInPage)=%3EtransformProductData_PQ(rec,firstItemAbsoluteIndexOnThisPage+idxInPage));console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20productQueryResults_PQ%20%E6%9B%B4%E6%96%B0%EF%BC%8C%E7%AD%86%E6%95%B8:%20${productQueryResults_PQ.length}%60)}else{if(effectivePageNo===1||userChoseShowAllForQuery)totalRecords_PQ=0;productQueryResults_PQ=[];console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20API%20%E5%9B%9E%E6%87%89%E7%84%A1%E8%A8%98%E9%8C%84%E6%88%96%E9%8C%AF%E8%AA%A4%EF%BC%8CproductQueryResults_PQ%20%E6%B8%85%E7%A9%BA,%20totalRecords_PQ%20=%22,totalRecords_PQ)}productListCurrentPage_PQ=userChoseShowAllForQuery?1:effectivePageNo;productListTotalPages_PQ=userChoseShowAllForQuery?1:(totalRecords_PQ%3E0?Math.ceil(totalRecords_PQ/productListPageSize_PQ):1);batchModeActive_PQ=(!userChoseShowAllForQuery&&totalRecords_PQ%3EproductListPageSize_PQ);console.log(%60[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20productListCurrentPage_PQ=${productListCurrentPage_PQ},%20productListTotalPages_PQ=${productListTotalPages_PQ},%20batchModeActive_PQ=${batchModeActive_PQ}%60);renderMainResultsUI_PQ();console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20UI%20%E6%87%89%E5%B7%B2%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E3%80%82%22);if(userChoseShowAllForQuery){displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%20${totalRecords_PQ}%20%E7%AD%86${totalRecords_PQ%20%3E%200%20?%20'%EF%BC%8C%E5%B7%B2%E5%85%A8%E9%83%A8%E9%A1%AF%E7%A4%BA%E6%96%BC%E6%9C%AC%E9%A0%81%E3%80%82'%20:%20''}%60,!1,(totalRecords_PQ%3E0?2500:3500))}else{if(effectivePageNo===1&&totalRecords_PQ===0){displaySystemNotification_PQ(%22%E6%9F%A5%E7%84%A1%E7%AC%A6%E5%90%88%E5%95%86%E5%93%81%E3%80%82%22,!1,3000)}else%20if(effectivePageNo===1&&batchModeActive_PQ){displaySystemNotification_PQ(%60%E7%B5%90%E6%9E%9C%E5%85%B1%20${totalRecords_PQ}%20%E7%AD%86%E3%80%82%E6%AF%8F%E9%A0%81%E9%A1%AF%E7%A4%BA%20${productListPageSize_PQ}%20%E7%AD%86%E3%80%82%60,!1,2500)}else%20if(effectivePageNo===1){displaySystemNotification_PQ(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%81%E5%85%B1%20${totalRecords_PQ}%20%E7%AD%86%E3%80%82%60,!1,2500)}else%20if(batchModeActive_PQ){displaySystemNotification_PQ(%60%E5%B7%B2%E8%BC%89%E5%85%A5%E7%AC%AC%20${productListCurrentPage_PQ}%20/%20${productListTotalPages_PQ}%20%E9%A0%81%E3%80%82%60,!1,2000)}}if(autoFetchDetailsAfterLoad_PQ&&productQueryResults_PQ.length%3E0){autoFetchDetailsAfterLoad_PQ=!1;console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20%E8%A7%B8%E7%99%BC%20autoFetchDetailsAfterLoad_PQ%22);const%20aFTId='pqAutoFetchNotify';displaySystemNotification_PQ(%60%E6%AD%A3%E5%9C%A8%E8%87%AA%E5%8B%95%E7%8D%B2%E5%8F%96%E6%9C%AC%E9%A0%81%20${productQueryResults_PQ.length}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99...%60,!1,0);await%20handleQueryAllData_PQ();const%20aT=document.getElementById('pqToolNotification_S_v2');if(aT&&aT.innerText.includes(%22%E8%A9%B3%E7%B4%B0%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%22))aT.remove();displaySystemNotification_PQ(%22%E6%9C%AC%E9%A0%81%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E8%B3%87%E6%96%99%E5%B7%B2%E8%BC%89%E5%85%A5%E3%80%82%22,!1,2500)}console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20fetchProductListPage_PQ:%20%E5%9F%B7%E8%A1%8C%E5%AE%8C%E7%95%A2%E3%80%82%22)}async%20function%20processQuerySetupAndExecute_PQ(querySetupResult){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ%20%E6%94%B6%E5%88%B0:%22,JSON.stringify(querySetupResult));productListCurrentPage_PQ=1;autoFetchDetailsAfterLoad_PQ=!1;currentSortKey_PQ=null;currentSortDirection_PQ='none';const%20effectivePageSize=querySetupResult.showAllOnOnePage?maxProductListPageSize_PQ:productListPageSize_PQ;let%20baseParams={pageNo:productListCurrentPage_PQ,pageSize:effectivePageSize,showAllOnOnePage:querySetupResult.showAllOnOnePage,queryMode:querySetupResult.queryMode};if(querySetupResult.queryMode==='planCode'){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E8%99%95%E7%90%86%20planCode%20%E6%A8%A1%E5%BC%8F%EF%BC%8C%E8%BC%B8%E5%85%A5%E5%80%BC:%22,querySetupResult.inputValue);const%20planCodes=querySetupResult.inputValue.split(/[\s,;]+/).map(c=%3Ec.trim().toUpperCase()).filter(Boolean).map(c=%3Ec.slice(0,4));console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E8%99%95%E7%90%86%E5%BE%8C%E7%9A%84%20planCodes%20%E9%99%A3%E5%88%97:%22,JSON.stringify(planCodes));if(planCodes.length===0){displaySystemNotification_PQ(%22%E6%9C%AA%E8%BC%B8%E5%85%A5%E6%9C%89%E6%95%88%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%EF%BC%81%22,!0);console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E5%9B%A0%20planCodes%20%E7%82%BA%E7%A9%BA%EF%BC%8C%E6%9F%A5%E8%A9%A2%E4%B8%AD%E6%AD%A2%E3%80%82%22);return}currentQueryParameters_PQ={...baseParams,codes:planCodes};console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E8%A8%AD%E5%AE%9A%20currentQueryParameters_PQ%20(planCode%E6%A8%A1%E5%BC%8F):%22,JSON.stringify(currentQueryParameters_PQ))}else%20if(querySetupResult.queryMode==='planCodeName'){const%20k=querySetupResult.inputValue.trim().split(/[\s,;]+/)[0];if(!k){displaySystemNotification_PQ(%22%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E4%B8%8D%E5%8F%AF%E7%82%BA%E7%A9%BA%EF%BC%81%22,!0);return}currentQueryParameters_PQ={...baseParams,planCodeName:k,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='allPlans'){currentQueryParameters_PQ={...baseParams,planCodeName:%22%22,orderBy:%22planCode%20asc%22}}else%20if(querySetupResult.queryMode==='inSaleWithDetails'){currentQueryParameters_PQ={...baseParams,saleEndDate:%229999-12-31%2000:00:00%22,planCodeName:%22%22,orderBy:%22planCode%20asc%22};autoFetchDetailsAfterLoad_PQ=!0}else{displaySystemNotification_PQ(%22%E6%9C%AA%E7%9F%A5%E7%9A%84%E6%9F%A5%E8%A9%A2%E6%A8%A1%E5%BC%8F%E3%80%82%22,!0);console.error(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E6%9C%AA%E7%9F%A5%E7%9A%84%E6%9F%A5%E8%A9%A2%E6%A8%A1%E5%BC%8F:%22,querySetupResult.queryMode);return}console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20%E6%BA%96%E5%82%99%E5%91%BC%E5%8F%AB%20fetchProductListPage_PQ(1)%22);await%20fetchProductListPage_PQ(1);console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20processQuerySetupAndExecute_PQ:%20fetchProductListPage_PQ(1)%20%E5%9F%B7%E8%A1%8C%E5%AE%8C%E7%95%A2%22)}async%20function%20solicitNewToken_PQ(attempt=1){const%20tokenResult=await%20createTokenDialog_PQ(attempt);if(tokenResult==='_close_tool_pq_'||tokenResult==='_token_dialog_cancel_pq_'){displaySystemNotification_PQ(tokenResult==='_close_tool_pq_'?'%E5%B7%A5%E5%85%B7%E5%B7%B2%E9%97%9C%E9%96%89':'Token%20%E8%BC%B8%E5%85%A5%E5%B7%B2%E5%8F%96%E6%B6%88',!0);return%20null}if(tokenResult==='_skip_token_pq_'){return'_skip_token_pq_'}const%20trimmedToken=normalizeInput_PQ(tokenResult||%22%22);if(trimmedToken){return%20trimmedToken}else{displaySystemNotification_PQ('TOKEN%20%E6%9C%AA%E8%BC%B8%E5%85%A5%E3%80%82',!0);if(attempt%3C3){return%20await%20solicitNewToken_PQ(attempt+1)}else{displaySystemNotification_PQ('TOKEN%20%E5%A4%9A%E6%AC%A1%E8%BC%B8%E5%85%A5%E7%84%A1%E6%95%88%E3%80%82',!0);return%20null}}}async%20function%20executeProductQueryTool(){console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20executeProductQueryTool:%20%E9%96%8B%E5%A7%8B%E5%9F%B7%E8%A1%8C%EF%BC%8C%E9%87%8D%E7%BD%AE%E7%8B%80%E6%85%8B...%22);apiAuthToken_PQ=null;tokenStatus_PQ=%22initial%22;productQueryResults_PQ=[];totalRecords_PQ=0;currentQueryParameters_PQ={};productListCurrentPage_PQ=1;productListTotalPages_PQ=1;batchModeActive_PQ=!1;currentSortKey_PQ=null;currentSortDirection_PQ='none';autoFetchDetailsAfterLoad_PQ=!1;mainUIDraggableState_PQ={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};document.getElementById(MAIN_UI_ID_PQ)?.remove();document.getElementById(CSS_ID_PQ)?.remove();document.getElementById(%22pcrBookMarkletDivV17%22)?.remove();document.getElementById(%22pcrBookMarkletCssV17%22)?.remove();document.getElementById('pqToolNotification_S_v2')?.remove();['pqEnvSelect_S_v2','pqToken_S_v2','pqQuerySetup_S_v2'].forEach(idBase=%3E{document.getElementById(idBase+'_overlay_pq')?.remove()});console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20executeProductQueryTool:%20%E7%8B%80%E6%85%8B%E9%87%8D%E7%BD%AE%E5%92%8C%E8%88%8AUI%E6%B8%85%E7%90%86%E5%AE%8C%E7%95%A2%E3%80%82%22);const%20selectedEnv=await%20createEnvSelectionDialog_PQ();if(!selectedEnv){displaySystemNotification_PQ('%E7%92%B0%E5%A2%83%E9%81%B8%E6%93%87%E5%B7%B2%E5%8F%96%E6%B6%88%E3%80%82%E5%B7%A5%E5%85%B7%E4%B8%AD%E6%AD%A2%E3%80%82',!0,3000);tokenStatus_PQ=%22initial%22;return}currentApiUrls_PQ=API_URL_TEMPLATES_PQ[selectedEnv];displaySystemNotification_PQ(%60%E7%92%B0%E5%A2%83%E5%B7%B2%E8%A8%AD%E7%82%BA:%20${selectedEnv.toUpperCase()}%60,!1,1500);apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ);if(!apiAuthToken_PQ){apiAuthToken_PQ=localStorage.getItem(TOKEN_STORAGE_KEY_PQ_FALLBACK)}if(!apiAuthToken_PQ){const%20tokenOutcome=await%20solicitNewToken_PQ();if(tokenOutcome===null){tokenStatus_PQ=%22failed_solicitation%22;displaySystemNotification_PQ('%E6%9C%AA%E6%8F%90%E4%BE%9B%E6%9C%89%E6%95%88TOKEN%EF%BC%8C%E5%B7%A5%E5%85%B7%E4%B8%AD%E6%AD%A2%E3%80%82',!0,3000);return}else%20if(tokenOutcome==='_skip_token_pq_'){apiAuthToken_PQ=null;tokenStatus_PQ=%22skipped_by_user%22;displaySystemNotification_PQ('%E5%B7%B2%E7%95%A5%E9%81%8ETOKEN%E8%BC%B8%E5%85%A5%20(%E6%9F%A5%E8%A9%A2%E5%8F%AF%E8%83%BD%E5%A4%B1%E6%95%97)',!1,2e3)}else{apiAuthToken_PQ=tokenOutcome;tokenStatus_PQ=%22valid%22;localStorage.setItem(TOKEN_STORAGE_KEY_PQ,apiAuthToken_PQ);displaySystemNotification_PQ('TOKEN%20%E5%B7%B2%E8%A8%AD%E5%AE%9A%E3%80%82',!1,1500)}}else{tokenStatus_PQ=%22valid%22;displaySystemNotification_PQ('%E5%B7%B2%E5%BE%9E%E6%9C%AC%E5%9C%B0%E8%BC%89%E5%85%A5%20TOKEN%E3%80%82',!1,1500)}const%20querySetupResult=await%20createQuerySetupDialog_PQ();if(!querySetupResult){displaySystemNotification_PQ('%E6%9F%A5%E8%A9%A2%E8%A8%AD%E5%AE%9A%E5%B7%B2%E5%8F%96%E6%B6%88%E3%80%82%E5%B7%A5%E5%85%B7%E4%B8%AD%E6%AD%A2%E3%80%82',!0,3000);return}await%20processQuerySetupAndExecute_PQ(querySetupResult);console.log(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20executeProductQueryTool:%20%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E5%9F%B7%E8%A1%8C%E5%AE%8C%E7%95%A2%E3%80%82%22)}try{await%20executeProductQueryTool()}catch(err){console.error(%22[%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E8%85%B3%E6%9C%AC]%20%E6%9C%80%E5%A4%96%E5%B1%A4%E5%9F%B7%E8%A1%8C%E9%8C%AF%E8%AA%A4:%22,err);alert(%22%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E5%B7%A5%E5%85%B7%E8%85%B3%E6%9C%AC%E5%9F%B7%E8%A1%8C%E6%99%82%E7%99%BC%E7%94%9F%E5%9A%B4%E9%87%8D%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%A9%B3%E8%A6%8B%E6%8E%A7%E5%88%B6%E5%8F%B0%E3%80%82\n%22+(err.message||err))}})()

javascript:(function(){'use strict';const CONFIG={API:{PROD:"https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisbq/api/",UAT:"https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisbq/api/",ENDPOINTS:{planCodeQuery:"planCodeController/query",planCodeDetail:"planCodeController/queryDetail",saleDateQuery:"planCodeSaleDateController/query"}},STORAGE:{TOKEN_KEY:"euisPlanCodeToken_v2",TOKEN_FALLBACK:'euisToken'},UI:{MAIN_ID:"planCodeQueryTool_v2",CSS_ID:"planCodeQueryCss_v2",Z_INDEX:{MAIN:999999,OVERLAY:1000000,NOTIFICATION:1000001}},LIMITS:{PAGE_SIZE:5000,BATCH_SIZE:50},MASTER_DATA:{CUR:{1:"TWD",2:"USD",3:"AUD",4:"CNT",5:"USD"},UNIT:{A1:"%E5%85%83",A3:"%E4%BB%9F%E5%85%83",A4:"%E8%90%AC%E5%85%83",B1:"%E8%A8%88%E7%95%AB",C1:"%E5%96%AE%E4%BD%8D"},TYPE:{M:"%E4%B8%BB%E7%B4%84",R:"%E9%99%84%E7%B4%84"}}};const State={currentEnv:null,apiToken:null,queryResults:[],totalRecords:0,sortKey:null,sortDirection:'none',batchMode:!1,batchPages:1,currentBatchPage:1,reset(){this.queryResults=[];this.totalRecords=0;this.sortKey=null;this.sortDirection='none';this.batchMode=!1;this.batchPages=1;this.currentBatchPage=1}};const Utils={normalizeInput:str=>typeof str==='string'?str.replace(/[\uff01-\uff5e]/g,s=%3EString.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g,%22%20%22).trim():str,escapeHtml:str=%3Etypeof%20str===%27string%27?str.replace(/[&%3C%3E%22%27]/g,m=%3E({%27&%27:%27&%27,%27%3C%27:%27%3C%27,%27%3E%27:%27%3E%27,%27%22%27:%27%22%27,%22%27%22:%27&#039;'})[m]):str,formatDate:dateStr=%3E{if(!dateStr)return%22%22;try{return%20dateStr.substring(0,10).replace(/-/g,%22%22)}catch{return%22%22}},getTodayString:()=%3E{const%20now=new%20Date();return%20%60${now.getFullYear()}${(now.getMonth()%20+%201).toString().padStart(2,%20'0')}${now.getDate().toString().padStart(2,%20'0')}%60},transformRecord:(record,index)=%3E{const%20startDate=Utils.formatDate(record.saleStartDate);const%20endDate=Utils.formatDate(record.saleEndDate);const%20isStillSelling=endDate===%2299991231%22||endDate%3E=Utils.getTodayString();let%20endDisplay=%22-%22;if(record._isErrorRow){endDisplay=%60%3Cspan%20style=%22color:red;%22%3E${record.name%20||%20'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97'}%3C/span%3E%60}else%20if(endDate){endDisplay=isStillSelling?%60%3Cspan%20style=%22color:blue;font-weight:bold;%22%3E%E7%8F%BE%E5%94%AE%E4%B8%AD%3C/span%3E%60:%60%3Cspan%20style=%22color:red;%22%3E${endDate}%3C/span%3E%60}return{_index:index,code:record.planCode||%22-%22,name:(record.shortName||%22%22).trim()||%22N/A%22,full:(record.planCodeName||%22%22).trim()||%22N/A%22,cur:CONFIG.MASTER_DATA.CUR[record.currency]||%22-%22,unit:CONFIG.MASTER_DATA.UNIT[(record.reportInsuranceAmountUnit||record.insuranceAmountUnit||%22%22).toUpperCase()]||%22-%22,type:CONFIG.MASTER_DATA.TYPE[record.coverageType]||%22-%22,start:startDate||%22-%22,end:endDate||%22-%22,isStillSelling,originalEndDisplay:endDisplay,_isErrorRow:record._isErrorRow||!1,_detailsFetched:!1,polplnCode:null,polplnDisplayText:null,channelInfo:null,channelDisplayHtml:null,applyYellowBg:!1}},extractPolpln:polplnString=%3E{if(!polplnString||typeof%20polplnString!=='string')return%22%22;let%20processed=polplnString.trim();if(processed.endsWith(%22%%22))processed=processed.substring(0,processed.length-1);return%20processed.replace(/^\d+/,%22%22).replace(/\d+$/,%22%22).trim()||%22%22},processMultiplePolpln:polplnRecords=%3E{if(!polplnRecords||polplnRecords.length===0)return%22-%22;if(polplnRecords.length===1)return%20Utils.extractPolpln(polplnRecords[0])||%22-%22;const%20extractedPolplns=polplnRecords.map(r=%3EUtils.extractPolpln(r)).filter(p=%3Ep!==%22%22);if(extractedPolplns.length===0)return%22-%22;const%20firstPolpln=extractedPolplns[0];return%20extractedPolplns.every(p=%3Ep===firstPolpln)?firstPolpln:%22-%22},formatChannelInfo:(response,planCode,baseDisplay,isBaseStillSelling)=%3E{const%20todayStr=Utils.getTodayString();let%20channelDetailsHtml=%22%22;let%20copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim();let%20hasActiveChannel=!1;let%20hasAnyChannelInfo=!1;if(response&&response.planCodeSaleDates&&response.planCodeSaleDates.records&&response.planCodeSaleDates.records.length%3E0){hasAnyChannelInfo=!0;const%20channelRecords=response.planCodeSaleDates.records.filter(rec=%3Erec.planCode===planCode&&rec.channel&&rec.saleEndDate).map(rec=%3E{const%20channelEndDate=Utils.formatDate(rec.saleEndDate);const%20channelStartDate=Utils.formatDate(rec.saleStartDate);const%20isChannelSelling=channelEndDate===%2299991231%22||channelEndDate%3E=todayStr;if(isChannelSelling)hasActiveChannel=!0;const%20titleText=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20%E5%8F%AF%E9%8A%B7%E5%94%AE%E6%9C%9F%E9%96%93%E7%82%BA%20${channelStartDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%20%EF%BD%9E%20${channelEndDate%20===%20%2299991231%22%20?%20%22%E6%8C%81%E7%BA%8C%E9%8A%B7%E5%94%AE%22%20:%20channelEndDate%20||%20%22%E6%9C%AA%E7%9F%A5%22}%60;let%20displayText,plainTextPart;if(isChannelSelling){displayText=%60%3Cspan%20title=%22${Utils.escapeHtml(titleText)}%22%20style=%22color:blue;%22%3E${Utils.escapeHtml(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%60}else{displayText=%60%3Cspan%20title=%22${Utils.escapeHtml(titleText)}%22%20style=%22color:red;%22%3E${Utils.escapeHtml(rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22)}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%3C/span%3E%60;plainTextPart=%60${rec.channel%20||%20%22%E6%9C%AA%E7%9F%A5%E9%80%9A%E8%B7%AF%22}%20(${channelEndDate%20||%20'%E6%9C%AA%E7%9F%A5'})%60}return{channel:rec.channel,text:displayText,isSelling:isChannelSelling,plainText:plainTextPart}}).sort((a,b)=%3E{if(a.isSelling!==b.isSelling)return%20a.isSelling?-1:1;return(a.channel||%22%22).localeCompare(b.channel||%22%22)});const%20sellingChannels=channelRecords.filter(r=%3Er.isSelling);const%20stoppedChannels=channelRecords.filter(r=%3E!r.isSelling);let%20currentCopyTextParts=[];if(sellingChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%8F%AF%E5%94%AE%EF%BC%9A${sellingChannels.map(r%20=%3E%20r.plainText).join(%22%E3%80%81%22)}%60)}if(stoppedChannels.length%3E0){channelDetailsHtml+=%60%3Cdiv%20style=%22line-height:%201.4;%22%3E%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(r%20=%3E%20r.text).join(%22%E3%80%81%22)}%3C/div%3E%60;currentCopyTextParts.push(%60%E5%81%9C%E5%94%AE%EF%BC%9A${stoppedChannels.map(r%20=%3E%20r.plainText).join(%22%E3%80%81%22)}%60)}if(currentCopyTextParts.length%3E0){copyTextContent=currentCopyTextParts.join(%22\n%22)}else%20if(hasAnyChannelInfo){copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E7%84%A1%E6%AD%A4%E5%95%86%E5%93%81%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E8%A8%8A)%3C/div%3E%60}}else%20if(response&&response.planCodeSaleDates&&response.planCodeSaleDates.records&&response.planCodeSaleDates.records.length===0){hasAnyChannelInfo=!0;copyTextContent=baseDisplay.replace(/%3C[^%3E]*%3E/g,%22%22).trim()+%22\n(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%22;channelDetailsHtml=%60%3Cdiv%20style=%22line-height:1.4;%20color:%20#777;%20font-style:%20italic;%22%3E(%E5%B0%9A%E7%84%A1%E9%80%9A%E8%B7%AF%E9%8A%B7%E5%94%AE%E8%B3%87%E6%96%99)%3C/div%3E%60}let%20finalHtml=baseDisplay;if(channelDetailsHtml){finalHtml+=%60%3Cdiv%20style=%22text-align:%20left;%20margin-top:%204px;%20padding-top:%203px;%20border-top:%201px%20solid%20#eee;%22%3E${channelDetailsHtml}%3C/div%3E%60}const%20applyYellowBg=!isBaseStillSelling&&hasActiveChannel;return{html:finalHtml,copyText:copyTextContent.trim(),applyYellowBg:applyYellowBg,hasChannelInfo:hasAnyChannelInfo}}};const%20Notification={show(message,isError=!1,duration=2000){const%20id='app-notification';document.getElementById(id)?.remove();const%20el=document.createElement('div');el.id=id;el.textContent=message;el.style.cssText=%60position:%20fixed;%20top:%2020px;%20left:%2050%;%20transform:%20translateX(-50%);background:%20${isError%20?%20'#dc3545'%20:%20'#007bff'};%20color:%20white;padding:%208px%2016px;%20border-radius:%204px;%20font-size:%2013px;z-index:%20${CONFIG.UI.Z_INDEX.NOTIFICATION};%20font-family:%20sans-serif;box-shadow:%200%202px%208px%20rgba(0,0,0,0.2);%60;document.body.appendChild(el);if(duration%3E0)setTimeout(()=%3Eel.remove(),duration);}};const%20API={getUrl(endpoint){return%20CONFIG.API[State.currentEnv]+CONFIG.API.ENDPOINTS[endpoint]},async%20call(endpoint,payload){try{const%20response=await%20fetch(this.getUrl(endpoint),{method:'POST',headers:{'Content-Type':'application/json','SSO-TOKEN':State.apiToken},body:JSON.stringify(payload)});if(response.status===401){return{error:'TOKEN_INVALID',message:%22TOKEN%20%E7%84%A1%E6%95%88%E6%88%96%E5%B7%B2%E9%81%8E%E6%9C%9F%22}}if(!response.ok){const%20errorText=await%20response.text();return{error:'API_ERROR',message:%60%E8%AB%8B%E6%B1%82%E5%A4%B1%E6%95%97:%20${response.status}%20(${response.statusText%20||%20errorText%20||%20'%E6%9C%AA%E7%9F%A5%E9%8C%AF%E8%AA%A4'})%60}}return%20await%20response.json()}catch(error){return{error:'NETWORK_ERROR',message:%22%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E9%8C%AF%E8%AA%A4%E6%88%96API%E7%84%A1%E5%9B%9E%E6%87%89%22}}},async%20validateToken(token){if(!token)return!1;const%20tempToken=State.apiToken;State.apiToken=token;const%20result=await%20this.call('planCodeQuery',{planCodeName:%22%22});State.apiToken=tempToken;return%20result&&!result.error}};const%20Dialog={create(content,width='400px'){const%20overlay=document.createElement('div');overlay.style.cssText=%60position:%20fixed;%20top:%200;%20left:%200;%20width:%20100%;%20height:%20100%;background:%20rgba(0,0,0,0.6);%20z-index:%20${CONFIG.UI.Z_INDEX.OVERLAY};display:%20flex;%20align-items:%20center;%20justify-content:%20center;%60;const%20dialog=document.createElement('div');dialog.style.cssText=%60background:%20white;%20padding:%2020px;%20border-radius:%208px;box-shadow:%200%204px%2020px%20rgba(0,0,0,0.3);%20width:%20${width};font-family:%20sans-serif;%20animation:%20fadeIn%200.2s%20ease-out;%60;dialog.innerHTML=content;overlay.appendChild(dialog);document.body.appendChild(overlay);this.insertStyles();return{overlay,dialog}},insertStyles(){if(document.getElementById('dialog-styles'))return;const%20style=document.createElement('style');style.id='dialog-styles';style.textContent=%60@keyframes%20fadeIn%20{%20from%20{%20opacity:%200;%20transform:%20scale(0.9);%20}%20to%20{%20opacity:%201;%20transform:%20scale(1);%20}%20}.dialog-btn%20{%20border:%20none;%20padding:%208px%2016px;%20border-radius:%204px;%20cursor:%20pointer;%20margin:%200%205px;%20}.btn-primary%20{%20background:%20#007bff;%20color:%20white;%20}.btn-success%20{%20background:%20#28a745;%20color:%20white;%20}.btn-warning%20{%20background:%20#ffc107;%20color:%20#212529;%20}.btn-secondary%20{%20background:%20#6c757d;%20color:%20white;%20}.dialog-input%20{%20width:%20100%;%20padding:%208px;%20border:%201px%20solid%20#ccc;%20border-radius:%204px;%20margin:%2010px%200;%20box-sizing:%20border-box;%20}.dialog-title%20{%20text-align:%20center;%20margin:%200%200%2020px%200;%20font-size:%2018px;%20color:%20#333;%20}%60;document.head.appendChild(style)},async%20selectEnvironment(){return%20new%20Promise(resolve=%3E{const{overlay}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E9%81%B8%E6%93%87%E6%9F%A5%E8%A9%A2%E7%92%B0%E5%A2%83%3C/h3%3E%3Cdiv%20style=%22text-align:%20center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-success%22%20onclick=%22resolveEnv('UAT')%22%3E%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83%20(UAT)%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-warning%22%20onclick=%22resolveEnv('PROD')%22%3E%E6%AD%A3%E5%BC%8F%E7%92%B0%E5%A2%83%20(PROD)%3C/button%3E%3Cbr%3E%3Cbr%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveEnv(null)%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'350px');window.resolveEnv=(value)=%3E{overlay.remove();delete%20window.resolveEnv;resolve(value)}})},async%20inputToken(attempt=1){return%20new%20Promise(resolve=%3E{const{overlay,dialog}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E8%BC%B8%E5%85%A5%20API%20TOKEN%3C/h3%3E%3Cinput%20type=%22password%22%20id=%22token-input%22%20class=%22dialog-input%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%82%A8%E7%9A%84%20TOKEN%22%3E${attempt%20%3E%201%20?%20'%3Cp%20style=%22color:%20red;%20text-align:%20center;%22%3ETOKEN%20%E7%84%A1%E6%95%88%EF%BC%8C%E8%AB%8B%E9%87%8D%E6%96%B0%E8%BC%B8%E5%85%A5%3C/p%3E'%20:%20''}%3Cdiv%20style=%22text-align:%20center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-primary%22%20onclick=%22confirmToken()%22%3E%E7%A2%BA%E5%AE%9A%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-warning%22%20onclick=%22resolveToken('_skip_')%22%3E%E7%95%A5%E9%81%8E%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveToken(null)%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'400px');const%20input=dialog.querySelector('#token-input');input.focus();input.addEventListener('keypress',(e)=%3E{if(e.key==='Enter'){const%20value=input.value.trim();overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)}});window.confirmToken=()=%3E{const%20value=input.value.trim();overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)};window.resolveToken=(value)=%3E{overlay.remove();delete%20window.confirmToken;delete%20window.resolveToken;resolve(value)}})},async%20setupQuery(){return%20new%20Promise(resolve=%3E{const{overlay,dialog}=this.create(%60%3Ch3%20class=%22dialog-title%22%3E%E6%9F%A5%E8%A9%A2%E8%A8%AD%E5%AE%9A%3C/h3%3E%3Cdiv%20style=%22margin:%2015px%200;%22%3E%3Clabel%20style=%22display:%20block;%20margin-bottom:%208px;%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22planCode%22%20checked%3E%20%E5%95%86%E5%93%81%E4%BB%A3%E7%A2%BC%3C/label%3E%3Clabel%20style=%22display:%20block;%20margin-bottom:%208px;%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22planCodeName%22%3E%20%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%3C/label%3E%3Clabel%20style=%22display:%20block;%20margin-bottom:%208px;%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22allPlans%22%3E%20%E6%9F%A5%E8%A9%A2%E5%85%A8%E9%83%A8%3C/label%3E%3Clabel%20style=%22display:%20block;%20margin-bottom:%208px;%22%3E%3Cinput%20type=%22radio%22%20name=%22query-type%22%20value=%22inSale%22%3E%20%E7%8F%BE%E5%94%AE%E5%95%86%E5%93%81%20(%E5%90%AB%E9%80%9A%E8%B7%AF%E8%A9%B3%E6%83%85)%3C/label%3E%3C/div%3E%3Ctextarea%20id=%22query-input%22%20class=%22dialog-input%22%20rows=%223%22%20placeholder=%22%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9%22%3E%3C/textarea%3E%3Cdiv%20style=%22text-align:%20center;%22%3E%3Cbutton%20class=%22dialog-btn%20btn-primary%22%20onclick=%22confirmQuery()%22%3E%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%3C/button%3E%3Cbutton%20class=%22dialog-btn%20btn-secondary%22%20onclick=%22resolveQuery(null)%22%3E%E5%8F%96%E6%B6%88%3C/button%3E%3C/div%3E%60,'500px');dialog.querySelectorAll('input[name=%22query-type%22]').forEach(radio=%3E{radio.onchange=()=%3E{const%20input=dialog.querySelector('#query-input');const%20type=dialog.querySelector('input[name=%22query-type%22]:checked').value;if(type==='allPlans'||type==='inSale'){input.disabled=!0;input.placeholder='%E7%84%A1%E9%9C%80%E8%BC%B8%E5%85%A5';input.value=''}else{input.disabled=!1;input.placeholder=type==='planCode'?'%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E4%BB%A3%E7%A2%BC%EF%BC%8C%E5%A4%9A%E7%AD%86%E7%94%A8%E7%A9%BA%E6%A0%BC%E3%80%81%E9%80%97%E8%99%9F%E6%88%96%E5%88%86%E8%99%9F%E5%88%86%E9%9A%94':'%E8%AB%8B%E8%BC%B8%E5%85%A5%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97'}}});window.confirmQuery=()=%3E{const%20type=dialog.querySelector('input[name=%22query-type%22]:checked').value;const%20input=dialog.querySelector('#query-input').value.trim();if((type==='planCode'||type==='planCodeName')&&!input){Notification.show('%E8%AB%8B%E8%BC%B8%E5%85%A5%E6%9F%A5%E8%A9%A2%E5%85%A7%E5%AE%B9',!0);return}if(type==='planCodeName'&&input.split(/[\s,;]+/).filter(Boolean).length%3E1){Notification.show('%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%E9%97%9C%E9%8D%B5%E5%AD%97%E6%9F%A5%E8%A9%A2%E5%83%85%E6%94%AF%E6%8F%B4%E5%96%AE%E4%B8%80%E9%97%9C%E9%8D%B5%E5%AD%97',!0);return}overlay.remove();delete%20window.confirmQuery;delete%20window.resolveQuery;resolve({queryMode:type,inputValue:input})};window.resolveQuery=(value)=%3E{overlay.remove();delete%20window.confirmQuery;delete%20window.resolveQuery;resolve(value)}})}};const%20UI={render(){this.cleanup();this.insertStyles();this.createMainUI();this.bindEvents()},cleanup(){document.getElementById(CONFIG.UI.MAIN_ID)?.remove();document.getElementById(CONFIG.UI.CSS_ID)?.remove()},insertStyles(){const%20style=document.createElement('style');style.id=CONFIG.UI.CSS_ID;style.textContent=%60#${CONFIG.UI.MAIN_ID}%20{position:%20fixed;%20z-index:%20${CONFIG.UI.Z_INDEX.MAIN};%20left:%2050%;%20top:%2020px;transform:%20translateX(-50%);%20background:%20white;%20border-radius:%208px;box-shadow:%200%204px%2020px%20rgba(0,0,0,0.2);%20padding:%200;%20width:%2090%;%20max-width:%201200px;max-height:%2090vh;%20display:%20flex;%20flex-direction:%20column;%20font-family:%20sans-serif;border:%201px%20solid%20#ddd;}#${CONFIG.UI.MAIN_ID}%20.header%20{background:%20#343a40;%20color:%20white;%20padding:%2012px%2020px;%20border-radius:%208px%208px%200%200;display:%20flex;%20justify-content:%20space-between;%20align-items:%20center;%20cursor:%20grab;}#${CONFIG.UI.MAIN_ID}%20.header%20h3%20{%20margin:%200;%20font-size:%2016px;%20}#${CONFIG.UI.MAIN_ID}%20.close-btn%20{%20background:%20none;%20border:%20none;%20color:%20white;%20font-size:%2018px;%20cursor:%20pointer;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20{display:%20flex;%20justify-content:%20space-between;%20align-items:%20center;%20padding:%2015px%2020px;background:%20#f8f9fa;%20border-bottom:%201px%20solid%20#ddd;%20flex-wrap:%20wrap;%20gap:%2010px;}#${CONFIG.UI.MAIN_ID}%20.controls%20.info%20{%20font-size:%2014px;%20font-weight:%20500;%20color:%20#212529;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20.info%20strong%20{%20color:%20#007bff;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20.buttons%20{%20display:%20flex;%20gap:%208px;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20button%20{background:%20#007bff;%20color:%20white;%20border:%20none;%20padding:%206px%2012px;border-radius:%204px;%20cursor:%20pointer;%20font-size:%2012px;%20transition:%20opacity%200.2s;}#${CONFIG.UI.MAIN_ID}%20.controls%20button:hover%20{%20opacity:%200.8;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20.btn-success%20{%20background:%20#28a745;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20.btn-info%20{%20background:%20#17a2b8;%20}#${CONFIG.UI.MAIN_ID}%20.controls%20.btn-secondary%20{%20background:%20#6c757d;%20}#${CONFIG.UI.MAIN_ID}%20.table-container%20{flex:%201;%20overflow:%20auto;%20padding:%200%2020px%2020px%2020px;}#${CONFIG.UI.MAIN_ID}%20table%20{%20width:%20100%;%20border-collapse:%20collapse;%20font-size:%2012px;%20}#${CONFIG.UI.MAIN_ID}%20th%20{background:%20#343a40;%20color:%20white;%20padding:%208px;%20text-align:%20center;position:%20sticky;%20top:%200;%20cursor:%20pointer;%20border:%201px%20solid%20#454d55;white-space:%20nowrap;}#${CONFIG.UI.MAIN_ID}%20td%20{padding:%206px%208px;%20border:%201px%20solid%20#eee;%20text-align:%20center;white-space:%20nowrap;%20vertical-align:%20middle;}#${CONFIG.UI.MAIN_ID}%20tr:nth-child(even)%20{%20background:%20#f8f9fa;%20}#${CONFIG.UI.MAIN_ID}%20tr:hover%20{%20background:%20#e9ecef;%20}#${CONFIG.UI.MAIN_ID}%20.seq-cell%20{%20color:%20#007bff;%20cursor:%20pointer;%20font-weight:%20bold;%20}#${CONFIG.UI.MAIN_ID}%20.seq-cell:hover%20{%20text-decoration:%20underline;%20}#${CONFIG.UI.MAIN_ID}%20.seq-cell[data-fetched=%22true%22]%20{%20color:%20#28a745;%20cursor:%20copy;%20font-weight:%20normal;%20}#${CONFIG.UI.MAIN_ID}%20.copy-cell%20{%20cursor:%20pointer;%20color:%20#0056b3;%20}#${CONFIG.UI.MAIN_ID}%20.copy-cell:hover%20{%20background:%20#e3f2fd;%20}#${CONFIG.UI.MAIN_ID}%20.name-cell%20{%20text-align:%20left;%20max-width:%20200px;%20white-space:%20normal;%20}#${CONFIG.UI.MAIN_ID}%20.date-cell%20{%20text-align:%20left;%20min-width:%20150px;%20max-width:%20280px;%20white-space:%20normal%20!important;%20vertical-align:%20top%20!important;%20}#${CONFIG.UI.MAIN_ID}%20.error-row%20{%20background-color:%20#ffebee%20!important;%20color:%20#c62828;%20}%60;document.head.appendChild(style)},createMainUI(){const%20mainDiv=document.createElement('div');mainDiv.id=CONFIG.UI.MAIN_ID;mainDiv.innerHTML=%60%3Cdiv%20class=%22header%22%3E%3Ch3%3E%E5%87%B1%E5%9F%BA%E4%BA%BA%E5%A3%BD%20%E5%95%86%E5%93%81%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%3C/h3%3E%3Cbutton%20class=%22close-btn%22%20onclick=%22App.close()%22%3E%C3%97%3C/button%3E%3C/div%3E%3Cdiv%20class=%22controls%22%3E%3Cdiv%20class=%22info%22%3E%E7%B8%BD%E5%85%B1%20%3Cstrong%3E${State.totalRecords}%3C/strong%3E%20%E7%AD%86%3C/div%3E%3Cdiv%20class=%22buttons%22%3E%3Cbutton%20class=%22btn-success%22%20onclick=%22App.copyAll()%22%3E%E4%B8%80%E9%8D%B5%E8%A4%87%E8%A3%BD%3C/button%3E%3Cbutton%20class=%22btn-info%22%20onclick=%22App.queryDetails()%22%3E%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E8%B3%87%E6%96%99%3C/button%3E%3Cbutton%20onclick=%22App.reload()%22%3E%E9%87%8D%E6%96%B0%E6%9F%A5%E8%A9%A2%3C/button%3E%3Cbutton%20class=%22btn-secondary%22%20onclick=%22App.close()%22%3E%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C%3C/button%3E%3C/div%3E%3C/div%3E%3Cdiv%20class=%22table-container%22%3E%3Ctable%3E%3Cthead%3E%3Ctr%3E%3Cth%20onclick=%22App.sort('_index')%22%3ENo%3C/th%3E%3Cth%20onclick=%22App.sort('code')%22%3E%E4%BB%A3%E8%99%9F%3C/th%3E%3Cth%20onclick=%22App.sort('name')%22%3E%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1%3C/th%3E%3Cth%20onclick=%22App.sort('cur')%22%3E%E5%B9%A3%E5%88%A5%3C/th%3E%3Cth%20onclick=%22App.sort('unit')%22%3E%E5%96%AE%E4%BD%8D%3C/th%3E%3Cth%20onclick=%22App.sort('type')%22%3E%E9%A1%9E%E5%9E%8B%3C/th%3E%3Cth%20onclick=%22App.sort('start')%22%3E%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5%3C/th%3E%3Cth%20onclick=%22App.sort('end')%22%3E%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5%3C/th%3E%3C/tr%3E%3C/thead%3E%3Ctbody%3E${this.createTableRows()}%3C/tbody%3E%3C/table%3E%3C/div%3E%60;document.body.appendChild(mainDiv)},createTableRows(){return%20State.queryResults.map((item,index)=%3E%60%3Ctr%20${item._isErrorRow%20?%20'class=%22error-row%22'%20:%20''}%20${item.applyYellowBg%20?%20'style=%22background-color:%20yellow%20!important;%22'%20:%20''}%3E%3Ctd%20class=%22seq-cell%22%20data-index=%22${index}%22%20data-plancode=%22${item.code}%22%20data-fetched=%22${item._detailsFetched}%22%3E${item._index%20+%201}%3C/td%3E%3Ctd%20class=%22copy-cell%22%20data-copy=%22${item.polplnCode%20?%20%60${item.code}\n${item.polplnCode}%60%20:%20item.code}%22%20title=%22${item.code}%22%3E${item.polplnDisplayText%20||%20Utils.escapeHtml(item.code)}%3C/td%3E%3Ctd%20class=%22copy-cell%20name-cell%22%20data-copy=%22${item.full}%22%20title=%22${item.full}%22%3E${Utils.escapeHtml(item.name)}%3C/td%3E%3Ctd%3E${item.cur}%3C/td%3E%3Ctd%3E${item.unit}%3C/td%3E%3Ctd%3E${item.type}%3C/td%3E%3Ctd%20class=%22copy-cell%22%20data-copy=%22${item.start}%22%3E${item.start}%3C/td%3E%3Ctd%20class=%22copy-cell%20date-cell%22%20data-copy=%22${item.channelInfo%20?%20item.channelInfo.copyText%20:%20item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,%20'').trim()}%22%3E${item.channelDisplayHtml%20||%20item.originalEndDisplay}%3C/td%3E%3C/tr%3E%60).join('')},bindEvents(){const%20mainDiv=document.getElementById(CONFIG.UI.MAIN_ID);const%20header=mainDiv.querySelector('.header');let%20isDragging=!1,startX=0,startY=0;header.onmousedown=(e)=%3E{if(e.target.classList.contains('close-btn'))return;isDragging=!0;startX=e.clientX-mainDiv.offsetLeft;startY=e.clientY-mainDiv.offsetTop;header.style.cursor='grabbing';document.onmousemove=(moveEvent)=%3E{if(!isDragging)return;mainDiv.style.left=(moveEvent.clientX-startX)+'px';mainDiv.style.top=(moveEvent.clientY-startY)+'px'};document.onmouseup=()=%3E{isDragging=!1;header.style.cursor='grab';document.onmousemove=null;document.onmouseup=null}};mainDiv.querySelectorAll('.copy-cell').forEach(cell=%3E{cell.onclick=()=%3E{navigator.clipboard.writeText(cell.dataset.copy);Notification.show('%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81')}});mainDiv.querySelectorAll('.seq-cell').forEach(cell=%3E{cell.onclick=async()=%3E{await%20App.handleSequenceClick(cell)}})},updateTable(){const%20tbody=document.querySelector(%60#${CONFIG.UI.MAIN_ID}%20tbody%60);if(tbody){tbody.innerHTML=this.createTableRows();this.bindEvents()}}};const%20App={async%20init(){try{const%20env=await%20Dialog.selectEnvironment();if(!env)return;State.currentEnv=env;let%20token=localStorage.getItem(CONFIG.STORAGE.TOKEN_KEY)||localStorage.getItem(CONFIG.STORAGE.TOKEN_FALLBACK);let%20attempt=1;while(!(token&&await%20API.validateToken(token))){const%20result=await%20Dialog.inputToken(attempt);if(!result||result==='_skip_')break;if(await%20API.validateToken(result)){token=result;localStorage.setItem(CONFIG.STORAGE.TOKEN_KEY,token);break}attempt++;if(attempt%3E3){Notification.show('TOKEN%20%E5%A4%9A%E6%AC%A1%E9%A9%97%E8%AD%89%E5%A4%B1%E6%95%97%EF%BC%8C%E8%AB%8B%E7%A2%BA%E8%AA%8D%E5%BE%8C%E9%87%8D%E8%A9%A6',!0);return}}State.apiToken=token;Notification.show(%60%E5%B7%B2%E9%80%A3%E6%8E%A5%E5%88%B0${env%20===%20'PROD'%20?%20'%E6%AD%A3%E5%BC%8F'%20:%20'%E6%B8%AC%E8%A9%A6'}%E7%92%B0%E5%A2%83%60);const%20queryConfig=await%20Dialog.setupQuery();if(!queryConfig)return;await%20this.executeQuery(queryConfig)}catch(error){console.error('%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E6%95%97:',error);Notification.show('%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E6%95%97:%20'+error.message,!0)}},async%20executeQuery(config){State.reset();Notification.show('%E6%9F%A5%E8%A9%A2%E4%B8%AD...');let%20endpoint,params;switch(config.queryMode){case%20'planCode':const%20codes=config.inputValue.split(/[\s,;]+/).filter(Boolean).map(code=%3Ecode.trim().toUpperCase());await%20this.queryByCodes(codes);return;case%20'planCodeName':endpoint='planCodeQuery';params={planCodeName:config.inputValue,pageSize:CONFIG.LIMITS.PAGE_SIZE};break;case%20'allPlans':endpoint='planCodeQuery';params={planCodeName:%22%22,pageSize:CONFIG.LIMITS.PAGE_SIZE};break;case%20'inSale':endpoint='saleDateQuery';params={planCodeName:%22%22,saleEndDate:Utils.getTodayString(),pageSize:CONFIG.LIMITS.PAGE_SIZE};break}const%20response=await%20API.call(endpoint,params);if(response&&!response.error&&response.records){State.queryResults=response.records.map(Utils.transformRecord);State.totalRecords=response.records.length;if(State.totalRecords%3ECONFIG.LIMITS.BATCH_SIZE){const%20userConfirm=confirm(%60%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%E5%85%B1%20${State.totalRecords}%20%E7%AD%86%EF%BC%8C%E8%B6%85%E9%81%8E${CONFIG.LIMITS.BATCH_SIZE}%E7%AD%86%E5%B0%87%E5%88%86%E6%89%B9%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%EF%BC%8C%E6%98%AF%E5%90%A6%E7%B9%BC%E7%BA%8C%EF%BC%9F%60);if(!userConfirm){Notification.show('%E6%93%8D%E4%BD%9C%E5%B7%B2%E5%8F%96%E6%B6%88');return}State.batchMode=!0;State.batchPages=Math.ceil(State.totalRecords/CONFIG.LIMITS.BATCH_SIZE)}UI.render();Notification.show(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%8C%E6%89%BE%E5%88%B0%20${State.totalRecords}%20%E7%AD%86%E8%B3%87%E6%96%99%60)}else{Notification.show(response?.message||'%E6%9F%A5%E8%A9%A2%E5%A4%B1%E6%95%97',!0)}},async%20queryByCodes(codes){const%20responses=await%20Promise.all(codes.map(async%20code=%3E{const%20response=await%20API.call('planCodeQuery',{planCode:code});if(response&&!response.error&&response.records?.length%3E0){return%20response.records.map(record=%3EUtils.transformRecord(record,0))}else{return[Utils.transformRecord({planCode:code,shortName:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,planCodeName:%22%E6%9F%A5%E7%84%A1%E8%B3%87%E6%96%99%22,_isErrorRow:!0},0)]}}));State.queryResults=responses.flat().map((item,index)=%3E({...item,_index:index}));State.totalRecords=State.queryResults.length;UI.render();Notification.show(%60%E6%9F%A5%E8%A9%A2%E5%AE%8C%E6%88%90%EF%BC%8C%E6%89%BE%E5%88%B0%20${State.totalRecords}%20%E7%AD%86%E8%B3%87%E6%96%99%60)},async%20handleSequenceClick(cell){const%20planCode=cell.dataset.plancode;const%20index=parseInt(cell.dataset.index);const%20item=State.queryResults[index];if(cell.dataset.fetched===%22true%22){const%20headerText=%22No\t%E4%BB%A3%E8%99%9F\t%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1\t%E5%B9%A3%E5%88%A5\t%E5%96%AE%E4%BD%8D\t%E9%A1%9E%E5%9E%8B\t%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5\t%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5\n%22;const%20rowData=[cell.textContent,item.polplnCode?%60${item.code}\n${item.polplnCode}%60:item.code,item.full,item.cur,item.unit,item.type,item.start,item.channelInfo?item.channelInfo.copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()];navigator.clipboard.writeText(headerText+rowData.join('\t'));Notification.show('%E8%A9%B2%E5%88%97%E8%B3%87%E6%96%99(%E5%90%AB%E8%A1%A8%E9%A0%AD)%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81');return}if(item._isErrorRow){Notification.show('%E9%8C%AF%E8%AA%A4%E8%B3%87%E6%96%99%E7%84%A1%E6%B3%95%E6%9F%A5%E8%A9%A2%E8%A9%B3%E6%83%85',!0);return}cell.style.cursor='wait';Notification.show(%60%E6%9F%A5%E8%A9%A2%20${planCode}%20%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A...%60);const[polplnResponse,channelResponse]=await%20Promise.all([API.call('planCodeDetail',{planCode:planCode,pageNo:1,pageSize:20}),API.call('saleDateQuery',{planCode:planCode,pageNo:1,pageSize:50})]);cell.style.cursor='default';if(polplnResponse&&!polplnResponse.error&&polplnResponse.records?.length%3E0){const%20polpln=Utils.processMultiplePolpln(polplnResponse.records.map(r=%3Er.polpln));if(polpln!==%22-%22&&polpln!==%22%22){item.polplnCode=polpln;item.polplnDisplayText=%60${item.code}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${polpln}%3C/span%3E%60}}if(channelResponse&&!channelResponse.error){item.channelInfo=Utils.formatChannelInfo(channelResponse,planCode,item.originalEndDisplay,item.isStillSelling);item.channelDisplayHtml=item.channelInfo.html;item.applyYellowBg=item.channelInfo.applyYellowBg}item._detailsFetched=!0;cell.dataset.fetched=%22true%22;UI.updateTable()},sort(key){if(State.sortKey===key){State.sortDirection=State.sortDirection==='asc'?'desc':'asc'}else{State.sortKey=key;State.sortDirection='asc'}State.queryResults.sort((a,b)=%3E{let%20valA=a[key]||'';let%20valB=b[key]||'';if(typeof%20valA==='number'&&typeof%20valB==='number'){return%20State.sortDirection==='asc'?valA-valB:valB-valA}return%20State.sortDirection==='asc'?String(valA).localeCompare(String(valB),'zh-Hant-TW',{sensitivity:'base',numeric:!0}):String(valB).localeCompare(String(valA),'zh-Hant-TW',{sensitivity:'base',numeric:!0})});UI.updateTable();const%20headerText=document.querySelector(%60#${CONFIG.UI.MAIN_ID}%20th[onclick=%22App.sort('${key}')%22]%60)?.textContent?.replace(/[%E2%96%B2%E2%96%BC\s]*/g,'')||key;Notification.show(%60%E5%B7%B2%E6%8C%89%E3%80%8C${headerText}%E3%80%8D${State.sortDirection%20===%20'asc'%20?%20'%E5%8D%87%E5%BA%8F'%20:%20'%E9%99%8D%E5%BA%8F'}%E6%8E%92%E5%88%97%60,!1,1500)},copyAll(){let%20text=%22No\t%E4%BB%A3%E8%99%9F\t%E5%95%86%E5%93%81%E5%90%8D%E7%A8%B1\t%E5%B9%A3%E5%88%A5\t%E5%96%AE%E4%BD%8D\t%E9%A1%9E%E5%9E%8B\t%E9%8A%B7%E5%94%AE%E8%B5%B7%E6%97%A5\t%E9%8A%B7%E5%94%AE%E8%BF%84%E6%97%A5\n%22;State.queryResults.forEach((item,index)=%3E{const%20rowData=[index+1,item.polplnCode?%60${item.code}\n${item.polplnCode}%60:item.code,item.full,item.cur,item.unit,item.type,item.start,item.channelInfo?item.channelInfo.copyText:item.originalEndDisplay.replace(/%3C[^%3E]*%3E/g,'').trim()];text+=rowData.map(cell=%3EString(cell).replace(/\n/g,'%20/%20')).join('\t')+'\n'});navigator.clipboard.writeText(text);Notification.show('%E8%A1%A8%E6%A0%BC%E5%85%A7%E5%AE%B9%E5%B7%B2%E8%A4%87%E8%A3%BD%EF%BC%81')},async%20queryDetails(){const%20mainDiv=document.getElementById(CONFIG.UI.MAIN_ID);if(!mainDiv){Notification.show('%E8%A1%A8%E6%A0%BC%E5%AE%B9%E5%99%A8%E4%B8%8D%E5%AD%98%E5%9C%A8',!0);return}if(!State.queryResults||State.queryResults.length===0){Notification.show('%E7%9B%AE%E5%89%8D%E6%B2%92%E6%9C%89%E5%8F%AF%E6%9F%A5%E8%A9%A2%E9%80%9A%E8%B7%AF%E7%9A%84%E5%95%86%E5%93%81',!0);return}Notification.show('%E9%96%8B%E5%A7%8B%E6%9F%A5%E8%A9%A2%E6%9C%AC%E9%A0%81%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E5%8F%8APOLPLN%E8%B3%87%E8%A8%8A...');const%20planCodes=State.queryResults.map(item=%3Eitem.code).filter(Boolean);if(planCodes.length===0){Notification.show('%E6%B2%92%E6%9C%89%E6%9C%89%E6%95%88%E7%9A%84%E5%95%86%E5%93%81%E4%BB%A3%E8%99%9F%E5%8F%AF%E4%BE%9B%E6%9F%A5%E8%A9%A2',!0);return}const%20queryPromises=planCodes.map(async%20planCode=%3E{const%20productItem=State.queryResults.find(item=%3Eitem.code===planCode);if(!productItem||productItem._isErrorRow||productItem._detailsFetched){return{planCode,status:'skipped'}}const[polplnResponse,channelResponse]=await%20Promise.all([API.call('planCodeDetail',{planCode:planCode,pageNo:1,pageSize:20}),API.call('saleDateQuery',{planCode:planCode,pageNo:1,pageSize:50})]);return{planCode,polplnResponse,channelResponse,productItem}});const%20results=await%20Promise.allSettled(queryPromises);let%20queryCount=0;results.forEach(result=%3E{if(result.status!=='fulfilled'||!result.value||result.value.status==='skipped'){return}const{planCode,polplnResponse,channelResponse,productItem}=result.value;if(polplnResponse&&!polplnResponse.error&&polplnResponse.records?.length%3E0){const%20polpln=Utils.processMultiplePolpln(polplnResponse.records.map(r=%3Er.polpln));if(polpln!==%22-%22&&polpln!==%22%22){productItem.polplnCode=polpln;productItem.polplnDisplayText=%60${productItem.code}%3Cbr%3E%3Cspan%20style=%22color:green;font-weight:bold;%22%3E${polpln}%3C/span%3E%60}}if(channelResponse&&!channelResponse.error){productItem.channelInfo=Utils.formatChannelInfo(channelResponse,planCode,productItem.originalEndDisplay,productItem.isStillSelling);productItem.channelDisplayHtml=productItem.channelInfo.html;productItem.applyYellowBg=productItem.channelInfo.applyYellowBg}productItem._detailsFetched=!0;queryCount++});UI.updateTable();if(queryCount%3E0){Notification.show(%60%E5%85%B1%20${queryCount}%20%E7%AD%86%E5%95%86%E5%93%81%E7%9A%84%E9%80%9A%E8%B7%AF%E5%8F%8APOLPLN%E8%B3%87%E8%A8%8A%E5%B7%B2%E6%9B%B4%E6%96%B0%60)}else{Notification.show('%E6%9F%A5%E8%A9%A2%E5%9D%87%E6%9C%AA%E6%88%90%E5%8A%9F%E6%88%96%E7%84%A1%E8%B3%87%E6%96%99')}},reload(){this.init()},close(){document.getElementById(CONFIG.UI.MAIN_ID)?.remove();document.getElementById(CONFIG.UI.CSS_ID)?.remove();document.getElementById('dialog-styles')?.remove()}};window.App=App;document.addEventListener('keydown',(e)=%3E{if(e.key==='Escape'&&document.getElementById(CONFIG.UI.MAIN_ID)){App.close()}});App.init()})()

【編輯】
javascript:(function(){if(document.getElementById('modeStatusPanel'))return;const STORAGE_KEY='modePanelPosition';let isEditable=true,pos=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')||{},x=pos.x||10,y=pos.y||10,hidden=false;function setEditMode(flag){document.body.contentEditable=flag?%27true%27:%27false%27;document.designMode=flag?%27on%27:%27off%27;}function%20createPanel(){let%20panel=document.createElement(%27div%27);panel.id=%27modeStatusPanel%27;Object.assign(panel.style,{position:%27fixed%27,left:x+%27px%27,top:y+%27px%27,zIndex:99999,backgroundColor:isEditable?%27#fff':'rgba(0,0,0,0.85)',color:isEditable?'#222':'#fff',border:'1px%20solid%20#ddd',borderRadius:'10px',padding:'16px%2048px%2022px%2018px',fontSize:'15px',fontFamily:'Arial,sans-serif',cursor:'move',boxShadow:'0%202px%2012px%20rgba(0,0,0,0.15)',opacity:'0.93',userSelect:'none',minWidth:'180px'});panel.contentEditable='false';let%20close=document.createElement('button');close.innerHTML='%3Csvg%20width=%2222%22%20height=%2222%22%20viewBox=%220%200%2022%2022%22%3E%3Ccircle%20cx=%2211%22%20cy=%2211%22%20r=%2210%22%20fill=%22rgba(0,0,0,0.12)%22/%3E%3Cline%20x1=%227%22%20y1=%227%22%20x2=%2215%22%20y2=%2215%22%20stroke=%22#555%22%20stroke-width=%222%22%20stroke-linecap=%22round%22/%3E%3Cline%20x1=%2215%22%20y1=%227%22%20x2=%227%22%20y2=%2215%22%20stroke=%22#555%22%20stroke-width=%222%22%20stroke-linecap=%22round%22/%3E%3C/svg%3E';close.setAttribute('aria-label','%E9%97%9C%E9%96%89');Object.assign(close.style,{position:'absolute',top:'7px',right:'10px',width:'28px',height:'28px',padding:'0',border:'none',background:'none',cursor:'pointer',borderRadius:'50%',transition:'background%200.2s',display:'flex',alignItems:'center',justifyContent:'center'});close.onmouseenter=function(){close.style.background='rgba(0,0,0,0.10)';};close.onmouseleave=function(){close.style.background='none';};close.onclick=function(){setEditMode(false);panel.remove();window.removeEventListener('keydown',hotkeyHandler);};let%20status=document.createElement('div');status.textContent=isEditable?'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%8F%AF%E7%B7%A8%E8%BC%AF':'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E4%B8%8D%E5%8F%AF%E7%B7%A8%E8%BC%AF';status.style.fontWeight='bold';status.style.cursor='pointer';status.style.marginTop='8px';status.style.textAlign='center';status.onclick=()=%3E{isEditable=!isEditable;setEditMode(isEditable);panel.remove();createPanel();};let%20range=document.createElement('input');range.type='range';range.min='0.05';range.max='1';range.step='0.05';range.value=panel.style.opacity;range.style.width='100%';range.style.marginTop='12px';range.oninput=e=%3E{panel.style.opacity=e.target.value;};panel.appendChild(close);panel.appendChild(status);panel.appendChild(range);document.body.appendChild(panel);let%20dragging=false,offsetX=0,offsetY=0;panel.addEventListener('mousedown',e=%3E{if(e.target.tagName==='INPUT'||e.target.tagName==='BUTTON'||e.target.tagName==='svg'||e.target.tagName==='circle'||e.target.tagName==='line')return;dragging=true;offsetX=e.clientX-x;offsetY=e.clientY-y;});document.addEventListener('mouseup',()=%3E{if(dragging)localStorage.setItem(STORAGE_KEY,JSON.stringify({x:parseInt(panel.style.left),y:parseInt(panel.style.top)}));dragging=false;});document.addEventListener('mousemove',e=%3E{if(dragging){panel.style.left=(e.clientX-offsetX)+'px';panel.style.top=(e.clientY-offsetY)+'px';}});function%20hotkeyHandler(e){if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='z'){hidden=!hidden;panel.style.display=hidden?'none':'block';}}window.addEventListener('keydown',hotkeyHandler);}setEditMode(isEditable);createPanel();})();

javascript:(function(){if(document.getElementById('modeStatusPanel'))return;const STORAGE_KEY='modePanelPosition';let isEditable=true,pos=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')||{},x=pos.x||10,y=pos.y||10,hidden=false;function setEditMode(flag){document.body.contentEditable=flag?%27true%27:%27false%27;document.designMode=flag?%27on%27:%27off%27;}function%20createPanel(){let%20panel=document.createElement(%27div%27);panel.id=%27modeStatusPanel%27;Object.assign(panel.style,{position:%27fixed%27,left:x+%27px%27,top:y+%27px%27,zIndex:99999,backgroundColor:isEditable?%27#fff':'rgba(0,0,0,0.85)',color:isEditable?'#222':'#fff',border:'1px%20solid%20#ddd',borderRadius:'10px',padding:'16px%2048px%2022px%2018px',fontSize:'15px',fontFamily:'Arial,sans-serif',cursor:'move',boxShadow:'0%202px%2012px%20rgba(0,0,0,0.15)',opacity:'0.93',userSelect:'none',minWidth:'180px'});panel.contentEditable='false';let%20close=document.createElement('button');close.innerHTML='%3Csvg%20width=%2222%22%20height=%2222%22%20viewBox=%220%200%2022%2022%22%3E%3Ccircle%20cx=%2211%22%20cy=%2211%22%20r=%2210%22%20fill=%22rgba(0,0,0,0.12)%22/%3E%3Cline%20x1=%227%22%20y1=%227%22%20x2=%2215%22%20y2=%2215%22%20stroke=%22#555%22%20stroke-width=%222%22%20stroke-linecap=%22round%22/%3E%3Cline%20x1=%2215%22%20y1=%227%22%20x2=%227%22%20y2=%2215%22%20stroke=%22#555%22%20stroke-width=%222%22%20stroke-linecap=%22round%22/%3E%3C/svg%3E';close.setAttribute('aria-label','%E9%97%9C%E9%96%89');Object.assign(close.style,{position:'absolute',top:'7px',right:'10px',width:'28px',height:'28px',padding:'0',border:'none',background:'none',cursor:'pointer',borderRadius:'50%',transition:'background%200.2s',display:'flex',alignItems:'center',justifyContent:'center'});close.onmouseenter=function(){close.style.background='rgba(0,0,0,0.10)';};close.onmouseleave=function(){close.style.background='none';};close.onclick=function(){setEditMode(false);panel.remove();window.removeEventListener('keydown',hotkeyHandler);};let%20status=document.createElement('div');status.textContent=isEditable?'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%8F%AF%E7%B7%A8%E8%BC%AF':'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E4%B8%8D%E5%8F%AF%E7%B7%A8%E8%BC%AF';status.style.fontWeight='bold';status.style.cursor='pointer';status.style.marginTop='8px';status.style.textAlign='center';status.onclick=()=%3E{isEditable=!isEditable;setEditMode(isEditable);panel.remove();createPanel();};let%20range=document.createElement('input');range.type='range';range.min='0.05';range.max='1';range.step='0.05';range.value=panel.style.opacity;range.style.width='100%';range.style.marginTop='12px';range.oninput=e=%3E{panel.style.opacity=e.target.value;};panel.appendChild(close);panel.appendChild(status);panel.appendChild(range);document.body.appendChild(panel);let%20dragging=false,offsetX=0,offsetY=0;panel.addEventListener('mousedown',e=%3E{if(e.target.tagName==='INPUT'||e.target.tagName==='BUTTON'||e.target.tagName==='svg'||e.target.tagName==='circle'||e.target.tagName==='line')return;dragging=true;offsetX=e.clientX-x;offsetY=e.clientY-y;});document.addEventListener('mouseup',()=%3E{if(dragging)localStorage.setItem(STORAGE_KEY,JSON.stringify({x:parseInt(panel.style.left),y:parseInt(panel.style.top)}));dragging=false;});document.addEventListener('mousemove',e=%3E{if(dragging){panel.style.left=(e.clientX-offsetX)+'px';panel.style.top=(e.clientY-offsetY)+'px';}});function%20hotkeyHandler(e){if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='z'){hidden=!hidden;panel.style.display=hidden?'none':'block';}}window.addEventListener('keydown',hotkeyHandler);}setEditMode(isEditable);createPanel();})();

javascript:(function(){if(document.getElementById('modeStatusPanel'))return;let s='modePanelPosition',e=!(document.body.contentEditable==='true'),p=JSON.parse(localStorage.getItem(s)||'{}')||{},x=p.x||10,y=p.y||10;let a=t=>{document.body.contentEditable=t?%27true%27:%27false%27,document.designMode=t?%27on%27:%27off%27,document.querySelectorAll(%27input%27).forEach(i=%3E{t?(i.removeAttribute(%27disabled%27),i.removeAttribute(%27readonly%27)):i.setAttribute(%27disabled%27,!0)})},c=()=%3E{let%20d=document.createElement(%27div%27);d.id=%27modeStatusPanel%27;Object.assign(d.style,{position:%27fixed%27,left:x+%27px%27,top:y+%27px%27,zIndex:99999,backgroundColor:e?%27white%27:%27rgba(0,0,0,0.8)%27,color:e?%27black%27:%27white%27,border:%271px%20solid%20#ccc',borderRadius:'6px',padding:'10px%2014px%2018px',fontSize:'14px',fontFamily:'Arial,sans-serif',cursor:'move',boxShadow:'0%200%206px%20rgba(0,0,0,0.5)',opacity:'0.85',userSelect:'none'});let%20l=document.createElement('div');l.textContent=e?'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%8F%AF%E7%B7%A8%E8%BC%AF':'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E4%B8%8D%E5%8F%AF%E7%B7%A8%E8%BC%AF';l.style.fontWeight='bold';l.style.cursor='pointer';l.onclick=()=%3E{e=!e,a(e),d.remove(),c()};let%20r=document.createElement('input');r.type='range';r.min='0.2';r.max='1';r.step='0.05';r.value=d.style.opacity;r.style.width='100%';r.style.marginTop='10px';r.oninput=o=%3E{d.style.opacity=o.target.value};d.appendChild(l);d.appendChild(r);document.body.appendChild(d);let%20g=!1,mx=0,my=0;d.addEventListener('mousedown',u=%3E{if(u.target.tagName==='INPUT')return;g=!0,mx=u.clientX,my=u.clientY});document.addEventListener('mouseup',()=%3E{if(g)localStorage.setItem(s,JSON.stringify({x:parseInt(d.style.left),y:parseInt(d.style.top)}));g=!1});document.addEventListener('mousemove',u=%3E{if(g){let%20dx=u.clientX-mx,dy=u.clientY-my;d.style.left=(x+dx)+'px',d.style.top=(y+dy)+'px'}})};a(e);c()})();

javascript:(function(){if(document.getElementById('modeStatusPanel'))return;const STORAGE_KEY='modePanelPosition';let isEditable=true;let pos=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');let x=pos.x||10;let y=pos.y||10;let hidden=false;let unlockedInputs=[];function setEditMode(flag){document.body.contentEditable=flag?%27true%27:%27false%27;document.designMode=flag?%27on%27:%27off%27;document.addEventListener(%27contextmenu%27,e=%3Eflag&&e.stopPropagation(),true);if(flag){document.oncontextmenu=null;window.oncontextmenu=null;}else{unlockedInputs.forEach(i=%3E{i.setAttribute(%27disabled%27,true);i.setAttribute(%27readonly%27,true)});unlockedInputs=[];}}function%20forceUnlockInputs(){document.querySelectorAll(%27input%27).forEach(i=%3E{if(i.disabled||i.readOnly){unlockedInputs.push(i);i.removeAttribute(%27disabled%27);i.removeAttribute(%27readonly%27);}});}function%20createPanel(){let%20panel=document.createElement(%27div%27);panel.id=%27modeStatusPanel%27;Object.assign(panel.style,{position:%27fixed%27,left:x+%27px%27,top:y+%27px%27,zIndex:2147483647,background:%27rgba(255,255,255,0.95)%27,border:%271px%20solid%20#e0e0e0',borderRadius:'12px',padding:window.innerWidth%3C768?'12px%2036px%2018px%2014px':'14px%2020px',fontSize:window.innerWidth%3C768?'13px':'15px',fontFamily:'Arial,sans-serif',cursor:'move',boxShadow:'0%204px%2020px%20rgba(0,0,0,0.1)',opacity:'0.85',userSelect:'none',minWidth:window.innerWidth%3C768?'120px':'180px',backdropFilter:'blur(8px)',transition:'all%200.2s'});let%20close=document.createElement('button');close.innerHTML='%C3%97';Object.assign(close.style,{position:'absolute',top:'12px',right:'12px',width:'24px',height:'24px',fontSize:'18px',color:'#666',background:'transparent',border:'none',transition:'all%200.2s',cursor:'pointer',lineHeight:'24px',textAlign:'center'});close.onmouseenter=()=%3E{close.style.color='#333';close.style.transform='scale(1.1)';};close.onmouseleave=()=%3E{close.style.color='#666';close.style.transform='none';};close.onclick=()=%3E{setEditMode(false);panel.remove();window.removeEventListener('keydown',hotkeyHandler);};let%20status=document.createElement('div');status.textContent=isEditable?'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%8F%AF%E7%B7%A8%E8%BC%AF':'%E7%9B%AE%E5%89%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%E4%B8%8D%E5%8F%AF%E7%B7%A8%E8%BC%AF';Object.assign(status.style,{fontWeight:'bold',cursor:'pointer',marginTop:'8px',textAlign:'center'});status.onclick=()=%3E{isEditable=!isEditable;setEditMode(isEditable);panel.remove();createPanel();};let%20forceBtn=document.createElement('button');forceBtn.textContent='%EF%BC%BB%E5%BC%B7%E5%88%B6%E8%A7%A3%E9%99%A4%EF%BC%BD';Object.assign(forceBtn.style,{marginTop:'10px',padding:'6px%2010px',fontSize:'13px',border:'1px%20solid%20#ccc',borderRadius:'6px',background:'#f8f8f8',cursor:'pointer'});forceBtn.onclick=forceUnlockInputs;let%20range=document.createElement('input');range.type='range';range.min='0.05';range.max='1';range.step='0.05';range.value='0.85';Object.assign(range.style,{width:'100%',marginTop:'12px',cursor:'pointer'});range.oninput=e=%3E{panel.style.opacity=e.target.value;};panel.appendChild(close);panel.appendChild(status);panel.appendChild(forceBtn);panel.appendChild(range);window.addEventListener('resize',()=%3E{panel.style.padding=window.innerWidth%3C768?'12px%2036px%2018px%2014px':'14px%2020px';panel.style.fontSize=window.innerWidth%3C768?'13px':'15px';panel.style.minWidth=window.innerWidth%3C768?'120px':'180px';});document.body.appendChild(panel);let%20dragging=false,offsetX=0,offsetY=0;panel.addEventListener('mousedown',e=%3E{if(e.target.tagName==='INPUT'||e.target.tagName==='BUTTON')return;dragging=true;offsetX=e.clientX-x;offsetY=e.clientY-y;});document.addEventListener('mouseup',()=%3E{if(dragging)localStorage.setItem(STORAGE_KEY,JSON.stringify({x:parseInt(panel.style.left),y:parseInt(panel.style.top)}));dragging=false;});document.addEventListener('mousemove',e=%3E{if(dragging){x=e.clientX-offsetX;y=e.clientY-offsetY;panel.style.left=x+'px';panel.style.top=y+'px';}});function%20hotkeyHandler(e){if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='z'){hidden=!hidden;panel.style.display=hidden?'none':'block';}}window.addEventListener('keydown',hotkeyHandler);}setEditMode(isEditable);createPanel();})()

[清除]
javascript:(function(){let c=[],d=()=>{let e=document.createElement('div');e.style='position:fixed;top:20px;right:20px;padding:15px;background:#e8f5e9;border:1px%20solid%20#a5d6a7;border-radius:5px;box-shadow:0%202px%2010px%20rgba(0,0,0,0.1);z-index:9999;max-width:300px;';e.innerHTML=%60%3Cdiv%20style=%22margin-bottom:10px%22%3E%E5%B7%B2%E6%B8%85%E9%99%A4:%20${c.join(',%20')}%3C/div%3E%3Cbutton%20onclick=%22this.parentNode.remove()%22%20style=%22padding:5px%2010px;background:#2196f3;color:white;border:none;border-radius:3px;cursor:pointer;%22%3E%E9%97%9C%E9%96%89%3C/button%3E%60;document.body.appendChild(e);setTimeout(()=%3Ee.remove(),1500);};try{document.cookie.split(';').forEach(f=%3E{let%20g=f.indexOf('='),h=g%3E-1?f.substr(0,g):f;document.cookie=h.trim()+'=;expires=Thu,%2001%20Jan%201970%2000:00:00%20GMT;path=/';});c.push('Cookies');}catch(e){}try{localStorage.clear();c.push('localStorage');}catch(e){}try{sessionStorage.clear();c.push('sessionStorage');}catch(e){}'serviceWorker'in%20navigator&&navigator.serviceWorker.getRegistrations?navigator.serviceWorker.getRegistrations().then(f=%3E{f.forEach(i=%3Ei.unregister());f.length%3E0&&c.push('Service%20Workers');d();}):d();})();

[查詢xhr
javascript:(function(){const createUI=()=>{if(document.getElementById('api-analyzer-container')){document.getElementById('api-analyzer-container').remove();}const container=document.createElement('div');container.id='api-analyzer-container';container.style.cssText=`position:fixed;top:20px;right:20px;width:380px;max-height:80vh;background-color:#fff;border-radius:8px;box-shadow:0%200%2020px%20rgba(0,0,0,0.3);z-index:9999999;font-family:Arial,sans-serif;overflow:hidden;display:flex;flex-direction:column;%60;const%20header=document.createElement('div');header.style.cssText=%60display:flex;justify-content:space-between;align-items:center;padding:10px%2015px;background-color:#4a6cf7;color:white;font-weight:bold;cursor:move;user-select:none;%60;header.innerHTML='API%20%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7';const%20buttonGroup=document.createElement('div');buttonGroup.style.cssText=%60display:flex;gap:8px;%60;const%20closeButton=document.createElement('button');closeButton.innerHTML='%E2%9C%95';closeButton.style.cssText=%60background:none;border:none;color:white;font-size:16px;cursor:pointer;padding:0%205px;%60;closeButton.onclick=()=%3Econtainer.remove();const%20content=document.createElement('div');content.style.cssText=%60padding:15px;overflow-y:auto;flex-grow:1;max-height:calc(80vh%20-%2060px);%60;const%20resultArea=document.createElement('div');resultArea.id='api-analyzer-results';resultArea.style.cssText=%60width:100%;min-height:100px;max-height:400px;overflow-y:auto;border:1px%20solid%20#ddd;border-radius:5px;padding:10px;font-family:monospace;font-size:12px;margin-bottom:15px;white-space:pre-wrap;word-break:break-all;%60;const%20actionArea=document.createElement('div');actionArea.style.cssText=%60display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;%60;const%20createButton=(text,onClick)=%3E{const%20button=document.createElement('button');button.innerText=text;button.style.cssText=%60padding:6px%2012px;background-color:#4a6cf7;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;%60;button.onclick=onClick;return%20button;};const%20analyzeButton=createButton('%E5%88%86%E6%9E%90%E9%A0%81%E9%9D%A2API',analyzePageAPIs);const%20copyButton=createButton('%E8%A4%87%E8%A3%BD%E7%B5%90%E6%9E%9C',()=%3E{const%20resultText=document.getElementById('api-analyzer-results').innerText;if(resultText){navigator.clipboard.writeText(resultText).then(()=%3Ealert('%E5%B7%B2%E8%A4%87%E8%A3%BD%E5%88%B0%E5%89%AA%E8%B2%BC%E7%B0%BF')).catch(err=%3Ealert('%E8%A4%87%E8%A3%BD%E5%A4%B1%E6%95%97%EF%BC%9A'+err));}});const%20clearButton=createButton('%E6%B8%85%E9%99%A4%E7%B5%90%E6%9E%9C',()=%3E{document.getElementById('api-analyzer-results').innerText='';});const%20downloadTxtButton=createButton('%E4%B8%8B%E8%BC%89TXT',()=%3E{downloadResults('txt');});const%20downloadCSVButton=createButton('%E4%B8%8B%E8%BC%89CSV',()=%3E{downloadResults('csv');});const%20formatSelect=document.createElement('select');formatSelect.id='api-analyzer-format';formatSelect.style.cssText=%60padding:6px;border-radius:4px;border:1px%20solid%20#ddd;font-size:12px;%60;const%20formatOptions=['JSON','Text','Structured'];formatOptions.forEach(option=%3E{const%20optionEl=document.createElement('option');optionEl.value=option.toLowerCase();optionEl.text=option;formatSelect.appendChild(optionEl);});const%20formatLabel=document.createElement('label');formatLabel.innerText='%E8%BC%B8%E5%87%BA%E6%A0%BC%E5%BC%8F%EF%BC%9A';formatLabel.style.cssText=%60font-size:12px;margin-right:5px;align-self:center;%60;buttonGroup.appendChild(closeButton);header.appendChild(buttonGroup);actionArea.appendChild(analyzeButton);actionArea.appendChild(copyButton);actionArea.appendChild(clearButton);actionArea.appendChild(formatLabel);actionArea.appendChild(formatSelect);actionArea.appendChild(downloadTxtButton);actionArea.appendChild(downloadCSVButton);content.appendChild(actionArea);content.appendChild(resultArea);container.appendChild(header);container.appendChild(content);document.body.appendChild(container);makeDraggable(container,header);return%20container;};const%20makeDraggable=(element,handle)=%3E{let%20pos1=0,pos2=0,pos3=0,pos4=0;handle.onmousedown=dragMouseDown;function%20dragMouseDown(e){e=e||window.event;e.preventDefault();pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDragElement;document.onmousemove=elementDrag;}function%20elementDrag(e){e=e||window.event;e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;element.style.top=(element.offsetTop-pos2)+%22px%22;element.style.left=(element.offsetLeft-pos1)+%22px%22;}function%20closeDragElement(){document.onmouseup=null;document.onmousemove=null;}};const%20analyzePageAPIs=()=%3E{const%20resultArea=document.getElementById('api-analyzer-results');resultArea.innerText='%E5%88%86%E6%9E%90%E4%B8%AD%EF%BC%8C%E8%AB%8B%E7%A8%8D%E5%80%99...';const%20apiInfo={endpoints:[],tokens:[],page:window.location.href,title:document.title,timestamp:new%20Date().toISOString()};const%20extractStorageTokens=()=%3E{const%20tokenKeys=['token','auth','jwt','access','session','key','api'];const%20tokens=[];for(let%20i=0;i%3ClocalStorage.length;i++){const%20key=localStorage.key(i);const%20value=localStorage.getItem(key);if(tokenKeys.some(tk=%3Ekey.toLowerCase().includes(tk))){tokens.push({source:'localStorage',key:key,value:value,type:detectTokenType(value)});continue;}if(isLikelyToken(value)){tokens.push({source:'localStorage',key:key,value:value,type:detectTokenType(value)});}}for(let%20i=0;i%3CsessionStorage.length;i++){const%20key=sessionStorage.key(i);const%20value=sessionStorage.getItem(key);if(tokenKeys.some(tk=%3Ekey.toLowerCase().includes(tk))){tokens.push({source:'sessionStorage',key:key,value:value,type:detectTokenType(value)});continue;}if(isLikelyToken(value)){tokens.push({source:'sessionStorage',key:key,value:value,type:detectTokenType(value)});}}return%20tokens;};const%20detectTokenType=(value)=%3E{if(!value||typeof%20value!=='string')return'unknown';if(/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(value)){return'JWT';}if(value.startsWith('Bearer%20')){return'Bearer';}if(value.startsWith('Basic%20')){return'Basic%20Auth';}if(/^[A-Za-z0-9]{32,}$/.test(value)){return'API%20Key';}return'unknown';};const%20isLikelyToken=(value)=%3E{if(!value||typeof%20value!=='string')return%20false;if(value.length%3C20)return%20false;if(/^[0-9]+$/.test(value)||/^[a-zA-Z]+$/.test(value))return%20false;const%20tokenPatterns=[/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/,/^[A-Za-z0-9]{32,}$/,/Bearer\s+[A-Za-z0-9-_.+/=]+$/i,/^[A-Za-z0-9-_.+/=]{40,}$/];return%20tokenPatterns.some(pattern=%3Epattern.test(value));};const%20extractCookieTokens=()=%3E{const%20tokens=[];const%20cookies=document.cookie.split(';');for(const%20cookie%20of%20cookies){const[key,value]=cookie.trim().split('=');if(key&&value){if(['token','auth','jwt','session','key','api'].some(tk=%3Ekey.toLowerCase().includes(tk))){try{const%20decodedValue=decodeURIComponent(value);tokens.push({source:'cookie',key:key,value:decodedValue,type:detectTokenType(decodedValue)});}catch(e){tokens.push({source:'cookie',key:key,value:value,type:'unknown%20(decode%20error)'});}}}}return%20tokens;};const%20getHeaderValue=(headers,name)=%3E{if(!headers)return%20null;name=name.toLowerCase();for(let[key,value]of%20headers.entries()){if(key.toLowerCase()===name){return%20value;}}return%20null;};const%20originalXHROpen=XMLHttpRequest.prototype.open;const%20originalXHRSend=XMLHttpRequest.prototype.send;const%20originalFetch=window.fetch;XMLHttpRequest.prototype.open=function(method,url){this._method=method;this._url=url;return%20originalXHROpen.apply(this,arguments);};XMLHttpRequest.prototype.send=function(data){const%20xhr=this;xhr._requestData=data;xhr.addEventListener('load',function(){try{let%20responseData;try{responseData=JSON.parse(xhr.responseText);}catch(e){responseData=xhr.responseText;}const%20requestHeaders={};if(xhr.getAllResponseHeaders){const%20headersString=xhr.getAllResponseHeaders();if(headersString){headersString.trim().split('\n').forEach(line=%3E{const%20parts=line.split(':%20');const%20header=parts.shift();const%20value=parts.join(':%20');requestHeaders[header]=value;});}}let%20requestDataParsed;if(xhr._requestData){try{requestDataParsed=JSON.parse(xhr._requestData);}catch(e){requestDataParsed=xhr._requestData;}}apiInfo.endpoints.push({url:xhr._url,method:xhr._method,requestHeaders:requestHeaders,requestData:requestDataParsed,responseStatus:xhr.status,responseType:xhr.getResponseHeader('Content-Type'),responseData:responseData});updateResults();}catch(e){console.error('API%E5%88%86%E6%9E%90%E5%99%A8%E8%99%95%E7%90%86XHR%E9%9F%BF%E6%87%89%E6%99%82%E5%87%BA%E9%8C%AF:',e);}});return%20originalXHRSend.apply(this,arguments);};window.fetch=async%20function(input,init){const%20url=(typeof%20input==='string')?input:input.url;const%20method=(init&&init.method)||(typeof%20input==='string'?'GET':input.method)||'GET';let%20requestData;if(init&&init.body){try{requestData=JSON.parse(init.body);}catch(e){requestData=init.body;}}try{const%20response=await%20originalFetch.apply(this,arguments);const%20clonedResponse=response.clone();let%20responseData;try{const%20contentType=clonedResponse.headers.get('content-type');if(contentType&&contentType.includes('application/json')){responseData=await%20clonedResponse.json();}else{responseData=await%20clonedResponse.text();}}catch(e){responseData='Unable%20to%20parse%20response';}const%20requestHeaders={};if(init&&init.headers){if(init.headers%20instanceof%20Headers){for(let[key,value]of%20init.headers.entries()){requestHeaders[key]=value;}}else%20if(typeof%20init.headers==='object'){Object.assign(requestHeaders,init.headers);}}apiInfo.endpoints.push({url:url,method:method,requestHeaders:requestHeaders,requestData:requestData,responseStatus:response.status,responseType:response.headers.get('Content-Type'),responseData:responseData});updateResults();return%20response;}catch(error){console.error('API%E5%88%86%E6%9E%90%E5%99%A8%E8%99%95%E7%90%86Fetch%E8%AB%8B%E6%B1%82%E6%99%82%E5%87%BA%E9%8C%AF:',error);throw%20error;}};apiInfo.tokens=[...extractStorageTokens(),...extractCookieTokens()];let%20lastResultCount=0;function%20updateResults(){if(apiInfo.endpoints.length%3ElastResultCount){lastResultCount=apiInfo.endpoints.length;const%20format=document.getElementById('api-analyzer-format').value;const%20resultArea=document.getElementById('api-analyzer-results');let%20outputContent='';if(format==='json'){outputContent=JSON.stringify(apiInfo,null,2);}else%20if(format==='text'){outputContent=generateTextOutput(apiInfo);}else{outputContent=generateStructuredOutput(apiInfo);}resultArea.innerText=outputContent;}}function%20generateTextOutput(data){let%20output=%60===%20%E9%A0%81%E9%9D%A2%E8%B3%87%E8%A8%8A%20===\n%60;output+=%60URL:%20${data.page}\n%60;output+=%60%E6%A8%99%E9%A1%8C:%20${data.title}\n%60;output+=%60%E5%88%86%E6%9E%90%E6%99%82%E9%96%93:%20${new%20Date(data.timestamp).toLocaleString()}\n\n%60;output+=%60===%20%E6%AC%8A%E9%99%90%E4%BB%A4%E7%89%8C%20===\n%60;if(data.tokens.length===0){output+=%60%E6%9C%AA%E6%89%BE%E5%88%B0%E4%BB%A4%E7%89%8C\n%60;}else{data.tokens.forEach((token,i)=%3E{output+=%60%E4%BB%A4%E7%89%8C%20${i+1}:\n%60;output+=%60%20%20%E4%BE%86%E6%BA%90:%20${token.source}\n%60;output+=%60%20%20%E9%8D%B5%E5%90%8D:%20${token.key}\n%60;output+=%60%20%20%E9%A1%9E%E5%9E%8B:%20${token.type}\n%60;output+=%60%20%20%E5%80%BC:%20${token.value.substring(0,20)}${token.value.length%3E20?'...':''}\n\n%60;});}output+=%60===%20API%E7%AB%AF%E9%BB%9E%20(${data.endpoints.length})%20===\n%60;data.endpoints.forEach((endpoint,i)=%3E{output+=%60API%20${i+1}:%20${endpoint.method}%20${endpoint.url}\n%60;output+=%60%20%20%E7%8B%80%E6%85%8B:%20${endpoint.responseStatus}\n%60;output+=%60%20%20%E8%AB%8B%E6%B1%82%E9%A0%AD:%20${JSON.stringify(endpoint.requestHeaders)}\n%60;if(endpoint.requestData){output+=%60%20%20%E8%AB%8B%E6%B1%82%E6%95%B8%E6%93%9A:%20${typeof%20endpoint.requestData==='object'?JSON.stringify(endpoint.requestData):endpoint.requestData}\n%60;}if(endpoint.responseData){const%20respData=typeof%20endpoint.responseData==='object'?JSON.stringify(endpoint.responseData):endpoint.responseData;output+=%60%20%20%E5%9B%9E%E6%87%89%E6%95%B8%E6%93%9A:%20${respData.length%3E200?respData.substring(0,200)+'...':respData}\n%60;}output+='\n';});return%20output;}function%20generateStructuredOutput(data){let%20output=%60#%20API%E5%88%86%E6%9E%90%E5%A0%B1%E5%91%8A\n\n%60;output+=%60##%20%E9%A0%81%E9%9D%A2%E8%B3%87%E8%A8%8A\n%60;output+=%60-%20**URL**:%20${data.page}\n%60;output+=%60-%20**%E6%A8%99%E9%A1%8C**:%20${data.title}\n%60;output+=%60-%20**%E5%88%86%E6%9E%90%E6%99%82%E9%96%93**:%20${new%20Date(data.timestamp).toLocaleString()}\n\n%60;output+=%60##%20%E6%AC%8A%E9%99%90%E4%BB%A4%E7%89%8C\n%60;if(data.tokens.length===0){output+=%60_%E6%9C%AA%E6%89%BE%E5%88%B0%E4%BB%A4%E7%89%8C_\n\n%60;}else{data.tokens.forEach((token,i)=%3E{output+=%60###%20%E4%BB%A4%E7%89%8C%20${i+1}\n%60;output+=%60-%20**%E4%BE%86%E6%BA%90**:%20${token.source}\n%60;output+=%60-%20**%E9%8D%B5%E5%90%8D**:%20${token.key}\n%60;output+=%60-%20**%E9%A1%9E%E5%9E%8B**:%20${token.type}\n%60;output+=%60-%20**%E5%80%BC**:%20\%60${token.value.substring(0,20)}${token.value.length%3E20?'...':''}\%60\n\n%60;});}output+=%60##%20API%E7%AB%AF%E9%BB%9E%20(${data.endpoints.length})\n\n%60;data.endpoints.forEach((endpoint,i)=%3E{output+=%60###%20${i+1}.%20${endpoint.method}%20${endpoint.url}\n%60;output+=%60-%20**%E7%8B%80%E6%85%8B%E7%A2%BC**:%20${endpoint.responseStatus}\n%60;output+=%60-%20**%E8%AB%8B%E6%B1%82%E9%A0%AD**:\n%60;if(Object.keys(endpoint.requestHeaders).length===0){output+=%60%20%20_%E7%84%A1%E8%AB%8B%E6%B1%82%E9%A0%AD%E8%B3%87%E8%A8%8A_\n%60;}else{for(const[key,value]of%20Object.entries(endpoint.requestHeaders)){output+=%60%20%20-%20\%60${key}\%60:%20\%60${value}\%60\n%60;}}if(endpoint.requestData){output+=%60-%20**%E8%AB%8B%E6%B1%82%E6%95%B8%E6%93%9A**:\n\%60\%60\%60json\n${typeof%20endpoint.requestData==='object'?JSON.stringify(endpoint.requestData,null,2):endpoint.requestData}\n\%60\%60\%60\n%60;}if(endpoint.responseData){output+=%60-%20**%E5%9B%9E%E6%87%89%E6%95%B8%E6%93%9A**:\n\%60\%60\%60json\n${typeof%20endpoint.responseData==='object'?JSON.stringify(endpoint.responseData,null,2).substring(0,400):endpoint.responseData.substring(0,400)}${endpoint.responseData.length%3E400?'\n...(%E5%B7%B2%E6%88%AA%E6%96%B7)':''}\n\%60\%60\%60\n%60;}output+='\n';});return%20output;}function%20convertToCSV(data){let%20csv='URL,Method,Status,RequestParams,ResponseFields\n';data.endpoints.forEach(endpoint=%3E{const%20url=%60%22${endpoint.url.replace(/%22/g,'%22%22')}%22%60;const%20method=endpoint.method;const%20status=endpoint.responseStatus;let%20requestParams='';if(endpoint.requestData){if(typeof%20endpoint.requestData==='object'){requestParams=%60%22${JSON.stringify(endpoint.requestData).replace(/%22/g,'%22%22')}%22%60;}else{requestParams=%60%22${endpoint.requestData.replace(/%22/g,'%22%22')}%22%60;}};let%20responseFields='';if(endpoint.responseData){if(typeof%20endpoint.responseData==='object'){responseFields=%60%22${JSON.stringify(endpoint.responseData).replace(/%22/g,'%22%22')}%22%60;}else{responseFields=%60%22${endpoint.responseData.replace(/%22/g,'%22%22')}%22%60;}};csv+=%60${url},${method},${status},${requestParams},${responseFields}\n%60;});return%20csv;}function%20downloadResults(format){let%20content,filename,type;if(format==='csv'){content=convertToCSV(apiInfo);filename=%60api-analysis-${new%20Date().toISOString().slice(0,10)}.csv%60;type='text/csv';}else{const%20outputFormat=document.getElementById('api-analyzer-format').value;if(outputFormat==='json'){content=JSON.stringify(apiInfo,null,2);}else%20if(outputFormat==='text'){content=generateTextOutput(apiInfo);}else{content=generateStructuredOutput(apiInfo);}filename=%60api-analysis-${new%20Date().toISOString().slice(0,10)}.txt%60;type='text/plain';}const%20blob=new%20Blob([content],{type});const%20link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=filename;link.click();URL.revokeObjectURL(link.href);}updateResults();setTimeout(()=%3E{if(apiInfo.endpoints.length===0){resultArea.innerText='%E5%B0%9A%E6%9C%AA%E6%8D%95%E7%8D%B2%E5%88%B0API%E8%AB%8B%E6%B1%82%E3%80%82%E8%AB%8B%E5%98%97%E8%A9%A6%E7%80%8F%E8%A6%BD%E7%B6%B2%E9%A0%81%E6%88%96%E9%80%B2%E8%A1%8C%E6%93%8D%E4%BD%9C%E4%BE%86%E8%A7%B8%E7%99%BCAPI%E8%AB%8B%E6%B1%82%E3%80%82';}},2000);};createUI();analyzePageAPIs();})();]

[ag]
javascript:(function(){'use strict';if(window.fetchInterceptorInstalled){alert("%E8%87%AA%E5%8B%95%E4%B8%8B%E8%BC%89%E7%9B%A3%E8%81%BD%E5%99%A8%E5%B7%B2%E7%B6%93%E5%9C%A8%E9%81%8B%E4%BD%9C%E4%B8%AD%EF%BC%8C%E7%84%A1%E9%9C%80%E9%87%8D%E8%A4%87%E5%95%9F%E5%8B%95%E3%80%82");return}function downloadJson(dataObject,filename){try{const jsonString=JSON.stringify(dataObject,null,2);const blob=new Blob([jsonString],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);console.log(`%E6%AA%94%E6%A1%88 '${filename}' %E5%B7%B2%E6%88%90%E5%8A%9F%E8%A7%B8%E7%99%BC%E4%B8%8B%E8%BC%89%E3%80%82`)}catch(error){console.error("%E4%B8%8B%E8%BC%89%E6%AA%94%E6%A1%88%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4:",error);alert("%E4%B8%8B%E8%BC%89%E6%AA%94%E6%A1%88%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4%EF%BC%8C%E8%AB%8B%E6%AA%A2%E6%9F%A5%E9%96%8B%E7%99%BC%E8%80%85%E5%B7%A5%E5%85%B7 Console %E7%9A%84%E8%A8%8A%E6%81%AF%E3%80%82")}}function installFetchInterceptor(){const originalFetch=window.fetch;window.fetch=async function(...args){const[url]=args;const response=await originalFetch(...args);if(response.url&&response.url.includes('ReportOnline.action?insuranceTypes%27)){console.log(%27%E6%88%90%E5%8A%9F%E6%94%94%E6%88%AA%E5%88%B0%E7%9B%AE%E6%A8%99%20API%20%E8%AB%8B%E6%B1%82:%20ReportOnline.action?insuranceTypes%27);try{const%20clonedResponse=response.clone();const%20data=await%20clonedResponse.json();console.log(%27%E6%88%90%E5%8A%9F%E7%8D%B2%E5%8F%96%20JSON%20%E8%B3%87%E6%96%99%EF%BC%8C%E6%BA%96%E5%82%99%E4%B8%8B%E8%BC%89...%27);downloadJson(data,%27insuranceTypes.json%27)}catch(e){console.error(%27%E8%99%95%E7%90%86%E6%94%94%E6%88%AA%E5%88%B0%E7%9A%84%E5%9B%9E%E6%87%89%E6%99%82%E7%99%BC%E7%94%9F%E9%8C%AF%E8%AA%A4:%27,e)}}return%20response};window.fetchInterceptorInstalled=!0;alert(%27%E2%9C%85%20%E8%87%AA%E5%8B%95%E4%B8%8B%E8%BC%89%E7%9B%A3%E8%81%BD%E5%99%A8%E5%B7%B2%E6%88%90%E5%8A%9F%E5%95%9F%E5%8B%95%EF%BC%81\n\n%E6%8E%A5%E4%B8%8B%E4%BE%86%E8%AB%8B%E6%AD%A3%E5%B8%B8%E6%93%8D%E4%BD%9C%E7%B6%B2%E9%A0%81%EF%BC%8C%E7%95%B6%20%22insuranceTypes%22%20%E8%B3%87%E6%96%99%E8%BC%89%E5%85%A5%E6%99%82%EF%BC%8C%E5%B0%87%E6%9C%83%E8%87%AA%E5%8B%95%E8%A7%B8%E7%99%BC%E4%B8%8B%E8%BC%89%E3%80%82%27)}installFetchInterceptor()})()
