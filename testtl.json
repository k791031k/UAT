[
  {
    "id": "清除快取工具",
    "description": "電腦一直跳很煩對吧，點我就對了，但可能會登出喔",
    "category": "系統工具",
    "type": "utility",
    "action_script": "javascript:(function(){let s={cookies:0,localStorage:0,sessionStorage:0,serviceWorkers:0},f=()=>{let e=document.createElement('div');e.style='position:fixed;top:20px;right:20px;padding:15px;background:#'+(s.fail?'ffebee':'e8f5e9')+';border:1px solid #'+(s.fail?'ef9a9a':'a5d6a7')+';border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:9999;max-width:300px;font-family:Arial;';e.innerHTML='<div style=\"margin-bottom:10px;font-weight:bold\">'+(s.fail?'清理完成！ (部分失敗)':'清理完成！')+'</div><div style=\"margin-bottom:8px\">✅ 成功：'+['Cookies','localStorage','sessionStorage','Service Workers'].filter(k=>s[k]).join(', ')+'</div>'+(s.fail?'<div style=\"color:#d32f2f;margin-bottom:8px\">❌ 失敗：'+s.fail+'</div>':'')+'<button style=\"padding:5px 10px;background:#2196f3;color:white;border:none;border-radius:3px;cursor:pointer;\"onclick=\"this.parentNode.remove()\">關閉</button>';document.body.appendChild(e);setTimeout(()=>e.remove(),3000);};try{document.cookie.split(';').forEach(c=>{let i=c.indexOf('='),n=i>-1?c.substr(0,i):c;document.cookie=n.trim()+'=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';});s.cookies=1;}catch(e){s.fail=(s.fail||'')+'Cookies ';}try{localStorage.clear();s.localStorage=1;}catch(e){s.fail=(s.fail||'')+'localStorage ';}try{sessionStorage.clear();s.sessionStorage=1;}catch(e){s.fail=(s.fail||'')+'sessionStorage ';}if('serviceWorker'in navigator&&navigator.serviceWorker.getRegistrations){navigator.serviceWorker.getRegistrations().then(r=>{r.forEach(w=>w.unregister());s.serviceWorkers=r.length>0?1:0;f();}).catch(e=>{s.fail=(s.fail||'')+'ServiceWorkers ';f();});}else{f();}})();"
  }, 
  {
    "id": "webUI",
    "description": "網頁助理",
    "category": "系統工具",
    "type": "utility",
    "action_script": "external:https://cdn.jsdelivr.net/gh/k791031k/TRY/webUI1.js?v=%27+Date.now()}, 

  {
    "id": "編輯",
    "description": "就是編輯啊",
    "category": "系統工具",
    "type": "utility",
    "action_script": "javascript:(function(){var isEditable = document.body.contentEditable === 'true'; if(isEditable){ document.body.contentEditable = 'false'; var elements = document.querySelectorAll('[readonly], [disabled]'); elements.forEach(function(element){if(!element.hasAttribute('readonly')){element.setAttribute('readonly', 'true'); } if(!element.hasAttribute('disabled')){element.setAttribute('disabled', 'true'); } }); }else{ document.body.contentEditable = 'true'; var elements = document.querySelectorAll('[readonly], [disabled]'); elements.forEach(function(element){element.removeAttribute('readonly');element.removeAttribute('disabled');});}})();"
  },
  {
    "id": "商品查詢",
    "description": "現售停售通路都可以查",
    "category": "商品",
    "type": "utility",
    "action_script": "external:https://cdn.jsdelivr.net/gh/k791031k/TRY/nGplan.js?v=%27+Date.now()"
  },
  {
    "id": "商品查詢",
    "description": "現售停售通路都可以查",
    "category": "商品",
    "type": "utility",
    "action_script": "external:https://cdn.jsdelivr.net/gh/k791031k/TRY/nGplan.js?v=%27+Date.now()"
  },
  {
    "id": "A17ok06"
    "description": "a17",
    "category": “a17",
    "type": "utility",
    "action_script": "javascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query';const TOKEN_STORAGE_KEY='euisToken';const A17_TEXT_SETTINGS_STORAGE_KEY='kgilifeQueryTool_A17TextSettings_v3';const TOOL_MAIN_CONTAINER_ID='kgilifeQueryToolMainContainer_vFinal';const Z_INDEX_OVERLAY=2147483640;const Z_INDEX_MAIN_UI=2147483630;const Z_INDEX_NOTIFICATION=2147483647;const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'送金單號碼',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'受理號碼',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'保單號碼',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'確認書編號',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'被保人ＩＤ',color:'#17a2b8'}];const FIELD_DISPLAY_NAMES_MAP={applyNumber:'受理號碼',policyNumber:'保單號碼',approvalNumber:'確認書編號',receiptNumber:'送金單',insuredId:'被保人ＩＤ',statusCombined:'狀態',mainStatus:'主狀態',subStatus:'次狀態',uwApproverUnit:'分公司',uwApprover:'核保員',approvalUser:'覆核',_queriedValue_:'查詢值',NO:'序號',_apiQueryStatus:'查詢結果'};const ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'];const UNIT_CODE_MAPPINGS={H:'核保部',B:'北一',C:'台中',K:'高雄',N:'台南',P:'北二',T:'桃竹',G:'保作'};const A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-總公司',color:'#007bff'},{id:'B',label:'B-北一',color:'#28a745'},{id:'P',label:'P-北二',color:'#ffc107'},{id:'T',label:'T-桃竹',color:'#17a2b8'},{id:'C',label:'C-台中',color:'#fd7e14'},{id:'N',label:'N-台南',color:'#6f42c1'},{id:'K',label:'K-高雄',color:'#e83e8c'},{id:'UNDEF',label:'查無單位',color:'#546e7a'}];const UNIT_MAP_FIELD_API_KEY='uwApproverUnit';const A17_DEFAULT_TEXT_CONTENT="DEAR,\n\n依據【管理報表：A17 新契約異常帳務】所載內容，報表中列示之送金單號碼，涉及多項帳務異常情形，例如：溢繳、短收、取消件需退費、以及無相對應之案件等問題。\n\n本週我們已逐筆查詢該等異常帳務，結果顯示，這些送金單應對應至下表所列之新契約案件。為利後續帳務處理，敬請協助確認各案件之實際帳務狀況，並如有需調整或處理事項，請一併協助辦理，謝謝。";let CURRENT_API_URL='';let apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY);let selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS[0];let originalQueryResults=[];let baseA17MasterData=[];let currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:!1,mainUIElement:null,tableBodyElement:null,tableHeadElement:null,a17UnitButtonsContainer:null,};let a17ModeState={isActive:!1,selectedUnits:new Set(),textSettings:{mainContent:A17_DEFAULT_TEXT_CONTENT,mainFontSize:12,mainLineHeight:1.5,mainFontColor:'#333333',dateFontSize:8,dateLineHeight:1.2,dateFontColor:'#555555',genDateOffset:-3,compDateOffset:0,},};let csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1,};let isEditMode=!1;let dragState={dragging:!1,startX:0,startY:0,initialX:0,initialY:0};let a17ButtonLongPressTimer=null;function escapeHtml(unsafe){if(typeof unsafe!=='string')return unsafe===null||unsafe===undefined?'':String(unsafe);return unsafe.replace(/[&<>"']/g,m=>({'&':'&','<':'<','>':'>','"':'"',"'":'&#039;'})[m])}function displaySystemNotification(message,isError=!1,duration=3000){const id=TOOL_MAIN_CONTAINER_ID+'_Notification';document.getElementById(id)?.remove();const n=document.createElement('div');n.id=id;n.style.cssText=%60position:fixed;top:20px;right:20px;background-color:${isError ? '#dc3545' : '#28a745'};color:white;padding:10px 15px;border-radius:5px;z-index:${Z_INDEX_NOTIFICATION};font-size:14px;font-family:'Microsoft JhengHei',Arial,sans-serif;box-shadow:0 2px 10px rgba(0,0,0,0.2);transform:translateX(calc(100% + 25px));transition:transform 0.3s ease-in-out;display:flex;align-items:center;%60;const i=document.createElement('span');i.style.marginRight='8px';i.style.fontSize='16px';i.innerHTML=isError?'&#x26A0;':'&#x2714;';n.appendChild(i);n.appendChild(document.createTextNode(message));document.body.appendChild(n);setTimeout(()=>n.style.transform='translateX(0)',50);setTimeout(()=>{n.style.transform='translateX(calc(100% + 25px))';setTimeout(()=>n.remove(),300)},duration)}function createDialogBase(idSuffix,contentHtml,minWidth='350px',maxWidth='600px',customStyles=''){const id=TOOL_MAIN_CONTAINER_ID+idSuffix;document.getElementById(id+'_overlay')?.remove();const overlay=document.createElement('div');overlay.id=id+'_overlay';overlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:${Z_INDEX_OVERLAY};display:flex;align-items:center;justify-content:center;font-family:'Microsoft JhengHei',Arial,sans-serif;backdrop-filter:blur(2px);%60;const dialog=document.createElement('div');dialog.id=id+'_dialog';dialog.style.cssText=%60background:#fff;padding:20px 25px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,0.25);min-width:${minWidth};max-width:${maxWidth};width:auto;animation:qtDialogAppear 0.2s ease-out;${customStyles}%60;dialog.innerHTML=contentHtml;overlay.appendChild(dialog);document.body.appendChild(overlay);const styleEl=document.createElement('style');styleEl.textContent=%60@keyframes qtDialogAppear{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}.qt-dialog-btn{border:none;padding:8px 15px;border-radius:4px;font-size:13px;cursor:pointer;transition:opacity 0.2s ease,transform 0.1s ease;font-weight:500;margin-left:8px;}.qt-dialog-btn:hover{opacity:0.85;}.qt-dialog-btn:active{transform:scale(0.98);}.qt-dialog-btn-blue{background:#007bff;color:white;}.qt-dialog-btn-grey{background:#6c757d;color:white;}.qt-dialog-btn-red{background:#dc3545;color:white;}.qt-dialog-btn-orange{background:#fd7e14;color:white;}.qt-dialog-btn-green{background:#28a745;color:white;}.qt-dialog-title{margin:0 0 15px 0;color:#333;font-size:18px;text-align:center;font-weight:600;}.qt-input,.qt-textarea,.qt-select{width:calc(100% - 18px);padding:9px;border:1px solid #ccc;border-radius:4px;font-size:13px;margin-bottom:15px;color:#333;box-sizing:border-box;}.qt-textarea{min-height:70px;resize:vertical;}.qt-dialog-flex-end{display:flex;justify-content:flex-end;margin-top:15px;}.qt-dialog-flex-between{display:flex;justify-content:space-between;align-items:center;margin-top:15px;}%60;dialog.appendChild(styleEl);return{overlay,dialog}}function extractName(strVal){if(!strVal||typeof strVal!=='string')return'';const matchResult=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+/);return matchResult?matchResult[0]:strVal.split(' ')[0]}function getFirstLetter(unitString){if(!unitString||typeof unitString!=='string')return'Z';for(let i=0;i<unitString.length;i++){const char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char))return char}return'Z'}function formatDate(date){const y=date.getFullYear();const m=String(date.getMonth()+1).padStart(2,'0');const d=String(date.getDate()).padStart(2,'0');return %60${y}${m}${d}%60}function createEnvSelectionDialog(){return new Promise(resolve=>{const contentHtml=%60<h3 class="qt-dialog-title">選擇查詢環境</h3><div style="display:flex; gap:10px; justify-content:center;"><button id="qt-env-uat" class="qt-dialog-btn qt-dialog-btn-green" style="flex-grow:1;">測試 (UAT)</button><button id="qt-env-prod" class="qt-dialog-btn qt-dialog-btn-orange" style="flex-grow:1;">正式 (PROD)</button></div><div style="text-align:center; margin-top:15px;"><button id="qt-env-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button></div>%60;const{overlay}=createDialogBase('_EnvSelect',contentHtml,'300px','auto');const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-env-uat').onclick=()=>closeDialog('test');overlay.querySelector('#qt-env-prod').onclick=()=>closeDialog('prod');overlay.querySelector('#qt-env-cancel').onclick=()=>closeDialog(null)})}function createTokenDialog(attempt=1){return new Promise(resolve=>{const contentHtml=%60<h3 class="qt-dialog-title">API TOKEN 設定</h3><input type="password" id="qt-token-input" class="qt-input" placeholder="請輸入您的 API TOKEN">${attempt > 1 ? %60<p style="color:red; font-size:12px; text-align:center; margin-bottom:10px;">Token驗證失敗，請重新輸入。</p>%60 : ''}<div class="qt-dialog-flex-between"><button id="qt-token-skip" class="qt-dialog-btn qt-dialog-btn-orange">略過</button><div><button id="qt-token-close-tool" class="qt-dialog-btn qt-dialog-btn-red">關閉工具</button><button id="qt-token-ok" class="qt-dialog-btn qt-dialog-btn-blue">${attempt > 1 ? '重試' : '確定'}</button></div></div>%60;const{overlay}=createDialogBase('_Token',contentHtml,'320px','auto');const inputEl=overlay.querySelector('#qt-token-input');inputEl.focus();if(attempt>2){const okBtn=overlay.querySelector('#qt-token-ok');okBtn.disabled=!0;okBtn.style.opacity='0.5';okBtn.style.cursor='not-allowed';displaySystemNotification('Token多次驗證失敗',!0,4000)}const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog('_token_dialog_cancel_');};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-token-ok').onclick=()=>closeDialog(inputEl.value.trim());overlay.querySelector('#qt-token-close-tool').onclick=()=>closeDialog('_close_tool_');overlay.querySelector('#qt-token-skip').onclick=()=>closeDialog('_skip_token_')})}function createQuerySetupDialog(){return new Promise(resolve=>{const queryButtonsHtml=QUERYABLE_FIELD_DEFINITIONS.map(def=>%60<button class="qt-querytype-btn" data-apikey="${def.queryApiKey}" style="background-color:${def.color}; color:white; border: 2px solid transparent; padding: 8px 10px; flex-grow: 1; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer;">${escapeHtml(def.queryDisplayName)}</button>%60).join('');const contentHtml=%60<h3 class="qt-dialog-title">查詢條件設定</h3><div style="margin-bottom:10px; font-size:13px; color:#555;">選擇查詢欄位類型：</div><div id="qt-querytype-buttons" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;">${queryButtonsHtml}</div><div style="margin-bottom:5px; font-size:13px; color:#555;">輸入查詢值 (可多筆，以換行/空格/逗號/分號分隔)：</div><textarea id="qt-queryvalues-input" class="qt-textarea" placeholder="請先選擇上方查詢欄位類型"></textarea><div style="margin-bottom:15px;"><button id="qt-csv-import-btn" class="qt-dialog-btn qt-dialog-btn-grey" style="margin-left:0;">從CSV/TXT匯入...</button><span id="qt-csv-filename-display" style="font-size:12px; color:#666; margin-left:10px;"></span></div><div class="qt-dialog-flex-between"><button id="qt-clear-all-input-btn" class="qt-dialog-btn qt-dialog-btn-orange">清除所有輸入</button><div><button id="qt-querysetup-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button><button id="qt-querysetup-ok" class="qt-dialog-btn qt-dialog-btn-blue">開始查詢</button></div></div><input type="file" id="qt-file-input-hidden" accept=".csv,.txt" style="display:none;">%60;const{overlay,dialog}=createDialogBase('_QuerySetup',contentHtml,'480px','auto');const queryValuesInput=overlay.querySelector('#qt-queryvalues-input');const typeButtons=overlay.querySelectorAll('.qt-querytype-btn');const csvImportBtn=overlay.querySelector('#qt-csv-import-btn');const fileInputHidden=overlay.querySelector('#qt-file-input-hidden');const csvFilenameDisplay=overlay.querySelector('#qt-csv-filename-display');function setActiveButton(apiKey){typeButtons.forEach(btn=>{const isSelected=btn.dataset.apikey===apiKey;btn.style.border=isSelected?%602px solid ${btn.style.backgroundColor}%60:'2px solid transparent';btn.style.boxShadow=isSelected?%600 0 8px ${btn.style.backgroundColor}70%60:'none';if(isSelected){selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(d=>d.queryApiKey===apiKey);queryValuesInput.placeholder=%60請輸入${selectedQueryDefinitionGlobal.queryDisplayName}(可多筆...)%60}})}typeButtons.forEach(btn=>btn.onclick=()=>{setActiveButton(btn.dataset.apikey);queryValuesInput.focus()});setActiveButton(selectedQueryDefinitionGlobal.queryApiKey);csvImportBtn.onclick=()=>fileInputHidden.click();fileInputHidden.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;csvFilenameDisplay.textContent=%60已選: ${file.name}%60;try{const text=await file.text();const lines=text.split(/\r?\n/).filter(line=>line.trim()!=='');if(lines.length===0){displaySystemNotification('CSV檔案為空',!0);return}const headers=lines[0].split(/,|;|\t/).map(h=>h.trim().replace(/^"|"$/g,''));const purpose=await createCSVPurposeDialog();if(!purpose){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}if(purpose==='fillQueryValues'){const columnIndex=await createCSVColumnSelectionDialog(headers,"選擇包含查詢值的欄位：");if(columnIndex===null||columnIndex===undefined){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}const values=[];for(let i=1;i<lines.length;i++){const cols=lines[i].split(/,|;|\t/).map(c=>c.trim().replace(/^"|"$/g,''));if(cols[columnIndex]&&cols[columnIndex].trim()!=="")values.push(cols[columnIndex].trim());}queryValuesInput.value=Array.from(new Set(values)).join('\n');displaySystemNotification('查詢值已從CSV填入',!1);csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=>line.split(/,|;|\t/).map(c=>c.trim().replace(/^"|"$/g,''))),selectedColForQueryName:headers[columnIndex],isA17CsvPrepared:!1,selectedColsForA17Merge:[]}}else if(purpose==='prepareA17Merge'){const selectedHeadersForA17=await createCSVColumnCheckboxDialog(headers,"勾選要在A17表格中顯示的CSV欄位：");if(!selectedHeadersForA17||selectedHeadersForA17.length===0){csvFilenameDisplay.textContent='';fileInputHidden.value='';return}csvImportState={...csvImportState,fileName:file.name,rawHeaders:headers,rawData:lines.slice(1).map(line=>line.split(/,|;|\t/).map(c=>c.trim().replace(/^"|"$/g,''))),selectedColsForA17Merge:selectedHeadersForA17,isA17CsvPrepared:!0,selectedColForQueryName:null};displaySystemNotification(%60已選 ${selectedHeadersForA17.length} 個CSV欄位供A17合併%60,!1)}}catch(err){console.error("處理CSV錯誤:",err);displaySystemNotification('讀取CSV失敗',!0);csvFilenameDisplay.textContent=''}fileInputHidden.value=''};overlay.querySelector('#qt-clear-all-input-btn').onclick=()=>{queryValuesInput.value='';csvFilenameDisplay.textContent='';csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};fileInputHidden.value='';displaySystemNotification('所有輸入已清除',!1)};const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-querysetup-ok').onclick=()=>{const values=queryValuesInput.value.trim();if(!selectedQueryDefinitionGlobal){displaySystemNotification('請選查詢欄位類型',!0);return}if(!values){displaySystemNotification(%60請輸入${selectedQueryDefinitionGlobal.queryDisplayName}%60,!0);queryValuesInput.focus();return}closeDialog({selectedApiKey:selectedQueryDefinitionGlobal.queryApiKey,queryValues:values})};overlay.querySelector('#qt-querysetup-cancel').onclick=()=>closeDialog(null)})}function createCSVPurposeDialog(){return new Promise(resolve=>{const contentHtml=%60<h3 class="qt-dialog-title">選擇CSV檔案用途</h3><div style="display:flex; flex-direction:column; gap:10px;"><button id="qt-csv-purpose-query" class="qt-dialog-btn qt-dialog-btn-blue" style="margin-left:0;">將CSV某欄作為查詢值</button><button id="qt-csv-purpose-a17" class="qt-dialog-btn qt-dialog-btn-green" style="margin-left:0;">勾選CSV欄位供A17合併顯示</button></div><div style="text-align:center; margin-top:15px;"><button id="qt-csv-purpose-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button></div>%60;const{overlay}=createDialogBase('_CSVPurpose',contentHtml,'300px','auto');const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csv-purpose-query').onclick=()=>closeDialog('fillQueryValues');overlay.querySelector('#qt-csv-purpose-a17').onclick=()=>closeDialog('prepareA17Merge');overlay.querySelector('#qt-csv-purpose-cancel').onclick=()=>closeDialog(null)})}function createCSVColumnSelectionDialog(headers,title){return new Promise(resolve=>{let optionsHtml=headers.map((header,index)=>%60<button class="qt-dialog-btn qt-dialog-btn-blue" data-index="${index}" style="margin:5px; width: calc(50% - 10px); text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${escapeHtml(header)}</button>%60).join('');const contentHtml=%60<h3 class="qt-dialog-title">${escapeHtml(title)}</h3><div style="display:flex; flex-wrap:wrap; justify-content:center; max-height:300px; overflow-y:auto; margin-bottom:15px;">${optionsHtml}</div><div style="text-align:center;"><button id="qt-csvcol-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button></div>%60;const{overlay,dialog}=createDialogBase('_CSVColSelect',contentHtml,'400px','auto');const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);dialog.querySelectorAll('.qt-dialog-btn[data-index]').forEach(btn=>{btn.onclick=()=>closeDialog(parseInt(btn.dataset.index))});overlay.querySelector('#qt-csvcol-cancel').onclick=()=>closeDialog(null)})}function createCSVColumnCheckboxDialog(headers,title){return new Promise(resolve=>{let checkboxesHtml=headers.map((header,index)=>%60<div style="margin-bottom: 8px; display:flex; align-items:center;"><input type="checkbox" id="qt-csv-header-cb-${index}" value="${escapeHtml(header)}" style="margin-right:8px; transform:scale(1.2);"><label for="qt-csv-header-cb-${index}" style="font-size:14px;">${escapeHtml(header)}</label></div>%60).join('');const contentHtml=%60<h3 class="qt-dialog-title">${escapeHtml(title)}</h3><div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px;">${checkboxesHtml}</div><div class="qt-dialog-flex-end"><button id="qt-csvcb-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button><button id="qt-csvcb-ok" class="qt-dialog-btn qt-dialog-btn-blue">確定勾選</button></div>%60;const{overlay,dialog}=createDialogBase('_CSVCheckbox',contentHtml,'400px','auto');const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-csvcb-ok').onclick=()=>{const selected=[];dialog.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>selected.push(cb.value));if(selected.length===0){displaySystemNotification('請至少勾選一個欄位',!0);return}closeDialog(selected)};overlay.querySelector('#qt-csvcb-cancel').onclick=()=>closeDialog(null)})}function createA17TextSettingDialog(){return new Promise(resolve=>{const s=a17ModeState.textSettings;const contentHtml=%60<h3 class="qt-dialog-title">A17 通知文本設定</h3><div style="display:grid; grid-template-columns: 1fr; gap: 15px;"><div><label for="qt-a17-mainContent" style="font-weight:bold; font-size:13px; display:block; margin-bottom:5px;">主文案內容：</label><textarea id="qt-a17-mainContent" class="qt-textarea" style="height:150px;">${escapeHtml(s.mainContent)}</textarea><div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap;"><label style="font-size:12px;">字體大小: <input type="number" id="qt-a17-mainFontSize" value="${s.mainFontSize}" min="8" max="24" step="0.5" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> pt</label><label style="font-size:12px;">行高: <input type="number" id="qt-a17-mainLineHeight" value="${s.mainLineHeight}" min="1" max="3" step="0.1" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> 倍</label><label style="font-size:12px;">顏色: <input type="color" id="qt-a17-mainFontColor" value="${s.mainFontColor}" style="padding:1px; height:25px; vertical-align:middle;"></label></div></div><div><label style="font-weight:bold; font-size:13px; display:block; margin-bottom:5px;">動態日期設定 (相對於今天)：</label><div style="display:flex; gap:15px; align-items:center; margin-bottom:5px;flex-wrap:wrap;"><label style="font-size:12px;">產檔時間偏移: <input type="number" id="qt-a17-genDateOffset" value="${s.genDateOffset}" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> 天</label><label style="font-size:12px;">比對時間偏移: <input type="number" id="qt-a17-compDateOffset" value="${s.compDateOffset}" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> 天</label></div><div style="display:flex; gap:10px; flex-wrap:wrap;"><label style="font-size:12px;">日期字體大小: <input type="number" id="qt-a17-dateFontSize" value="${s.dateFontSize}" min="6" max="16" step="0.5" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> pt</label><label style="font-size:12px;">日期行高: <input type="number" id="qt-a17-dateLineHeight" value="${s.dateLineHeight}" min="1" max="3" step="0.1" class="qt-input" style="width:60px; padding:3px; margin-bottom:0;"> 倍</label><label style="font-size:12px;">日期顏色: <input type="color" id="qt-a17-dateFontColor" value="${s.dateFontColor}" style="padding:1px; height:25px; vertical-align:middle;"></label></div></div><div><label style="font-weight:bold; font-size:13px; display:block; margin-bottom:5px;">預覽效果 (此區可臨時編輯，僅影響當次複製)：</label><div id="qt-a17-preview" contenteditable="true" style="border:1px solid #ccc; padding:10px; min-height:100px; max-height:200px; overflow-y:auto; font-size:${s.mainFontSize}pt; line-height:${s.mainLineHeight}; color:${s.mainFontColor}; background:#f9f9f9; border-radius:4px;"></div></div></div><div class="qt-dialog-flex-between" style="margin-top:20px;"><button id="qt-a17-text-reset" class="qt-dialog-btn qt-dialog-btn-orange">重設預設</button><div><button id="qt-a17-text-cancel" class="qt-dialog-btn qt-dialog-btn-grey">取消</button><button id="qt-a17-text-save" class="qt-dialog-btn qt-dialog-btn-blue">儲存設定</button></div></div>%60;const{overlay,dialog}=createDialogBase('_A17TextSettings',contentHtml,'550px','auto');const previewEl=overlay.querySelector('#qt-a17-preview');const getSettingsFromUI=()=>({mainContent:overlay.querySelector('#qt-a17-mainContent').value,mainFontSize:parseFloat(overlay.querySelector('#qt-a17-mainFontSize').value),mainLineHeight:parseFloat(overlay.querySelector('#qt-a17-mainLineHeight').value),mainFontColor:overlay.querySelector('#qt-a17-mainFontColor').value,dateFontSize:parseFloat(overlay.querySelector('#qt-a17-dateFontSize').value),dateLineHeight:parseFloat(overlay.querySelector('#qt-a17-dateLineHeight').value),dateFontColor:overlay.querySelector('#qt-a17-dateFontColor').value,genDateOffset:parseInt(overlay.querySelector('#qt-a17-genDateOffset').value),compDateOffset:parseInt(overlay.querySelector('#qt-a17-compDateOffset').value)});const updatePreview=()=>{const currentUISettings=getSettingsFromUI();const today=new Date();const genDate=new Date(today);genDate.setDate(today.getDate()+currentUISettings.genDateOffset);const compDate=new Date(today);compDate.setDate(today.getDate()+currentUISettings.compDateOffset);const genDateStr=formatDate(genDate);const compDateStr=formatDate(compDate);let previewContent=escapeHtml(currentUISettings.mainContent).replace(/\n/g,'<br>')+%60<br><br><span class="qt-a17-dynamic-date" style="font-size:${currentUISettings.dateFontSize}pt; line-height:${currentUISettings.dateLineHeight}; color:${currentUISettings.dateFontColor};">產檔時間：${genDateStr}<br>比對時間：${compDateStr}</span>%60;previewEl.innerHTML=previewContent;previewEl.style.fontSize=currentUISettings.mainFontSize+'pt';previewEl.style.lineHeight=currentUISettings.mainLineHeight;previewEl.style.color=currentUISettings.mainFontColor};['#qt-a17-mainContent','#qt-a17-mainFontSize','#qt-a17-mainLineHeight','#qt-a17-mainFontColor','#qt-a17-dateFontSize','#qt-a17-dateLineHeight','#qt-a17-dateFontColor','#qt-a17-genDateOffset','#qt-a17-compDateOffset'].forEach(selector=>{const el=overlay.querySelector(selector);if(el.type==='color')el.onchange=updatePreview;else el.oninput=updatePreview});updatePreview();const closeDialog=(value)=>{overlay.remove();document.removeEventListener('keydown',escListener);resolve(value)};const escListener=(e)=>{if(e.key==='Escape')closeDialog(null);};document.addEventListener('keydown',escListener);overlay.querySelector('#qt-a17-text-save').onclick=()=>{const newSettings=getSettingsFromUI();if(!newSettings.mainContent.trim()){displaySystemNotification('主文案內容不可為空',!0);return}a17ModeState.textSettings=newSettings;localStorage.setItem(A17_TEXT_SETTINGS_STORAGE_KEY,JSON.stringify(newSettings));displaySystemNotification('A17文本設定已儲存',!1);closeDialog(!0)};overlay.querySelector('#qt-a17-text-cancel').onclick=()=>closeDialog(null);overlay.querySelector('#qt-a17-text-reset').onclick=()=>{overlay.querySelector('#qt-a17-mainContent').value=A17_DEFAULT_TEXT_CONTENT;overlay.querySelector('#qt-a17-mainFontSize').value=12;overlay.querySelector('#qt-a17-mainLineHeight').value=1.5;overlay.querySelector('#qt-a17-mainFontColor').value='#333333';overlay.querySelector('#qt-a17-dateFontSize').value=8;overlay.querySelector('#qt-a17-dateLineHeight').value=1.2;overlay.querySelector('#qt-a17-dateFontColor').value='#555555';overlay.querySelector('#qt-a17-genDateOffset').value=-3;overlay.querySelector('#qt-a17-compDateOffset').value=0;updatePreview()}})}async function performApiQuery(queryValue,apiKey){const reqBody={currentPage:1,pageSize:10};reqBody[apiKey]=queryValue;const fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody),};if(apiAuthToken)fetchOpts.headers['SSO-TOKEN']=apiAuthToken;let retries=1;while(retries>=0){try{const res=await fetch(CURRENT_API_URL,fetchOpts);const data=await res.json();if(res.status===401){apiAuthToken=null;localStorage.removeItem(TOKEN_STORAGE_KEY);return{error:'token_invalid',data:null}}if(!res.ok){throw new Error(%60API請求錯誤: ${res.status} ${res.statusText}%60)}return{error:null,data:data,success:data&&data.records&&data.records.length>0}}catch(e){console.error(%60查詢 ${queryValue} 錯誤 (嘗試 ${2-retries}):%60,e);if(retries>0){displaySystemNotification(%60查詢 ${queryValue} 失敗，2秒後重試...%60,!0,1800);await new Promise(r=>setTimeout(r,2000));retries--}else{return{error:'network_error',data:null}}}}}function renderResultsTableUI(dataToRender){currentTableInstance.mainUIElement?.remove();document.removeEventListener('keydown',mainUIEscListener);const mainUI=document.createElement('div');currentTableInstance.mainUIElement=mainUI;mainUI.id=TOOL_MAIN_CONTAINER_ID;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:50%;transform:translate(-50%,-50%);background:#f8f9fa;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.15);padding:0;width:auto;max-width:850px;max-height:90vh;display:flex;flex-direction:column;font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:13px;border:1px solid #dee2e6;user-select:none;%60;const titleBar=document.createElement('div');titleBar.textContent='凱基人壽案件查詢結果';titleBar.style.cssText=%60padding:10px 15px;margin:-0px -0px 10px -0px;background-color:#343a40;color:white;font-weight:bold;font-size:14px;text-align:center;border-top-left-radius:9px;border-top-right-radius:9px;cursor:grab;user-select:none;%60;mainUI.appendChild(titleBar);const contentWrapper=document.createElement('div');contentWrapper.style.cssText='padding:15px; overflow-y:auto; display:flex; flex-direction:column; flex-grow:1;';mainUI.appendChild(contentWrapper);const controlsHeader=document.createElement('div');controlsHeader.style.cssText=%60display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0;flex-wrap:wrap;gap:8px;%60;const summarySec=document.createElement('div');summarySec.id=TOOL_MAIN_CONTAINER_ID+'_SummarySection';summarySec.style.cssText='font-size:13px;font-weight:bold;color:#2c3e50;white-space:nowrap;';controlsHeader.appendChild(summarySec);const filterInput=document.createElement('input');filterInput.type='text';filterInput.id=TOOL_MAIN_CONTAINER_ID+'_TableFilterInput';filterInput.placeholder='篩選表格內容...';filterInput.className='qt-input';filterInput.style.width='180px';filterInput.style.marginBottom='0';const buttonsGroupLeft=document.createElement('div');buttonsGroupLeft.style.cssText='display:flex;gap:6px;align-items:center;';const buttonsGroupRight=document.createElement('div');buttonsGroupRight.style.cssText='display:flex;gap:6px;align-items:center;margin-left:auto;';[{id:'ClearConditions',text:'清除條件',cls:'qt-dialog-btn-grey',group:buttonsGroupLeft},{id:'Requery',text:'重新查詢',cls:'qt-dialog-btn-orange',group:buttonsGroupLeft},{id:'A17',text:'A17作業',cls:'qt-dialog-btn-purple',group:buttonsGroupLeft},{id:'CopyTable',text:'複製表格',cls:'qt-dialog-btn-green',group:buttonsGroupLeft},{id:'EditMode',text:'編輯模式',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft},{id:'AddRow',text:'+ 新增列',cls:'qt-dialog-btn-blue',group:buttonsGroupLeft,style:'display:none;'}].forEach(cfg=>{const btn=document.createElement('button');btn.id=TOOL_MAIN_CONTAINER_ID+'_btn'+cfg.id;btn.textContent=cfg.text;btn.className=%60qt-dialog-btn ${cfg.cls}%60;if(cfg.style)btn.style.cssText+=cfg.style;cfg.group.appendChild(btn)});const closeBtn=document.createElement('button');closeBtn.id=TOOL_MAIN_CONTAINER_ID+'_btnCloseTool';closeBtn.textContent='關閉工具';closeBtn.className='qt-dialog-btn qt-dialog-btn-red';buttonsGroupRight.appendChild(closeBtn);controlsHeader.appendChild(filterInput);controlsHeader.appendChild(buttonsGroupLeft);controlsHeader.appendChild(buttonsGroupRight);contentWrapper.appendChild(controlsHeader);const a17UnitBtnsCtr=document.createElement('div');a17UnitBtnsCtr.id=TOOL_MAIN_CONTAINER_ID+'_A17UnitBtns';a17UnitBtnsCtr.style.cssText='margin-bottom:10px;display:none;flex-wrap:wrap;gap:6px;justify-content:flex-start;';contentWrapper.appendChild(a17UnitBtnsCtr);currentTableInstance.a17UnitButtonsContainer=a17UnitBtnsCtr;const a17TextControls=document.createElement('div');a17TextControls.id=TOOL_MAIN_CONTAINER_ID+'_A17TextControls';a17TextControls.style.cssText='margin-bottom:10px;display:none;align-items:center;gap:10px;';a17TextControls.innerHTML=%60<label style="font-size:12px;color:#333;display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText" checked style="margin-right:4px;">A17含通知文</label><button id="${TOOL_MAIN_CONTAINER_ID}_btnA17EditText" class="qt-dialog-btn qt-dialog-btn-blue" style="margin-left:0;padding:5px 10px;font-size:12px;">編輯通知文</button>%60;contentWrapper.appendChild(a17TextControls);const tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px solid #ccc;border-radius:5px;background:white;';const tableEl=document.createElement('table');tableEl.id=TOOL_MAIN_CONTAINER_ID+'_ResultsTable';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:12px;';tableScrollWrap.appendChild(tableEl);contentWrapper.appendChild(tableScrollWrap);const tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:1;background-color:#343a40;color:white;';tableEl.appendChild(tHREl);currentTableInstance.tableHeadElement=tHREl;const tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);currentTableInstance.tableBodyElement=tBREl;document.body.appendChild(mainUI);titleBar.onmousedown=(e)=>{if(e.target!==titleBar)return;e.preventDefault();dragState.dragging=!0;dragState.startX=e.clientX;dragState.startY=e.clientY;dragState.initialX=mainUI.offsetLeft;dragState.initialY=mainUI.offsetTop;titleBar.style.cursor='grabbing';mainUI.style.transform='none'};document.onmousemove=(e)=>{if(dragState.dragging){const dx=e.clientX-dragState.startX;const dy=e.clientY-dragState.startY;mainUI.style.left=(dragState.initialX+dx)+'px';mainUI.style.top=(dragState.initialY+dy)+'px'}};document.onmouseup=()=>{if(dragState.dragging){dragState.dragging=!1;titleBar.style.cursor='grab'}};filterInput.oninput=()=>applyTableFilter();mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnClearConditions%60).onclick=handleClearConditions;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnRequery%60).onclick=()=>{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener);executeCaseQueryTool()};const a17Btn=mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17%60);a17Btn.onmousedown=(e)=>{if(e.button!==0)return;a17ButtonLongPressTimer=setTimeout(()=>{a17ButtonLongPressTimer=null;toggleA17Mode(!0)},700)};a17Btn.onmouseup=()=>{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null;toggleA17Mode(!1)}};a17Btn.onmouseleave=()=>{if(a17ButtonLongPressTimer){clearTimeout(a17ButtonLongPressTimer);a17ButtonLongPressTimer=null}};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnCopyTable%60).onclick=handleCopyTable;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60).onclick=toggleEditMode;mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60).onclick=handleAddRowToTable;closeBtn.onclick=()=>{mainUI.remove();document.removeEventListener('keydown',mainUIEscListener)};mainUI.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnA17EditText%60).onclick=async()=>{await createA17TextSettingDialog()};document.addEventListener('keydown',mainUIEscListener);updateSummaryCount(dataToRender.length);if(currentTableInstance.isA17Mode){renderA17ModeUI();populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{renderNormalModeUI();populateTableRows(dataToRender)}}const mainUIEscListener=(e)=>{if(e.key==='Escape'&&currentTableInstance.mainUIElement&&!document.querySelector(%60[id^="${TOOL_MAIN_CONTAINER_ID}_"][id$="_overlay"]%60)){currentTableInstance.mainUIElement.remove();document.removeEventListener('keydown',mainUIEscListener)}};function updateSummaryCount(visibleRowCount){const summaryEl=currentTableInstance.mainUIElement?.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_SummarySection%60);if(!summaryEl)return;let baseDataCount=currentTableInstance.isA17Mode?baseA17MasterData.length:originalQueryResults.length;let text=%60查詢結果：<strong>${baseDataCount}</strong>筆%60;const filterInput=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60);const isFiltered=(filterInput&&filterInput.value.trim()!=='')||(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size>0);if(isFiltered&&visibleRowCount!==baseDataCount){text+=%60 (篩選後顯示 <strong>${visibleRowCount}</strong> 筆)%60}summaryEl.innerHTML=text}function renderTableHeaders(headers){currentTableInstance.tableHeadElement.innerHTML='';const hr=document.createElement('tr');headers.forEach((hTxt,idx)=>{const th=document.createElement('th');th.textContent=escapeHtml(hTxt);th.style.cssText=%60padding: 8px 6px; text-align:center; white-space:nowrap; cursor:pointer; user-select:none; font-weight:600; font-size:12px; border-right: 1px solid #4a6075;%60;if(idx===headers.length-1)th.style.borderRight='none';if(idx===0&&!currentTableInstance.isA17Mode)th.style.backgroundColor='#007bff';th.onclick=()=>sortTableByColumn(hTxt);hr.appendChild(th)});if(isEditMode){const thAction=document.createElement('th');thAction.textContent="操作";thAction.style.cssText=%60padding: 8px 6px; text-align:center; white-space:nowrap; font-weight:600; font-size:12px;%60;hr.appendChild(thAction)}currentTableInstance.tableHeadElement.appendChild(hr);currentTableInstance.currentHeaders=headers}function populateTableRows(data){currentTableInstance.tableBodyElement.innerHTML='';data.forEach((row,rowIndex)=>{const tr=document.createElement('tr');tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff';tr.onmouseover=()=>{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor='#e9ecef'};tr.onmouseout=()=>{if(!tr.classList.contains('qt-editing-row'))tr.style.backgroundColor=rowIndex%2?'#f8f9fa':'#ffffff'};currentTableInstance.currentHeaders.forEach((headerKey,colIndex)=>{const td=document.createElement('td');td.style.cssText='padding:6px; border-bottom:1px solid #dee2e6; font-size:12px; text-align:center; border-right:1px solid #dee2e6;';if(colIndex===currentTableInstance.currentHeaders.length-1)td.style.borderRight='none';let cellValue=row[headerKey]===null||row[headerKey]===undefined?'':String(row[headerKey]);if(headerKey===FIELD_DISPLAY_NAMES_MAP.statusCombined&&typeof cellValue==='string'&&cellValue.includes('<span')){td.innerHTML=cellValue}else{td.textContent=cellValue}if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){td.style.backgroundColor='#e6f7ff';td.style.fontWeight='500'}if(isEditMode&&((colIndex>1&&!row._isNewRow)||(row._isNewRow&&headerKey!=="操作"))&&headerKey!==FIELD_DISPLAY_NAMES_MAP._apiQueryStatus){td.onclick=(e)=>{if(e.target.tagName!=='INPUT'&&e.target.tagName!=='SELECT')startCellEdit(td,row,headerKey,rowIndex);}}else if(!isEditMode){td.onclick=()=>{navigator.clipboard.writeText(td.textContent||td.innerText).then(()=>displaySystemNotification(%60已複製: ${td.textContent || td.innerText}%60,!1,1000)).catch(err=>displaySystemNotification('複製失敗',!0))}}tr.appendChild(td)});if(isEditMode){const tdAction=document.createElement('td');tdAction.style.cssText='padding:6px; border-bottom:1px solid #dee2e6; text-align:center;';const deleteBtn=document.createElement('button');deleteBtn.innerHTML='&#x1F5D1;';deleteBtn.className='qt-dialog-btn qt-dialog-btn-red';deleteBtn.style.padding='3px 6px';deleteBtn.style.fontSize='10px';deleteBtn.onclick=()=>handleDeleteRow(rowIndex);tdAction.appendChild(deleteBtn);tr.appendChild(tdAction)}currentTableInstance.tableBodyElement.appendChild(tr)});updateSummaryCount(data.length)}function sortTableByColumn(headerKeyToSortBy){const currentData=currentTableInstance.isA17Mode?[...baseA17MasterData]:[...originalQueryResults];if(currentData.length===0)return;const direction=(currentTableInstance.sortDirections[headerKeyToSortBy]||'desc')==='asc'?'desc':'asc';currentTableInstance.sortDirections={};currentTableInstance.sortDirections[headerKeyToSortBy]=direction;currentData.sort((a,b)=>{let valA=a[headerKeyToSortBy]===null||a[headerKeyToSortBy]===undefined?'':String(a[headerKeyToSortBy]);let valB=b[headerKeyToSortBy]===null||b[headerKeyToSortBy]===undefined?'':String(b[headerKeyToSortBy]);const isNumeric=headerKeyToSortBy===FIELD_DISPLAY_NAMES_MAP.NO||(!isNaN(parseFloat(valA))&&isFinite(valA)&&!isNaN(parseFloat(valB))&&isFinite(valB)&&valA.trim()!==''&&valB.trim()!=='');let comparison=0;if(isNumeric){comparison=parseFloat(valA)-parseFloat(valB)}else{comparison=valA.localeCompare(valB,'zh-Hant-TW')}return direction==='asc'?comparison:-comparison});if(currentTableInstance.isA17Mode)baseA17MasterData=currentData;else originalQueryResults=currentData;populateTableRows(currentData);displaySystemNotification(%60已按「${headerKeyToSortBy}」${direction === 'asc' ? '升序' : '降序'}排列%60,!1);currentTableInstance.tableHeadElement.querySelectorAll('th').forEach(th=>{const currentHeaderText=th.textContent.replace(/[\u25B2\u25BC\s]*$/,'').trim();th.innerHTML=escapeHtml(currentHeaderText);if(currentHeaderText===headerKeyToSortBy){th.innerHTML+=(direction==='asc'?' <span style="font-size:10px;">\u25B2</span>':' <span style="font-size:10px;">\u25BC</span>')}})}function applyTableFilter(){const filterText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value.trim().toLowerCase();const baseData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;let filteredData=baseData;if(filterText){filteredData=baseData.filter(row=>currentTableInstance.currentHeaders.some(headerKey=>(String(row[headerKey]||'').toLowerCase().includes(filterText))))}if(currentTableInstance.isA17Mode&&a17ModeState.selectedUnits.size>0){let unitFilteredData=[];a17ModeState.selectedUnits.forEach(unitId=>{unitFilteredData=unitFilteredData.concat(filteredData.filter(row=>{const unitVal=String(row[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');if(unitId==='UNDEF'){const knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=>b.id!=='UNDEF').map(b=>b.id.toUpperCase());return unitVal.trim()===''||!knownPrefixes.some(prefix=>unitVal.toUpperCase().startsWith(prefix))}return unitVal.toUpperCase().startsWith(unitId.toUpperCase())}))});filteredData=Array.from(new Set(unitFilteredData.map(JSON.stringify))).map(JSON.parse)}populateTableRows(filteredData)}function handleClearConditions(){currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableFilterInput%60).value='';currentTableInstance.sortDirections={};if(currentTableInstance.isA17Mode){a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button.highlighted').forEach(btn=>{btn.classList.remove('highlighted');btn.style.boxShadow='none'});csvImportState={fileName:'',rawHeaders:[],rawData:[],selectedColForQueryName:null,selectedColsForA17Merge:[],isA17CsvPrepared:!1};baseA17MasterData=[...originalQueryResults];baseA17MasterData.sort((a,b)=>(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(baseA17MasterData);updateA17UnitButtonCounts()}else{originalQueryResults.sort((a,b)=>(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));populateTableRows(originalQueryResults)}renderTableHeaders(currentTableInstance.currentHeaders);displaySystemNotification('所有條件已清除，表格已重置為按序號排序',!1)}function toggleEditMode(){isEditMode=!isEditMode;const editBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnEditMode%60);const addRowBtn=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_btnAddRow%60);editBtn.textContent=isEditMode?'完成編輯':'編輯模式';editBtn.className=%60qt-dialog-btn ${isEditMode ? 'qt-dialog-btn-red' : 'qt-dialog-btn-blue'}%60;addRowBtn.style.display=isEditMode?'inline-block':'none';const currentData=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;renderTableHeaders(currentTableInstance.currentHeaders);populateTableRows(currentData);displaySystemNotification(isEditMode?'已進入編輯模式':'已退出編輯模式',!1)}function startCellEdit(td,rowData,headerKey,rowIndex){if(td.querySelector('input, select'))return;td.classList.add('qt-editing-cell');const originalText=td.textContent;td.innerHTML='';let inputElement;if(isEditMode&&currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){inputElement=document.createElement('select');inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px solid #007bff;margin:0;background:transparent;';const defaultOption=document.createElement('option');defaultOption.value="";defaultOption.textContent="--選擇分公司--";inputElement.appendChild(defaultOption);A17_UNIT_BUTTONS_DEFS.forEach(unitDef=>{if(unitDef.id==='UNDEF')return;const option=document.createElement('option');option.value=unitDef.id;option.textContent=unitDef.label;const currentUnitPrefix=String(rowData[headerKey]||'').split('-')[0].toUpperCase();if(unitDef.id===currentUnitPrefix)option.selected=!0;inputElement.appendChild(option)});inputElement.onchange=()=>finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'select')}else{inputElement=document.createElement('input');inputElement.type='text';inputElement.className='qt-input';inputElement.style.cssText='width:100%;padding:4px;font-size:12px;border:1px solid #007bff;margin:0;';inputElement.value=originalText;inputElement.onkeydown=(e)=>{if(e.key==='Enter'){e.preventDefault();finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,'input')}else if(e.key==='Escape'){td.textContent=originalText;td.classList.remove('qt-editing-cell')}}}inputElement.onblur=()=>{setTimeout(()=>{if(td.contains(inputElement))finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputElement.tagName.toLowerCase());},100)};td.appendChild(inputElement);inputElement.focus();if(inputElement.select)inputElement.select();}function finishCellEdit(td,inputElement,rowData,headerKey,originalText,rowIndex,inputType='input'){const newValue=inputElement.value.trim();td.classList.remove('qt-editing-cell');const displayValue=(inputType==='select'&&newValue)?A17_UNIT_BUTTONS_DEFS.find(def=>def.id===newValue)?.label||newValue:newValue;td.textContent=displayValue;if(newValue!==originalText||(inputType==='select'&&(rowData[headerKey]||'').split('-')[0]!==newValue)){rowData[headerKey]=displayValue;displaySystemNotification(%60「${headerKey}」已更新%60,!1,1500);td.style.backgroundColor='#d4edda';if(currentTableInstance.isA17Mode&&headerKey===FIELD_DISPLAY_NAMES_MAP.uwApproverUnit){updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size>0)applyTableFilter();}}else{td.textContent=originalText}}function handleAddRowToTable(){if(!isEditMode){displaySystemNotification('請先進入編輯模式',!0);return}const newRow={_isNewRow:!0};let maxNo=0;const targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;targetDataset.forEach(row=>{const currentNo=parseInt(row[FIELD_DISPLAY_NAMES_MAP.NO]);if(!isNaN(currentNo)&&currentNo>maxNo)maxNo=currentNo});newRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(maxNo+1);currentTableInstance.currentHeaders.forEach(header=>{if(header!==FIELD_DISPLAY_NAMES_MAP.NO&&header!=="操作")newRow[header]=''});if(currentTableInstance.isA17Mode){baseA17MasterData.push(newRow);populateTableRows(baseA17MasterData)}else{originalQueryResults.push(newRow);populateTableRows(originalQueryResults)}displaySystemNotification('已新增一列，請編輯內容',!1);const tableWrapper=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_TableScrollWrapper%60);if(tableWrapper)tableWrapper.scrollTop=tableWrapper.scrollHeight}function handleDeleteRow(rowIndex){if(!isEditMode)return;const targetDataset=currentTableInstance.isA17Mode?baseA17MasterData:originalQueryResults;if(rowIndex>=0&&rowIndex<targetDataset.length){targetDataset.splice(rowIndex,1);populateTableRows(targetDataset);displaySystemNotification('已刪除該列資料',!1);if(currentTableInstance.isA17Mode)updateA17UnitButtonCounts();}}function loadA17TextSettings(){const saved=localStorage.getItem(A17_TEXT_SETTINGS_STORAGE_KEY);if(saved){try{const parsed=JSON.parse(saved);for(const key in a17ModeState.textSettings){if(parsed.hasOwnProperty(key))a17ModeState.textSettings[key]=parsed[key]}}catch(e){console.error("載入A17文本設定失敗:",e)}}}function toggleA17Mode(forceEnter=!1){const a17TextControls=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_A17TextControls%60);if(currentTableInstance.isA17Mode){currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;a17ModeState.selectedUnits.clear();currentTableInstance.a17UnitButtonsContainer.style.display='none';a17TextControls.style.display='none';renderNormalModeUI();populateTableRows(originalQueryResults);displaySystemNotification('已退出A17作業模式',!1)}else{if(!forceEnter&&!csvImportState.isA17CsvPrepared){displaySystemNotification('請先透過「匯入CSV/TXT」按鈕選擇「勾選CSV欄位供A17合併」並完成設定。或長按「A17作業」按鈕強制進入。',!0,6000);return}currentTableInstance.isA17Mode=!0;a17ModeState.isActive=!0;currentTableInstance.a17UnitButtonsContainer.style.display='flex';a17TextControls.style.display='flex';if(forceEnter&&!csvImportState.isA17CsvPrepared){baseA17MasterData=originalQueryResults.map(row=>{const newRow={};newRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]=row[FIELD_DISPLAY_NAMES_MAP._queriedValue_];newRow[FIELD_DISPLAY_NAMES_MAP.NO]=row[FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{const displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(row.hasOwnProperty(displayName))newRow[displayName]=row[displayName]});newRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=row[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus];return newRow})}else{baseA17MasterData=[];const keyCsvHeader=csvImportState.rawHeaders.find(h=>h.includes('送金單'));const keyCsvIndex=keyCsvHeader?csvImportState.rawHeaders.indexOf(keyCsvHeader):(csvImportState.rawHeaders.length>0?0:-1);csvImportState.rawData.forEach((csvRowData,index)=>{let mergedRow={};mergedRow[FIELD_DISPLAY_NAMES_MAP.NO]=String(index+1);csvImportState.selectedColsForA17Merge.forEach(selectedCsvHeader=>{const originalCsvIndex=csvImportState.rawHeaders.indexOf(selectedCsvHeader);if(originalCsvIndex!==-1)mergedRow[selectedCsvHeader]=csvRowData[originalCsvIndex]});const csvKeyValue=(keyCsvIndex!==-1)?csvRowData[keyCsvIndex]:null;let apiFound=!1;if(csvKeyValue){const matchingApiRow=originalQueryResults.find(apiRow=>(apiRow[FIELD_DISPLAY_NAMES_MAP.receiptNumber]===csvKeyValue||apiRow[FIELD_DISPLAY_NAMES_MAP._queriedValue_]===csvKeyValue));if(matchingApiRow){apiFound=!0;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{const displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName)&&matchingApiRow.hasOwnProperty(displayName)){mergedRow[displayName]=matchingApiRow[displayName]}});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=matchingApiRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]||'✔%EF%B8%8F 成功'}}if(!apiFound){ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{const displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!mergedRow.hasOwnProperty(displayName))mergedRow[displayName]='-'});mergedRow[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]='➖ 無對應API資料'}baseA17MasterData.push(mergedRow)})}renderA17ModeUI();populateTableRows(baseA17MasterData);createA17UnitButtons();updateA17UnitButtonCounts();displaySystemNotification('已進入A17作業模式',!1)}}function renderNormalModeUI(){let headers=[FIELD_DISPLAY_NAMES_MAP._queriedValue_,FIELD_DISPLAY_NAMES_MAP.NO];ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function renderA17ModeUI(){let headers=[];if(csvImportState.isA17CsvPrepared&&csvImportState.selectedColsForA17Merge.length>0){csvImportState.selectedColsForA17Merge.forEach(csvHeader=>{if(!headers.includes(csvHeader))headers.push(csvHeader);});ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{const displayName=FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey;if(!headers.includes(displayName))headers.push(displayName);})}else{headers.push(FIELD_DISPLAY_NAMES_MAP._queriedValue_);headers.push(FIELD_DISPLAY_NAMES_MAP.NO);ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{headers.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)})}if(!headers.includes(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus))headers.push(FIELD_DISPLAY_NAMES_MAP._apiQueryStatus);renderTableHeaders(headers)}function createA17UnitButtons(){currentTableInstance.a17UnitButtonsContainer.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=>{const btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.textContent=%60${unitDef.label} (0)%60;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:11px;transition:all 0.2s ease;flex-grow:1;min-width:80px;text-align:center;%60;btn.onclick=()=>{if(btn.classList.contains('disabled'))return;const unitId=btn.dataset.unitId;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow=%600 0 0 2px white, 0 0 0 4px ${btn.style.backgroundColor}%60}applyTableFilter();displaySystemNotification(%60已選擇 ${a17ModeState.selectedUnits.size} 個單位%60,!1,1500)};currentTableInstance.a17UnitButtonsContainer.appendChild(btn)})}function updateA17UnitButtonCounts(){if(!currentTableInstance.isA17Mode)return;const unitCounts={};const dataToCount=baseA17MasterData;dataToCount.forEach(row=>{const unitFull=String(row[FIELD_DISPLAY_NAMES_MAP.uwApproverUnit]||'');let unitPrefix='UNDEF';for(const code in UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()==='')unitPrefix='UNDEF';unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});currentTableInstance.a17UnitButtonsContainer.querySelectorAll('button').forEach(btn=>{const unitId=btn.dataset.unitId;const count=unitCounts[unitId]||0;const unitDef=A17_UNIT_BUTTONS_DEFS.find(def=>def.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label} (${count})%60;if(count===0){btn.classList.add('disabled');btn.disabled=!0;btn.style.opacity='0.6';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.classList.remove('disabled');btn.disabled=!1;btn.style.opacity='1'}}})}function handleCopyTable(){const dataToCopy=[];const rows=currentTableInstance.tableBodyElement.querySelectorAll('tr');rows.forEach(tr=>{const rowData={};tr.querySelectorAll('td').forEach((td,colIndex)=>{if(isEditMode&&colIndex===currentTableInstance.currentHeaders.length)return;const headerKey=currentTableInstance.currentHeaders[colIndex];rowData[headerKey]=td.textContent||td.innerText});if(Object.keys(rowData).length>0)dataToCopy.push(rowData);});if(dataToCopy.length===0){displaySystemNotification('沒有資料可複製',!0);return}if(currentTableInstance.isA17Mode){const includeText=currentTableInstance.mainUIElement.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_cbA17IncludeText%60).checked;const previewDialog=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_A17TextSettings_overlay');let customContentFromPreview=null;if(previewDialog&&previewDialog.style.display==='flex'){const previewEl=previewDialog.querySelector('#qt-a17-preview');if(previewEl)customContentFromPreview=previewEl.innerHTML}generateAndCopyA17NotificationHTML(dataToCopy,currentTableInstance.currentHeaders,includeText,customContentFromPreview)}else{let tsvContent=currentTableInstance.currentHeaders.join('\t')+'\n';dataToCopy.forEach(row=>{const rowValues=currentTableInstance.currentHeaders.map(header=>String(row[header]||'').replace(/\t/g,' ').replace(/\n/g,' '));tsvContent+=rowValues.join('\t')+'\n'});navigator.clipboard.writeText(tsvContent).then(()=>displaySystemNotification(%60已複製 ${dataToCopy.length} 筆資料 (TSV格式)%60,!1)).catch(err=>{console.error('TSV複製失敗:',err);displaySystemNotification('複製TSV失敗',!0)})}}function generateAndCopyA17NotificationHTML(data,headers,includeText,customPreviewContent=null){const s=a17ModeState.textSettings;const today=new Date();const genDate=new Date(today);genDate.setDate(today.getDate()+s.genDateOffset);const compDate=new Date(today);compDate.setDate(today.getDate()+s.compDateOffset);const genDateStr=formatDate(genDate);const compDateStr=formatDate(compDate);let textContentHtml='';if(includeText){if(customPreviewContent){textContentHtml=customPreviewContent}else{textContentHtml=%60<div style="font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:${s.mainFontSize}pt;line-height:${s.mainLineHeight};color:${s.mainFontColor};">%60+escapeHtml(s.mainContent).replace(/\n/g,'<br>')+%60<br><br><p style="font-size:${s.dateFontSize}pt;line-height:${s.dateLineHeight};color:${s.dateFontColor};margin-top:${s.dateLineHeight > 1.2 ? '10px':'5px'};margin-bottom:${s.dateLineHeight > 1.2 ? '10px':'5px'};">產檔時間：${genDateStr}<br>比對時間：${compDateStr}</p></div>%60}}const tableRowsHtml=data.map((row,idx)=>%60<tr style="background-color:${idx % 2 ? '#f8f9fa':'#ffffff'};">${headers.map(header => %60<td style="border:1px solid #dddddd;padding:5px 7px;text-align:center;font-size:10pt;color:#333333;white-space:normal;word-break:break-all;">${escapeHtml(row[header]||'')}</td>%60).join('')}</tr>%60).join('');const tableHtml=%60<table style="border-collapse:collapse;width:100%;margin-top:10px;font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:10pt;"><thead><tr style="background-color:#343a40;color:white;font-weight:bold;">${headers.map(header => %60<th style="border:1px solid #23272b;padding:6px 8px;text-align:center;">${escapeHtml(header)}</th>%60).join('')}</tr></thead><tbody>${tableRowsHtml}</tbody></table>%60;const finalHtml=textContentHtml+tableHtml;try{const blobHtml=new Blob([finalHtml],{type:'text/html'});const plainTextForClipboard=(includeText?(customPreviewContent?new DOMParser().parseFromString(customPreviewContent,"text/html").body.textContent:s.mainContent)+%60\n\n產檔時間：${genDateStr}\n比對時間：${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=>headers.map(h=>String(r[h]||'')).join('\t')).join('\n');const blobText=new Blob([plainTextForClipboard],{type:'text/plain'});navigator.clipboard.write([new ClipboardItem({'text/html':blobHtml,'text/plain':blobText})]).then(()=>displaySystemNotification('A17通知已複製 (HTML格式)',!1)).catch(err=>{console.error('HTML Clipboard API 失敗:',err);navigator.clipboard.writeText(plainTextForClipboard).then(()=>displaySystemNotification('A17通知已複製 (純文字)',!1)).catch(txtErr=>displaySystemNotification('複製失敗',!0))})}catch(e){console.error('ClipboardItem API 不可用:',e);const plainFallback=(includeText?(customPreviewContent?new DOMParser().parseFromString(customPreviewContent,"text/html").body.textContent:s.mainContent)+%60\n\n產檔時間：${genDateStr}\n比對時間：${compDateStr}\n\n%60:'')+headers.join('\t')+'\n'+data.map(r=>headers.map(h=>String(r[h]||'')).join('\t')).join('\n');navigator.clipboard.writeText(plainFallback).then(()=>displaySystemNotification('A17通知已複製 (純文字)',!1)).catch(txtErr=>displaySystemNotification('複製失敗',!0))}}async function executeCaseQueryTool(){if(document.getElementById(TOOL_MAIN_CONTAINER_ID)){displaySystemNotification('查詢工具已開啟',!0);return}const selectedEnv=await createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('操作已取消',!0);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60環境: ${selectedEnv === 'prod' ? '正式' : '測試'}%60,!1);let tokenIsValid=!1;if(apiAuthToken)tokenIsValid=!0;if(!tokenIsValid){let tokenAttempt=1;while(!0){const tokenResult=await createTokenDialog(tokenAttempt);if(tokenResult==='_close_tool_'){displaySystemNotification('工具已關閉',!1);return}if(tokenResult==='_skip_token_'){apiAuthToken=null;displaySystemNotification('已略過Token輸入',!1);break}if(tokenResult==='_token_dialog_cancel_'){displaySystemNotification('Token輸入已取消',!0);return}if(tokenResult&&tokenResult.trim()!==''){apiAuthToken=tokenResult.trim();localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken);displaySystemNotification('Token已設定',!1);break}else{if(tokenAttempt>=2){}else{displaySystemNotification('Token未輸入',!0)}}tokenAttempt++;if(tokenAttempt>2&&(!tokenResult||tokenResult.trim()===''))break}}const querySetupResult=await createQuerySetupDialog();if(!querySetupResult){displaySystemNotification('操作已取消',!0);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=>qdf.queryApiKey===querySetupResult.selectedApiKey);const queryValues=querySetupResult.queryValues.split(/[\s,;\n]+/).map(x=>x.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('未輸入有效查詢值',!0);return}const loadingDialog=createDialogBase('_Loading',%60<h3 class="qt-dialog-title" id="${TOOL_MAIN_CONTAINER_ID}_LoadingTitle">查詢中...</h3><p id="${TOOL_MAIN_CONTAINER_ID}_LoadingMsg" style="text-align:center;font-size:13px;color:#555;">處理中...</p><div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;margin:15px auto;animation:qtSpin 1s linear infinite;"></div>%60,'300px','auto','text-align:center;');const loadingTitleEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingTitle%60);const loadingMsgEl=loadingDialog.dialog.querySelector(%60#${TOOL_MAIN_CONTAINER_ID}_LoadingMsg%60);originalQueryResults=[];let currentQueryCount=0;for(const singleQueryValue of queryValues){currentQueryCount++;if(loadingTitleEl)loadingTitleEl.textContent=%60查詢中 (${currentQueryCount}/${queryValues.length})%60;if(loadingMsgEl)loadingMsgEl.textContent=%60正在處理: ${singleQueryValue}%60;const resultRowBase={[FIELD_DISPLAY_NAMES_MAP.NO]:String(currentQueryCount),[FIELD_DISPLAY_NAMES_MAP._queriedValue_]:singleQueryValue};const apiResult=await performApiQuery(singleQueryValue,selectedQueryDefinitionGlobal.queryApiKey);let apiQueryStatusText='❌ 查詢失敗';if(apiResult.error==='token_invalid'){apiQueryStatusText='❌ TOKEN失效';loadingDialog.overlay.remove();displaySystemNotification('Token已失效或無效，請重新設定Token後再次查詢。',!0,5000);apiAuthToken=null;return}else if(apiResult.success){apiQueryStatusText='✔%EF%B8%8F 成功'}else if(!apiResult.error){apiQueryStatusText='➖ 查無資料'}resultRowBase[FIELD_DISPLAY_NAMES_MAP._apiQueryStatus]=apiQueryStatusText;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=>{const populatedRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=>{const displayName=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let cellValue=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){const mainS=rec.mainStatus||'';const subS=rec.subStatus||'';populatedRow[displayName]=%60<span style="font-weight:bold;">${escapeHtml(mainS)}</span>%60+(subS?%60 <span style="color:#777;">(${escapeHtml(subS)})</span>%60:'')}else if(dKey===UNIT_MAP_FIELD_API_KEY){const unitCodePrefix=getFirstLetter(cellValue);const mappedUnitName=UNIT_CODE_MAPPINGS[unitCodePrefix]||cellValue;populatedRow[displayName]=unitCodePrefix&&UNIT_CODE_MAPPINGS[unitCodePrefix]?%60${unitCodePrefix}-${mappedUnitName.replace(/^[A-Z]-/,'')}%60:mappedUnitName}else if(dKey==='uwApprover'||dKey==='approvalUser'){populatedRow[displayName]=extractName(cellValue)}else{populatedRow[displayName]=cellValue}});originalQueryResults.push(populatedRow)})}else{ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=>{resultRowBase[FIELD_DISPLAY_NAMES_MAP[dKey]||dKey]='-'});originalQueryResults.push(resultRowBase)}}loadingDialog.overlay.remove();if(originalQueryResults.length>0)originalQueryResults.sort((a,b)=>(parseInt(a[FIELD_DISPLAY_NAMES_MAP.NO])||0)-(parseInt(b[FIELD_DISPLAY_NAMES_MAP.NO])||0));currentTableInstance.isA17Mode=!1;a17ModeState.isActive=!1;isEditMode=!1;renderResultsTableUI(originalQueryResults);displaySystemNotification(%60查詢完成！共處理 ${queryValues.length} 個查詢值，獲取 ${originalQueryResults.length} 筆資料%60,!1,3500)}(function(){document.getElementById(TOOL_MAIN_CONTAINER_ID)?.remove();['EnvSelect','Token','QuerySetup','A17TextSettings','Loading','CSVPurpose','CSVColSelect','CSVCheckbox'].forEach(suffix=>{const el=document.getElementById(TOOL_MAIN_CONTAINER_ID+'_'+suffix+'_overlay');if(el)el.remove();});document.getElementById(TOOL_MAIN_CONTAINER_ID+'_Notification')?.remove();loadA17TextSettings();executeCaseQueryTool()})()})()"
  },  
{
    "id": "A17_06"
    "description": "a17",
    "category": “a17",
    "type": "utility",
    "action_script": "javascript:(async()=>{const API_URL_UAT='https://euisv-uat.apps.tocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',API_URL_PROD='https://euisv.apps.ocp4.kgilife.com.tw/euisw/euisb/api/caseQuery/query',TOKEN_STORAGE_KEY='euisToken',Z_INDEX_DIALOG=2147483640,Z_INDEX_MAIN_UI=2147483630,Z_INDEX_NOTIFICATION=2147483647;let CURRENT_API_URL='',apiAuthToken=localStorage.getItem(TOKEN_STORAGE_KEY),selectedQueryDefinitionGlobal=null,originalQueryResults=[],baseA17MasterData=[],isEditMode=false,currentTableInstance={sortDirections:{},currentHeaders:[],isA17Mode:false,isCSVImportModeGlobal:false},a17ModeState={isActive:false,selectedUnits:new Set(),sortedData:[]},csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const QUERYABLE_FIELD_DEFINITIONS=[{queryApiKey:'receiptNumber',queryDisplayName:'送金單號碼',color:'#007bff'},{queryApiKey:'applyNumber',queryDisplayName:'受理號碼',color:'#6f42c1'},{queryApiKey:'policyNumber',queryDisplayName:'保單號碼',color:'#28a745'},{queryApiKey:'approvalNumber',queryDisplayName:'確認書編號',color:'#fd7e14'},{queryApiKey:'insuredId',queryDisplayName:'被保人ＩＤ',color:'#17a2b8'}],ALL_DISPLAY_FIELDS_API_KEYS_MAIN=['applyNumber','policyNumber','approvalNumber','receiptNumber','insuredId','statusCombined','uwApproverUnit','uwApprover','approvalUser'],FIELD_DISPLAY_NAMES_MAP={applyNumber:'受理號碼',policyNumber:'保單號碼',approvalNumber:'確認書編號',receiptNumber:'送金單',insuredId:'被保人ＩＤ',statusCombined:'狀態',uwApproverUnit:'分公司',uwApprover:'核保員',approvalUser:'覆核'},UNIT_MAP_FIELD_API_KEY='uwApproverUnit',UNIT_CODE_MAPPINGS={H:'核保部',B:'北一',C:'台中',K:'高雄',N:'台南',P:'北二',T:'桃竹',G:'保作'},A17_UNIT_BUTTONS_DEFS=[{id:'H',label:'H-總公司',color:'#007bff'},{id:'B',label:'B-北一',color:'#28a745'},{id:'P',label:'P-北二',color:'#ffc107'},{id:'T',label:'T-桃竹',color:'#17a2b8'},{id:'C',label:'C-台中',color:'#fd7e14'},{id:'N',label:'N-台南',color:'#6f42c1'},{id:'K',label:'K-高雄',color:'#e83e8c'},{id:'UNDEF',label:'查無',color:'#546e7a'}],A17_CSV_DISPLAY_HEADERS=['送金單','科目代碼','幣別','餘額','入帳日期','入帳人員','保單狀態'],A17_API_DATA_DISPLAY_HEADERS=['受理號碼','保單號碼','確認書編號','分公司','核保員'],A17_COPY_ONLY_HEADERS=['送金單','科目代碼','幣別','餘額','入帳日期','入帳人員','保單狀態','保單號碼','分公司','核保員','',''],A17_PARA1="您好，",A17_PARA2_TEMPLATE="依據【管理報表：A17 新契約異常帳務】所載內容，本週報表中列示之送金單號碼，涉及多項帳務異常情形，例如：溢繳、短收、取消件需退費、無相對應之案件等問題。",A17_PARA3="經逐筆查詢比對後，該等送金單應對應至下表所列之新契約案件，敬請協助確認各案件之帳務狀況，謝謝。";let textSettings={content:A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3,fontSize:10.5,lineHeight:1.5};function loadTextSettings(){const saved=localStorage.getItem('qt_a17_text_settings');if(saved)try{textSettings={...textSettings,...JSON.parse(saved)}}catch(e){}}function saveTextSettings(){localStorage.setItem('qt_a17_text_settings',JSON.stringify(textSettings))}function escapeHtml(s){return s===undefined||s===null?'':String(s).replace(/[&<"']/g,m=>({'&':'&','<':'<','"':'"',"'":'&#039;'})[m])}function displaySystemNotification(msg,err,dur=2000){const nId='qtNotif_vFinal';document.getElementById(nId)?.remove();const n=document.createElement('div');n.id=nId;n.style.cssText=%60position:fixed;top:10px;right:10px;background:${err?'#c0392b':'#27ae60'};color:white;padding:6px 9px;border-radius:3px;z-index:${Z_INDEX_NOTIFICATION};font-weight:500;font-size:12px;transform:translateX(calc(100% + 15px));transition:transform 0.25s;box-shadow:0 1px 5px rgba(0,0,0,0.12);font-family:'Microsoft JhengHei',Arial,sans-serif;%60;n.innerHTML=%60${err?'&#x26A0;':'&#x2714;'} <span>${escapeHtml(msg)}</span>%60;document.body.appendChild(n);setTimeout(()=>n.style.transform='translateX(0)',20);setTimeout(()=>{n.style.transform='translateX(calc(100% + 15px))';setTimeout(()=>n.remove(),250)},dur)}function createDialogBase(id,contentHtml,minWidth='320px',maxWidth='480px'){document.getElementById(id)?.remove();const d=document.createElement('div');d.id=id;d.style.cssText=%60position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2);min-width:${minWidth};max-width:${maxWidth};z-index:${Z_INDEX_DIALOG};font-family:'Microsoft JhengHei',Arial,sans-serif;%60;d.innerHTML=contentHtml+%60<style>.qt-dialog-btn-final{border:none;padding:8px 16px;border-radius:4px;font-size:13px;cursor:pointer;font-weight:500;transition:all 0.2s ease;margin-left:4px}.qt-dialog-btn-final:hover{opacity:0.8}.qt-dialog-btn-blue{background:#007bff;color:white}.qt-dialog-btn-grey{background:#6c757d;color:white}.qt-dialog-btn-orange{background:#fd7e14;color:white}</style>%60;document.body.appendChild(d);return{dialog:d}}function extractName(strVal){if(!strVal||typeof strVal!=='string')return'';const m=strVal.match(/^[\u4e00-\u9fa5\uff0a*\u00b7\uff0e]+(?=\s|$)/);return m?m[0]:strVal.split(' ')[0]}function createEnvSelectionDialog(){return new Promise(resolve=>{const html=%60<h3 style="margin:0 0 10px 0;color:#333;font-size:16px;text-align:center;font-weight:700;">選擇查詢環境</h3><div style="display:flex;gap:8px;justify-content:center;"><button class="qt-env-btn" data-v="test" style="background:#27ae60;color:white;padding:10px 16px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;">測試 (UAT)</button><button class="qt-env-btn" data-v="prod" style="background:#d35400;color:white;padding:10px 16px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold;">正式 (PROD)</button></div>%60;const{dialog}=createDialogBase('qtEnvSelDialog',html);dialog.querySelectorAll('.qt-env-btn').forEach(b=>{b.onmouseover=()=>b.style.opacity='0.8';b.onmouseout=()=>b.style.opacity='1';b.onclick=()=>{dialog.remove();resolve(b.dataset.v)}})})}function createTokenDialog(){return new Promise(resolve=>{const html=%60<h3 style="margin:0 0 12px 0;color:#333;font-size:16px;text-align:center;font-weight:600;">API TOKEN 設定</h3><input type="password" id="qt-token-input" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;margin-bottom:12px;color:#333;box-sizing:border-box;outline:none;" placeholder="請輸入您的 API TOKEN"><div style="text-align:right;display:flex;justify-content:flex-end;gap:8px;"><button id="qt-token-skip" class="qt-dialog-btn-final qt-dialog-btn-orange">略過</button><button id="qt-token-cancel" class="qt-dialog-btn-final qt-dialog-btn-grey">取消</button><button id="qt-token-ok" class="qt-dialog-btn-final qt-dialog-btn-blue">確定</button></div>%60;const{dialog}=createDialogBase('qtTokenDialog_final',html,'320px','400px');setTimeout(()=>{const inputEl=document.getElementById('qt-token-input');if(inputEl)inputEl.focus()},100);const cleanup=value=>{document.removeEventListener('keydown',keyHandler);dialog.remove();resolve(value)};const keyHandler=e=>{if(e.key==='Escape'){cleanup(null)}else if(e.key==='Enter'){e.preventDefault();const inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')}};document.addEventListener('keydown',keyHandler);document.getElementById('qt-token-ok').onclick=()=>{const inputEl=document.getElementById('qt-token-input');cleanup(inputEl?inputEl.value.trim():'')};document.getElementById('qt-token-cancel').onclick=()=>cleanup(null);document.getElementById('qt-token-skip').onclick=()=>cleanup('_QT_SKIP_')})}function createQuerySetupDialog(currentApiKey){return new Promise(resolve=>{let selApiKey=currentApiKey||QUERYABLE_FIELD_DEFINITIONS[0]?.queryApiKey;const btns=QUERYABLE_FIELD_DEFINITIONS.map(d=>%60<button class="qt-querytype-btn-final" data-apikey="${d.queryApiKey}" style="background-color:${d.color};color:white;border:2px solid transparent;padding:5px 0;flex-grow:1;text-align:center;border-radius:3px;font-size:11.5px;font-weight:500;cursor:pointer;transition:all 0.15s ease;height:26px;line-height:1.2;">${escapeHtml(d.queryDisplayName)}</button>%60).join('');const html=%60<h3 style="margin:0 0 8px 0;color:#333;font-size:15px;text-align:center;font-weight:700;">選擇查詢條件</h3><div id="qt-querytype-buttons-final" style="display:flex;gap:4px;margin-bottom:8px;">${btns}</div><textarea id="qt-queryvalues-input-final" style="width:100%;min-height:45px;padding:6px;border:1px solid #ccc;border-radius:3px;font-size:12px;margin-bottom:8px;color:#333;resize:vertical;box-sizing:border-box;" placeholder="請先選擇上方查詢欄位"></textarea><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><button id="qt-clear-input-btn" class="qt-dialog-btn-final qt-dialog-btn-orange">清除</button><button id="qt-import-csv-btn" class="qt-dialog-btn-final qt-dialog-btn-grey">匯入檔案</button><button id="qt-querysetup-cancel-final" class="qt-dialog-btn-final qt-dialog-btn-grey">取消</button><button id="qt-querysetup-ok-final" class="qt-dialog-btn-final qt-dialog-btn-blue">確認</button></div><input type="file" id="qt-csv-file-input" accept=".csv,.txt" style="display:none;">%60;const{dialog}=createDialogBase('qtQuerySetupDialog_final',html,'420px','600px');const qvInput=document.getElementById('qt-queryvalues-input-final');const typeBtns=dialog.querySelectorAll('.qt-querytype-btn-final');const csvFileInput=document.getElementById('qt-csv-file-input');const importCsvBtn=document.getElementById('qt-import-csv-btn');function setActiveButton(apiKey){typeBtns.forEach(b=>{const isSel=b.dataset.apikey===apiKey;b.style.borderColor=isSel?b.style.backgroundColor:'transparent';b.style.boxShadow=isSel?%600 0 0 1.5px #fff, 0 0 0 3px ${b.style.backgroundColor}%60:'none';b.style.filter=isSel?'brightness(1.12)':'brightness(1)';if(isSel){const selDef=QUERYABLE_FIELD_DEFINITIONS.find(d=>d.queryApiKey===apiKey);qvInput.placeholder=%60請輸入${selDef.queryDisplayName}(可多筆，用空格、逗號、分號或換行分隔)%60}})}typeBtns.forEach(b=>{b.onclick=()=>{selApiKey=b.dataset.apikey;setActiveButton(selApiKey);qvInput.focus()}});setActiveButton(selApiKey);document.getElementById('qt-clear-input-btn').onclick=()=>{qvInput.value='';const csvColSel=document.getElementById('qt-csv-col-sel');if(csvColSel){csvColSel.parentElement.remove()}currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};const csvFileInput=document.getElementById('qt-csv-file-input');if(csvFileInput){csvFileInput.value=''}if(selApiKey){setActiveButton(selApiKey)}qvInput.focus();displaySystemNotification('已清除所有匯入資料',false)};importCsvBtn.onclick=()=>csvFileInput.click();csvFileInput.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=re=>{try{const text=re.target.result;const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");if(lines.length<2){displaySystemNotification('CSV檔案資料不足',true);return}currentTableInstance.isCSVImportModeGlobal=true;csvImportState.isImported=true;csvImportState.fileName=file.name;const headers=lines[0].split(/,|;|\t/).map(h=>h.trim());csvImportState.headers=headers;csvImportState.csvHeaders=headers;const oldSelector=document.getElementById('qt-csv-col-sel');if(oldSelector){oldSelector.parentElement.remove()}let selectHtml=%60<div style="margin-bottom:8px;"><label style="font-weight:bold;">選擇查詢依據欄位：</label><select id="qt-csv-col-sel" style="margin:0 8px 8px 0;">%60;headers.forEach((h,idx)=>selectHtml+=%60<option value="${idx}">${h}</option>%60);selectHtml+=%60</select><span style="font-size:11px;color:#666;">(檔案: ${file.name})</span></div>%60;qvInput.insertAdjacentHTML('beforebegin',selectHtml);const colSel=document.getElementById('qt-csv-col-sel');function fillInputByCol(colIdx){const values=[];for(let i=1;i<lines.length;i++){const cols=lines[i].split(/,|;|\t/);if(cols[colIdx]&&cols[colIdx].trim()!=="")values.push(cols[colIdx].trim())}const uniq=Array.from(new Set(values));qvInput.value=uniq.join('\n');csvImportState.selectedColumn=colIdx}colSel.onchange=()=>fillInputByCol(Number(colSel.value));fillInputByCol(0);displaySystemNotification('CSV匯入成功，請選擇查詢依據欄位',false)}catch(err){displaySystemNotification('CSV解析失敗',true)}};reader.onerror=()=>displaySystemNotification('讀取檔案失敗',true);reader.readAsText(file,'utf-8');e.target.value=null};document.getElementById('qt-querysetup-ok-final').onclick=()=>{const vs=qvInput.value.trim();if(!selApiKey){displaySystemNotification('請選擇查詢類型',true);return}if(!vs){displaySystemNotification('請輸入查詢內容',true);qvInput.focus();return}dialog.remove();resolve({selectedApiKey:selApiKey,queryValues:vs})};document.getElementById('qt-querysetup-cancel-final').onclick=()=>{dialog.remove();resolve(null)}})}function createTextSettingDialog(){return new Promise(resolve=>{const html=%60<h3 style="margin:0 0 15px 0;color:#333;font-size:16px;text-align:center;font-weight:600;">A17 文本設定</h3><div style="margin-bottom:12px;"><label style="display:block;margin-bottom:5px;font-weight:500;color:#555;">文本內容：</label><textarea id="qt-text-content" style="width:100%;height:120px;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;resize:vertical;font-family:'Microsoft JhengHei',Arial,sans-serif;" placeholder="請輸入 A17 通知文本內容...">${escapeHtml(textSettings.content)}</textarea></div><div style="display:flex;gap:15px;margin-bottom:15px;"><div style="flex:1;"><label style="display:block;margin-bottom:5px;font-weight:500;color:#555;">字體大小：</label><input type="number" id="qt-font-size" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;" value="${textSettings.fontSize}" min="8" max="24" step="0.5"><small style="color:#666;">pt</small></div><div style="flex:1;"><label style="display:block;margin-bottom:5px;font-weight:500;color:#555;">行高：</label><input type="number" id="qt-line-height" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:13px;color:#333;box-sizing:border-box;" value="${textSettings.lineHeight}" min="1" max="3" step="0.1"><small style="color:#666;">倍數</small></div></div><div style="background:#f8f9fa;padding:10px;border-radius:4px;margin-bottom:15px;"><div style="font-size:11px;color:#666;margin-bottom:5px;">預覽效果：</div><div id="qt-text-preview" style="font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};color:#333;max-height:80px;overflow-y:auto;border:1px solid #e9ecef;padding:8px;background:white;border-radius:3px;">${escapeHtml(textSettings.content.substring(0,100))}...</div></div><div style="text-align:right;display:flex;justify-content:flex-end;gap:8px;"><button id="qt-text-reset" class="qt-dialog-btn-final qt-dialog-btn-orange">重設</button><button id="qt-text-cancel" class="qt-dialog-btn-final qt-dialog-btn-grey">取消</button><button id="qt-text-save" class="qt-dialog-btn-final qt-dialog-btn-blue">存檔</button></div>%60;const{dialog}=createDialogBase('qtTextSettingDialog_final',html,'480px','600px');function updatePreview(){const content=document.getElementById('qt-text-content').value;const fontSize=document.getElementById('qt-font-size').value;const lineHeight=document.getElementById('qt-line-height').value;const preview=document.getElementById('qt-text-preview');preview.style.fontSize=fontSize+'pt';preview.style.lineHeight=lineHeight;preview.textContent=content.substring(0,100)+(content.length>100?'...':'')}setTimeout(()=>{document.getElementById('qt-text-content').addEventListener('input',updatePreview);document.getElementById('qt-font-size').addEventListener('input',updatePreview);document.getElementById('qt-line-height').addEventListener('input',updatePreview)},100);document.getElementById('qt-text-save').onclick=()=>{const newSettings={content:document.getElementById('qt-text-content').value.trim(),fontSize:parseFloat(document.getElementById('qt-font-size').value),lineHeight:parseFloat(document.getElementById('qt-line-height').value)};if(!newSettings.content){displaySystemNotification('請輸入文本內容',true);return}textSettings=newSettings;saveTextSettings();displaySystemNotification('文本設定已保存',false);dialog.remove();resolve(true)};document.getElementById('qt-text-cancel').onclick=()=>{dialog.remove();resolve(false)};document.getElementById('qt-text-reset').onclick=()=>{document.getElementById('qt-text-content').value=A17_PARA1+'\n\n'+A17_PARA2_TEMPLATE+'\n\n'+A17_PARA3;document.getElementById('qt-font-size').value=10.5;document.getElementById('qt-line-height').value=1.5;updatePreview()}})}async function performApiQuery(queryValue){const reqBody={currentPage:1,pageSize:10};reqBody[selectedQueryDefinitionGlobal.queryApiKey]=queryValue;const fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)};if(apiAuthToken){fetchOpts.headers['SSO-TOKEN']=apiAuthToken}try{const res=await fetch(CURRENT_API_URL,fetchOpts);const data=await res.json();if(res.status===401){displaySystemNotification('TOKEN無效或已過期',true);return{error:'token_invalid',data:null}}return{error:null,data:data,success:data&&data.records&&data.records.length>0}}catch(e){console.error('查詢失敗:',e);return{error:'network_error',data:null}}}function getFirstLetter(unitString){if(!unitString||typeof unitString!=='string')return'Z';for(let i=0;i<unitString.length;i++){const char=unitString.charAt(i).toUpperCase();if(/[A-Z]/.test(char)){return char}}return'Z'}function filterDataByUnit(data,unitId){if(unitId==='UNDEF'){const knownPrefixes=A17_UNIT_BUTTONS_DEFS.filter(b=>b.id!=='UNDEF').map(b=>b.id.toUpperCase());return data.filter(r=>{const uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return uVal.trim()===''||!knownPrefixes.some(prefix=>uVal.toUpperCase().startsWith(prefix))})}else{return data.filter(r=>{const uVal=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');return uVal.toUpperCase().startsWith(unitId.toUpperCase())})}}function createA17UnitButtons(){const a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(!a17BtnsCtr)return;a17BtnsCtr.style.cssText='margin-bottom:5px;display:flex;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;visibility:visible;';a17BtnsCtr.innerHTML='';A17_UNIT_BUTTONS_DEFS.forEach(unitDef=>{const btn=document.createElement('button');btn.dataset.unitId=unitDef.id;btn.style.cssText=%60background-color:${unitDef.color};color:white;border:none;padding:5px 4px;border-radius:3px;cursor:pointer;font-size:9px;transition:all 0.2s ease;width:calc((100vw - 320px) / 8);min-width:70px;max-width:90px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;%60;btn.textContent=%60${unitDef.label} (0)%60;btn.onclick=()=>{if(btn.disabled)return;const unitId=unitDef.id;if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}else{a17ModeState.selectedUnits.add(unitId);btn.classList.add('highlighted');btn.style.boxShadow='0 0 0 2px white, 0 0 0 4px black'}if(a17ModeState.selectedUnits.size>0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification(%60已選擇 ${a17ModeState.selectedUnits.size} 個單位%60,false)};a17BtnsCtr.appendChild(btn)})}function filterA17DataBySelectedUnits(){let filteredData=[];a17ModeState.selectedUnits.forEach(unitId=>{let unitData=filterDataByUnit(baseA17MasterData,unitId);filteredData=filteredData.concat(unitData)});filteredData.sort((a,b)=>{const unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const firstLetterA=getFirstLetter(unitA);const firstLetterB=getFirstLetter(unitB);return firstLetterA.localeCompare(firstLetterB)});window.pTBRs(filteredData)}function updateA17UnitButtonCounts(){if(!a17ModeState.isActive)return;const unitCounts={};baseA17MasterData.forEach(r=>{const unitFull=String(r[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');let unitPrefix='UNDEF';for(const code in UNIT_CODE_MAPPINGS){if(unitFull.toUpperCase().startsWith(code)){unitPrefix=code;break}}if(unitFull.trim()===''){unitPrefix='UNDEF'}unitCounts[unitPrefix]=(unitCounts[unitPrefix]||0)+1});const buttons=document.getElementById('qt-a17-unit-btns-ctr-final')?.querySelectorAll('button')||[];buttons.forEach(btn=>{const unitId=btn.dataset.unitId;const count=unitCounts[unitId]||0;const unitDef=A17_UNIT_BUTTONS_DEFS.find(def=>def.id===unitId);if(unitDef){btn.textContent=%60${unitDef.label} (${count})%60;if(count===0){btn.disabled=true;btn.style.opacity='0.5';if(a17ModeState.selectedUnits.has(unitId)){a17ModeState.selectedUnits.delete(unitId);btn.classList.remove('highlighted');btn.style.boxShadow='none'}}else{btn.disabled=false;btn.style.opacity='1'}}});if(a17ModeState.selectedUnits.size===0){window.pTBRs(baseA17MasterData)}}function generateAndCopyA17NotificationWithSettings(dataToCopy,headers,withText){loadTextSettings();const htmlRows=dataToCopy.map((r,idx)=>%60<tr style="${idx%2?'background-color:#fdfdfd;':'#f7f7f7'}">${headers.map(h=>{let cellTxt='';if(h===''){cellTxt=''}else{cellTxt=escapeHtml(String(r[h]||''))}return%60<td style="border:1px solid #bbb;padding:3px 4px;text-align:center;font-size:${textSettings.fontSize}pt;color:#333;">${cellTxt}</td>%60}).join('')}</tr>%60).join('');const htmlTab=%60<table style="border-collapse:collapse;font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;width:100%;margin-top:8px;"><thead><tr style="background-color:#34495e;color:white;">${headers.map(h=>%60<th style="border:1px solid #2c3e50;padding:4px;text-align:center;font-weight:bold;">${escapeHtml(h)}</th>%60).join('')}</tr></thead><tbody>${htmlRows}</tbody></table>%60;const htmlOut=withText?%60<div style="font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:${textSettings.fontSize}pt;line-height:${textSettings.lineHeight};">${textSettings.content.split('\n').map(line=>%60<p>${escapeHtml(line)}</p>%60).join('')}${htmlTab}</div>%60:htmlTab;const plainRows=dataToCopy.map(r=>headers.map(h=>String(r[h]||'')).join('\t')).join('\n');const plainOut=withText?textSettings.content+'\n\n'+headers.join('\t')+'\n'+plainRows:headers.join('\t')+'\n'+plainRows;try{navigator.clipboard.write([new ClipboardItem({'text/html':new Blob([htmlOut],{type:'text/html'}),'text/plain':new Blob([plainOut],{type:'text/plain'})})]).then(()=>{displaySystemNotification('已複製 A17 通知內容',false)})}catch(e){navigator.clipboard.writeText(plainOut).then(()=>{displaySystemNotification('已複製 A17 通知內容',false)})}}function executeA17SortAndFilter(){if(!a17ModeState.isActive){a17ModeState.isActive=true;currentTableInstance.isA17Mode=true;const a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='flex'}baseA17MasterData=[...originalQueryResults];let a17Headers;if(currentTableInstance.isCSVImportModeGlobal&&csvImportState.csvHeaders.length>0){a17Headers=[...csvImportState.csvHeaders,...A17_API_DATA_DISPLAY_HEADERS]}else{a17Headers=['送金單號碼','NO','受理號碼','保單號碼','確認書編號','分公司','核保員','覆核','狀態','查詢結果']}currentTableInstance.currentHeaders=[...a17Headers];window.rTHs(a17Headers);createA17UnitButtons();updateA17UnitButtonCounts();window.pTBRs(baseA17MasterData);displaySystemNotification('已進入 A17 模式',false)}else{a17ModeState.isActive=false;a17ModeState.selectedUnits.clear();const a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.style.display='none'}let originalHeaders=[];if(selectedQueryDefinitionGlobal){originalHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{originalHeaders.push("查詢值")}originalHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{originalHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});originalHeaders.push('查詢結果');currentTableInstance.currentHeaders=[...originalHeaders];window.rTHs(originalHeaders);window.pTBRs(originalQueryResults);displaySystemNotification('已退出 A17 模式',false)}}function handleA17Copy(){const isTextEnabled=document.getElementById('qt-text-enable-checkbox')?.checked||false;let dataToCopy;if(a17ModeState.selectedUnits.size>0){dataToCopy=[];a17ModeState.selectedUnits.forEach(unitId=>{let unitData=filterDataByUnit(baseA17MasterData,unitId);dataToCopy=dataToCopy.concat(unitData)});dataToCopy.sort((a,b)=>{const unitA=String(a[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const unitB=String(b[FIELD_DISPLAY_NAMES_MAP[UNIT_MAP_FIELD_API_KEY]]||'');const firstLetterA=getFirstLetter(unitA);const firstLetterB=getFirstLetter(unitB);return firstLetterA.localeCompare(firstLetterB)})}else{dataToCopy=[...baseA17MasterData]}generateAndCopyA17NotificationWithSettings(dataToCopy,A17_COPY_ONLY_HEADERS,isTextEnabled)}function sortTableByColumn(columnIndex,headerName){const currentData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const header=currentTableInstance.currentHeaders[columnIndex];const currentDirection=currentTableInstance.sortDirections[header]||'asc';const newDirection=currentDirection==='asc'?'desc':'asc';currentTableInstance.sortDirections[header]=newDirection;const sortedData=[...currentData].sort((a,b)=>{const aVal=String(a[header]||'');const bVal=String(b[header]||'');if(newDirection==='asc'){return aVal.localeCompare(bVal)}else{return bVal.localeCompare(aVal)}});if(a17ModeState.isActive){baseA17MasterData=sortedData}else{originalQueryResults=sortedData}window.pTBRs(sortedData);displaySystemNotification(%60已按${headerName}${newDirection==='asc'?'升序':'降序'}排序%60,false)}function renderResultsTableUI(dataToRender){const mainId='qtMainContainer_final';document.getElementById(mainId)?.remove();const mainUI=document.createElement('div');mainUI.id=mainId;mainUI.style.cssText=%60position:fixed;z-index:${Z_INDEX_MAIN_UI};left:50%;top:20px;transform:translateX(-50%);background:#ffffff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.15);padding:16px;width:900px;max-width:95vw;max-height:90vh;overflow:hidden;font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:13px;display:flex;flex-direction:column;border:1px solid rgba(0,0,0,0.1);%60;let initialTableHeaders=[];if(selectedQueryDefinitionGlobal){initialTableHeaders.push(selectedQueryDefinitionGlobal.queryDisplayName)}else{initialTableHeaders.push("查詢值")}initialTableHeaders.push('NO');ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(apiKey=>{initialTableHeaders.push(FIELD_DISPLAY_NAMES_MAP[apiKey]||apiKey)});initialTableHeaders.push('查詢結果');currentTableInstance.currentHeaders=[...initialTableHeaders];const controlsHeader=document.createElement('div');controlsHeader.style.cssText='display:flex;align-items:center;margin-bottom:5px;padding-bottom:5px;border-bottom:1px solid #ddd;flex-shrink:0;';const summarySec=document.createElement('div');summarySec.style.cssText='font-size:12px;font-weight:bold;color:#2c3e50;white-space:nowrap;margin-right:10px;flex-shrink:0;';summarySec.innerHTML=%60查詢結果：<strong>${dataToRender.length}</strong>筆%60;controlsHeader.appendChild(summarySec);const filterInput=document.createElement('input');filterInput.type='text';filterInput.id='qt-tbl-flt-final';filterInput.placeholder='找出我要的資料。';filterInput.style.cssText='padding:5px 7px;border:1px solid #bababa;border-radius:3px;font-size:12px;width:120px;flex-shrink:0;margin-right:10px;';controlsHeader.appendChild(filterInput);const buttonsGroup=document.createElement('div');buttonsGroup.style.cssText='display:flex;align-items:center;gap:5px;flex-shrink:0;';const buttonConfigs=[{id:'qt-clr-cond-btn-final',text:'清除條件',style:'background:#6c757d;color:white;'},{id:'qt-req-btn-final',text:'重新查詢',style:'background:#ffc107;color:#212529;'},{id:'qt-a17-btn-final',text:'A17作業通知',style:'background:#6f42c1;color:white;'},{id:'qt-cpy-all-btn-final',text:'複製',style:'background:#28a745;color:white;'}];buttonConfigs.forEach(config=>{const btn=document.createElement('button');btn.id=config.id;btn.textContent=config.text;btn.style.cssText=config.style+'border:none;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:11.5px;font-weight:500;transition:opacity 0.1s ease;white-space:nowrap;';btn.onmouseover=()=>btn.style.opacity='0.8';btn.onmouseout=()=>btn.style.opacity='1';buttonsGroup.appendChild(btn)});controlsHeader.appendChild(buttonsGroup);const textCheckbox=document.createElement('input');textCheckbox.type='checkbox';textCheckbox.id='qt-text-enable-checkbox';textCheckbox.checked=true;textCheckbox.style.cssText='margin-left:10px;cursor:pointer;';const textCheckboxLabel=document.createElement('label');textCheckboxLabel.htmlFor='qt-text-enable-checkbox';textCheckboxLabel.textContent='A17文本';textCheckboxLabel.style.cssText='font-size:11px;color:#555;cursor:pointer;margin:0 8px 0 2px;user-select:none;';const textEditBtn=document.createElement('button');textEditBtn.id='qt-text-edit-btn-final';textEditBtn.textContent='文本編輯';textEditBtn.style.cssText='background:#17a2b8;color:white;font-size:10px;padding:4px 8px;border:none;border-radius:3px;cursor:pointer;';textEditBtn.onmouseover=()=>textEditBtn.style.opacity='0.8';textEditBtn.onmouseout=()=>textEditBtn.style.opacity='1';controlsHeader.appendChild(textCheckbox);controlsHeader.appendChild(textCheckboxLabel);controlsHeader.appendChild(textEditBtn);const editModeBtn=document.createElement('button');editModeBtn.id='qt-edit-mode-btn-final';editModeBtn.textContent='編輯模式';editModeBtn.style.cssText='background:#6c757d;color:white;font-size:11px;padding:5px 10px;margin-left:8px;border:none;border-radius:3px;cursor:pointer;';editModeBtn.onmouseover=()=>editModeBtn.style.opacity='0.8';editModeBtn.onmouseout=()=>editModeBtn.style.opacity='1';controlsHeader.appendChild(editModeBtn);const closeBtn=document.createElement('button');closeBtn.textContent='關閉';closeBtn.style.cssText='background:#dc3545;color:white;margin-left:auto;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:11.5px;';closeBtn.onmouseover=()=>closeBtn.style.opacity='0.8';closeBtn.onmouseout=()=>closeBtn.style.opacity='1';closeBtn.onclick=()=>mainUI.remove();controlsHeader.appendChild(closeBtn);mainUI.appendChild(controlsHeader);const a17BtnsCtr=document.createElement('div');a17BtnsCtr.id='qt-a17-unit-btns-ctr-final';a17BtnsCtr.style.cssText='margin-bottom:5px;display:none;flex-wrap:nowrap;gap:4px;justify-content:flex-start;flex-shrink:0;margin-left:260px;';mainUI.appendChild(a17BtnsCtr);const tableScrollWrap=document.createElement('div');tableScrollWrap.style.cssText='flex-grow:1;overflow:auto;border:1px solid #ccc;border-radius:4px;';const tableEl=document.createElement('table');tableEl.id='qt-res-tbl-final';tableEl.style.cssText='width:100%;border-collapse:collapse;font-size:11.5px;';tableScrollWrap.appendChild(tableEl);mainUI.appendChild(tableScrollWrap);const tHREl=document.createElement('thead');tHREl.style.cssText='position:sticky;top:0;z-index:10;background-color:#34495e;';tableEl.appendChild(tHREl);const tBREl=document.createElement('tbody');tableEl.appendChild(tBREl);document.body.appendChild(mainUI);function rTHs(hdrs){tHREl.innerHTML='';const hr=document.createElement('tr');hdrs.forEach((hTxt,idx)=>{const th=document.createElement('th');th.textContent=hTxt;th.style.cssText=%60color:#fff;text-align:center;padding:6px 4px;border-bottom:1px solid #2c3e50;white-space:nowrap;cursor:pointer;user-select:none;font-weight:600;border-right:1px solid #4a6075;font-size:11px;${idx===0?'background:#007bff;':''}%60;if(idx===hdrs.length-1)th.style.borderRight='none';th.onclick=()=>{sortTableByColumn(idx,hTxt)};hr.appendChild(th)});tHREl.appendChild(hr)}function pTBRs(data){tBREl.innerHTML='';data.forEach((row,idx)=>{const tr=document.createElement('tr');tr.style.backgroundColor=idx%2?'#f8f9fa':'#fff';currentTableInstance.currentHeaders.forEach((header,colIdx)=>{const td=document.createElement('td');td.style.cssText='padding:4px 6px;border-bottom:1px solid #dee2e6;font-size:11px;text-align:center;cursor:pointer;';if(colIdx===0){td.style.background='#e3f0fd';td.style.fontWeight='bold'}let cellContent=row[header];if(header.includes('狀態')&&typeof cellContent==='string'&&cellContent.includes('<span')){td.innerHTML=cellContent}else{td.textContent=cellContent||''}td.onclick=function(e){e.stopPropagation();if(isEditMode&&colIdx>1){startCellEdit(td,row,header,cellContent)}else{navigator.clipboard.writeText(td.textContent).then(()=>{displaySystemNotification('已複製內容：'+td.textContent,false,1000)})}};tr.appendChild(td)});tBREl.appendChild(tr)});if(a17ModeState.isActive){setTimeout(()=>{updateA17UnitButtonCounts()},100)}}function startCellEdit(td,rowData,headerName,originalValue){if(td.querySelector('input'))return;const input=document.createElement('input');input.type='text';input.value=td.textContent;input.style.cssText=%60width:100%;border:2px solid #007bff;padding:2px 4px;font-size:11px;background:#fff3cd;box-sizing:border-box;outline:none;%60;td.innerHTML='';td.appendChild(input);input.focus();input.select();input.onkeydown=function(e){if(e.key==='Enter'){finishEdit(td,input,rowData,headerName,originalValue)}else if(e.key==='Escape'){td.textContent=originalValue}};input.onblur=function(){finishEdit(td,input,rowData,headerName,originalValue)}}function finishEdit(td,input,rowData,headerName,originalValue){const newValue=input.value.trim();td.textContent=newValue;rowData[headerName]=newValue;if(newValue!==originalValue){td.style.background='#d4edda';displaySystemNotification(%60已更新：${headerName}%60,false,1000);if(headerName==='分公司'&&a17ModeState.isActive){const rowIndex=originalQueryResults.findIndex(row=>row.NO===rowData.NO);if(rowIndex!==-1){originalQueryResults[rowIndex][headerName]=newValue}baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size>0){filterA17DataBySelectedUnits()}}}}function updateTableEditMode(){const cells=tableEl.querySelectorAll('tbody td');cells.forEach((cell,index)=>{const colIndex=index%currentTableInstance.currentHeaders.length;if(isEditMode&&colIndex>1){cell.style.cursor='text';cell.style.border='1px dashed #007bff';cell.title='點擊編輯，按 Enter 完成'}else{cell.style.cursor='pointer';cell.style.border='';cell.title='點擊複製'}})}rTHs(currentTableInstance.currentHeaders);pTBRs(dataToRender);filterInput.oninput=()=>{const v=filterInput.value.trim().toLowerCase();if(!v){pTBRs(a17ModeState.isActive?baseA17MasterData:originalQueryResults);return}const sourceData=a17ModeState.isActive?baseA17MasterData:originalQueryResults;const filtered=sourceData.filter(row=>Object.values(row).some(val=>String(val||'').toLowerCase().includes(v)));pTBRs(filtered)};document.getElementById('qt-clr-cond-btn-final').onclick=()=>{a17ModeState.selectedUnits.clear();const a17BtnsCtr=document.getElementById('qt-a17-unit-btns-ctr-final');if(a17BtnsCtr){a17BtnsCtr.querySelectorAll('button').forEach(btn=>{btn.classList.remove('highlighted');btn.style.boxShadow='none'})}filterInput.value='';currentTableInstance.isCSVImportModeGlobal=false;csvImportState={isImported:false,headers:[],selectedColumn:null,fileName:'',csvHeaders:[]};if(a17ModeState.isActive){const normalA17Headers=['送金單號碼','NO','受理號碼','保單號碼','確認書編號','分公司','核保員','覆核','狀態','查詢結果'];currentTableInstance.currentHeaders=[...normalA17Headers];window.rTHs(normalA17Headers)}pTBRs(originalQueryResults);displaySystemNotification('條件已清除，包含CSV匯入資料',false)};document.getElementById('qt-req-btn-final').onclick=()=>{mainUI.remove();executeCaseQueryTool()};document.getElementById('qt-a17-btn-final').onclick=()=>{executeA17SortAndFilter()};document.getElementById('qt-cpy-all-btn-final').onclick=()=>{if(a17ModeState.isActive){handleA17Copy()}else{handleNormalCopy()}};textEditBtn.onclick=()=>{createTextSettingDialog()};editModeBtn.onclick=()=>{isEditMode=!isEditMode;editModeBtn.textContent=isEditMode?'退出編輯':'編輯模式';editModeBtn.style.background=isEditMode?'#dc3545':'#6c757d';updateTableEditMode();if(!isEditMode&&a17ModeState.isActive){baseA17MasterData=[...originalQueryResults];updateA17UnitButtonCounts();if(a17ModeState.selectedUnits.size>0){filterA17DataBySelectedUnits()}else{window.pTBRs(baseA17MasterData)}displaySystemNotification('已更新A17分公司篩選狀態',false)}};window.pTBRs=pTBRs;window.rTHs=rTHs}function handleNormalCopy(){const dataToCopy=[...originalQueryResults];const headers=currentTableInstance.currentHeaders;const rows=dataToCopy.map(row=>headers.map(header=>String(row[header]||'')).join('\t')).join('\n');const textOutput=headers.join('\t')+'\n'+rows;navigator.clipboard.writeText(textOutput).then(()=>{displaySystemNotification(%60已複製 ${dataToCopy.length} 筆查詢結果%60,false)}).catch(e=>{console.error('複製失敗:',e);displaySystemNotification('複製失敗',true)})}async function executeCaseQueryTool(){const mainContainerId='qtMainContainer_vFinal';if(document.getElementById(mainContainerId)){displaySystemNotification('查詢工具已開啟',true);return}const selectedEnv=await createEnvSelectionDialog();if(!selectedEnv){displaySystemNotification('操作已取消',true);return}CURRENT_API_URL=selectedEnv==='prod'?API_URL_PROD:API_URL_UAT;displaySystemNotification(%60環境: ${selectedEnv==='prod'?'正式':'測試'}%60);if(!apiAuthToken){const tokenRes=await createTokenDialog();if(tokenRes===null){displaySystemNotification('操作已取消',true);return}if(tokenRes==='_QT_SKIP_'){displaySystemNotification('已略過TOKEN輸入',false);apiAuthToken=null}else if(!tokenRes){displaySystemNotification('未提供TOKEN，查詢中止',true);return}else{apiAuthToken=tokenRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}}const querySetupRes=await createQuerySetupDialog(selectedQueryDefinitionGlobal?.queryApiKey);if(!querySetupRes){displaySystemNotification('操作已取消',true);return}selectedQueryDefinitionGlobal=QUERYABLE_FIELD_DEFINITIONS.find(qdf=>qdf.queryApiKey===querySetupRes.selectedApiKey);const queryValuesRaw=querySetupRes.queryValues;const queryValues=queryValuesRaw.split(/[\s,;\n]+/).map(x=>x.trim().toUpperCase()).filter(Boolean);if(queryValues.length===0){displaySystemNotification('未輸入有效查詢值',true);return}const loadingOverlay=document.createElement('div');loadingOverlay.style.cssText=%60position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:${Z_INDEX_DIALOG+1};display:flex;align-items:center;justify-content:center;font-family:"Microsoft JhengHei",Arial,sans-serif;%60;const loadingP=document.createElement('p');loadingP.style.cssText='margin:0;color:#333;font-size:14px;font-weight:500;';const loadingDiv=document.createElement('div');loadingDiv.style.cssText='background:#fff;padding:20px 25px;border-radius:7px;text-align:center;box-shadow:0 3px 12px rgba(0,0,0,0.1);';loadingDiv.innerHTML=%60<div style="width:30px;height:30px;border:3px solid #e0e0e0;border-top:3px solid #007bff;border-radius:50%;animation:qtSpinAnimationFull 1s linear infinite;margin:0 auto 10px;"></div>%60;loadingDiv.appendChild(loadingP);loadingOverlay.appendChild(loadingDiv);document.body.appendChild(loadingOverlay);const loadingStyle=document.createElement('style');loadingStyle.textContent='@keyframes qtSpinAnimationFull{to{transform:rotate(360deg)}}';document.head.appendChild(loadingStyle);let fetchedResultsCollector=[];let currentCounter=1;for(let i=0;i<queryValues.length;i++){const singleQueryValue=queryValues[i];loadingP.textContent=%60查詢中: 第 ${i+1} / ${queryValues.length} 筆 (${singleQueryValue})...%60;const resultRowBase={'NO':String(currentCounter++),'_queriedValue_':singleQueryValue};const apiResult=await performApiQuery(singleQueryValue);let apiQueryStatus='✗ 查詢失敗';if(apiResult.error==='token_invalid'){apiQueryStatus='✗ TOKEN失效';loadingOverlay.remove();const tokenRetryRes=await createTokenDialog();if(tokenRetryRes===null||!tokenRetryRes||tokenRetryRes==='_QT_SKIP_'){apiAuthToken=null;displaySystemNotification(tokenRetryRes===null?'操作取消':'TOKEN未更新/略過',true);if(tokenRetryRes===null){if(loadingStyle)loadingStyle.remove();return}}else{apiAuthToken=tokenRetryRes;localStorage.setItem(TOKEN_STORAGE_KEY,apiAuthToken)}if(document.body.contains(loadingOverlay))loadingOverlay.style.display='flex';else document.body.appendChild(loadingOverlay)}else if(apiResult.success){apiQueryStatus='✓ 成功'}else if(!apiResult.error){apiQueryStatus='✗ 查無資料'}resultRowBase._apiQueryStatus=apiQueryStatus;if(apiResult.success&&apiResult.data.records){apiResult.data.records.forEach(rec=>{const popRow={...resultRowBase};const mainStatusVal=rec['mainStatus']||'';const subStatusVal=rec['subStatus']||'';popRow['_raw_mainStatus_']=mainStatusVal;popRow['_raw_subStatus_']=subStatusVal;ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=>{const dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;let cVal=rec[dKey]===null||rec[dKey]===undefined?'':String(rec[dKey]);if(dKey==='statusCombined'){popRow[dN]=%60<span class="qt-status-main">${escapeHtml(mainStatusVal)}</span><span class="qt-status-sub">${escapeHtml(subStatusVal)}</span>%60}else if(dKey===UNIT_MAP_FIELD_API_KEY){const uVal=cVal;let uPre='';for(let k=0;k<uVal.length;k++){if(/[A-Za-z]/.test(uVal.charAt(k))){uPre=uVal.charAt(k).toUpperCase();break}}const mName=UNIT_CODE_MAPPINGS[uPre]||uVal;popRow[dN]=uPre?%60${uPre}-${mName.replace(/^[A-Za-z]-/,'')}%60:mName}else if(dKey==='uwApprover'||dKey==='approvalUser'){popRow[dN]=extractName(cVal)}else{popRow[dN]=cVal}});popRow['查詢結果']=apiQueryStatus;fetchedResultsCollector.push(popRow)})}else{const failOrEmptyRow={...resultRowBase};ALL_DISPLAY_FIELDS_API_KEYS_MAIN.forEach(dKey=>{const dN=FIELD_DISPLAY_NAMES_MAP[dKey]||dKey;if(dKey==='statusCombined'){failOrEmptyRow['_raw_mainStatus_']='-';failOrEmptyRow['_raw_subStatus_']='';failOrEmptyRow[dN]='-'}else{failOrEmptyRow[dN]='-'}});if(selectedQueryDefinitionGlobal&&FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]){failOrEmptyRow[FIELD_DISPLAY_NAMES_MAP[selectedQueryDefinitionGlobal.queryApiKey]]=singleQueryValue}failOrEmptyRow['查詢結果']=apiQueryStatus;fetchedResultsCollector.push(failOrEmptyRow)}if(queryValues.length>1&&i<queryValues.length-1)await new Promise(r=>setTimeout(r,250))}if(document.body.contains(loadingOverlay))loadingOverlay.remove();if(loadingStyle)loadingStyle.remove();originalQueryResults=[...fetchedResultsCollector];renderResultsTableUI(originalQueryResults)}loadTextSettings();executeCaseQueryTool()})();},
  {
    "id": "A17-1.js",
    "description": "A17 報表工具 2",
    "category": "a17",
    "type": "action",
    "action_script": "https://cdn.jsdelivr.net/gh/k791031k/TRY/07-17-1.js?v=%27+Date.now();"
  }, 
  {
    "id": "A17-2.js",
    "description": "A17 報表工具 2",
    "category": "a17",
    "type": "action",
    "action_script": "https://cdn.jsdelivr.net/gh/k791031k/TRY/07-17-2.js?v=%27+Date.now();"
  },  
  {
    "id": "A17-3.js",
    "description": "A17 報表工具 2",
    "category": "a17",
    "type": "action",
    "action_script": "https://cdn.jsdelivr.net/gh/k791031k/TRY/07-17-3.js?v=%27+Date.now();"
  },  
  {
    "id": "A17-4.js",
    "description": "A17 報表工具 2",
    "category": "a17",
    "type": "action",
    "action_script": "https://cdn.jsdelivr.net/gh/k791031k/TRY/07-17-4.js?v=%27+Date.now();"
  },
]
